/*


 Copyright ? 2011 Jonathon Reesor

 This file is part of Jayus.

 Jayus is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 Jayus is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with Jayus.  If not, see <http://www.gnu.org/licenses/>.
*/
window.EquationParser=function(){var a={applyRule:function(a,c,d){var e,f,g,h;for(e=1;e<a.length;e++)if(h=a[e],h===c||h===d){f=a[e-1];g=a[e+1];if(43===h)f+=g;else if(45===h)f-=g;else if(42===h)f*=g;else if(47===h){if(0===g)throw"Division by zero";f/=g}else throw"Invalid argument";a.splice(e-1,3,f);e=-1}},parse:function(b){for(var c,d,e,f=[],g=0;-1!==b.indexOf("(")&&-1!==b.indexOf(")");)for(c=b.indexOf("(");c<b.length;c++)if(d=b.charCodeAt(c),40===d&&(g=c+1),40===d||41===d)40===e&&41===d&&(b=b.substr(0,
g-1)+a.parse(b.substr(g,c-g))+b.substr(c+1)),e=d;for(c=1;c<b.length;c++)if(d=b.charCodeAt(c),43===d||45===d||42===d||47===d)e=b.charCodeAt(c-1),43!==e&&45!==e&&42!==e&&47!==e&&(f.push(Number(b.substr(g,c-g)),d),g=c+1);if(0===f.length)return Number(b);0<g&&f.push(Number(b.substr(g)));a.applyRule(f,42,47);a.applyRule(f,43,45);return f.length?f[0]:0}};return a}();var jayus;
(function(){window.jayus={running:!1,frameIntervalRunning:!1,lastFrameTime:0,lastStepTime:0,frameInterval:null,stepInterval:null,useReqAnimFrame:!0,framerate:60,steprate:60,displays:[],hasFocus:!1,focusedDisplay:null,cursorFocus:null,animators:[],frameEventData:{},fontCache:{},fontCacheMaxChar:255,copyObject:function(a){return this.applyObject(a,{})},applyObject:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},createClass:function(a){"function"!==typeof a.init&&(a.init=function(){});
var b=a.init;b.prototype=a;b.init=function(a,d){b.prototype.init.apply(a,d)};b.extend=window.jayus.extendMethod;b.fromObject=window.jayus.fromObjectMethod;return b},extendMethod:function(a){var b;b="function"===typeof a.init?a.init:"function"===typeof this.prototype.init?function(){this.init.apply(this,arguments)}:function(){};b.prototype=Object.create(this.prototype);jayus.applyObject(a,b.prototype);b.init=function(a,d){b.prototype.init.apply(a,d)};b.extend=window.jayus.extendMethod;b.fromObject=
window.jayus.fromObjectMethod;return b},fromObjectMethod:function(a){var b=new this;b.initFromObject(a);return b},parse:function(a){if("number"===typeof a.frozen)return a;var b=a.type;if("function"!==typeof jayus[b])throw Error("jayus.parse() - Unknown class "+b+", check the type property");b=new jayus[b];b.initFromObject(a);return b},groupToObject:function(a){!0!==this.propagateCursor&&(a.propagateCursor=this.propagateCursor);if(this.children!==jayus.Group.children){a.children=[];for(var b=0;b<this.items.length;b++)a.children.push(this.items[b].toObject())}},
groupInitFromObject:function(a){"boolean"===typeof a.propagateCursor&&(this.propagateCursor=a.propagateCursor);if("object"===typeof a.children){this.children=new jayus.List(this);this.items=this.children.items;this.freeze();for(var b=0;b<a.children.length;b++)this.children.add(jayus.parse(a.children[b]));this.unfreeze()}},executeFormula:function(a,b){if(0<=b.indexOf("parent")){if(null===a.parent)return console.error("jayus.executeFormula() - Parent property in formula, entity has no parent, returning 0",
a,b),0;b=b.replace(/parent.x/g,a.parent.x).replace(/parent.y/g,a.parent.y).replace(/parent.width/g,a.parent.width).replace(/parent.height/g,a.parent.height)}if(0<=b.indexOf("domain")){if(null===a.parent)return console.error("jayus.executeFormula() - Domain property in formula, entity has no parent, returning 0",a,b),0;b=b.replace(/domain.width/g,a.domainWidth).replace(/domain.height/g,a.domainHeight)}var c=window.EquationParser.parse(b.replace(/x/g,a.x).replace(/y/g,a.y).replace(/width/g,a.width).replace(/height/g,
a.height));return"string"===typeof c?(console.error('jayus.executeFormula() - Unknown error: "'+c+'", returning 0'),0):c},declareChildrenAsProperties:!0,keepTrackOfObjects:!1,identifiedObjects:[],getObject:function(a){for(var b=0;b<this.identifiedObjects.length;b++){var c=this.identifiedObjects[b];if(c.id===a)return c}return null},mustGetObject:function(a){var b=this.getObject(a);if(null===b)throw Error('jayus.mustGetObject() - Object with id "'+a+'" not found');return b},getUrlParameters:function(){for(var a=
0,b={},c,d=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");a<d.length;a++)c=d[a].split("="),b[c[0]]=c[1];return b},init:function(){var a=document.createElement("canvas");if("function"!==typeof a.getContext||"object"!==typeof a.getContext("2d"))throw Error("Fatal error, browser does not support the canvas element, unable to initiate Jayus");this.applyObject(this.Responder.prototype,this);this.addDefaultHandlers();this.ua=this.detectBrowser();this.ua.lineDash="function"===
typeof this.getContext().setLineDash;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;this.ua.requestAnimationFrame="function"===typeof window.requestAnimationFrame;this.keyboard.init();this.colors.cssNames=[];for(a=0;a<this.colors.displayNames.length;a++)this.colors.cssNames.push(this.colors.displayNames[a].replace(" ","").replace(" ","").toLowerCase());this.initialized=
!0},detectBrowser:function(){var a=[{src:navigator.platform,str:"Win",id:"Windows"},{src:navigator.platform,str:"Mac",id:"Mac"},{src:navigator.userAgent,str:"iPhone",id:"iPhone/iPod"},{src:navigator.platform,str:"Linux",id:"Linux"}],b,c=function(a){for(var c=0;c<a.length;c++){var d=a[c].src;b=a[c].ver||a[c].id;if(d){if(-1!==d.indexOf(a[c].str))return a[c].id}else if(a[c].prop)return a[c].id}},d=function(a){var c=a.indexOf(b);if(-1!==c)return parseFloat(a.substring(c+b.length+1))};return{browser:c([{src:navigator.userAgent,
str:"Chrome",id:"Chrome"},{src:navigator.userAgent,str:"OmniWeb",ver:"OmniWeb/",id:"OmniWeb"},{src:navigator.vendor,str:"Apple",id:"Safari",ver:"Version"},{prop:window.opera,id:"Opera",ver:"Version"},{src:navigator.vendor,str:"iCab",id:"iCab"},{src:navigator.vendor,str:"KDE",id:"Konqueror"},{src:navigator.userAgent,str:"Firefox",id:"Firefox"},{src:navigator.vendor,str:"Camino",id:"Camino"},{src:navigator.userAgent,str:"Netscape",id:"Netscape"},{src:navigator.userAgent,str:"MSIE",id:"Explorer",ver:"MSIE"},
{src:navigator.userAgent,str:"Gecko",id:"Mozilla",ver:"rv"},{src:navigator.userAgent,str:"Mozilla",id:"Netscape",ver:"Mozilla"}])||null,version:d(navigator.userAgent)||d(navigator.appVersion)||null,OS:c(a)||null}},start:function(){this.running||(null===this.isHandler&&(this.isHandler={frame:!1,step:!1}),this.running=!0,this.useReqAnimFrame&&this.ua.requestAnimationFrame?this.frameIntervalRunning||(this.lastFrameTime=Date.now(),this.lastStepTime=Date.now(),this.frameIntervalRunning=!0,this.frame()):
this.frameInterval=setInterval(jayus.frame,1E3/this.framerate),this.stepInterval=setInterval(jayus.step,1E3/this.steprate))},stop:function(){this.running&&(this.running=!1,clearInterval(this.frameInterval),clearInterval(this.stepInterval),this.stepInterval=this.frameInterval=null)},step:function(){if(jayus.running){var a,b,c=Date.now(),d=(c-jayus.lastStepTime)/1E3;jayus.lastStepTime=c;if(!jayus.isHandler.step||!jayus.fire("step",d)){for(a=0;a<jayus.displays.length;a++)b=jayus.displays[a],b.hasPendingMousemoveEvent&&
(b.processPendingMousemove(),b.hasPendingMousemoveEvent=!1);for(a=0;a<jayus.animators.length;a++)jayus.animators[a].tick(c,d);jayus.box2d.enabled&&jayus.box2d.step(d)}}},frame:function(){if(jayus.running){jayus.useReqAnimFrame&&jayus.ua.requestAnimationFrame&&window.requestAnimationFrame(jayus.frame);var a,b;a=Date.now();b=a-jayus.lastFrameTime;jayus.fps=1E3/b;jayus.lastFrameTime=a;if(!jayus.isHandler.frame||!jayus.fire("frame",b/1E3))for(a=0;a<jayus.displays.length;a++)b=jayus.displays[a],b.dirtied&&
b.refreshBuffer()}else jayus.frameIntervalRunning=!1},addDefaultHandlers:function(){},manuallyDrawImage:function(a,b,c,d){if("boolean"===typeof b.imageSmoothingEnabled)c=b.imageSmoothingEnabled,b.imageSmoothingEnabled=!1,b.drawImage(a.canvas,0,0),b.imageSmoothingEnabled=c;else{a=a.getImageData(0,0,c,d).data;var e,f;for(e=d-1;0<=e;e--)for(d=c-1;0<=d;d--)f=4*(d+c*e),b.fillStyle="rgba("+a[f]+","+a[f+1]+","+a[f+2]+","+a[f+3]/255+")",b.fillRect(d,e,1,1)}},cacheFont:function(a){var b,c,d;if(!this.isFontCached(a)){d=
[];c=this.getContext();c.save();c.font=a;for(b=0;b<this.fontCacheMaxChar+1;b++)d[b]=c.measureText(String.fromCharCode(b)).width;c.restore();b=this.getVerticalFontMetrics(a);b.charWidths=d;this.fontCache[a]=b}},cacheFonts:function(a){for(var b=0;b<a.length;b++)this.cacheFont(a[b])},isFontCached:function(a){return"object"===typeof this.fontCache[a]},getFontDescriptor:function(a){this.isFontCached(a)||this.cacheFont(a);return this.fontCache[a]},getTextMetrics:function(a,b){"object"!==typeof this.fontCache[b]&&
this.cacheFont(b);var c=jayus.fontCache[b],d=c.charWidths,e,f=0;for(e=a.length-1;0<=e;e--)f+=d[a.charCodeAt(e)];return{width:f,ascent:c.ascent,descent:c.descent,height:c.height}},getTextWidth:function(a,b){"object"!==typeof this.fontCache[b]&&this.cacheFont(b);var c=jayus.fontCache[b].charWidths,d,e=0;for(d=a.length-1;0<=d;d--)e+=c[a.charCodeAt(d)];return e},getVerticalFontMetrics:function(a){var b={},c=document.createElement("span"),d=document.createElement("div"),e=document.createElement("div");
c.style.font=a;c.innerText="Hg";d.style.display="inline-block";d.style.width="1px";d.style.height="0";e.appendChild(c);e.appendChild(d);document.body.appendChild(e);try{d.style.verticalAlign="baseline",b.ascent=d.offsetTop-c.offsetTop,d.style.verticalAlign="bottom",b.height=d.offsetTop-c.offsetTop,b.descent=b.height-b.ascent}finally{document.body.removeChild(e)}return b},box2d:{enabled:!0,scale:0.5,worlds:[],velocityIterations:10,positionIterations:10,physicalEntities:[],addWorld:function(a){this.worlds.push(a)},
removeWorld:function(a){this.worlds.splice(this.worlds.indexOf(this.world),1)},step:function(a){var b,c;for(b=0;b<this.worlds.length;b++)c=this.worlds[b],c.Step(a,this.velocityIterations,this.positionIterations),c.ClearForces();for(b=0;b<this.physicalEntities.length;b++)this.physicalEntities[b].updateFromBody()},drawDebug:function(){for(var a=0;a<this.worlds.length;a++)this.worlds[a].DrawDebugData()}},getContext:function(){return this.displays.length?this.displays[0].context:document.createElement("canvas").getContext("2d")},
intersectTest:function(a,b){var c;c=a.shapeType;for(var d=b.shapeType;!c;)a=a.getBounds(),c=a.shapeType;for(;!d;)b=b.getBounds(),d=b.shapeType;if(-1===c){for(c=0;c<a.items.length;c++)if(this.intersectTest(a[c],b))return!0;return!1}if(-1===d){for(c=0;c<b.items.length;c++)if(this.intersectTest(a,b[c]))return!0;return!1}c>d&&(c=a,a=b,b=c);switch(a.shapeType+b.shapeType){case 2:return a.x===b.x&&a.y===b.y;case 3:return b.intersectsAt(a.x,a.y);case 4:return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)<=(a.radius+
b.radius)*(a.radius+b.radius);case 5:return b.intersectsAt(a.x,a.y);case 6:return c=2*Math.abs(a.x-(b.x+b.width/2)),d=2*Math.abs(a.y-(b.y+b.height/2)),c>b.width+2*a.radius||d>b.height+2*a.radius?!1:c<=b.width||d<=b.height?!0:(c-b.width)*(c-b.width)+(d-b.height)*(d-b.height)<=4*a.radius*a.radius;case 8:return!(a.x+a.width<b.x||a.y+a.height<b.y||a.x>b.x+b.width||a.y>b.y+b.height);case 9:return b.intersectsAt(a.x,a.y);case 10:return this.intersectsPolygonPolygon(a.toPolygon(),b);case 12:return this.intersectPolygonPolygon(a.toPolygon(),
b);case 16:return this.intersectsPolygonPolygon(a,b);case 17:return b.intersectsAt(a.x,a.y);case 18:return this.intersectsPolygonPolygon(a.toPolygon(),b.toPolygon());case 20:return this.intersectsPolygonPolygon(a.toPolygon(),b.toPolygon());case 24:return this.intersectsPolygonPolygon(a,b.toPolygon());case 32:return this.intersectsPolygonPolygon(a.toPolygon(),b.toPolygon())}},intersectLineLine:function(a,b,c,d){var e=(d.x-c.x)*(a.y-c.y)-(d.y-c.y)*(a.x-c.x),f=(b.x-a.x)*(a.y-c.y)-(b.y-a.y)*(a.x-c.x);
a=(d.y-c.y)*(b.x-a.x)-(d.x-c.x)*(b.y-a.y);return 0!==a?(e/=a,f/=a,0<=e&&1>=e&&0<=f&&1>=f):0===e||0===f},intersectLinePolygon:function(a,b,c){for(var d=c.xPoints.length-1;0<=d;d--)if(this.intersectLineLine(a,b,c.xPoints[d],c.yPoints[d]))return!0;return!1},intersectPolygonPolygon:function(a,b){for(var c=a.xPoints.length-1;0<=c;c--)if(this.intersectLinePolygon(a.xPoints[c],a.yPoints[c],b))return!0;return!1},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},math:{randomFrom:function(a){return a[this.randomBetween(0,
a.length-1)]},randomBetween:function(a,b){return a+Math.floor((b-a+1)*Math.random())},clamp:function(a,b,c){return b<a?a:b>c?c:b},min:function(a){var b,c,d=a[0];for(b=a.length-1;1<=b;b--)c=a[b],c<d&&(d=c);return d},max:function(a){var b,c,d=a[0];for(b=a.length-1;1<=b;b--)c=a[b],c>d&&(d=c);return d},average:function(a){var b,c=0;for(b=a.length-1;1<=b;b--)c+=a[b];return c/a.length},toDegrees:function(a){return 180/Math.PI*a},toRadians:function(a){return Math.PI/180*a},vFlipAngle:function(a){return 2*
Math.PI-a},hFlipAngle:function(a){a=Math.PI-a;0>a&&(a+=2*Math.PI);return a},getCwAngleBetween:function(a,b){var c=a-b;0>c&&(c+=2*Math.PI);return c},getCcwAngleBetween:function(a,b){var c=b-a;0>c&&(c+=2*Math.PI);return c}},colors:{count:140,displayNames:"Alice Blue;Antique White;Aqua;Aquamarine;Azure;Beige;Bisque;Black;Blanched Almond;Blue;Blue Violet;Brown;Burly Wood;Cadet Blue;Chartreuse;Chocolate;Coral;Cornflower Blue;Cornsilk;Crimson;Cyan;Dark Blue;Dark Cyan;Dark Goldenrod;Dark Grey;Dark Green;Dark Khaki;Dark Magenta;Dark Olive Green;Dark Orange;Dark Orchid;Dark Red;Dark Salmon;Dark Sea Green;Dark Slate Blue;Dark Slate Grey;Dark Turquoise;Dark Violet;Deep Pink;Deep Sky Blue;Dim Grey;Dodger Blue;Firebrick;Floral White;Forest Green;Fuchsia;Gainsboro;Ghost White;Gold;Goldenrod;Grey;Green;Green Yellow;Honeydew;Hot Pink;Indian Red;Indigo;Ivory;Khaki;Lavender;Lavender Blush;Lawn Green;Lemon Chiffon;Light Blue;Light Coral;Light Cyan;Light Goldenrod;Light Green;Light Grey;Light Pink;Light Salmon;Light Sea Green;Light Sky Blue;Light Slate Grey;Light Steel Blue;Light Yellow;Lime;Lime Green;Linen;Magenta;Maroon;Medium Aquamarine;Medium Blue;Medium Orchid;Medium Purple;Medium Sea Green;Medium Slate Blue;Medium Spring Green;Medium Turquoise;Medium Violet Red;Midnight Blue;Mint Cream;Misty Rose;Moccasin;Navajo White;Navy;Old Lace;Olive;Olive Drab;Orange;Orange Red;Orchid;Pale Goldenrod;Pale Green;Pale Turquoise;Pale Violet Red;Papaya Whip;Peach Puff;Peru;Pink;Plum;Powder Blue;Purple;Red;Rosy Brown;Royal Blue;Saddle Brown;Salmon;Sandy Brown;Sea Green;Seashell;Sienna;Silver;Sky Blue;Slate Blue;Slate Grey;Snow;Spring Green;Steel Blue;Tan;Teal;Thistle;Tomato;Turquoise;Violet;Wheat;White;White Smoke;Yellow;Yellow Green".split(";"),
cssNames:null,redComponents:[240,250,0,127,240,245,255,0,255,0,138,165,222,95,127,210,255,100,255,220,0,0,0,184,169,0,189,139,85,255,153,139,233,143,72,47,0,148,255,0,105,30,178,255,34,255,220,248,255,218,127,0,173,240,255,205,75,255,240,230,255,124,255,173,240,224,250,144,211,255,255,32,135,119,176,255,0,50,250,255,127,102,0,186,147,60,123,0,72,199,25,245,255,255,255,0,253,128,107,255,255,218,238,152,175,219,255,255,205,255,221,176,127,255,188,65,139,250,244,46,255,160,192,135,106,112,255,0,70,210,
0,216,255,64,238,245,255,245,255,154],greenComponents:[248,235,255,255,255,245,228,0,235,0,43,42,184,158,255,105,127,149,248,20,255,0,139,134,169,100,183,0,107,140,50,0,150,188,61,79,206,0,20,191,105,144,34,250,139,0,220,248,215,165,127,127,255,255,105,92,0,255,230,230,240,252,250,216,128,255,250,238,211,182,160,178,206,136,196,255,255,205,240,0,0,205,0,85,112,179,104,250,209,21,25,255,228,228,222,0,245,128,142,165,69,112,232,251,238,112,239,218,133,192,160,224,127,0,143,105,69,128,164,139,245,82,
192,206,90,128,250,255,130,180,128,191,99,225,130,222,255,255,255,205],blueComponents:[255,215,255,212,255,220,196,0,205,255,226,42,135,160,0,30,80,237,220,60,255,139,139,11,169,0,107,139,47,0,204,0,122,143,139,79,209,211,147,255,105,255,34,240,34,255,220,255,0,32,127,127,47,240,180,92,130,240,140,250,245,0,205,230,128,255,210,144,211,193,122,170,250,153,222,224,0,50,230,255,127,170,205,211,219,113,238,154,204,133,112,250,225,181,173,128,230,0,35,0,0,214,170,152,238,147,213,185,63,203,221,230,0,0,
143,225,19,114,96,87,238,45,192,235,205,144,250,127,180,140,128,216,71,208,238,179,255,245,0,50]},DIRTY:{VISIBILITY:1,POSITION:2,SIZE:4,TRANSFORMS:8,CONTENT:16,STYLE:32,BACKGROUND:16,FRAME:6,SCOPE:14,ALL:127},SHAPES:{LIST:-1,CUSTOM:0,POINT:1,CIRCLE:2,RECTANGLE:4,POLYGON:8,PATH:16}}})();jayus.easing={linear:function(a){return a},easeInQuad:function(a){return a*a},easeOutQuad:function(a){return a*(2-a)},easeInOutQuad:function(a){return(1>(a/=0.5)?a*a:(1-a)*(a-3)+1)/2},easeInCubic:function(a){return a*a*a},easeOutCubic:function(a){return--a*a*a+1},easeInOutCubic:function(a){return 1>(a/=0.5)?a*a*a/2:(a-=2)*a*a/2+1},easeInQuart:function(a){return a*a*a*a},easeOutQuart:function(a){return--a*a*a*-a+1},easeInOutQuart:function(a){return 1>(a/=0.5)?a*a*a*a/2:1-(a-=2)*a*a*a/2},easeInQuint:function(a){return a*
a*a*a*a},easeOutQuint:function(a){return--a*a*a*a*a+1},easeInOutQuint:function(a){return 1>(a/=0.5)?a*a*a*a*a/2:(a-=2)*a*a*a*a/2+1},easeInSine:function(a){return 1-Math.cos(a*Math.PI/2)},easeOutSine:function(a){return Math.sin(a*Math.PI/2)},easeInOutSine:function(a){return 0.5-Math.cos(a*Math.PI)/2},easeInExpo:function(a){return(0<a)*Math.pow(2,10*a-10)},easeOutExpo:function(a){return 1-(1!==a)*Math.pow(2,-10*a)},easeInOutExpo:function(a){return a&&1!==a?1>(a/=0.5)?Math.pow(2,10*a-10)/2:1-Math.pow(2,
10-10*a)/2:a},easeInCirc:function(a){return 1-Math.sqrt(1-a*a)},easeOutCirc:function(a){return Math.sqrt(--a*-a+1)},easeInOutCirc:function(a){return 1>(a/=0.5)?-(Math.sqrt(1-a*a)-1)/2:(Math.sqrt(1-(a-=2)*a)+1)/2},easeInElastic:function(a){if(!a||1===a)return a;var b=0.3/(2*Math.PI)*Math.PI/2;return-Math.pow(2,10*--a)*Math.sin(2*(a-b)*Math.PI/0.3)},easeOutElastic:function(a){if(!a||1===a)return a;var b=0.3/(2*Math.PI)*Math.PI/2;return Math.pow(2,-10*a)*Math.sin(2*(a-b)*Math.PI/0.3)+1},easeInOutElastic:function(a){if(!a||
1===a)return a;var b=0.3*1.5,c=b/(2*Math.PI)*Math.PI/2;return 1>(a/=0.5)?-Math.pow(2,10*--a)*Math.sin(2*(a-c)*Math.PI/b)/2:Math.pow(2,-10*--a)*Math.sin(2*(a-c)*Math.PI/b)/2+1},easeInBack:function(a){return a*a*(2.70158*a-1.70158)},easeOutBack:function(a){return--a*a*(2.70158*a+1.70158)+1},easeInOutBack:function(a){var b=1.70158;return 1>(a/=0.5)?a*a*(((b*=1.525)+1)*a-b)/2:(a-=2)*a*(((b*=1.525)+1)*a+b)/2+1},easeInBounce:function(a){return 1-jayus.easing.easeOutBounce(1-a)},easeOutBounce:function(a){return a<
1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},easeInOutBounce:function(a){return 0.5>a?jayus.easing.easeInBounce(2*a)/2:jayus.easing.easeOutBounce(2*a-1)/2+0.5}};jayus.Responder=jayus.createClass({hasHandlers:!1,isHandler:null,handlers:null,handle:function(a){for(var b in a)a.hasOwnProperty(b)&&this.addHandler(b,a[b]);return this},addHandler:function(a,b,c){this.hasHandlers||(this.hasHandlers=!0,this.isHandler={frame:!1},this.handlers={});"object"!==typeof c&&(c={});c.handler=b;c.hasContext="object"===typeof c.context;c.enabled=!0;c.remove=!1;this.isHandler[a]?this.handlers[a].push(c):(this.handlers[a]=[c],this.isHandler[a]=!0);return this},removeHandler:function(a,
b){if(this.isHandler[a]){var c,d,e=this.handlers[a];if("object"===typeof b)e.splice(e.indexOf(b),1);else if(b instanceof Function)for(c=0;c<e.length;c++)d=e[c],d.handler===b&&e.splice(c,1);else for(c=0;c<e.length;c++)d=e[c],d.id===b&&e.splice(c,1);e.length||(delete this.handlers[a],this.isHandler[a]=!1)}return this},removeHandlers:function(a){this.isHandler[a]&&(delete this.handlers[a],this.isHandler[a]=!1);return this},removeAllHandlers:function(){this.hasHandlers=!1;this.handlers=this.isHandler=
null;"object"===typeof this.events&&null!==this.events&&this.handle(this.events);return this},fire:function(a,b){var c,d,e;if(this.hasHandlers&&this.isHandler[a])for(e=this.handlers[a].slice(0),c=0;c<e.length;c++)if(d=e[c],d.remove)this.removeHandler(a,d.handler);else if(d.enabled&&d.handler.call(d.hasContext?d.context:this,b,d))return!0;return!1}});jayus.Animator=jayus.Responder.extend({isAnimator:!0,running:!1,attachToJayus:!0,startTime:null,duration:1E3,easing:jayus.easing.linear,looped:!1,oscillate:!1,init:function(a){this.update=a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);"number"===typeof a.duration&&(this.duration=a.duration);"boolean"===typeof a.looped&&(this.looped=a.looped);"boolean"===typeof a.oscillate&&(this.oscillate=a.oscillate);"undefined"!==typeof a.easing&&this.setEasing(a.easing);"object"===
typeof a.target&&(this.target=a.target);return this.dirty(127)},start:function(){this.running||(this.startTime=Date.now(),this.running=!0,this.attachToJayus&&jayus.animators.push(this),this.fire("started"),this.update(0));return this},restart:function(){this.startTime=Date.now();this.running=!0;jayus.animators.push(this);this.fire("started");this.update(0);return this},stop:function(){if(this.running){this.running=!1;if(this.attachToJayus){var a=jayus.animators.indexOf(this);-1!==a&&jayus.animators.splice(a,
1)}this.fire("stopped")}return this},finish:function(){if(this.running){this.running=!1;if(this.attachToJayus){var a=jayus.animators.indexOf(this);-1!==a&&jayus.animators.splice(a,1)}this.update(1);this.fire("finished")}return this},setDuration:function(a){this.duration=a;return this},setEasing:function(a){"string"===typeof a&&(a=jayus.easing[a]);this.easing=a;return this},tick:function(a){a-this.startTime<this.duration?(a=this.easing((a-this.startTime)/this.duration),0>a&&(a=0),this.oscillate&&(a=
0.5>=a?2*a:1-2*(a-0.5)),this.update(a)):this.looped?this.startTime=Date.now():this.finish()},setLooped:function(a){this.looped=a;return this},setOscillate:function(a){this.oscillate=a;return this}});jayus.Animatable=jayus.createClass({actionsToAnimate:0,animate:function(){this.actionsToAnimate++;return this}});
jayus.MethodAnimator=jayus.Animator.extend({target:null,method:null,initialValue:null,finalValue:null,multipleParameters:!1,values:null,init:function(a,b,c,d){arguments.length&&(this.target=a,this.method=b,this.initialValue=c,this.finalValue=d,c instanceof Array&&(this.multipleParameters=!0,this.values=[]))},update:function(a){if(this.multipleParameters){for(var b=0;b<this.initialValue.length;b++)this.values[b]=this.initialValue[b]+a*(this.finalValue[b]-this.initialValue[b]);this.method.apply(this.target,
this.values)}else this.method.call(this.target,this.initialValue+a*(this.finalValue-this.initialValue))}});
jayus.MethodAnimatorBy=jayus.Animator.extend({target:null,getter:null,setter:null,from:null,by:null,init:function(a,b,c,d){arguments.length&&(this.target=a,this.getter=b,this.setter=c,this.by=d);var e=this;this.addHandler("started",function(){e.from="function"===typeof e.getter?e.getter.call(e.target):e.target[e.getter]})},initFromObject:function(a){jayus.Animator.prototype.initFromObject.call(this,a);"undefined"!==typeof a.target&&(this.target=a.target);"undefined"!==typeof a.getter&&(this.getter=
a.getter);"undefined"!==typeof a.setter&&(this.setter=a.setter);"number"===typeof a.by&&(this.by=a.by);return this.dirty(127)},update:function(a){if("function"===typeof this.setter)this.setter.call(this.target,this.from+a*this.by);else if("function"===typeof this.target[this.setter])this.target[this.setter](this.from+a*this.by);else this.target[this.setter]=this.from+a*this.by}});
jayus.MethodAnimatorFromTo=jayus.Animator.extend({target:null,setter:null,from:null,nullFrom:!1,to:null,init:function(a,b,c,d,e){arguments.length&&(this.target=a,this.getter=b,this.setter=c,this.from=d,this.to=e);if(this.nullFrom){var f=this;this.addHandler("started",function(){f.from=f.setter.call(f.target)})}this.nullFrom=null===this.from},initFromObject:function(a){jayus.Animator.prototype.initFromObject.call(this,a);"undefined"!==typeof a.target&&(this.target=a.target);"undefined"!==typeof a.getter&&
(this.getter=a.getter);"undefined"!==typeof a.setter&&(this.setter=a.setter);"number"===typeof a.from&&(this.from=a.from);"number"===typeof a.to&&(this.to=a.to);return this.dirty(127)},update:function(a){if("function"===typeof this.setter)this.setter.call(this.target,this.from+a*(this.to-this.from));else if("function"===typeof this.target[this.setter])this.target[this.setter](this.from+a*(this.to-this.from));else this.target[this.setter]=this.from+a*(this.to-this.from)}});
jayus.Animator.Discrete=jayus.Animator.extend({count:null,updater:null,init:function(a,b){this.count=a;this.updater=b},update:function(a){a=Math.floor(a*this.count);a===this.count&&a--;this.updater(a)}});
jayus.AnimatorSequence=jayus.Animator.extend({animators:null,currentIndex:null,init:function(){this.animators=new jayus.List(this)},initFromObject:function(a){jayus.Animator.prototype.initFromObject.call(this,a);if("object"===typeof a.animators){this.animators=new jayus.List(this);for(var b=0;b<a.animators.length;b++)this.animators.add(jayus.parse(a.animators[b]))}return this.dirty(127)},listItemAdded:function(a,b){b.attachToJayus=!1},listItemsAdded:function(a,b){for(var c=0;c<b.length;c++)b[c].attachToJayus=
!1},listItemRemoved:function(a,b){b.attachToJayus=!0},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].attachToJayus=!0},update:function(a){var b=this.animators.items,c=b.length,d=Math.floor(a*c);d===c&&d--;this.currentIndex!==d&&(null!==this.currentIndex&&b[this.currentIndex].finish(),b[d].start(),this.currentIndex=d);b[d].update(a*c-d)}});jayus.Dependency=jayus.Animatable.extend({id:"",dependents:null,dependentCount:0,frozen:0,setId:function(a){this.id=a;jayus.keepTrackOfObjects&&-1===jayus.identifiedObjects.indexOf(this)&&jayus.identifiedObjects.push(this);return this},initFromObject:function(a){"undefined"!==typeof a.id&&this.setId(a.id);return this},attach:function(a){this.dependentCount||(this.dependents=[]);this.dependents.push(a);this.dependentCount++},detach:function(a){this.dependentCount&&(a=this.dependents.indexOf(a),-1!==
a&&(this.dependents.splice(a,1),this.dependentCount--))},clearDependents:function(){this.dependents=null;this.dependentCount=0},dirty:function(a){this.frozen||this.informDependents(a);return this},informDependents:function(a){for(var b=0;b<this.dependentCount;b++)this.dependents[b].componentDirtied(this,a)},forEachDependent:function(a,b){for(var c=0;c<this.dependentCount;c++)a.apply(this.dependents[c],b)}});jayus.List=jayus.createClass({shapeType:-1,parent:null,items:null,init:function(a){1===arguments.length&&(this.parent=a);this.items=[]},added:function(a){this.parent.listItemAdded(this,a)},addedMany:function(a){this.parent.listItemsAdded(this,a)},removed:function(a){this.parent.listItemRemoved(this,a)},removedMany:function(a){this.parent.listItemsRemoved(this,a)},indexOf:function(a){var b;if("string"===typeof a){for(b=this.items.length-1;0<=b;b--)if(this.items[b].id===a)return b;return-1}return this.items.indexOf(a)},
has:function(a){return 0<=this.items.indexOf(a)},count:function(){return this.items.length},at:function(a){return 0<=a&&a<this.items.length?this.items[a]:null},get:function(a){var b,c;for(b=this.items.length-1;0<=b;b--)if(c=this.items[b],c.id===a)return c;return null},find:function(a){var b,c;for(b=this.items.length-1;0<=b;b--)if(c=this.items[b],c.id===a||c.isParent&&(c=c.find(a),null!==c))return c},add:function(a){var b;if(1===arguments.length)b=a,"number"!==typeof b.frozen&&jayus.parse(b),this.items.push(a),
this.added(a);else{for(var c=Array.prototype.slice.call(arguments),d=0;d<c.length;d++)b=c[d],"number"!==typeof b.frozen&&(b=jayus.parse(b),c[d]=b),this.items.push(b);this.addedMany(c)}return this},append:function(a){for(var b=0;b<a.length;b++)this.items.push(a[b]);this.addedMany(a);return this},insert:function(a,b){this.items.splice(b,0,a);this.added(a);return this},insertBefore:function(a,b){var c=this.items.indexOf(b);0<c&&(this.items.splice(c-1,0,a),this.added(a));return this},insertAfter:function(a,
b){var c=this.items.indexOf(b);-1!==c&&(this.items.splice(c,0,a),this.added(a));return this},remove:function(a){var b,c;if(1===arguments.length)c=this.items.indexOf(a),0<=c&&(this.items.splice(c,1),this.removed(a));else{for(b=0;b<arguments.length;b++)c=this.items.indexOf(arguments[b]),0<=c&&this.items.splice(c,1);this.removedMany(arguments)}return this},removeAt:function(a){if(0<=a&&a<this.items.length){var b=this.items[a];this.items.splice(a,1);this.removed(b)}return this},replace:function(a,b){return this.replaceAt(this.indexOf(a),
b)},update:function(a,b){var c=this.indexOf(a);-1===c?this.add(b):this.replaceAt(c,b);return this},replaceAt:function(a,b){0<=a&&(this.removed(this.items[a]),this.items[a]=b,this.added(b));return this},purge:function(){var a=this.items;this.removedMany(a);this.items=[];this.parent.items===a&&(this.parent.items=this.items);return this},onEach:function(a,b){for(var c=0;c<this.items.length;c++)this.items[c][a].apply(this.items[c],b);return this},forEach:function(a,b){var c,d;for(c=0;c<this.items.length;c++)if(d=
a.apply(this.items[c],b),void 0!==d)return d;return null},forEvery:function(a,b){var c,d;for(c=0;c<this.items.length;c++)if(d=a.apply(this.items[c],b),void 0!==d)return d;return null},sort:function(a){this.items.sort(a);this.parent.listItemsMoved();return this}});jayus.Color=jayus.Dependency.extend({r:0,g:0,b:0,a:1,init:function(){arguments.length&&this.set.apply(this,arguments)},toObject:function(){var a={type:"Color",r:this.r,g:this.g,b:this.b,a:this.a};""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){this.r=a.r;this.g=a.g;this.b=a.b;this.a=a.a;return this.dirty(127)},set:function(a,b,c,d){switch(arguments.length){case 1:return this.set(a,1);case 2:var e=jayus.colors.displayNames.indexOf(a);0>e&&(e=jayus.colors.cssNames.indexOf(a));e+1&&
this.set(jayus.colors.redComponents[e],jayus.colors.greenComponents[e],jayus.colors.blueComponents[e],b);return this;case 3:return this.set(a,b,c,1);case 4:if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.set,[this.r,this.g,this.b,this.a],[a,b,c,d]);this.r=a;this.g=b;this.b=c;this.a=d;return this}},setRed:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setRed,this.r,a);this.r!==a&&(this.r=a,this.dirty(32));
return this},setGreen:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setGreen,this.g,a);this.g!==a&&(this.g=a,this.dirty(32));return this},setBlue:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setBlue,this.b,a);this.b!==a&&(this.b=a,this.dirty(32));return this},setAlpha:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setAlpha,this.a,
a);this.a!==a&&(this.a=a,this.dirty(32));return this},toHex:function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);return"#"+(1===a.length?"0"+a:a)+(1===b.length?"0"+b:b)+(1===c.length?"0"+c:c)},toCSS:function(){this.a=jayus.math.clamp(0,this.a,1);return this.a-1?"rgba("+this.r+","+this.g+","+this.b+","+this.a+")":"rgb("+this.r+","+this.g+","+this.b+")"},getName:function(){var a,b=jayus.colors;for(a=b.count-1;0<=a;a--)if(this.r===b.redComponents[a]&&this.g===b.greenComponents[a]&&
this.b===b.blueComponents[a])return b.displayNames[a];return""}});jayus.Brush=jayus.Dependency.extend({filling:!1,stroking:!1,fillType:0,strokeType:0,shadowType:0,alpha:1,strokeFirst:!1,fill:null,stroke:null,lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,lineDash:null,lineDashOffset:null,shadow:null,shadowOffsetX:null,shadowOffsetY:null,shadowBlur:null,properties:{names:"alpha strokeFirst fill stroke lineWidth lineCap lineJoin miterLimit lineDash lineDashOffset shadow shadowOffsetY shadowOffsetY shadowBlur".split(" "),objects:["fill","stroke","shadow"]},
init:function(a){arguments.length&&this.apply(a)},componentDirtied:function(a,b){this.dirty(32)},toObject:function(){var a={type:"Brush"},b,c,d,e;for(b=0;b<jayus.Brush.prototype.properties.names.length;b++)c=jayus.Brush.prototype.properties.names[b],d=a[c],e=typeof d,d!==jayus.Brush.prototype[c]&&("object"===e&&(d=d.toObject()),a[c]=d);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.ignoreDirty++;var b,c,d,e;for(b=0;b<jayus.Brush.prototype.properties.names.length;b++)c=
jayus.Brush.prototype.properties.names[b],d=a[c],e=typeof d,"undefined"!==e&&("object"===e&&(d=jayus.parse(d)),"fill"===c?this.setFill(d):"stroke"===c?this.setStroke(d):"shadow"===c?this.setShadow(d):this[c]=d);this.ignoreDirty--;this.dirty(127)},apply:function(a){this.ignoreDirty++;for(var b in a)if(a.hasOwnProperty(b))this["set"+b[0].toUpperCase()+b.slice(1)](a[b]);this.ignoreDirty--;return this.dirty(32)},findStyleType:function(a){if(null===a)return 0;if("string"===typeof a)return 1;if(a instanceof
CanvasGradient)return 2;if(a instanceof CanvasPattern)return 3;if(a instanceof jayus.Color)return 4;if(a instanceof jayus.LinearGradient)return 5;if(a instanceof jayus.RadialGradient)return 6},getNativeStyle:function(a,b){if(3>=a)return b;if(4===a)return b.toCSS();if(5===a||6===a)return b.getNative()},applyTo:function(a){1!==this.alpha&&(a.globalAlpha*=this.alpha);this.filling&&(a.fillStyle=this.getNativeStyle(this.fillType,this.fill));this.stroking&&(a.strokeStyle=this.getNativeStyle(this.strokeType,
this.stroke),null!==this.lineWidth&&(a.lineWidth=this.lineWidth),null!==this.lineCap&&(a.lineCap=this.lineCap),null!==this.lineJoin&&(a.lineJoin=this.lineJoin),null!==this.miterLimit&&(a.miterLimit=this.miterLimit),null!==this.lineDash&&jayus.ua.lineDash&&(a.setLineDash(this.lineDash),null!==this.lineDashOffset&&(a.lineDashOffset=this.lineDashOffset)));this.shadowType&&(1===this.shadowType?a.shadowColor=this.shadow:2===this.shadowType&&(a.shadowColor=this.shadow.toCSS()),null!==this.shadowOffsetX&&
(a.shadowOffsetX=this.shadowOffsetX),null!==this.shadowOffsetY&&(a.shadowOffsetY=this.shadowOffsetY),null!==this.shadowBlur&&(a.shadowBlur=this.shadowBlur))},paintShape:function(a){this.applyTo(a);this.stroking&&this.strokeFirst&&a.stroke();this.filling&&a.fill();this.stroking&&!this.strokeFirst&&a.stroke()},paintRect:function(a,b,c,d,e){a.save();this.applyTo(a);this.stroking&&this.strokeFirst&&a.strokeRect(b,c,d,e);this.filling&&a.fillRect(b,c,d,e);this.stroking&&!this.strokeFirst&&a.strokeRect(b,
c,d,e);a.restore()},setAlpha:function(a){null===a&&(a=1);this.alpha!==a&&(this.alpha=a,this.dirty(32));return this},setFill:function(a){4<=this.fillType&&this.fill.detach(this);"object"===typeof a&&null!==a&&"string"===typeof a.type&&(a=jayus.parse(a));this.fill=a;this.fillType=this.findStyleType(a);4<=this.fillType&&this.fill.attach(this);this.filling=!!this.fillType;return this.dirty(32)},setStroke:function(a){4<=this.strokeType&&this.stroke.detach(this);"object"===typeof a&&null!==a&&"string"===
typeof a.type&&(a=jayus.parse(a));this.stroke=a;this.strokeType=this.findStyleType(a);4<=this.strokeType&&this.stroke.attach(this);this.stroking=!!this.strokeType;return this.dirty(32)},setLineWidth:function(a){this.lineWidth!==a&&(this.lineWidth=a,this.dirty(32));return this},setLineCap:function(a){this.lineCap!==a&&(this.lineCap=a,this.dirty(32));return this},setLineJoin:function(a){this.lineJoin!==a&&(this.lineJoin=a,this.dirty(32));return this},setMiterLimit:function(a){this.miterLimit!==a&&(this.miterLimit=
a,this.dirty(32));return this},setLineDash:function(a){this.lineDash=a;this.dirty(32);return this},setLineDashOffset:function(a){this.lineDashOffset!==a&&(this.lineDashOffset=a,this.dirty(32));return this},setShadow:function(a){2===this.shadowType&&this.shadow.detach(this);this.shadow=a;null===a?this.shadowType=0:"string"===typeof a?this.shadowType=1:a instanceof jayus.Color&&(this.shadowType=2,this.shadow.attach(this));this.dirty(32);return this},setShadowOffsetX:function(a){this.shadowOffsetX!==
a&&(this.shadowOffsetX=a,this.dirty(32));return this},setShadowOffsetY:function(a){this.shadowOffsetY!==a&&(this.shadowOffsetY=a,this.dirty(32));return this},setShadowBlur:function(a){this.shadowBlur!==a&&(this.shadowBlur=a,this.dirty(32));return this}});jayus.Gradient=jayus.Dependency.extend({stopPositions:null,stopColors:null,nativeGradient:null,reformNative:!0,toObject:function(){var a={type:"Gradient"};null!==this.stopPositions&&(a.stopPositions=this.stopPositions);null!==this.stopColors&&(a.stopColors=this.stopColors.toObject());""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){"object"===typeof a.stopPositions&&(this.stopPositions=a.stopPositions);"object"===typeof a.stopColors&&(this.stopColors=a.stopColors);this.reformNative=
!0;return this.dirty(127)},componentDirtied:function(a,b){this.reformNative=!0;this.dirty(32)},translate:function(a,b){if(1===arguments.length)return this.translate(a.x,a.y);this.start.translate(a,b);this.end.translate(a,b);this.dirty(127);return this},addColorStop:function(a,b){this.stopPositions.push(a);this.stopColors.push(b);return this},getNative:function(){this.reformNative&&(this.refresh(),this.reformNative=!1);return this.nativeGradient}});
jayus.LinearGradient=jayus.Gradient.extend({start:null,end:null,init:function(a,b,c,d){2===arguments.length?(this.stopPositions=[],this.stopColors=[],this.start=a,this.start.attach(this),this.end=b,this.end.attach(this)):4===arguments.length&&this.init(new jayus.Point(a,b),new jayus.Point(c,d))},toObject:function(){var a=jayus.Gradient.prototype.toObject.apply(this);a.type="LinearGradient";null!==this.start&&(a.start=this.start.toObject());null!==this.end&&(a.end=this.end.toObject());return a},initFromObject:function(a){jayus.Gradient.prototype.initFromObject.call(this,
a);"object"===typeof a.start&&(this.start=(new jayus.Point).initFromObject(a.start));"object"===typeof a.end&&(this.end=(new jayus.Point).initFromObject(a.end));return this.dirty(127)},refresh:function(){var a,b;this.nativeGradient=jayus.getContext().createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y);for(a=this.stopPositions.length-1;0<=a;a--)b=this.stopColors[a],b instanceof jayus.Color&&(b=b.toCSS()),this.nativeGradient.addColorStop(this.stopPositions[a],b);return this}});
jayus.RadialGradient=jayus.Gradient.extend({start:null,end:null,init:function(a,b,c,d,e,f){this.stopPositions=[];this.stopColors=[];var g,h;2===arguments.length?(g=a,h=b):4===arguments.length?(g=new jayus.Circle(a,b),h=new jayus.Circle(c,d)):(g=new jayus.Circle(a,b,c),h=new jayus.Circle(d,e,f));g.attach(this);this.start=g;h.attach(this);this.end=h},toObject:function(){var a=jayus.Gradient.prototype.toObject.apply(this);a.type="RadialGradient";this.start!==jayus.RadialGradient.prototype.start&&(a.start=
this.start.toObject());this.end!==jayus.RadialGradient.prototype.end&&(a.end=this.end.toObject());return a},initFromObject:function(a){jayus.Gradient.prototype.initFromObject.call(this,a);"object"===typeof a.start&&(this.start=new jayus.Circle(a.start));"object"===typeof a.end&&(this.end=new jayus.Circle(a.end));return this.dirty(127)},refresh:function(){var a,b;this.nativeGradient=jayus.getContext().createRadialGradient(this.start.x,this.start.y,this.start.radius,this.end.x,this.end.y,this.end.radius);
for(a=this.stopPositions.length-1;0<=a;a--)b=this.stopColors[a],b instanceof jayus.Color&&(b=b.toCSS()),this.nativeGradient.addColorStop(this.stopPositions[a],b);return this}});jayus.Matrix=jayus.createClass({a:1,b:0,tx:0,c:0,d:1,ty:0,init:function(a,b,c,d,e,f){arguments.length&&(this.a=a,this.b=b,this.tx=c,this.c=d,this.d=e,this.ty=f)},toObject:function(){var a={type:"Matrix",a:this.a,b:this.b,tx:this.tx,c:this.c,d:this.d,ty:this.ty};""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.a=a.a;this.b=a.b;this.tx=a.tx;this.c=a.c;this.d=a.d;this.ty=a.ty;this.dirty(127)},translate:function(a,b){if(1===
arguments.length)return this.translate(a.x,a.y);this.tx+=this.a*a+this.b*b;this.ty+=this.d*b+this.c*a;return this},scale:function(a,b){if(1===arguments.length)return this.scale(a.x,a.y);this.a*=a;this.c*=a;this.d*=b;this.b*=b;return this},rotate:function(a){var b=Math.sin(a);a=Math.cos(a);var c=this.a*a+this.b*b;this.b=-this.a*b+this.b*a;this.a=c;c=this.d*b+this.c*a;this.d=this.d*a-this.c*b;this.c=c;return this},multiply:function(a){return new jayus.Matrix(a.a*this.a+a.b*this.c,a.a*this.b+a.b*this.d,
a.a*this.tx+a.b*this.ty+a.tx,a.c*this.a+a.d*this.c,a.c*this.b+a.d*this.d,a.c*this.tx+a.d*this.ty+a.ty)},transformPoint:function(a,b){return 1===arguments.length?this.transformPoint(a.x,a.y):this.transformPointOnto(a,b,new jayus.Point)},transformPointOnto:function(a,b,c){c.x=a*this.a+b*this.b+this.tx;c.y=a*this.c+b*this.d+this.ty;return c},inverseTransformPoint:function(a,b){return 1===arguments.length?this.inverseTransformPoint(a.x,a.y):this.inverseTransformPointOnto(a,b,new jayus.Point)},inverseTransformPointOnto:function(a,
b,c){var d=this.getDeterminant();return d?(a-=this.tx,b-=this.ty,c.x=(a*this.d-b*this.b)/d,c.y=(b*this.a-a*this.c)/d,c):null},identity:function(){this.a=this.d=1;this.b=this.tx=this.c=this.ty=0;return this},getDeterminant:function(){var a=this.a*this.d-this.b*this.c;return isFinite(a)&&1E-11<Math.abs(a)&&isFinite(this.tx)&&isFinite(this.ty)?a:null},clone:function(){return this.cloneOnto(new jayus.Matrix)},cloneOnto:function(a){a.init(this.a,this.b,this.tx,this.c,this.d,this.ty);return a},equals:function(a){return this.a===
a.a&&this.b===a.b&&this.c===a.c&&this.d===a.d&&this.tx===a.tx&&this.ty===a.ty},applyToContext:function(a){a.transform(this.a,this.c,this.b,this.d,this.tx,this.ty)}});jayus.SizePolicy=jayus.createClass({size:0,weight:1,expand:!0,flexible:!0,init:function(){},toObject:function(){var a={type:"SizePolicy"};0!==this.size&&(a.size=this.size);1!==this.weight&&(a.weight=this.weight);!0!==this.expand&&(a.expand=this.expand);this.flexible!==jayus.SizePolicy.prototype.flexible&&(a.flexible=this.flexible);return a},initFromObject:function(a){"number"===typeof a.size&&(this.size=a.size);"number"===typeof a.weight&&(this.weight=a.weight);"boolean"===typeof a.expand&&(this.expand=
a.expand);"boolean"===typeof a.flexible&&(this.flexible=a.flexible);return this}});jayus.images={images:{},pendingImageCount:0,isLoaded:function(a){if("object"===typeof a){for(var b=0;b<a.length;b++)if(!this.isLoaded(a[b]))return!1;return!0}return"object"===typeof this.images[a]&&(this.images[a].loaded||"CANVAS"===this.images[a].tagName)},get:function(a){if("object"===typeof a){for(var b=[],c=0;c<a.length;c++)b[c]=this.get(a[c]);return b}this.isLoaded(a);return this.images[a]},setSubimage:function(a,b,c,d,e,f){var g=this.get(a),h=document.createElement("canvas");h.width=e;h.height=
f;h.getContext("2d").drawImage(g,c,d,e,f,0,0,e,f);this.images[b]=h;jayus.fire("imageLoaded",{filepath:a,image:h});return this},whenLoaded:function(a,b){"object"===typeof a?this.isLoaded(a)?b():(jayus.addHandler("imageLoaded",function(c,d){jayus.images.isLoaded(a)&&(b(),d.remove=!0)}),this.load(a)):this.isLoaded(a)?b({filepath:a,image:this.get(a)}):(jayus.addHandler("imageLoaded",function(c,d){c.filepath===a&&(b(c),d.remove=!0)}),this.load(a));return this},load:function(a){if("object"===typeof a)for(var b=
0;b<a.length;b++)this.load(a[b]);else"object"!==typeof this.images[a]&&(b=new Image,b.isSheet=!1,b.loaded=!1,this.images[a]=b,b.onload=function(){this.loaded=!0;jayus.fire("imageLoaded",{filepath:a,image:this});jayus.images.pendingImageCount--;jayus.images.pendingImageCount||jayus.fire("imagesLoaded")},this.pendingImageCount++,b.src=a)}};jayus.objects={objects:{},pendingObjectCount:0,isLoaded:function(a){if("object"===typeof a){for(var b=0;b<a.length;b++)if(!this.isLoaded(a[b]))return!1;return!0}return"object"===typeof this.objects[a]&&null!==this.objects[a]},get:function(a){if("object"===typeof a){for(var b=[],c=0;c<a.length;c++)b[c]=this.get(a[c]);return b}this.isLoaded(a);return this.objects[a]},whenLoaded:function(a,b){"object"===typeof a?this.isLoaded(a)?b():(jayus.addHandler("objectLoaded",function(c,d){jayus.objects.isLoaded(a)&&
(b(),d.remove=!0)}),this.load(a)):this.isLoaded(a)?b({filepath:a,object:this.get(a)}):(jayus.addHandler("objectLoaded",function(c,d){c.filepath===a&&(b(c,d),d.remove=!0)}),this.load(a));return this},load:function(a){if("object"===typeof a)for(var b=0;b<a.length;b++)this.load(a[b]);else"object"!==typeof this.objects[a]&&(b=new XMLHttpRequest,b.filepath=a,b.open("get",a,!0),b.onload=function(){var a=JSON.parse(this.responseText);jayus.objects.objects[this.filepath]=a;jayus.fire("objectLoaded",{filepath:this.filepath,
object:a,xhr:this});jayus.objects.pendingObjectCount--;jayus.objects.pendingObjectCount||jayus.fire("objectsLoaded")},this.objects[a]=null,this.pendingObjectCount++,b.send())}};jayus.keyboard={requireFocus:!0,pressed:{},keys:[0,0,0,0,0,0,0,0,"backspace","tab",0,0,0,"enter",0,0,"shift","ctrl","alt","break","capsLock",0,0,0,0,0,0,"escape",0,0,0,0,"space","pageUp","pageDown","end","home","left","up","right","down",0,0,0,0,"insert","delete",0,"0","1","2","3","4","5","6","7","8","9",0,0,0,0,0,0,0,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","leftWin","rightWin","select",0,0,"num0","num1","num2","num3","num4","num5","num6",
"num7","num8","num9","numMultiply","numAdd",0,"numSubtract","numPeriod","numDivide","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"numLock","scrollLock",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"semicolon","equalSign","comma","dash","period","forwardSlash","grave",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"leftBracket","backslash","rightBracket","quote"],init:function(){document.addEventListener("keydown",
function(a){if(jayus.keyboard.requireFocus&&jayus.hasFocus){var b=jayus.keyboard.keys[a.keyCode],c={event:a,key:b};if(jayus.keyboard.pressed[b])return!jayus.fire("keyTap",c);jayus.keyboard.pressed[b]=!0;if(jayus.fire("keyPress",c)||jayus.fire("keyTap",c))return a.preventDefault(),!1}});document.addEventListener("keyup",function(a){var b=jayus.keyboard.keys[a.keyCode];if(jayus.keyboard.pressed[b]&&(jayus.keyboard.pressed[b]=!1,jayus.fire("keyRelease",{event:a,key:b})))return a.preventDefault(),!1});
document.addEventListener("keypress",function(a){if(jayus.keyboard.requireFocus&&jayus.hasFocus&&jayus.fire("charType",{event:a,"char":String.fromCharCode(a.charCode)}))return a.preventDefault(),!1})},isPressed:function(a){return!!this.pressed[a]},isKey:function(a){return 0<=this.keys.indexOf(a)}};jayus.Point=jayus.Dependency.extend({x:0,y:0,init:function(a,b){arguments.length&&(this.x=a,this.y=b)},toObject:function(){var a={type:"Point",x:this.x,y:this.y};""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.x=a.x;this.y=a.y;return this.dirty(127)},setX:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setX,this.x,a);this.x!==a&&(this.x=a,this.dirty(2));return this},
setY:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setY,this.y,a);this.y!==a&&(this.y=a,this.dirty(2));return this},set:function(a,b){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.set,[this.x,this.y],[a,b]);if(this.x!==a||this.y!==b)this.x=a,this.y=b,this.dirty(2);return this},translate:function(a,b){return 1===arguments.length?this.set(this.x+a.x,this.y+b.y):this.set(this.x+a,this.y+b)},clone:function(){return new jayus.Point(this.x,
this.y)},cloneOnto:function(a){a.x=this.x;a.y=this.y;return a},equals:function(a,b){return 1===arguments.length?this.equals(a.x,a.y):this.x===a&&this.y===b}});jayus.Rectangle=jayus.Dependency.extend({shapeType:4,x:0,y:0,width:0,height:0,roundX:!1,roundY:!1,init:function(a,b,c,d){arguments.length&&(3===arguments.length?(this.height=c,this.width=d,this.y=a.y,this.x=a.x):(this.x=a,this.y=b,this.width=c,this.height=d))},toObject:function(){var a={type:"Rectangle",x:this.x,y:this.y,width:this.width,height:this.height};this.roundX!==jayus.Rectangle.prototype.roundX&&(a.roundX=this.roundX);this.roundY!==jayus.Rectangle.prototype.roundY&&(a.roundY=this.roundY);
""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.x=a.x;this.y=a.y;this.width=a.width;this.height=a.height;"number"===typeof a.roundX&&(this.roundX=a.roundX);"number"===typeof a.roundY&&(this.roundY=a.roundY);return this.dirty(127)},getOrigin:function(){return new jayus.Point(this.x,this.y)},getOriginOnto:function(a){a.x=this.x;a.y=this.y;return a},setX:jayus.Point.prototype.setX,setY:jayus.Point.prototype.setY,setOrigin:function(a,
b){if(1===arguments.length)return this.setOrigin(a.x,a.y);if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setOrigin,[this.x,this.y],[a,b]);if(this.x!==a||this.y!==b)this.x=a,this.y=b,this.dirty(2);return this},translate:function(a,b){return 1===arguments.length?this.setOrigin(this.x+a.x,this.y+a.y):this.setOrigin(this.x+a,this.y+b)},setRounding:function(a,b){if(1===arguments.length)this.roundX=a,this.roundY=b;else if(this.roundX!==a||this.roundY!==b)this.roundX=
a,this.roundY=b,this.dirty(127);return this},setWidth:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setWidth,this.width,a);this.width!==a&&(this.width=a,this.dirty(4));return this},setHeight:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setHeight,this.height,a);this.height!==a&&(this.height=a,this.dirty(4));return this},setSize:function(a,b){1===arguments.length&&(b=a.height,a=a.width);
if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setSize,[this.width,this.height],[a,b]);if(this.width!==a||this.height!==b)this.width=a,this.height=b,this.dirty(4);return this},expand:function(a,b){return this.setSize(this.width+a,this.height+b)},getLeft:function(){return this.x},getRight:function(){return this.x+this.width},getTop:function(){return this.y},getBottom:function(){return this.y+this.height},setLeft:function(a){return this.setFrame(a,this.y,
this.x+this.width-a,this.height)},setRight:function(a){return this.setWidth(this.width+a-this.x)},setTop:function(a){return this.setFrame(this.x,a,this.width,this.y+this.height-a)},setBottom:function(a){return this.setHeight(this.height+a-this.y)},setFrame:function(a,b,c,d){if(3===arguments.length)return this.setFrame(a.x,a.y,b,c);if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setFrame,[this.x,this.y,this.width,this.height],[a,b,c,d]);this.x=a;this.y=b;
this.width=c;this.height=d;this.dirty(6);return this},includePoint:function(a,b){if(1===arguments.length)return this.includePoint(a.x,a.y);var c=Math.min(this.x,a),d=Math.min(this.y,b),e=Math.max(this.x+this.width,a),f=Math.max(this.y+this.height,b);return this.setFrame(c,d,e-c,f-d)},includeRectangle:function(a,b,c,d){if(1===arguments.length)return this.includeRectangle(a.x,a.y,a.width,a.height);if(3===arguments.length)return this.includeRectangle(a.x,a.y,b,c);var e=Math.min(this.x,a),f=Math.min(this.y,
b),g=Math.max(this.x+this.width,a+c),h=Math.max(this.y+this.height,b+d);return this.setFrame(e,f,g-e,h-f)},alignToCanvas:function(){return this.setFrame(Math.floor(this.x)+0.5,Math.floor(this.y)+0.5,Math.round(this.width),Math.round(this.height))},intersectsAt:function(a,b){return this.x<=a&&a<=this.x+this.width&&this.y<=b&&b<=this.y+this.height},getScope:function(){return this.clone()},getTransformed:function(a){return this.toPolygon().getTransformed(a)},clone:function(){return this.cloneOnto(new jayus.Rectangle)},
cloneOnto:function(a){a.x=this.x;a.y=this.y;a.width=this.width;a.height=this.height;return a},toPolygon:function(){return new jayus.Polygon.Rectangle(this.x,this.y,this.width,this.height)},paintedWith:function(a){return new jayus.PaintedShape(this,a)},etchOntoContext:function(a){var b=this.x,c=this.y,d=this.width,e=this.height;a.beginPath();this.roundX&&(b=Math.round(b)+0.5,d=Math.round(d));this.roundY&&(c=Math.round(c)+0.5,e=Math.round(e));a.rect(b,c,d,e);return this}});jayus.Circle=jayus.Dependency.extend({shapeType:2,x:0,y:0,radius:1,init:function(a,b,c){arguments.length&&(2===arguments.length?(this.radius=b,this.y=a.y,this.x=a.x):(this.x=a,this.y=b,this.radius=c))},toObject:function(){var a={type:"Circle",x:this.x,y:this.y,radius:this.radius};""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.x=a.x;this.y=a.y;this.radius=a.radius;return this.dirty(127)},getCenter:function(){return new jayus.Point(this.x,
this.y)},setX:jayus.Point.prototype.setX,setY:jayus.Point.prototype.setY,setCenter:jayus.Point.prototype.set,translate:function(a,b){return 1===arguments.length?this.setCenter(this.x+a.x,this.y+a.y):this.setCenter(this.x+a,this.y+b)},alignToCanvas:function(){return this},paintedWith:function(a){return new jayus.PaintedShape(this,a)},getRadius:function(){return this.radius},setRadius:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setRadius,this.radius,
a);this.radius!==a&&(this.radius=a,this.dirty(4));return this},intersectsAt:function(a,b){return(this.x-a)*(this.x-a)+(this.y-b)*(this.y-b)<=this.radius*this.radius},getScope:function(){return new jayus.Rectangle(this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)},clone:function(){return new jayus.Circle(this.x,this.y,this.radius)},cloneOnto:function(a){a.x=this.x;a.y=this.y;a.radius=this.radius;return a},toPolygon:function(a){return arguments.length?new jayus.Polygon.Regular(a,this.radius):
this.toPolygon(10)},etchOntoContext:function(a){a.beginPath();a.arc(this.x,this.y,this.radius,0,2*Math.PI)}});jayus.Polygon=jayus.Dependency.extend({shapeType:8,xPoints:null,yPoints:null,x1:0,y1:0,x2:0,y2:0,closed:!0,frame:null,frameDirty:!0,init:function(a,b){if(2===arguments.length)this.xPoints=a,this.yPoints=b;else if(this.xPoints=[],this.yPoints=[],1===arguments.length)for(var c=0;c<a.length;c++)this.xPoints[c]=a[c].x,this.yPoints[c]=a[c].y},toObject:function(){var a={type:"Polygon",xPoints:this.xPoints,yPoints:this.yPoints};!0!==this.closed&&(a.closed=this.closed);""!==this.id&&(a.id=this.id);return a},
initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.xPoints=a.xPoints;this.yPoints=a.yPoints;"boolean"===typeof a.closed&&(this.closed=a.closed);this.reformFrame();return this.dirty(127)},translate:function(a,b){if(1===arguments.length)return this.translate(a.x,a.y);if(a||b){for(var c=0;c<this.xPoints.length;c++)this.xPoints[c]+=a,this.yPoints[c]+=b;this.frameDirty=!0}return this},alignToCanvas:function(){return this},paintedWith:function(a){return new jayus.PaintedShape(this,
a)},addPoint:function(a,b){if(1===arguments.length)return this.addPoint(a.x,a.y);this.xPoints.push(a);this.yPoints.push(b);this.frameDirty=!0;return this.dirty(16)},addPoints:function(a,b){if(1===arguments.length)for(var c=0;c<a.length;c++)this.xPoints.push(a[c].x),this.yPoints.push(a[c].y);else 2===arguments.length&&(this.xPoints=this.xPoints.concat(a),this.yPoints=this.yPoints.concat(b));this.frameDirty=!0;return this.dirty(16)},insertPoint:function(a,b,c){if(2===arguments.length)return this.insertPoint(a,
b.x,b.y);this.xPoints.splice(a,0,b);this.yPoints.splice(a,0,c);this.frameDirty=!0;return this.dirty(16)},setPoint:function(a,b,c){if(2===arguments.length)return this.setPoint(a,b.x,b.y);this.xPoints[a]=b;this.yPoints[a]=c;this.frameDirty=!0;return this.dirty(16)},getLeft:function(){return this.getFrame().getLeft()},getTop:function(){return this.getFrame().getTop()},getWidth:function(){return this.getFrame().getWidth()},getHeight:function(){return this.getFrame().getHeight()},getScope:function(){return this.getFrame()},
getFrame:function(){this.frameDirty&&(this.reformFrame(),this.frameDirty=!1);return this.frame},reformFrame:function(){var a,b,c,d=null,e=null,f=null,g=null;for(a=0;a<this.xPoints.length;a++){b=this.xPoints[a];c=this.yPoints[a];if(null===d||b<d)d=b;if(null===e||b>e)e=b;if(null===f||c<f)f=c;if(null===g||c>g)g=c}null===this.frame&&(this.frame=new jayus.Rectangle);this.frame.setFrame(d,f,e-d,g-f)},intersectsAt:function(a,b){var c=jayus.getContext();c.save();this.etchOntoContext(c);var d=c.isPointInPath(a,
b);c.restore();return d},setClosed:function(a){this.closed!==a&&(this.closed=a,this.dirty(16));return this},clone:function(){return new jayus.Polygon(this.xPoints.slice(0),this.yPoints.slice(0))},cloneOnto:function(a){a.xPoints=this.xPoints.slice(0);a.yPoints=this.yPoints.slice(0);a.frameDirty=!0;return a},transform:function(a){var b,c=new jayus.Point;for(b=0;b<this.xPoints.length;b++)a.transformPointOnto(this.xPoints[b],this.yPoints[b],c),this.xPoints[b]=c.x,this.yPoints[b]=c.y;this.frameDirty=!0;
return this},getTransformed:function(a){return this.getTransformedOnto(a,new jayus.Polygon)},getTransformedOnto:function(a,b){var c,d=new jayus.Point;b.xPoints=[];b.yPoints=[];for(c=0;c<this.xPoints.length;c++)a.transformPointOnto(this.xPoints[c],this.yPoints[c],d),b.xPoints.push(d.x),b.yPoints.push(d.y);return b},etchOntoContext:function(a){if(this.xPoints.length){a.beginPath();a.moveTo(this.xPoints[0],this.yPoints[0]);for(var b=0;b<this.xPoints.length;b++)a.lineTo(this.xPoints[b],this.yPoints[b]);
this.closed&&a.closePath()}return this}});jayus.Polygon.Line=function(a,b,c,d){return 2===arguments.length?jayus.Polygon.Line(a.x,a.y,b.x,b.y):new jayus.Polygon([a,c],[b,d])};jayus.Polygon.LineOnto=function(a,b,c,d,e){e.xPoints=[a,c];e.yPoints=[b,d];e.frameDirty=!0;return e};jayus.Polygon.Rectangle=function(a,b,c,d){return 3===arguments.length?jayus.Polygon.Rectangle(a.x,a.y,b,c):new jayus.Polygon([a,a+c,a+c,a],[b,b,b+d,b+d])};
jayus.Polygon.Regular=function(a,b){var c,d=new jayus.Polygon,e=0,f=2*Math.PI/a;for(c=0;c<a;c++)d.addPoint(b*Math.cos(e),b*Math.sin(e)),e+=f;return d};jayus.Polygon.Star=function(a,b,c){var d,e=new jayus.Polygon,f=0,g=Math.PI/a,h=!0,k=b;for(d=0;d<2*a;d++)e.addPoint(k*Math.cos(f),k*Math.sin(f)),k+=h?c:b,h=!h,f+=g;return e};jayus.Path=jayus.Dependency.extend({shapeType:16,segments:null,x1:0,y1:0,x2:0,y2:0,frame:null,frameDirty:!0,toPolygonDetail:10,init:function(a){this.segments=[];arguments.length&&this.addSVS(a)},toObject:function(){var a={type:"Path",segments:this.segments};10!==this.toPolygonDetail&&(a.toPolygonDetail=this.toPolygonDetail);""!==this.id&&(a.id=this.id);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.x=a.xPoints;this.y=a.yPoints;"number"===typeof a.toPolygonDetail&&
(this.toPolygonDetail=a.toPolygonDetail);this.reformFrame();return this.dirty(127)},translate:function(a,b){if(1===arguments.length)return this.translate(a.x,a.y);for(var c=0;c<this.segments.length;c++)this.moveSegment(c,a,b);return this},alignToCanvas:function(){return this},paintedWith:function(a){return new jayus.PaintedShape(this,a)},getScope:function(){if(0===this.segments.length)return null;this.reformFrame();return new jayus.Rectangle(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1)},reformFrame:function(){var a,
b,c,d=null,e=null,f=null,g=null;for(a=0;a<this.segments.length;a++){c=this.getPoint(a);b=c.x;c=c.y;if(null===d||b<d)d=b;if(null===e||b>e)e=b;if(null===f||c<f)f=c;if(null===g||c>g)g=c}this.x1=d;this.x2=e;this.y1=f;this.y2=g},intersectsAt:function(a,b){var c=jayus.getContext();c.save();this.etchOntoContext(c);var d=c.isPointInPath(a,b);c.restore();return d},moveTo:function(a,b){return this.addSegment(["moveTo",a,b])},moveBy:function(a,b){var c=this.getCurrentPoint();return this.moveTo(c.x+a,c.y+b)},
closePath:function(){return this.addSegment(["closePath"])},lineTo:function(a,b){return this.addSegment(["lineTo",a,b])},lineBy:function(a,b){var c=this.getCurrentPoint();return this.lineTo(c.x+a,c.y+b)},quadraticCurveTo:function(a,b,c,d){return this.addSegment(["quadraticCurveTo",a,b,c,d])},quadraticCurveBy:function(a,b,c,d){var e=this.getCurrentPoint();return this.quadraticCurveTo(e.x+a,e.y+b,e.x+c,e.y+d)},bezierCurveTo:function(a,b,c,d,e,f){return this.addSegment(["bezierCurveTo",a,b,c,d,e,f])},
bezierCurveBy:function(a,b,c,d,e,f){var g=this.getCurrentPoint();return this.bezierCurveTo(g.x+a,g.y+b,g.x+c,g.y+d,g.x+e,g.y+f)},arcTo:function(a,b,c,d,e){return this.addSegment(["arcTo",a,b,c,d,e])},arcBy:function(a,b,c,d,e){var f=this.getCurrentPoint();return this.arcTo(f.x+a,f.y+b,f.x+c,f.y+d,e)},arc:function(a,b,c,d,e,f){return this.addSegment(["arc",a,b,c,d,e,f])},rect:function(a,b,c,d){return this.addSegment(["rect",a,b,c,d])},ellipse:function(a,b,c,d,e,f,g,h){return this.addSegment(["ellipse",
a,b,c,d,f,g,h])},horizontalLineTo:function(a){return this.lineTo(a,this.getCurrentPoint().y)},horizontalLineBy:function(a){return this.lineBy(a,0)},verticalLineTo:function(a){return this.lineTo(this.getCurrentPoint().x,a)},verticalLineBy:function(a){return this.lineBy(0,a)},addSegment:function(a){this.segments.push(a);return this},getInitialPoint:function(){return this.getPoint(0)},getCurrentPoint:function(){return this.getPoint(this.segments.length-1)},getPoint:function(a){if(this.hasPointIndex(a)){var b=
this.segments[a];switch(b[0]){case "moveTo":return new jayus.Point(b[1],b[2]);case "closePath":return this.getInitialPoint();case "lineTo":return new jayus.Point(b[1],b[2]);case "quadraticCurveTo":return new jayus.Point(b[3],b[4]);case "bezierCurveTo":return new jayus.Point(b[5],b[6]);case "arcTo":return jayus.getFinalArcToPoint(this,b);case "arc":a=b[2];var c=b[3],d=b[5];return new jayus.Point(b[1]+c*Math.cos(d),a+c*Math.sin(d));case "rect":return this.getPoint(a-1);case "ellipse":throw Error('Path.getPoint() - Unimplemented for "ellipse"');
}}else throw new RangeError("Path.getPoint() - Invalid index sent: "+a);},addSVG:function(a){var b,c=this.parsePathString(a);for(a=0;a<c.length;a++)switch(b=c[a],b[0]){case "M":this.moveTo(b[1],b[2]);break;case "m":this.moveBy(b[1],b[2]);break;case "Z":case "z":this.closePath();break;case "L":this.lineTo(b[1],b[2]);break;case "l":this.lineBy(b[1],b[2]);break;case "H":this.horizontalLineTo(b[1]);break;case "h":this.horizontalLineBy(b[1]);break;case "V":this.verticalLineTo(b[1]);break;case "v":this.verticalLineBy(b[1]);
break;case "C":this.bezierCurveTo(b[1],b[2],b[3],b[4],b[5],b[6]);break;case "c":this.bezierCurveBy(b[1],b[2],b[3],b[4],b[5],b[6]);break;case "S":case "s":throw Error("Path.addSVG() - Unimplemented for S/s commands");case "Q":this.quadraticCurveTo(b[1],b[2],b[3],b[4]);break;case "q":this.quadraticCurveBy(b[1],b[2],b[3],b[4]);break;case "T":case "t":throw Error("Path.addSVG() - Unimplemented for T/t commands");case "A":case "a":throw Error("Path.addSVG() - Unimplemented for A/a commands");case "R":case "r":throw Error("Path.addSVG() - Unimplemented for R/r commands");
}},parsePathString:function(a){a=a.replace(/ /g,",").replace(/-/g,",-");a=a.replace(/[MmZzLlHhVvCcSsQqTtAaRr]/g,function(a){return","+a+","});a=a.split(",");var b,c,d={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},e,f=[],g=0;for(b=0;b<a.length;b++)if(c=a[b],""!==c)if(0===g)if(d.hasOwnProperty(c.toLowerCase()))e=[c],g=d[c.toLowerCase()],f.push(e);else return"ERROR: expected command, got: "+c;else{var h=parseFloat(c);if(isNaN(h))return"ERROR: expected parameter, got: "+c;e.push(h);g--}return f},getSegmentCount:function(){return this.segments.length},
hasPointIndex:function(a){return 0<=a&&a<this.segments.length},isClosed:function(){return this.getInitialPoint().equals(this.getCurrentPoint())},clone:function(){var a,b,c,d,e=[];for(a=0;a<this.segments.length;a++){c=this.segments[a];d=[];for(b=0;b<c.length;b++)d.push(c[b]);e.push(d)}a=new jayus.Path;a.segments=e;return a},getTransformed:function(a){var b,c,d,e,f=[];for(b=0;b<this.segments.length;b++)switch(c=this.segments[b],d=[c[0]],f.push(d),c[0]){case "moveTo":e=a.transformPoint(c[1],c[2]);d[1]=
e.x;d[2]=e.y;break;case "lineTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;break;case "quadraticCurveTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;e=a.transformPoint(c[3],c[4]);d[3]=e.x;d[4]=e.y;break;case "bezierCurveTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;e=a.transformPoint(c[3],c[4]);d[3]=e.x;d[4]=e.y;e=a.transformPoint(c[5],c[6]);d[5]=e.x;d[6]=e.y;break;case "arcTo":case "arc":case "rect":case "ellipse":throw Error("TODO: Path.getTransformed() - Unimplemented for command "+
c[0]);}},toPolygon:function(a){arguments.length||(a=this.toPolygonDetail);throw Error("TODO: Path.toPolygon() - Unimplemented");},etchOntoContext:function(a){a.beginPath();var b,c;b=this.getPoint(0);var d=b.x,e=b.y;for(b=0;b<this.segments.length;b++)switch(c=this.segments[b],c[0]){case "moveTo":d=c[1];e=c[2];a.moveTo(d,e);break;case "closePath":a.closePath();break;case "lineTo":d=c[1];e=c[2];a.lineTo(d,e);break;case "bezierCurveTo":d=c[5];e=c[6];a.bezierCurveTo(c[1],c[2],c[3],c[4],d,e);break;case "quadraticCurveTo":d=
c[3];e=c[4];a.quadraticCurveTo(c[1],c[2],d,e);break;case "arcTo":a.arcTo(c[1],c[2],c[3],c[4],c[5]);this.getPoint(b);break;case "arc":a.arc(c[1],c[2],c[3],c[4],c[5],c[6]);this.getPoint(b);break;case "rect":d=c[1];e=c[2];a.rect(d,e,c[3],c[4]);break;case "ellipse":throw Error("Path.etchOntoContext() - Unimplemented for command ellipse");}return this}});jayus.Path.Circle=function(a,b,c){return 2===arguments.length?jayus.Path.Circle(a.x,a.y,b):(new jayus.Path).arc(a,b,c,0,2*Math.PI,!1)};
jayus.Path.Rectangle=function(a,b,c,d){return 3===arguments.length?(new jayus.Path).rect(a.x,a.y,b,c):(new jayus.Path).rect(a,b,c,d)};jayus.getFinalArcToPoint=function(a,b){var c=a.getPoint(b-1),d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],c=Math.atan2(c.y-e,c.x-d),f=Math.atan2(e-g,d-f),g=Math.abs(c-f),g=Math.min(2*Math.PI-g,g)/2,h=h/Math.tan(g),d=d+h*Math.cos(f),e=e+h*Math.sin(f);return new jayus.Point(d,e)};
jayus.getPathScope=function(a){var b,c,d=new jayus.Rectangle;for(b=0;b<a.segments.length;b++)switch(c=a.segments[b],c[0]){case "moveTo":d.includeAt(c[1],c[2]);break;case "lineTo":d.includeAt(c[1],c[2]);break;case "bezierCurveTo":d.includeAt(c[1],c[2]);d.includeAt(c[3],c[4]);d.includeAt(c[5],c[6]);break;case "quadraticCurveTo":d.includeAt(c[1],c[2]);d.includeAt(c[3],c[4]);break;case "rect":var e=c[1],f=c[2],g=c[3];c=c[4];d.setLeft(Math.max(d.getLeft(),e));d.setRight(Math.max(d.getRight(),e+g));d.setTop(Math.max(d.getTop(),
f));d.setBottom(Math.max(d.getBottom(),f+c))}};(function(){jayus.applyObject(jayus.Dependency.prototype,jayus.Responder.prototype);jayus.Entity=jayus.Responder.extend({shapeType:0,isParent:!1,included:!0,visible:!0,alpha:1,events:null,isTransformed:!1,actionsToAnimate:0,enableDragEvents:!1,leftDragging:!1,middleDragging:!1,rightDragging:!1,properties:"visible included alpha angle xAnchor yAnchor trackCursor canAcceptCursor canReleaseCursor enableDragEvents".split(" "),animate:function(){this.actionsToAnimate++;return this},init:function(){"object"===
typeof this.events&&null!==this.events&&this.handle(this.events);this.enableDragEvents&&this.handle({leftPress:function(a){this.leftDragging=!0;return this.fire("leftDragStart",a)},leftRelease:function(a){if(this.leftDragging)return this.leftDragging=!1,this.fire("leftDragEnd",a)},middlePress:function(a){this.middleDragging=!0;return this.fire("middleDragStart",a)},middleRelease:function(a){if(this.middleDragging)return this.middleDragging=!1,this.fire("middleDragEnd",a)},rightPress:function(a){this.rightDragging=
!0;return this.fire("rightDragStart",a)},rightRelease:function(a){if(this.rightDragging)return this.rightDragging=!1,this.fire("rightDragEnd",a)},cursorMove:function(a){var b=!1;this.leftDragging&&(b=this.fire("leftDrag",a)||b);this.middleDragging&&(b=this.fire("middleDrag",a)||b);this.rightDragging&&(b=this.fire("rightDrag",a)||b);return b},cursorOut:function(){this.leftDragging&&this.fire("leftDragEnd");this.middleDragging&&this.fire("middleDragEnd");this.rightDragging&&this.fire("rightDragEnd");
this.leftDragging=this.middleDragging=this.rightDragging=!1}})},toObject:function(){var a={type:"Entity"};""!==this.id&&(a.id=this.id);var b,c,d,e;for(b=0;b<jayus.Entity.prototype.properties.length;b++)c=jayus.Entity.prototype.properties[b],d=this[c],e=typeof d,d!==jayus.Entity.prototype[c]&&("object"===e&&(d=d.toObject()),a[c]=d);return a},initFromObject:function(a){jayus.Dependency.prototype.initFromObject.call(this,a);this.frozen++;var b,c,d,e;for(b=0;b<jayus.Entity.prototype.properties.length;b++)c=
jayus.Entity.prototype.properties[b],d=a[c],e=typeof d,void 0!==d&&("object"===e&&(d=jayus.parse(d)),this[c]=d);"string"===typeof a.tooltip&&this.setTooltip(a.tooltip);"number"===typeof a.xScale&&this.setXScale(a.xScale);"number"===typeof a.yScale&&this.setYScale(a.yScale);"number"===typeof a.scale&&this.setScale(a.scale);"number"===typeof a.xVelocity&&this.setXVelocity(a.xVelocity);"number"===typeof a.yVelocity&&this.setYVelocity(a.yVelocity);"string"===typeof a.dragButton&&this.setDragButton(a.dragButton);
"object"===typeof a.parent&&this.setParent(a.parent);"object"===typeof a.constraints&&this.setConstraints(a.constraints);"object"===typeof a.events&&null!==a.events&&this.handle(a.events);this.frozen--;return this.dirty(127)},setId:function(a){jayus.Dependency.prototype.setId.call(this,a);jayus.declareChildrenAsProperties&&null!==this.parent&&a&&(this.parent[a]=this)},addHandler:function(a){jayus.Responder.prototype.addHandler.apply(this,arguments);"leftClick"===a?this.addHandler("leftRelease",function(a){jayus.entityPressedOn===
this&&this.fire("leftClick",a)}):"middleClick"===a?this.addHandler("middleRelease",function(a){jayus.entityPressedOn===this&&this.fire("middleClick",a)}):"rightClick"===a?this.addHandler("rightRelease",function(a){jayus.entityPressedOn===this&&this.fire("rightClick",a)}):!this.trackCursor&&(0===a.indexOf("cursor")||0<=a.indexOf("Press")||0<=a.indexOf("Release"))&&(this.trackCursor=!0,null!==this.parent&&this.parent.childCursorTrackingChanged(this,!0))},dirtied:!0,frozen:0,pendingDirty:0,ignoreDirty:0,
freeze:function(){this.frozen++;return this},unfreeze:function(){this.frozen--;this.frozen||this.thaw();return this},thaw:function(){jayus.dirtyCount++;this.fire("dirty",this.pendingDirty);this.dirtied=!0;this.informDependents(this.pendingDirty);null!==this.constraints&&this.constrain();this.pendingDirty=0;return this},dirty:function(a){this.ignoreDirty||(this.frozen?this.pendingDirty|=a:(jayus.dirtyCount++,null!==this.constraints&&this.constrain(),this.isTransformed&&a&10&&(this.matrixDirty=!0),
this.fire("dirty",a),this.dirtied=!0,this.informDependents(a),null!==this.parentDisplay&&a&14&&this.parentDisplay.startCursorUpdate()));return this},parent:null,parentDisplay:null,getAbsoluteParent:function(){return null!==this.parent?this.parent.getAbsoluteParent():this},setParent:function(a){if(this.parent!==a){this.parent=a;this.parentDisplay=a.parentDisplay;this.attach(a);jayus.declareChildrenAsProperties&&this.id&&("undefined"!==typeof a[this.id]?console.error('Entity.setParent() - Collision between child id("'+
this.id+'") and parent property('+a[this.id]+")"):a[this.id]=this);this.trackCursor&&a.childCursorTrackingChanged(this,!0);if(this.constraintsNeedParent){this.parentConstrainerOptions={};var b=this;this.parent.addHandler("dirty",function(a){b.constrain()},this.parentConstrainerOptions)}this.fire("added")}},removeParent:function(){null!==this.constraints&&this.constraints.needsParent&&(this.parentConstrainerOptions.remove=!0,this.parentConstrainerOptions=null);jayus.declareChildrenAsProperties&&this.id&&
delete this.parent[this.id];this.detach(this.parent);this.parent=null;this.underCursor=!1;this.fire("removed")},setIncluded:function(a){this.included!==a&&(this.included=a,this.dirty(127));return this},include:function(){return this.setIncluded(!0)},exclude:function(){return this.setIncluded(!1)},setVisible:function(a){this.visible!==a&&(this.visible=a,this.dirty(1));return this},show:function(){return this.setVisible(!0)},hide:function(){return this.setVisible(!1)},constraints:null,hasConstraint:null,
constraintsNeedParent:!1,parentConstrainerOptions:null,setConstraint:function(a,b){if("object"!==typeof this.constraints){var c={};c[a]=b;this.setConstraints(c)}else this.constraints[a]=b,this.hasConstraint[a]=!0,this.constrain();return this},clearConstraint:function(a){"object"===typeof this.constraints&&(delete this.constraints[a],this.hasConstraint[a]=!1);return this},setConstraints:function(a){var b,c,d=!1;this.hasConstraint={x:!1,y:!1,width:!1,height:!1};for(b in a)c=a[b],this.hasConstraint[b]=
!0,-1!==c.indexOf("parent")&&(d=!0);if(d&&null!==this.parent){var e=this;this.parent.addHandler("dirty",function(){e.constrain()})}this.constraints=a;this.constraintsNeedParent=d;this.constrain();return this},constrain:function(){if(null!==this.constraints&&(!this.constraintsNeedParent||null!==this.parent)){var a=this.hasConstraint,b=this.constraints;a.x&&this.setX(jayus.executeFormula(this,b.x));a.y&&this.setY(jayus.executeFormula(this,b.y));a.width&&this.setWidth(jayus.executeFormula(this,b.width));
a.height&&this.setHeight(jayus.executeFormula(this,b.height))}return this},setAlpha:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setAlpha,this.alpha,a);this.alpha!==a&&(this.alpha=a,this.dirty(16));return this},trackCursor:!1,canAcceptCursor:!0,canReleaseCursor:!0,underCursor:!1,hasCursor:!1,cursorX:0,cursorY:0,tooltip:"",setTooltip:function(a){this.trackCursor=!0;null!==this.parent&&this.parent.childCursorTrackingChanged(this,!0);this.canAcceptCursor=
!0;this.tooltip=a},updateCursor:function(a,b){var c=new jayus.Point(a,b);this.isTransformed&&this.getMatrix().inverseTransformPointOnto(a,b,c);this.cursorX=c.x;this.cursorY=c.y;var d=this.cursorHitTest(c.x,c.y);this.underCursor?d?this.isParent&&this.propagateCursor&&this.updateCursorOnChildren(c.x,c.y):(this.underCursor=!1,this.fire("cursorOut",c),this.isParent&&this.removeCursorFromChildren()):d&&(this.underCursor=!0,this.fire("cursorOver",c),this.isParent&&this.propagateCursor&&this.updateCursorOnChildren(c.x,
c.y))},cursorHitTest:function(a,b){return!0},removeCursor:function(){this.underCursor=!1;this.fire("cursorOut",null);this.isParent&&this.removeCursorFromChildren()},dragButton:null,dragging:!1,dragStarterOptions:null,dragEnderOptions:null,dragHandlerOptions:null,setDragButton:function(a){null===this.dragButton&&"string"===typeof a?(this.dragStarterOptions={},this.dragHandlerOptions={},this.dragEnderOptions={},this.addHandler(a+"Press",function(b){this.dragging=!1;this.dragHandlerOptions.remove=!1;
this.dragEnderOptions.remove=!1;var c=this;this.parentDisplay.addHandler("cursorMove",function(a){c.canReleaseCursor=!1;c.dragging||(c.parentDisplay.setCursor("move"),c.fire("dragStart"),c.dragging=!0);c.fire("dragged",a)||c.translate(a.deltaX,a.deltaY);return!0},this.dragHandlerOptions);jayus.addHandler(a+"Release",function(a,b){c.dragging&&(c.canReleaseCursor=!0,c.parentDisplay.updateCursor(c.parentDisplay.cursor.x,c.parentDisplay.cursor.y),c.fire("dragEnd"),c.parentDisplay.resetCursor());c.dragHandlerOptions.remove=
!0;b.remove=!0;if(c.dragging)return c.dragging=!1,!0},this.dragEnderOptions)},this.dragStarterOptions)):"string"===typeof this.dragButton&&null===a?(this.dragStarterOptions.remove=!0,this.dragStarterOptions=null,this.dragHandlerOptions.remove=!0,this.dragHandlerOptions=null,this.dragEnderOptions.remove=!0,this.dragEnderOptions=null):"string"===typeof this.dragButton&&"string"===typeof a&&this.dragButton!==a&&(this.setDragButton(null),this.setDragButton(a));this.dragButton=a;return this},matrix:null,
matrixDirty:!0,getMatrix:function(){this.matrixDirty&&(null===this.matrix?this.matrix=new jayus.Matrix:this.matrix.identity(),this.applyTransforms(this.matrix),this.matrixDirty=!1);return this.matrix},applyTransforms:function(a){if(this.isTransformed){var b=this.xScale,c=this.yScale;this.flipX&&(b*=-1);this.flipY&&(c*=-1);(this.xAnchor||this.yAnchor)&&a.translate(this.xAnchor,this.yAnchor);a.scale(b,c);a.rotate(this.angle);(this.xAnchor||this.yAnchor)&&a.translate(-this.xAnchor,-this.yAnchor)}return this},
angle:0,setAngle:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setAngle,this.angle,a);this.angle!==a&&(this.angle=a,this.isTransformed=!0,this.dirty(8));return this},rotate:function(a){return this.setAngle(this.angle+a)},xScale:1,yScale:1,setScale:function(a,b){1===arguments.length&&(b=a);if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setScale,[this.xScale,this.yScale],[a,b]);if(this.xScale!==a||this.yScale!==
b)this.xScale=a,this.yScale=b,this.isTransformed=!0,this.dirty(8);return this},setScaleAround:function(a,b,c,d){if(3===arguments.length)return this.setScaleAround(a,a,b,c);var e=this.localToParent(c,d);this.setScale(a,b);var f=this.localToParent(c,d);this.translate(e.x-f.x,e.y-f.y);return this.dirty(127)},scale:function(a,b){1===arguments.length&&(b=a);return this.setScale(this.xScale*a,this.yScale*b)},setXScale:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,
this.setXScale,this.xScale,a);this.xScale!==a&&(this.xScale=a,this.isTransformed=!0,this.dirty(8));return this},setYScale:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setYScale,this.yScale,a);this.yScale!==a&&(this.yScale=a,this.isTransformed=!0,this.dirty(8));return this},flipX:!1,flipY:!1,setFlipX:function(a){this.flipX!==a&&(this.flipX=a,this.isTransformed=!0,this.dirty(8));return this},setFlipY:function(a){this.flipX!==a&&(this.flipY=a,
this.isTransformed=!0,this.dirty(8));return this},setFlipping:function(a,b){if(this.flipX!==a||this.flipY!==b)this.flipX=a,this.flipY=b,this.isTransformed=!0,this.dirty(8);return this},xAnchor:0,yAnchor:0,setAnchor:function(a,b){if(1===arguments.length)return this.setAnchor(a.x,a.y);if(this.xAnchor!==a||this.yAnchor!==b){var c=this.getPosAt(this.xAnchor/this.width,this.yAnchor/this.height);this.xAnchor=a;this.yAnchor=b;var d=this.getPosAt(this.xAnchor/this.width,this.yAnchor/this.height);console.log(d.x-
c.x,d.y-c.y);this.dirty(8)}return this},screenToLocal:function(a,b){if(1===arguments.length)return this.screenToLocal(a.x,a.y);if(null!==this.parent){var c=this.parent.screenToLocal(a,b);return this.parentToLocal(c)}return new jayus.Point(a,b)},parentToLocal:function(a,b){if(1===arguments.length)return this.parentToLocal(a.x,a.y);var c=new jayus.Point(a,b);this.isTransformed?this.getMatrix().inverseTransformPointOnto(a,b,c):(c.x-=this.x,c.y-=this.y);return c},localToScreen:function(a,b){return 1===
arguments.length?this.localToScreen(a.x,a.y):null!==this.parent?this.parent.localToScreen(this.localToParent(a,b)):new jayus.Point(a,b)},localToScreenOnto:function(a,b,c){null!==this.parent?(this.localToParentOnto(a,b,c),this.parent.localToScreenOnto(c.x,c.y,c)):(c.x=a,c.y=b);return c},localToParent:function(a,b){return 1===arguments.length?this.localToParent(a.x,a.y):this.localToParentOnto(a,b,new jayus.Point)},localToParentOnto:function(a,b,c){if(this.isTransformed)return this.getMatrix().transformPointOnto(a,
b,c);c.x=a+this.x;c.y=b+this.y;return c},running:!1,xVelocity:0,yVelocity:0,setXVelocity:function(a){this.xVelocity=a;this.running||(jayus.animators.push(this),this.running=!0);return this},setYVelocity:function(a){this.yVelocity=a;this.running||(jayus.animators.push(this),this.running=!0);return this},setVelocity:function(a,b){if(1===arguments.length)return this.setVelocity(a.x,a.y);this.xVelocity=a;this.yVelocity=b;this.running||(jayus.animators.push(this),this.running=!0);return this},clearVelocity:function(){this.running&&
(this.yVelocity=this.xVelocity=0,jayus.animators.splice(jayus.animators.indexOf(this),1),this.running=!1);return this},tick:function(a,b){this.translate(this.xVelocity*b,this.yVelocity*b)},intersects:function(a){return jayus.intersectTest(this,a)},intersectCount:function(a){var b,c=0;for(b=a.length-1;0<=b;b--)jayus.intersectTest(this,a[b])&&c++;return c},intersectsAny:function(a){a instanceof jayus.List&&(a=a.items);for(var b=0;b<a.length;b++)if(jayus.intersectTest(this,a[b]))return!0;return!1},intersectsAll:function(a){a instanceof
jayus.List&&(a=a.items);for(var b=0;b<a.length;b++)if(!jayus.intersectTest(this,a[b]))return!1;return!0},intersectsWhich:function(a){a instanceof jayus.List&&(a=a.items);var b,c=[];for(b=0;b<a.length;b++)jayus.intersectTest(this,a[b])&&c.push(a[b]);return c},rasterize:function(){var a=this.getScope(),a=new jayus.Surface(a.width,a.height),b=this.x,c=this.y;this.y=this.x=0;this.drawOnto(a);this.x=b;this.y=c;return a},drawOnto:function(a){var b=a.context;b.save();this.drawOntoContext(b,0,0);b.restore();
a.dirty(16);return this}})})();jayus.RectEntity=jayus.Entity.extend({shapeType:4,properties:["x","y","roundX","roundY","alignBg"],updateCursor:function(a,b){var c=new jayus.Point(a,b);this.isTransformed?this.getMatrix().inverseTransformPointOnto(a,b,c):(c.x-=this.x,c.y-=this.y);this.cursorX=c.x;this.cursorY=c.y;var d=this.cursorHitTest(c.x,c.y);this.underCursor?d?this.isParent&&this.propagateCursor&&this.updateCursorOnChildren(c.x,c.y):(this.underCursor=!1,this.fire("cursorOut",c),this.isParent&&this.removeCursorFromChildren()):
d&&(this.underCursor=!0,this.fire("cursorOver",c),this.isParent&&this.propagateCursor&&this.updateCursorOnChildren(c.x,c.y))},cursorHitTest:function(a,b){return 0<=a&&0<=b&&a<=this.width&&b<=this.height},toObject:function(){var a=jayus.Entity.prototype.toObject.apply(this);a.type="RectEntity";var b,c,d,e;for(b=0;b<jayus.RectEntity.prototype.properties.length;b++)c=jayus.RectEntity.prototype.properties[b],d=this[c],e=typeof d,d!==jayus.RectEntity.prototype[c]&&("object"===e&&(d=d.toObject()),a[c]=
d);null!==this.bg&&(a.bg=this.bg.toObject());null!==this.bounds&&(a.bounds=this.bounds.toObject());return a},initFromObject:function(a){jayus.Entity.prototype.initFromObject.call(this,a);this.ignoreDirty++;var b,c,d;for(b=0;b<jayus.RectEntity.prototype.properties.length;b++)c=jayus.RectEntity.prototype.properties[b],d=a[c],"undefined"!==typeof d&&(this[c]=d);"number"===typeof a.width&&this.setWidth(a.width);"number"===typeof a.height&&this.setHeight(a.height);"object"===typeof a.bounds&&(this.bounds=
jayus.parse(a.bounds));"boolean"===typeof a.negateBlur&&(this.negateBlur=a.negateBlur);"boolean"===typeof a.buffering&&this.setBuffering(a.buffering);"object"===typeof a.bg&&this.setBg(a.bg);"object"===typeof a.widthPolicy&&(this.widthPolicy=jayus.parse(a.widthPolicy));"object"===typeof a.heightPolicy&&(this.heightPolicy=jayus.parse(a.heightPolicy));this.ignoreDirty--;return this.dirty(127)},x:0,y:0,setX:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,
this.setX,this.x,a);this.x!==a&&(this.x=a,this.dirty(2));return this},setY:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setY,this.y,a);this.y!==a&&(this.y=a,this.dirty(2));return this},getOrigin:jayus.Rectangle.prototype.getOrigin,setOrigin:jayus.Rectangle.prototype.setOrigin,translate:jayus.Rectangle.prototype.translate,getLeft:jayus.Rectangle.prototype.getLeft,getRight:jayus.Rectangle.prototype.getRight,getTop:jayus.Rectangle.prototype.getTop,
getBottom:jayus.Rectangle.prototype.getBottom,setLeft:jayus.Rectangle.prototype.setLeft,setRight:jayus.Rectangle.prototype.setRight,setTop:jayus.Rectangle.prototype.setTop,setBottom:jayus.Rectangle.prototype.setBottom,getPosAt:function(a,b){return 1===arguments.length?this.getPosAt(a.x,a.y):this.localToParent(a*this.width,b*this.height)},setPosAt:function(a,b,c,d){if(3===arguments.length)return this.setPosAt(a.x,a.y,b,c);var e=this.getPosAt(c,d);return this.translate(a-e.x,b-e.y)},setRelativeAnchor:function(a,
b){return 1===arguments.length?this.setAnchor(this.width*a.x,this.height*a.y):this.setAnchor(this.width*a,this.height*b)},roundX:!1,roundY:!1,setRounding:function(a,b){if(1===arguments.length)this.roundX=a,this.roundY=b;else if(this.roundX!==a||this.roundY!==b)this.roundX=a,this.roundY=b,this.dirty(127);return this},body:null,setBody:function(a){null!==this.body?delete this.body.entity:(jayus.box2d.physicalEntities.push(this),this.setAnchor(this.width/2,this.height/2));this.body=a;this.body.entity=
this;return this},removeBody:function(){null!==this.body&&(delete this.body.entity,this.body=null,jayus.box2d.physicalEntities.splice(jayus.box2d.physicalEntities.indexOf(this),1));return this},updateFromBody:function(){if(null!==this.body&&this.body.IsAwake()){var a=this.body.GetPosition();this.setPosAt(a.x,a.y,0.5,0.5);this.angle=this.body.GetAngle();this.matrixDirty=this.isTransformed=!0}},width:0,height:0,setWidth:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,
this.setWidth,this.width,a);a!==this.width&&this.changeSize(a,this.height);return this},setHeight:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setHeight,this.height,a);a!==this.height&&this.changeSize(this.width,a);return this},setSize:function(a,b){if(1===arguments.length)return this.setSize(a.width,a.height);this.width===a&&this.height===b||this.changeSize(a,b);return this},changeSize:function(a,b){this.width=a;this.height=b;this.dirty(4)},
intersectsAt:function(a,b){return this.getBounds().intersectsAt(a,b)},getUnFrame:function(){return new jayus.Rectangle(this.x,this.y,this.width,this.height)},getFrame:function(){return this.isTransformed?(new jayus.Polygon.Rectangle(0,0,this.width,this.height)).transform(this.getMatrix()):new jayus.Rectangle(this.x,this.y,this.width,this.height)},getScope:function(){return this.getFrame().getScope()},bounds:null,boundsClone:null,getBounds:function(){return null!==this.bounds?(this.bounds.cloneOnto(this.boundsClone),
this.boundsClone.translate(this.x,this.y)):this.getFrame().getScope()},setBounds:function(a){"number"!==a.shapeType&&(a=jayus.parse(a));null!==this.bounds&&this.bounds.detach(this);this.bounds=a;this.bounds.attach(this);this.boundsClone=this.bounds.clone();this.shapeType=0;return this},clearBounds:function(){null!==this.bounds&&(this.bounds.detach(this),this.boundsClone=this.bounds=null,this.shapeType=4);return this},componentDirtied:function(a,b){a===this.bounds&&this.bounds.cloneOnto(this.boundsClone)},
bg:null,alignBg:!0,setBg:function(a){a instanceof jayus.Brush||(a=new jayus.Brush(a));null!==this.bg&&this.bg.detach(this);this.bg=a;this.bg.attach(this);return this.dirty(16)},clearBg:function(){null!==this.bg&&(this.bg.detach(this),this.bg=null,this.dirty(16));return this},buffered:!1,bufferBg:!0,canvas:null,context:null,negateBlur:!1,setBuffering:function(a){!this.buffered&&a?(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.refreshBuffer()):this.buffered&&
!a&&(this.context=this.canvas=null);this.buffered=a;return this},refreshBuffer:function(){if(this.buffered){var a=this.canvas;if(this.width!==a.width||this.height!==a.height)a.width=this.width,a.height=this.height;this.fullyRefreshBuffer()}},fullyRefreshBuffer:function(){if(this.buffered){var a=this.context;a.clearRect(0,0,this.width,this.height);a.save();this.bufferBg&&null!==this.bg&&this.bg.paintRect(a,0,0,this.width,this.height);this.paintContents(a);a.restore()}},applyTransforms:function(a){var b=
this.x,c=this.y;this.roundX&&(b=Math.round(b));this.roundY&&(c=Math.round(c));if(this.isTransformed){var d=this.xScale,e=this.yScale;if(this.xAnchor||this.yAnchor)b+=this.xAnchor,c+=this.yAnchor;a.translate(b,c);a.scale(d,e);a.rotate(this.angle);(this.xAnchor||this.yAnchor)&&a.translate(-this.xAnchor,-this.yAnchor);if(this.flipX||this.flipY)a.translate(this.width/2,this.height/2),a.scale(this.flipX?-1:1,this.flipY?-1:1),a.translate(-this.width/2,-this.height/2)}else(b||c)&&a.translate(b,c);return this},
drawOntoContext:function(a){a.save();1!==this.alpha&&(a.globalAlpha*=this.alpha);this.applyTransforms(a);this.buffered?(this.dirtied&&this.refreshBuffer(),this.bufferBg||null===this.bg||(this.alignBg&&this.bg.lineWidth%2?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):this.bg.paintRect(a,0,0,this.width,this.height)),this.negateBlur?jayus.manuallyDrawImage(this.context,a,this.width,this.height):a.drawImage(this.canvas,0,0)):(null!==this.bg&&(this.alignBg&&this.bg.lineWidth%
2?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):this.bg.paintRect(a,0,0,this.width,this.height)),this.paintContents(a));this.dirtied=!1;a.restore();return this}});jayus.PaintedShape=jayus.Entity.extend({shape:null,brush:null,init:function(a,b){jayus.Entity.prototype.init.apply(this);2===arguments.length&&(this.shape=a,a.attach(this),void 0!==b&&this.setBrush(b))},toObject:function(){var a=jayus.Entity.prototype.toObject.apply(this);a.type="PaintedShape";null!==this.shape&&(a.shape=this.shape.toObject());null!==this.brush&&(a.brush=this.brush.toObject());return a},initFromObject:function(a){jayus.Entity.prototype.initFromObject.call(this,a);this.ignoreDirty++;
"object"===typeof a.shape&&this.setShape(a.shape);"object"===typeof a.brush&&this.setBrush(a.brush);this.ignoreDirty--;return this.dirty(127)},componentDirtied:function(a,b){this.dirty(16)},translate:function(a,b){this.shape.translate.call(this.shape,a,b);this.dirty(2)},intersectsAt:function(a,b){if(this.isTransformed){var c=this.getMatrix().inverseTransformPoint(a,b);a=c.x;b=c.y}return this.shape.intersectsAt(a,b)},cursorHitTest:function(a,b){return this.shape.intersectsAt(a,b)},setShape:function(a){this.shape!==
a&&("number"!==typeof a.frozen&&(a=jayus.parse(a)),null!==this.shape&&this.shape.detach(this),this.shape=a,a.attach(this),this.dirty(127));return this},setBrush:function(a){null!==this.brush&&this.brush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.brush=a;a.attach(this);return this.dirty(16)},clearBrush:function(){null!==this.brush&&(this.brush.detach(this),this.brush=null,this.dirty(16));return this},getScope:function(){if(!this.isTransformed)return this.shape.getScope();var a=
this.shape.getScope().getTransformed(this.getMatrix()).getScope();if(this.brush.stroking||this.brush.shadowing){var b=Math.max(this.xScale,this.yScale),c=0,d=0,e=0,f=0;this.brush.stroking&&(c=10,"number"===typeof this.brush.miterLimit&&(c=this.brush.miterLimit),c=d=e=f=c*b/1.5);this.brush.shadowing&&(c=Math.max(c,c+this.brush.shadowBlur-this.brush.shadowOffsetX),d=Math.max(d,d+this.brush.shadowBlur+this.brush.shadowOffsetX),e=Math.max(e,e+this.brush.shadowBlur-this.brush.shadowOffsetY),f=Math.max(f,
f+this.brush.shadowBlur+this.brush.shadowOffsetY));a.setSize(a.width+c+d,a.height+e+f);a.translate(-c,-e)}return a},getBounds:function(){return this.shape},drawOntoContext:function(a){null!==this.brush&&(a.save(),1!==this.alpha&&(a.globalAlpha*=this.alpha),this.applyTransforms(a),this.shape.etchOntoContext(a),this.brush.paintShape(a),a.restore())}});jayus.Text=jayus.RectEntity.extend({text:"",font:"12pt sans-serif",brush:null,alignment:0,fontDesc:null,lines:null,lineWidths:null,init:function(a,b,c){jayus.Entity.prototype.init.apply(this);this.fontDesc=jayus.getFontDescriptor(this.font);this.lines=[];this.lineWidths=[];arguments.length&&(this.ignoreDirty++,this.setText(a),1<arguments.length&&(this.setFont(b),2<arguments.length&&this.setBrush(c)),this.ignoreDirty--);this.refreshMetrics()},toObject:function(){var a=jayus.RectEntity.prototype.toObject.apply(this);
a.type="Text";""!==this.text&&(a.text=this.text);this.font!==jayus.Text.prototype.font&&(a.font=this.font);null!==this.brush&&(a.brush=this.brush);0!==this.alignment&&(a.alignment=this.alignment);return a},initFromObject:function(a){this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,a);"string"===typeof a.text&&this.setText(a.text);"string"===typeof a.font&&this.setFont(a.font);"undefined"!==typeof a.brush&&this.setBrush(a.brush);"number"===typeof a.alignment&&this.setAlignment(a.alignment);
this.ignoreDirty--;this.refreshMetrics();return this.dirty(127)},componentDirtied:function(){this.dirty(16)},refreshMetrics:function(){for(var a,b=0,c=this.lines.length-1;0<=c;c--)a=jayus.getTextWidth(this.lines[c],this.font),this.lineWidths[c]=a,a>b&&(b=a);this.changeSize(b,this.lines.length*this.fontDesc.height);this.minWidth=this.width;this.minHeight=this.height},getScope:function(){var a=this.getFrame().getScope();if(null!==this.brush&&(this.brush.stroking||this.brush.shadowing)){var b=Math.max(this.xScale,
this.yScale),c=0,d=0,e=0,f=0;this.brush.stroking&&(b=this.brush.lineWidth*b/2,c=d=e=f=Math.sqrt(b*b*2));this.brush.shadowing&&(c=Math.max(c,c+this.brush.shadowBlur-this.brush.shadowOffsetX),d=Math.max(d,d+this.brush.shadowBlur+this.brush.shadowOffsetX),e=Math.max(e,e+this.brush.shadowBlur-this.brush.shadowOffsetY),f=Math.max(f,f+this.brush.shadowBlur+this.brush.shadowOffsetY));a.setSize(a.width+c+d,a.height+e+f);a.translate(-c,-e)}return a},setText:function(a){this.text!==a&&(this.text=a,this.lines=
a.split("\n"),this.lineWidths.length=this.lines.length,this.refreshMetrics(),this.dirty(16));return this},setFont:function(a){this.font!==a&&(this.font=a,this.fontDesc=jayus.getFontDescriptor(a),this.refreshMetrics());return this},setAlignment:function(a){this.alignment!==a&&(this.alignment=a,1<this.lines.length&&(this.refreshMetrics(),this.dirty(16)));return this},setBrush:function(a){null!==this.brush&&this.brush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.brush=a;this.brush.attach(this);
return this.dirty(127)},clearBrush:function(){null!==this.brush&&(this.brush.detach(this),this.brush=null,this.dirty(127));return this},paintContents:function(a){var b=this.fontDesc.ascent,c=this.fontDesc.height;this.brush.applyTo(a);a.font=this.font;var d,e,f;for(d=0;d<this.lines.length;d++)e=this.lines[d],f=(this.width-this.lineWidths[d])*this.alignment,this.brush.stroking&&this.brush.strokeFirst&&a.strokeText(e,f,b+d*c),this.brush.filling&&a.fillText(e,f,b+d*c),this.brush.stroking&&!this.brush.strokeFirst&&
a.strokeText(e,f,b+d*c)}});jayus.TextBox=jayus.Text.extend({init:function(a,b,c){jayus.Entity.prototype.init.apply(this);this.fontDesc=jayus.getFontDescriptor(this.font);this.lines=[];this.lineWidths=[];arguments.length&&(this.ignoreDirty++,this.setText(a),1<arguments.length&&(this.setFont(b),2<arguments.length&&this.setBrush(c)),this.ignoreDirty--);this.words=this.divideText(this.text);this.refreshMetrics();this.addHandler("dirty",function(a){a&4&&this.refreshMetrics()})},setText:function(a){this.text!==a&&(this.text=a,this.words=
this.divideText(this.text),this.refreshMetrics(),this.dirty(16));return this},divideText:function(a){var b,c,d=[],e="";for(b=0;b<a.length;b++)c=a[b]," "===c||"\n"===c?(d.push(e,c),e=""):e+=c;d.push(e);return d},refreshMetrics:function(){for(var a=this.font,b=[],c=[],d=this.words,e=0,f,g,h,k,l=0;e!==d.length;){f="";g=0;h=d[e];k=" "===h||"\n"===h?0:jayus.getTextWidth(h,a);do{if("\n"===h){e++;break}f+=h;g+=k;e++;if(e===d.length)break;h=d[e];k=jayus.getTextWidth(h,a);k>l&&(l=k)}while(g+k<this.width);
for(;" "===f[0]||"\n"===f[0];)f=f.substr(1);b.push(f);c.push(g)}this.minWidth=l;this.lines=b;this.lineWidths=c}});jayus.Grid=jayus.RectEntity.extend({isParent:!0,slotWidth:10,slotHeight:10,xPadding:0,yPadding:0,items:null,init:function(){jayus.RectEntity.prototype.init.apply(this);this.items=[[null]]},componentDirtied:function(a,b){},updateSize:function(){return this.updateWidth().updateHeight()},updateWidth:function(){return this.setWidth(this.items[0].length*this.slotWidth+(this.items[0].length-1)*this.xPadding)},updateHeight:function(){return this.setHeight(this.items.length*this.slotHeight+(this.items.length-
1)*this.yPadding)},setSlotWidth:function(a){this.slotWidth!==a&&(this.slotWidth=a,this.updateSize());return this},setSlotHeight:function(a){this.slotHeight!==a&&(this.slotHeight=a,this.updateSize());return this},setSlotSize:function(a,b){1===arguments.length&&(b=a.height,a=a.width);if(this.slotWidth!==a||this.slotHeight!==b)this.slotWidth=a,this.slotHeight=b,this.updateSize();return this},setPadding:function(a,b){if(1===arguments.length)return this.setPadding(a.x,a.y);if(this.xPadding!==a||this.yPadding!==
b)this.xPadding=a,this.yPadding=b,this.dirty(127);return this},count:function(){var a,b,c=0;for(a=0;a<this.getRowCount();a++)for(b=0;b<this.getColumnCount();b++)null!==this.items[a][b]&&c++;return c},slotCount:function(){return this.items.length*this.items[0].length},hasSlot:function(a,b){return 1===arguments.length?this.hasSlot(a.x,a.y):this.hasColumn(a)&&this.hasRow(b)},hasColumn:function(a){return 0<=a&&a<this.items[0].length},hasRow:function(a){return 0<=a&&a<this.items.length},hasChild:function(a){var b,
c;if(a instanceof jayus.Entity)for(b=0;b<this.getRowCount();b++){if(0<=this.items[0].indexOf(a))return!0}else for(b=0;b<this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.items[b][c].id===a)return!0;return!1},hasChildAt:function(a,b){return 1===arguments.length?this.hasChildAt(a.x,a.y):null!==this.getChildAt(a,b)},indexOf:function(a){var b,c,d;if(a instanceof jayus.Entity)for(b=0;b<this.getRowCount();b++){if(d=this.items[b].indexOf(a),0<=d)return new jayus.Point(c,b)}else for(b=0;b<
this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.get(c,b).id===a)return new jayus.Point(c,b);return null},getChildAt:function(a,b){return 1===arguments.length?this.getChildAt(a.x,a.y):this.hasSlot(a,b)?this.items[b][a]:null},getChild:function(a){var b,c;for(b=0;b<this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.getChildAt(c,b).id===a)return this.items[b][c];return null},setChild:function(a,b,c){if(2===arguments.length)return this.setChild(a.x,a.y,b);if(this.hasSlot(a,
b)){var d=this.items[b][a];null!==d&&d.removeParent();this.items[b][a]=c;null!==c&&(c.setParent(this),c.translate(a*(this.slotWidth+this.xPadding),b*(this.slotHeight+this.yPadding)));this.dirty()}return this},getChildUnder:function(a,b){return 1===arguments.length?this.getChildUnder(a.x,a.y):this.getChildAt(this.getSlotUnder(a,b))},getSlotUnder:function(a,b){return 1===arguments.length?this.getSlotUnder(a.x,a.y):new jayus.Point(Math.floor((a-this.x)/(this.slotWidth+this.xPadding)),Math.floor((b-this.y)/
(this.slotHeight+this.yPadding)))},getSlotFrame:function(a,b){return 1===arguments.length?this.getSlotFrame(a.x,a.y):this.hasSlot(a,b)?new jayus.Rectangle(this.x+a*(this.slotWidth+this.xPadding),this.y+b*(this.slotHeight+this.yPadding),this.slotWidth,this.slotHeight):null},removeChild:function(a){var b=this.indexOf(a);null!==b&&("object"!==typeof a?this.items[b.y][b.x].removeParent():a.removeParent(),this.items[b.y][b.x]=null);return this},removeChildAt:function(a,b){if(1===arguments.length)return this.removeChildAt(a.x,
a.y);var c=this.getChildAt(a,b);null!==c&&(c.removeParent(),this.items[b][a]=null);return this},setGridSize:function(a,b){return this.setColumnCount(a).setRowCount(b)},getRowCount:function(){return this.items.length},setRowCount:function(a){for(;a<this.getRowCount();)this.removeRow();for(;a>this.getRowCount();)this.addRow();return this},addRow:function(a){for(arguments.length||(a=[]);a.length<this.getColumnCount();)a.push(null);this.items.push(a);this.updateSize();return this.dirty()},removeRow:function(a){this.forEachInRow(a,
function(){this.removeParent()});1<this.getRowCount()&&this.hasRow(a)&&this.items.splice(a,1);this.updateSize();return this.dirty()},getColumnCount:function(){return this.items[0].length},setColumnCount:function(a){for(;a<this.getColumnCount();)this.removeColumn();for(;a>this.getColumnCount();)this.addColumn();return this},addColumn:function(a){for(arguments.length||(a=[]);a.length<this.getRowCount();)a.push(null);for(var b=0;b<this.getRowCount();b++)this.items[b].push(a[b]);this.updateSize();return this.dirty()},
removeColumn:function(a){this.forEachInColumn(a,function(){this.removeParent()});if(1<this.getColumnCount()&&this.hasColumn(a))for(var b=0;b<this.getRowCount();b++)this.items[b].splice(a,1);this.updateSize();return this.dirty()},onEach:function(a,b){return this.forEachSlot(function(c,d,e){null!==e&&e[a].apply(e,c,d,b)})},forEach:function(a,b){return this.forEachSlot(function(b,d,e){null!==e&&a.call(this,b,d,e)})},forEachInRow:function(a,b,c){if(this.hasRow(a))for(var d=0,e;d<this.getColumnCount();d++)e=
this.items[a][d],null!==e&&b.apply(e,c);return this},forEachInColumn:function(a,b,c){if(this.hasColumn(a))for(var d=0,e;d<this.getRowCount();d++)e=this.items[d][a],null!==e&&b.apply(e,c);return this},forEachSlot:function(a){var b,c;for(b=0;b<this.getColumnCount();b++)for(c=0;c<this.getRowCount();c++)if(null===a.call(this,b,c,this.items[c][b]))return this;return this},findCursorAcceptor:function(){var a,b=null;this.forEach(function(c,d,e){if(e.underCursor){if(e.isParent&&(a=e.findCursorAcceptor(),
null!==a))return b=a,null;if(e.canAcceptCursor)return b=e,null}});return b},fireOnEach:function(a,b){var c,d,e;for(c=0;c<this.getColumnCount();c++)for(d=0;d<this.getRowCount();d++)if(e=this.items[d][c],null!==e&&e.fire(a,b))return!0;return!1},fireOnCursor:function(a,b){var c,d,e;for(c=0;c<this.getColumnCount();c++)for(d=0;d<this.getRowCount();d++)if(e=this.items[d][c],null!==e&&e.underCursor&&(e.isParent&&e.fireOnCursor(a,b)||e.fire(a,b)))return!0;return!1},updateCursorOnChildren:function(a,b){this.forEach(function(c,
d,e){e.trackCursor&&jayus.util.updateCursorOnChild(e,a,b)})},removeCursorFromChildren:function(a){this.forEach(function(a,c,d){d.underCursor&&d.removeCursor()})},paintContents:function(a){var b,c,d;for(b=0;b<this.items.length;b++)for(c=0;c<this.items[b].length;c++)d=this.items[b][c],null!==d&&d.visible&&d.drawOntoContext(a)}});jayus.Image=jayus.RectEntity.extend({image:null,filepath:null,hasSection:!1,sectionX:0,sectionY:0,loaded:!1,pendingLoad:!1,roundX:!0,roundY:!0,init:function(a,b){jayus.Entity.prototype.init.apply(this);0!==arguments.length&&(2===arguments.length&&this.addHandler("loaded",b),this.setSource(a))},toObject:function(){var a=jayus.RectEntity.prototype.toObject.apply(this);a.type="Image";null!==this.section&&(a.section=this.section.toObject());this.image instanceof HTMLImageElement?a.image=this.filepath:
this.image instanceof jayus.Surface&&(a.image=this.image.toObject());delete a.width;delete a.height;return a},initFromObject:function(a){jayus.RectEntity.prototype.initFromObject.call(this,a);if(this.hasSection="object"===typeof a.section)this.section=new jayus.Rectangle(a.section);"string"===typeof a.image?this.setSource(a.image):"object"===typeof a.image&&this.setSource(new jayus.Surface(a.image));return this.dirty(127)},setSource:function(a){if("string"===typeof a){if(this.filepath===a)return console.debug("Image.setSource() - Called twice with same filepath: "+
a),this;this.filepath=a;if(!jayus.images.isLoaded(a)){this.loaded=!1;this.pendingLoad=!0;var b=this;jayus.images.whenLoaded(a,function(a){b.pendingLoad=!1;b.setSource(a.image)});return this}a=jayus.images.get(a)}this.image=a;this.hasSection||(this.width=this.image.width,this.height=this.image.height,this.dirty(4));this.loaded=!0;this.fire("loaded");return this},whenLoaded:function(a){this.loaded?a.apply(this):this.addHandler("loaded",function(b,c){a.apply(this);c.remove=!0});return this},setSection:function(a,
b,c,d){if(1===arguments.length)return this.setSection(a.x,a.y,a.width,a.height);if(3===arguments.length)return this.setSection(a.x,a.y,b,c);this.hasSection=!0;if(this.width!==c||this.height!==d)this.sectionX=a,this.sectionY=b,this.width=c,this.height=d,this.dirty(4);else if(this.sectionX!==a||this.sectionY!==b)this.sectionX=a,this.sectionY=b,this.dirty(16);return this},clearSection:function(){this.hasSection&&(this.hasSection=!1,this.width=this.image.width,this.height=this.image.height,this.dirty(4));
return this},toPattern:function(a){arguments.length||(a="repeat");return this.rasterize().toPattern(a)},paintContents:function(a){var b=this.image;b instanceof jayus.Surface&&(b=b.canvas);this.hasSection?a.drawImage(b,this.sectionX,this.sectionY,this.width,this.height,0,0,this.width,this.height):a.drawImage(b,0,0);return this}});jayus.Sprite=jayus.Image.extend({animation:null,animator:null,spriteIndexX:null,spriteIndexY:null,sheet:null,toObject:function(){var a=jayus.Image.prototype.toObject.call(this);a.type="Sprite";if(null!==this.spriteIndexX||null!==this.spriteIndexY)a.spriteIndexX=this.spriteIndexX,a.spriteIndexY=this.spriteIndexY;return a},initFromObject:function(a){jayus.Image.prototype.initFromObject.call(this,a);"undefined"===typeof a.spriteIndexX&&"undefined"===typeof a.spriteIndexY||this.setSprite(a.spriteIndexX,
a.spriteIndexY);return this.dirty(127)},setSpriteSheet:function(a){this.sheet=a;return this},setSprite:function(a,b){var c=this.sheet||this.image.sheet;if(1===arguments.length){if("string"===typeof a)return this.spriteIndexX!==a&&(c=c.namedSprites[a],this.setSection(c.x,c.y,c.width,c.height),this.setRelativeAnchor(0.5,0.5),this.setFlipping(c.flipX,c.flipY),this.spriteIndexX=a),this;if("number"===typeof a){var c=Math.floor(this.width/(c.spriteWidth+c.marginX)),d=a%c;return this.setSprite(d,(a-d)/c)}return this.setSprite(a.x,
a.y)}if(this.spriteIndexX!==a||this.spriteIndexY!==b)this.spriteIndexX=a,this.spriteIndexY=b,this.setSection(c.marginX+a*c.spriteWidth,c.marginY+b*c.spriteHeight,c.spriteWidth,c.spriteHeight),this.dirty(127);return this},playAnimation:function(a,b){this.setAnimation(a,!1);1<arguments.length&&this.animator.addHandler("finished",b);return this},loopAnimation:function(a){return this.setAnimation(a,!0)},setAnimation:function(a,b){var c=this.sheet||this.image.sheet;if(null!==this.animator&&this.animator.running){if(this.animation===
a)return this;this.animator.stop()}this.animation=a;var d=c.animations[a],e=d.sprites;this.setRelativeAnchor(0.5,0.5);this.setFlipping(d.flipX,d.flipY);this.animator=new jayus.Animator.Discrete(e.length,function(a){this.sprite.setSprite(e[a])});this.animator.sprite=this;this.animator.setDuration(c.animations[a].duration).setLooped(b).start();return this},stopAnimation:function(){null!==this.animator&&this.animator.running&&this.animator.stop()}});jayus.SpriteSheet=jayus.Dependency.extend({spriteWidth:32,spriteHeight:32,spacingX:0,spacingY:0,marginX:0,marginY:0,animations:null,namedSprites:null,init:function(a){this.animations={};this.namedSprites={};if(arguments.length){var b=this;jayus.images.whenLoaded(a,function(a){a.image.sheet=b})}},nameSprite:function(a,b,c,d,e){this.namedSprites[a]={x:b,y:c,width:d,height:e,flipX:!1,flipY:!1};return this},setSpriteFlipping:function(a,b,c){a=this.namedSprites[a];a.flipX=b;a.flipY=c;return this},setSpriteSize:function(a,
b){1===arguments.length&&(b=a.height,a=a.width);if(this.spriteWidth!==a||this.spriteHeight!==b)this.spriteWidth=a,this.spriteHeight=b,this.dirty(4);return this},setSpacing:function(a,b){if(1===arguments.length)return this.setSpacing(a.x,a.y);this.spacingX=a;this.spacingY=b;return this},setMargin:function(a,b){if(1===arguments.length)return this.setMargin(a.x,a.y);this.marginX=a;this.marginY=b;return this},hasAnimation:function(a){return"object"===typeof this.animations[a]},addAnimation:function(a,
b,c){2===arguments.length&&(c=1E3);this.animations[a]={sprites:b,duration:c,flipX:!1,flipY:!1};return this},add:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];"undefined"===typeof c.flipX&&(c.flipX=!1);"undefined"===typeof c.flipY&&(c.flipY=!1);"undefined"===typeof c.duration&&(c.duration=1E3);this.animations[b]=c}return this},setAnimationDuration:function(a,b){this.animations[a].duration=b;return this},setAnimationFlipping:function(a,b,c){this.animations[a].flipX=b;this.animations[a].flipY=
c;return this}});jayus.Surface=jayus.RectEntity.extend({width:300,height:150,init:function(a,b){jayus.Entity.prototype.init.apply(this);2===arguments.length&&(this.width=a,this.height=b);this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.context=this.canvas.getContext("2d")},initFromObject:function(a){this.ignoreDirty++;jayus.Scene.prototype.initFromObject.call(this,a);"boolean"===typeof a.negateBlur&&(this.negateBlur=a.negateBlur);this.ignoreDirty--;this.dirty(127)},
changeSize:function(a,b){this.width=a;this.height=b;this.canvas.width=a;this.canvas.height=b;this.dirty(4)},clear:function(){this.context.clearRect(0,0,this.width,this.height);return this.dirty(16)},fill:function(a,b,c,d){switch(arguments.length){case 1:return this.fill(a.r,a.g,a.b,a.a);case 2:return this.fill(a.r,a.g,a.b,a.a*b);case 3:return this.fill(a,b,c,1);case 4:var e=this.context;e.save();e.fillStyle="rgba("+a+","+b+","+c+","+d+")";e.globalCompositeOperation="copy";e.fillRect(0,0,this.width,
this.height);e.restore();return this}},getBuffer:function(a,b,c,d){switch(arguments.length){case 0:return this.getBuffer(0,0,this.width,this.height);case 1:return this.getBuffer(a.x,a.y,a.width,a.height);case 3:return this.getBuffer(a.x,a.y,c,d)}return this.context.getImageData(a,b,c,d)},putBuffer:function(a,b,c){switch(arguments.length){case 1:return this.putBuffer(0,0,a);case 2:return this.putBuffer(a.x,a.y,b)}this.context.putImageData(c,a,b);return this.dirty(16)},getPixel:function(a,b){if(1===
arguments.length)return this.getPixel(a.x,a.y);var c=this.getBuffer(a,b,1,1).data;return new jayus.Color(c[0],c[1],c[2],c[3]/255)},setPixel:function(a,b,c,d,e,f){switch(arguments.length){case 2:return this.setPixel(a.x,a.y,b.r,b.g,b.b,b.a);case 3:return this.setPixel(a,b,c.r,c.g,c.b,c.a);case 4:return this.setPixel(a.x,a.y,b,c,d,1);case 5:return this.setPixel(a,b,c,d,e,1);case 6:var g=this.context.createImageData(1,1),h=g.data;h[0]=c;h[1]=d;h[2]=e;h[3]=255*f;return this.putBuffer(a,b,g)}},getPixelFrame:function(a,
b){return 1===arguments.length?this.getPixelFrame(a.x,a.y):new jayus.Rectangle(this.x+a*this.xScale,this.y+b*this.yScale,this.xScale,this.yScale)},getPixelAt:function(a,b){return 1===arguments.length?this.getPixelAt(a.x,a.y):this.intersectsAt(a,b)?(a===this.x+this.width&&a--,b===this.y+this.height&&b--,new jayus.Point(Math.floor((a-this.x)/this.xScale),Math.floor((b-this.y)/this.yScale))):null},blurImage:function(a){var b=this.getBuffer().data,c=this.width,d=this.height,e=this.context.createImageData(c,
d),f=e.data,g,h,k,l,n,m,p,t,q,s,r=0;for(h=d-1;0<=h;h--)for(g=c-1;0<=g;g--){n=p=m=t=q=0;for(l=h-a;l<h+1+a;l++)if(0<=l&&l<d)for(k=g-a;k<g+1+a;k++)0<=k&&k<c&&(s=4*(l*c+k),n+=b[s],p+=b[s+1],m+=b[s+2],t+=b[s+3],q++);f[r]=n/q;f[r+1]=p/q;f[r+2]=m/q;f[r+3]=t/q;r+=4}return this.putBuffer(e)},exportPNG:function(){window.open(this.canvas.toDataURL("image/png"),"_blank");return this},toPattern:function(a){arguments.length||(a="repeat");return this.context.createPattern(this.canvas,a)},paintContents:function(a){this.negateBlur?
jayus.manuallyDrawImage(this.context,a,this.width,this.height):a.drawImage(this.canvas,0,0)}});jayus.Group={children:null,isParent:!0,find:function(a){var b,c;for(b=this.items.length-1;0<=b;b--)if(c=this.items[b],c.id===a||c.isParent&&(c=c.find(a),null!==c))return c;return null},getAllChildren:function(a){var b,c,d=[];for(b=0;b<this.items.length;b++)c=this.items[b],c.isParent?d=a?d.concat(c,c.getAllChildren(a)):d.concat(c.getAllChildren(a),c):d.push(c);return d},getChildrenUnderCursor:function(){var a,b=[];for(a=0;a<this.items.length;a++)this.items[a].underCursor&&b.push(this.items[a]);return b},
getChildrenAt:function(a,b){if(1===arguments.length)return this.getChildrenAt(a.x,a.y);var c,d=[];for(c=0;c<this.items.length;c++)this.items[c].intersectsAt(a,b)&&d.push(this.items[c]);return d},forEachChild:function(a,b){return this.children.forEach(a,b)},forEveryChild:function(a,b){return this.children.forEvery(a,b)},fireOnChildren:function(a,b){var c,d,e=this.items;for(c=0;c<e.length;c++)if(d=e[c],d.isParent&&d.fireOnChildren(a,b)||d.fire(a,b))return!0;return!1},fireOnCursor:function(a,b){var c,
d,e=this.items.slice(0);for(c=e.length-1;0<=c;c--)if(d=e[c],d.underCursor&&(d.isParent&&d.fireOnCursor(a,b)||d.fire(a,b)))return!0;return!1},propagateCursor:!1,updateCursorOnChildren:function(a,b){var c,d,e=this.items;void 0!==this.contentsOriginX&&(a-=this.contentsOriginX,b-=this.contentsOriginY);for(c=e.length-1;0<=c;c--)d=e[c],d.trackCursor&&d.updateCursor(a,b)},findCursorAcceptor:function(){var a,b,c;for(a=this.items.length-1;0<=a;a--)if(b=this.items[a],b.underCursor){if(b.isParent&&(c=b.findCursorAcceptor(),
null!==c))return c;if(b.canAcceptCursor)return b}return null},removeCursorFromChildren:function(){var a,b,c=this.items;for(a=0;a<c.length;a++)b=c[a],b.underCursor&&(b.underCursor=!1,b.fire("cursorOut"),b.isParent&&b.removeCursorFromChildren())},childCursorTrackingChanged:function(a,b){b&&(this.propagateCursor=!0,this.trackCursor||(this.trackCursor=!0,null!==this.parent&&this.parent.childCursorTrackingChanged(this,!0)))}};jayus.Wrapper={isParent:!1,propagateCursor:!0,childCursorTrackingChanged:function(a,b){b&&(this.propagateCursor=!0,this.trackCursor||(this.trackCursor=!0,null!==this.parent&&this.parent.childCursorTrackingChanged(this,!0)))},updateCursorOnChildren:function(a,b){this.child.trackCursor&&this.child.updateCursor(a,b)},removeCursorFromChildren:function(){this.child.underCursor&&this.child.removeCursor()},findCursorAcceptor:function(){if(this.child.underCursor)if(this.child.isParent){var a=this.child.findCursorAcceptor();
if(null!==a)return a;if(this.child.canAcceptCursor)return this.child}else return this.child;return null},child:null,setChild:function(a){this.child=a;a.setParent(this);this.isParent=!0;a.trackCursor&&this.childCursorTrackingChanged(a,!0);return this},removeChild:function(){this.child.removeParent();this.child=null;this.isParent=!1;return this},find:function(a){if(this.isParent){if(this.child.id===a)return this.child;if(this.child.isParent)return this.child.find(a)}return null},onEachChild:function(a,
b){return this.child[a].apply(this.child,b)},forEachChild:function(a,b){return a.apply(this.child,b)},forEveryChild:function(a,b){this.child.isParent&&this.child.forEveryChild(a,b);return a.apply(this.child,b)},fireOnChildren:function(a,b){return this.child.fire(a,b)},fireOnCursor:function(a,b){return this.isParent&&this.child.underCursor?this.child.isParent&&this.child.fireOnCursor(a,b)?!0:this.child.fire(a,b):!1}};jayus.Layer=jayus.Entity.extend({x:0,y:0,childrenAdded:null,scope:null,scopeDirty:!0,canAcceptCursor:!1,componentDirtied:function(a,b){a instanceof jayus.Entity&&(b&14&&(a.scopeChanged=!0),this.scopeDirty=!0);this.dirty(16)},listItemAdded:function(a,b){this.childrenAdded.push(b);b.prevScope=b.getScope();b.setParent(this);this.dirty(16)},listItemsAdded:function(a,b){var c,d;for(c=0;c<b.length;c++)d=b[c],this.childrenAdded.push(d),d.prevScope=d.getScope(),d.setParent(this);this.dirty(16)},listItemRemoved:function(a,
b){b.removeParent();this.dirty(16)},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.dirty(16)},init:function(a,b){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;this.scope=new jayus.Rectangle;this.childrenAdded=[];2===arguments.length&&(this.width=a,this.height=b)},toObject:function(){var a=jayus.Entity.prototype.toObject.apply(this);a.type="Layer";var b,c,d,e;for(b=0;b<jayus.Layer.prototype.properties.length;b++)c=
jayus.Layer.prototype.properties[b],d=this[c],e=typeof d,d!==jayus.Layer.prototype[c]&&("object"===e&&(d=d.toObject()),a[c]=d);return a},cursorHitTest:function(a,b){return!0},getScope:function(){var a,b,c,d,e,f;if(this.scopeDirty)if(this.items.length){d=c=Infinity;f=e=-Infinity;for(a=this.items.length-1;0<=a;a--)b=this.items[a].getScope(),b.x<c&&(c=b.x),b.x+b.width>e&&(e=b.x+b.width),b.y<d&&(d=b.y),b.y+b.height>f&&(f=b.y+b.height);this.scope.setFrame(c,d,e-c,f-d)}else this.scope.setFrame(0,0,0,0);
return this.scope},setX:jayus.RectEntity.prototype.setX,setY:jayus.RectEntity.prototype.setY,getOrigin:jayus.Rectangle.prototype.getOrigin,setOrigin:jayus.Rectangle.prototype.setOrigin,translate:jayus.Rectangle.prototype.translate,intersectsAt:function(a,b){return!0},roundX:!1,roundY:!1,setRounding:jayus.RectEntity.prototype.setRounding,applyTransforms:function(a){var b=this.x,c=this.y;this.roundX&&(b=Math.round(b));this.roundY&&(c=Math.round(c));if(this.isTransformed){var d=this.xScale,e=this.yScale;
this.flipX&&(d*=-1);this.flipY&&(e*=-1);if(this.xAnchor||this.yAnchor)b+=this.xAnchor,c+=this.yAnchor;a.translate(b,c);a.scale(d,e);a.rotate(this.angle);(this.xAnchor||this.yAnchor)&&a.translate(-this.xAnchor,-this.yAnchor)}else(b||c)&&a.translate(b,c);return this},drawOntoContext:function(a){a.save();1!==this.alpha&&(a.globalAlpha*=this.alpha);this.applyTransforms(a);var b,c;for(b=0;b<this.items.length;b++)c=this.items[b],c.visible&&c.drawOntoContext(a);a.restore()}});
jayus.applyObject(jayus.Group,jayus.Layer.prototype);jayus.Scene=jayus.RectEntity.extend({childrenAdded:null,clipChildrenToFrame:!1,redrawAll:!0,componentDirtied:function(a,b){a instanceof jayus.Entity&&b&14&&(a.scopeChanged=!0);a===this.bounds&&this.bounds.cloneOnto(this.boundsClone);this.dirty(16)},listItemAdded:function(a,b){null===this.childrenAdded&&(this.childrenAdded=[]);this.childrenAdded.push(b);b.prevScope=b.getScope();b.trackCursor&&this.childCursorTrackingChanged(b,!0);b.setParent(this);this.dirty(16)},listItemsAdded:function(a,b){var c,
d;null===this.childrenAdded&&(this.childrenAdded=[]);for(c=0;c<b.length;c++)d=b[c],this.childrenAdded.push(d),d.prevScope=d.getScope(),d.trackCursor&&this.childCursorTrackingChanged(d,!0),d.setParent(this);this.dirty(16)},listItemRemoved:function(a,b){b.removeParent();this.redrawAll=!0;this.dirty(16)},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.redrawAll=!0;this.dirty(16)},init:function(a,b){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);
this.items=this.children.items;2===arguments.length&&(this.width=a,this.height=b)},toObject:function(){var a=jayus.RectEntity.prototype.toObject.apply(this);jayus.groupToObject.call(this,a);a.type="Scene";!1!==this.optimizeBuffering&&(a.optimizeBuffering=this.optimizeBuffering);!0!==this.groupDamagedRegions&&(a.groupDamagedRegions=this.groupDamagedRegions);2!==this.damagedRegionPadding&&(a.damagedRegionPadding=this.damagedRegionPadding);return a},initFromObject:function(a){this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,
a);jayus.groupInitFromObject.call(this,a);"boolean"===typeof a.clipChildrenToFrame&&(this.clipChildrenToFrame=a.clipChildrenToFrame);"boolean"===typeof a.optimizeBuffering&&(this.optimizeBuffering=a.optimizeBuffering);"boolean"===typeof a.groupDamagedRegions&&(this.groupDamagedRegions=a.groupDamagedRegions);"number"===typeof a.damagedRegionPadding&&(this.damagedRegionPadding=a.damagedRegionPadding);this.ignoreDirty--;this.dirty(127)},optimizeBuffering:!1,groupDamagedRegions:!0,damagedRegionPadding:2,
setOptimizedBuffering:function(a){this.optimizeBuffering!==a&&(this.optimizeBuffering=a,this.redrawAll=!0,this.dirty(16));return this},refreshBuffer:function(){if(this.buffered){var a=this.width,b=this.height,c=this.canvas;if(a!==c.width||b!==c.height)c.width=a,c.height=b;this.optimizeBuffering&&!this.redrawAll?this.optimizedRefreshBuffer():(this.fullyRefreshBuffer(),this.redrawAll=!1);this.dirtied=!1}},optimizedRefreshBuffer:function(){if(this.buffered){var a=this.context,b,c,d,e,f=[];for(b=0;b<
this.items.length;b++)d=this.items[b],d.clean=!0,d.scopeChanged?(f.push(d.getScope().includeRectangle(d.prevScope)),d.prevScope=d.getScope(),d.scopeChanged=!1,d.clean=!1):d.dirtied&&(f.push(d.getScope()),d.dirtied=!1,d.clean=!1);var g=!1;if(this.groupDamagedRegions)for(;!g;)for(g=!0,b=0;b<f.length;b++)for(e=f[b],c=0;c<f.length;c++)d=f[c],e!==d&&jayus.intersectTest(e,d)&&(f[b].includeRectangle(d),f.splice(c,1),g=!1,b>=c&&b--,c--);c=this.damagedRegionPadding;for(b=0;b<f.length;b++)e=f[b],e.translate(-c,
-c),e.setSize(e.width+2*c,e.height+2*c);for(b=0;b<f.length;b++)for(e=f[b],c=0;c<this.items.length;c++)d=this.items[c],d.clean&&jayus.intersectTest(d,e)&&(d.clean=!1);a.save();for(b=0;b<f.length;b++)e=f[b],a.clearRect(e.x,e.y,e.width,e.height);a.beginPath();for(b=0;b<f.length;b++)e=f[b],a.rect(e.x,e.y,e.width,e.height);a.clip();this.bufferBg&&null!==this.bg&&(this.alignBg?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):this.bg.paintRect(a,0,0,this.width,this.height));for(b=
0;b<this.items.length;b++)d=this.items[b],!d.clean&&d.visible&&d.drawOntoContext(a);a.restore()}},paintContents:function(a){this.clipChildrenToFrame&&(a.beginPath(),a.rect(0,0,this.width,this.height),a.clip());void 0!==this.contentsOriginX&&a.translate(this.contentsOriginX,this.contentsOriginY);var b,c;for(b=0;b<this.items.length;b++)c=this.items[b],c.visible&&c.drawOntoContext(a)}});jayus.applyObject(jayus.Group,jayus.Scene.prototype);jayus.Display=jayus.Scene.extend({buffered:!0,cursor:new jayus.Point,suppressContextMenu:!0,suppressSelection:!0,pendMousemoveEvents:!0,hasPendingMousemoveEvent:!1,pendingMousemoveEvent:null,init:function(a,b){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;var c;1===arguments.length?(c=a,c.parentElement.style.position="relative"):(c=document.createElement("canvas"),arguments.length&&(c.width=a,c.height=b));this.canvas=c;this.width=c.width;
this.height=c.height;this.context=c.getContext("2d");jayus.displays.push(this);this.hookCursorListeners(this.canvas);this.addHandler("dirty",function(a){a&14&&this.startCursorUpdate()})},listItemAdded:function(a,b){jayus.Scene.prototype.listItemAdded.call(this,a,b);b.parentDisplay=this;if(b.isParent){var c=this;b.forEveryChild(function(){this.parentDisplay=c})}},listItemsAdded:function(a,b){jayus.Scene.prototype.listItemsAdded.call(this,a,b);var c,d,e=function(){this.parentDisplay=f};for(c=0;c<b.length;c++)if(d=
b[c],d.parentDisplay=this,d.isParent){var f=this;d.forEveryChild(e)}},setBuffering:function(){},processPendingMousemove:function(a){this.hasPendingMousemoveEvent=!1;return this.processMousemove(this.pendingMousemoveEvent)},processMousemove:function(a){this.underCursor||(this.underCursor=!0,this.fire("cursorOver"));var b=void 0===a.offsetX?a.layerX:a.offsetX,c=void 0===a.offsetY?a.layerY:a.offsetY;a={display:this,event:a,x:b,y:c,deltaX:b-this.cursor.x,deltaY:c-this.cursor.y};this.cursor.x=b;this.cursor.y=
c;this.cursor.dependentCount&&this.cursor.dirty(2);this.fireOnCursor("cursorMove",a)||this.fire("cursorMove",a);this.startCursorUpdate()},hookCursorListeners:function(a){var b=this,c={event:null,display:b,x:null,y:null},d={event:null,display:b,x:null,y:null,scroll:null,xScroll:null,yScroll:null},e=function(a){c.event=a;c.x=void 0===a.offsetX?a.layerX:a.offsetX;c.y=void 0===a.offsetY?a.layerY:a.offsetY},f=function(a){return 0===a.button?"left":1===a.button?"middle":2===a.button?"right":"unknown"};
a.addEventListener("mousemove",function(a){b.pendMousemoveEvents?(b.pendingMousemoveEvent=a,b.hasPendingMousemoveEvent=!0):b.processMousemove(a)});a.addEventListener("mouseleave",function(a){b.hasPendingMousemoveEvent&&b.processPendingMousemove();e(a);a=0;for(var d;3>a;a++)d=f(a),jayus[d+"Down"]&&(jayus[d+"Down"]=!1,jayus.fire(d+"Release",c),b.fireOnCursor(d+"Release",c));null!==jayus.cursorFocus&&(jayus.cursorFocus.fire("cursorLeave"),jayus.cursorFocus=null);b.underCursor=!1;b.fire("cursorOut");
b.removeCursorFromChildren()});this.suppressSelection&&(a.style.webkitUserSelect="none",a.style.mozUserSelect="none",a.onselectstart=function(){return!1});a.addEventListener("focus",function(a){b.fire("focused",{event:a,display:b});b.focused=!0;jayus.focusedDisplay=b;jayus.hasFocus=!0});a.addEventListener("blur",function(a){b.fire("blurred",{event:a,display:b});b.focused=!1;jayus.focusedDisplay=null;jayus.hasFocus=!1});a.setAttribute("tabindex","1");a.style.outline=0;a.addEventListener("mousedown",
function(a){b.hasPendingMousemoveEvent&&b.processPendingMousemove();b.focus();b.underCursor||(b.underCursor=!0,b.fire("cursorOver"));e(a);var d=f(a),k=d+"Press";jayus[d+"Down"]=!0;jayus.entityPressedOn=jayus.cursorFocus;if(jayus.fire(k,c)||b.fireOnCursor(k,c)||b.fire(k,c))return a.stopPropagation(),a.preventDefault(),!1});document.body.addEventListener("mouseup",function(a){b.hasPendingMousemoveEvent&&b.processPendingMousemove();e(a);a=f(a);var d=a+"Release";jayus[a+"Down"]=!1;jayus.fire(d,c)||b.fireOnCursor(d,
c)||b.fire(d,c)});a.addEventListener("contextmenu",function(a){b.suppressContextMenu&&a.preventDefault()});"Firefox"===jayus.ua.browser?a.addEventListener("wheel",function(a){b.hasPendingMousemoveEvent&&b.processPendingMousemove();b.underCursor||(b.underCursor=!0,b.fire("cursorOver"));var c=a.deltaX,e=a.deltaY;d.event=a;d.scroll=NaN;d.xScroll=c;d.yScroll=e;(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))&&a.preventDefault()}):"IE"===jayus.ua.browser?a.onmousewheel=function(a){b.hasPendingMousemoveEvent&&
b.processPendingMousemove();b.underCursor||(b.underCursor=!0,b.fire("cursorOver"));var c=a.wheelDelta,e=a.wheelDeltaX,f=a.wheelDeltaY;d.event=a;d.scroll=c;d.xScroll=e;d.yScroll=f;if(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))return!1}:a.addEventListener("mousewheel",function(a){b.hasPendingMousemoveEvent&&b.processPendingMousemove();b.underCursor||(b.underCursor=!0,b.fire("cursorOver"));var c=-a.wheelDelta/120,e=a.wheelDeltaX/120,f=-a.wheelDeltaY/120;d.event=a;d.scroll=
c;d.xScroll=e;d.yScroll=f;(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))&&a.preventDefault()})},startCursorUpdate:function(){var a;this.underCursor&&this.propagateCursor&&(this.updateCursorOnChildren(this.cursor.x,this.cursor.y),this.cursorFocus=a=this.findCursorAcceptor(),jayus.cursorFocus===a||null!==jayus.cursorFocus&&!jayus.cursorFocus.canReleaseCursor||(null!==jayus.cursorFocus&&jayus.cursorFocus.fire("cursorLeave"),jayus.cursorFocus=a,null!==a?(a.fire("cursorEnter"),
a=a.tooltip,this.canvas.title!==a&&this.canvas.setAttribute("title",a)):this.canvas.title&&this.canvas.removeAttribute("title")))},getTopCanvas:function(){return null!==this.overlayCanvas?this.overlayCanvas:this.canvas},setVisible:function(a){this.visible=a;this.canvas.style.visibility=a?"":"hidden";return this},setAlpha:function(a){if(this.actionsToAnimate)return this.actionsToAnimate--,new jayus.MethodAnimator(this,this.setAlpha,this.alpha,a);this.alpha!==a&&(this.alpha=a,this.canvas.style.opacity=
a);return this},setInto:function(a){a.style.position="relative";this.visible&&a.appendChild(this.canvas);return this},focus:function(){this.canvas.focus();return this},blur:function(){this.canvas.blur();return this},isFullScreen:function(){return(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullScreenEnabled)&&this.canvas===(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullScreenElement)},requestFullScreen:function(){var a=this.canvas;a.requestFullScreen?
a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen();return this.isFullScreen()},cancelFullScreen:function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();return this},getCursor:function(){return this.customIcon?this.customCursor:this.getTopCanvas().style.cursor},setCursor:function(a){"string"===
typeof a?(this.getTopCanvas().style.cursor=a,this.hasCustomCursor=!1):(this.getTopCanvas().style.cursor="none",this.hasCustomCursor=!0,this.customCursor=a);return this},resetCursor:function(){this.getTopCanvas().style.cursor="";this.hasCustomCursor=!1;this.customCursor=null}});jayus.RESIZE_SELF=0;jayus.RESIZE_CHILD=1;jayus.RESIZE_MARGINS=2;
jayus.Frame=jayus.RectEntity.extend(jayus.applyObject({flexible:!1,forming:!1,widthMode:0,heightMode:0,minWidthMode:"child",minHeightMode:"child",init:function(a){jayus.Entity.prototype.init.apply(this);void 0!==a?(this.setChild(a),this.formContents(),this.isParent=!0):this.isParent=!1;this.addHandler("dirty",function(a){this.formContents()})},initFromObject:function(a){this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,a);"number"===typeof a.marginLeft&&(this.marginLeft=a.marginLeft);
"number"===typeof a.marginRight&&(this.marginRight=a.marginRight);"number"===typeof a.marginTop&&(this.marginTop=a.marginTop);"number"===typeof a.marginBottom&&(this.marginBottom=a.marginBottom);"number"===typeof a.widthMode&&(this.widthMode=a.widthMode);"number"===typeof a.heightMode&&(this.heightMode=a.heightMode);"object"===typeof a.child&&this.setChild(jayus.parse(a.child));this.ignoreDirty--;return this.dirty(127)},setChild:function(a){jayus.Wrapper.setChild.call(this,a);this.width||this.setWidth(a.width+
this.marginLeft+this.marginRight);this.height||this.setHeight(a.height+this.marginTop+this.marginBottom);"number"===typeof a.minWidth&&(this.minWidth=a.minWidth+this.marginLeft+this.marginRight);"number"===typeof a.minHeight&&(this.minHeight=a.minHeight+this.marginTop+this.marginBottom);this.formContents();return this},componentDirtied:function(a,b){b&4?("child"===this.minWidthMode&&"number"===typeof this.child.minWidth&&(this.minWidth=this.child.minWidth+this.marginLeft+this.marginRight),"child"===
this.minHeightMode&&"number"===typeof this.child.minHeight&&(this.minHeight=this.child.minHeight+this.marginTop+this.marginBottom),this.forming||this.formContents()):this.dirty(127)},marginBrush:null,setMarginBrush:function(a){null!==this.marginBrush&&this.marginBrush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.marginBrush=a;this.marginBrush.attach(this);return this.dirty(16)},clearMarginBrush:function(){null!==this.marginBrush&&(this.marginBrush.detach(this),this.marginBrush=
null,this.dirty(16));return this},marginLeft:6,marginRight:6,marginTop:6,marginBottom:6,setMargin:function(a,b,c,d){1===arguments.length&&(d=c=b=a);this.marginLeft=a;this.marginRight=b;this.marginTop=c;this.marginBottom=d;this.formContents();return this},setMarginLeft:function(a){return this.setMargin(a,this.marginRight,this.marginTop,this.marginBottom)},setMarginRight:function(a){return this.setMargin(this.marginLeft,a,this.marginTop,this.marginBottom)},setMarginTop:function(a){return this.setMargin(this.marginLeft,
this.marginRight,a,this.marginBottom)},setMarginBottom:function(a){return this.setMargin(this.marginLeft,this.marginRight,this.marginTop,a)},formContents:function(){if(null!==this.child&&!this.forming){var a=this.child;this.forming=!0;a.setOrigin(this.marginLeft,this.marginTop);this.widthMode===jayus.RESIZE_SELF?this.setWidth(a.width+this.marginLeft+this.marginRight):this.widthMode===jayus.RESIZE_CHILD?a.setWidth(this.width-this.marginLeft-this.marginRight):console.error("Frame.formContents() - Invalid widthMode: "+
this.widthMode);this.heightMode===jayus.RESIZE_SELF?this.setHeight(a.height+this.marginTop+this.marginBottom):this.heightMode===jayus.RESIZE_CHILD?a.setHeight(this.height-this.marginTop-this.marginBottom):console.error("Frame.formContents() - Invalid heightMode: "+this.heightMode);this.width<this.minWidth&&this.changeSize(this.minWidth,this.height);this.height<this.minHeight&&this.changeSize(this.width,this.minHeight);this.forming=!1}},paintContents:function(a){null!==this.marginBrush&&(this.marginBrush.fill||
this.marginBrush.stroking)&&(a.save(),this.marginBrush.applyTo(a),a.beginPath(),a.moveTo(0,0),a.lineTo(this.width,0),a.lineTo(this.width,this.height),a.lineTo(0,this.height),a.lineTo(0,0),a.moveTo(this.marginLeft,this.marginTop),a.lineTo(this.width-this.marginRight,this.marginTop),a.lineTo(this.width-this.marginRight,this.height-this.marginBottom),a.lineTo(this.marginLeft,this.height-this.marginBottom),a.lineTo(this.marginLeft,this.marginTop),this.marginBrush.stroking&&this.marginBrush.strokeFirst&&
a.stroke(),this.marginBrush.filling&&a.fill(),this.marginBrush.stroking&&!this.marginBrush.strokeFirst&&a.stroke(),a.restore());a.save();this.child.drawOntoContext(a);this.child.dirtied=!1;a.restore()}},jayus.copyObject(jayus.Wrapper)));jayus.FlexibleFrame=jayus.Frame.extend({flexible:!0});jayus.EditableFrame=jayus.Frame.extend({maxWidth:Infinity,maxHeight:Infinity,flexible:!0,enabledHandles:{nw:1,n:1,ne:1,e:1,se:1,s:1,sw:1,w:1},cornerThreshold:6,edgeThreshold:5,state:"",display:null,init:function(a){jayus.Frame.prototype.init.call(this,a);this.addHandler("cursorMove",function(a){if(!this.dragging){this.state="";var c=a.display.cursor,d=this.child.hasFlexibleWidth,e=this.child.hasFlexibleHeight;d&&e&&(this.enabledHandles.nw&&jayus.distance(this.getPosAt(0,0),c)<this.cornerThreshold?
this.state="nw":this.enabledHandles.ne&&jayus.distance(this.getPosAt(1,0),c)<this.cornerThreshold?this.state="ne":this.enabledHandles.sw&&jayus.distance(this.getPosAt(0,1),c)<this.cornerThreshold?this.state="sw":this.enabledHandles.se&&jayus.distance(this.getPosAt(1,1),c)<this.cornerThreshold&&(this.state="se"));""===this.state&&d&&(this.enabledHandles.w&&Math.abs(this.x-a.x)<this.edgeThreshold?this.state="w":this.enabledHandles.e&&Math.abs(this.x+this.width-a.x)<this.edgeThreshold&&(this.state="e"));
""===this.state&&e&&(this.enabledHandles.n&&Math.abs(this.y-a.y)<this.edgeThreshold?this.state="n":this.enabledHandles.s&&Math.abs(this.y+this.height-a.y)<this.edgeThreshold&&(this.state="s"));""!==this.state?this.parentDisplay.setCursor(this.state+"-resize"):this.parentDisplay.resetCursor()}});this.addHandler("cursorOut",function(a){this.dragging||(this.parentDisplay.resetCursor(),this.state="")});this.addHandler("leftPress",function(a){this.dragging=!0;if(""===this.state)this.parentDisplay.setCursor("move"),
this.fire("dragStart");else if("nw"===this.state)this.start=this.getPosAt(1,1);else if("n"===this.state||"e"===this.state||"ne"===this.state)this.start=this.getPosAt(0,1);else if("sw"===this.state||"w"===this.state)this.start=this.getPosAt(1,0);else if("s"===this.state||"se"===this.state)this.start=this.getPosAt(0,0);var c=this;jayus.addHandler("leftRelease",function(a,b){c.dragging=!1;""===c.state&&(c.fire("dragEnd"),c.parentDisplay.resetCursor());b.remove=!0});a.display.addHandler("cursorMove",
function(a,b){if(c.dragging){if(""===c.state)c.translate(a.deltaX,a.deltaY);else{var f=null,g=null,h=0,k=0;"nw"===c.state?(k=h=1,f=c.start.x-a.x,g=c.start.y-a.y):"n"===c.state?(k=1,g=c.start.y-a.y):"ne"===c.state?(k=1,f=a.x-c.start.x,g=c.start.y-a.y):"sw"===c.state?(h=1,f=c.start.x-a.x,g=a.y-c.start.y):"s"===c.state?g=a.y-c.start.y:"se"===c.state?(f=a.x-c.start.x,g=a.y-c.start.y):"e"===c.state?f=a.x-c.start.x:"w"===c.state&&(h=1,f=c.start.x-a.x);var l=c.getPosAt(h,k);null!==f&&(f<c.minWidth?f=c.minWidth:
f>c.maxWidth&&(f=c.maxWidth));null!==g&&(g<c.minHeight?g=c.minHeight:g>c.maxHeight&&(g=c.maxHeight));null!==f&&null!==g?c.setSize(f,g):null===g?c.setWidth(f):c.setHeight(g);c.setPosAt(l,h,k)}return!0}b.remove=!0});return!0})},setMinimumSize:function(a,b){this.minW=a;this.minH=b;return this}});jayus.FlowLayout=jayus.RectEntity.extend({alignment:0,contractHeight:!1,width:100,height:100,forming:!1,minWidth:0,init:function(){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;this.addHandler("dirty",function(a){a&4&&this.formContents()})},componentDirtied:function(a,b){this.forming||this.dirty(127)},listItemAdded:function(a,b){b.setParent(this);b.minWidth>this.minWidth&&(this.minWidth=b.minWidth);this.dirty(127)},listItemsAdded:function(a,
b){for(var c=0;c<b.length;c++){var d=b[c];d.setParent(this);d.minWidth>this.minWidth&&(this.minWidth=d.minWidth)}this.dirty(127)},listItemRemoved:function(a,b){b.removeParent();this.refreshMinWidth();this.dirty(127)},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.refreshMinWidth();this.dirty(127)},refreshMinWidth:function(){for(var a=0,b=0;b<this.items.length;b++){var c=this.items[b];c.minWidth>a&&(a=c.minWidth)}this.minWidth=a},setAlignment:function(a){this.alignment!==
a&&(this.alignment=a,this.formContents());return this},formContents:function(){if(!this.forming){this.forming=!0;for(var a=this.items,b=0,c,d=0,e,f,g,h,k,l=[];b!==a.length;){e=[];c=g=f=0;h=a[b];k=h.width;do{h.x=c;h.y=d;e.push(h);f+=k;c+=k;h.height>g&&(g=h.height);b++;if(b===a.length)break;h=a[b];k=h.width}while(f+k<this.width);for(c=0;c<e.length;c++)h=e[c],0!==this.alignment&&(h.x+=(this.width-f)*this.alignment),"number"===typeof h.verticalAlign&&(h.y+=h.verticalAlign*(g-h.height));d+=g;l.push(g)}for(b=
0;b<a.length;b++)a[b].dirty(2);this.lineHeights=l;this.minHeight=d;(this.contractHeight||this.height<this.minHeight)&&this.changeSize(this.width,this.minHeight);this.dirty(4);this.forming=!1}},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.FlowLayout.prototype);jayus.Stack=jayus.RectEntity.extend({spacing:8,reversed:!1,isParent:!0,init:function(){jayus.RectEntity.prototype.init.apply(this,arguments);this.children=new jayus.List(this);this.items=this.children.items},toObject:function(){var a=jayus.RectEntity.prototype.toObject.apply(this);jayus.groupToObject.call(this,a);a.type="Stack";8!==this.spacing&&(a.spacing=this.spacing);8!==this.reversed&&(a.reversed=this.reversed);return a},initFromObject:function(a){this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,
a);jayus.groupInitFromObject.call(this,a);"number"===typeof a.spacing&&(this.spacing=a.spacing);"boolean"===typeof a.reversed&&(this.reversed=a.reversed);this.formContents();this.ignoreDirty--;return this.dirty(127)},componentDirtied:function(a,b){b&4&&this.formContents();this.dirty(16)},listItemAdded:function(a,b){this.formContents();b.setParent(this);this.dirty(16)},listItemsAdded:function(a,b){this.formContents();for(var c=0;c<b.length;c++)b[c].setParent(this);this.dirty(16)},listItemRemoved:function(a,
b){this.formContents();b.removeParent();this.dirty(16)},listItemsRemoved:function(a,b){this.formContents();for(var c=0;c<b.length;c++)b[c].removeParent();this.dirty(16)},listItemsMoved:function(){this.formContents();this.dirty(16)},setReversed:function(a){this.reversed!==a&&(this.reversed=a,this.formContents());return this},setSpacing:function(a){this.spacing!==a&&(this.spacing=a,this.formContents());return this},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Stack.prototype);
jayus.hStack=jayus.Stack.extend({automaticHeight:!0,hasFlexibleWidth:!1,toObject:function(){var a=jayus.Stack.prototype.toObject.apply(this);a.type="hStack";!0!==this.automaticHeight&&(a.automaticHeight=this.automaticHeight.toObject());return a},formContents:function(){var a=0,b=0,c,d;if(this.reversed)for(d=this.items.length-1;0<=d;d--)c=this.items[d],c.included&&(c.setX(a),a+=c.width+this.spacing,c=c.height,c>b&&(b=c));else for(d=0;d<this.items.length;d++)c=this.items[d],c.included&&(c.setX(a),a+=
c.width+this.spacing,c=c.height,c>b&&(b=c));d=this.height;this.minWidth=this.width;this.minHeight=b;this.height<this.minHeight&&(d=b);this.changeSize(a-this.spacing,d)}});
jayus.vStack=jayus.Stack.extend({automaticWidth:!0,hasFlexibleHeight:!1,getAutomaticWidth:function(){return this.automaticWidth},setAutomaticWidth:function(a){this.automaticWidth!==a&&(this.automaticWidth=a,this.formContents());return this},toObject:function(){var a=jayus.Stack.prototype.toObject.apply(this);a.type="vStack";!0!==this.automaticWidth&&(a.automaticWidth=this.automaticWidth.toObject());return a},formContents:function(){var a=0,b=0,c,d;if(this.reversed)for(c=this.items.length-1;0<=c;c--)d=
this.items[c],d.included&&(d.setY(a),a+=d.height+this.spacing,d=d.width,d>b&&(b=d));else for(c=0;c<this.items.length;c++)d=this.items[c],d.included&&(d.setY(a),a+=d.height+this.spacing,d=d.width,d>b&&(b=d));c=this.width;this.minWidth=b;this.minHeight=this.height;this.width<this.minWidth&&(c=b);this.changeSize(c,a-this.spacing)}});jayus.Box=jayus.RectEntity.extend({width:100,height:100,spacing:8,reversed:!1,isParent:!0,forming:!1,init:function(a){jayus.Entity.prototype.init.apply(this,arguments);this.children=new jayus.List(this);this.items=this.children.items;this.addHandler("dirty",function(a){a&4&&this.formContents()})},toObject:function(){var a=jayus.RectEntity.prototype.toObject.call(this);jayus.groupToObject.call(this,a);a.id="__Box__";this.spacing!==jayus.Box.prototype.spacing&&(a.spacing=this.spacing);!1!==this.reversed&&
(a.reversed=this.reversed);return a},initFromObject:function(a){jayus.RectEntity.prototype.initFromObject.call(this,a);jayus.groupInitFromObject.call(this,a);"number"===typeof a.spacing&&this.setSpacing(a.spacing);"boolean"===typeof a.reversed&&this.setReversed(a.reversed);return this.dirty(127)},componentDirtied:function(a,b){this.forming||this.dirty(127)},listItemRemoved:function(a,b){b.removeParent();this.dirty(127)},setReversed:function(a){this.reversed!==a&&(this.reversed=a,this.formContents());
return this},setSpacing:function(a){this.spacing!==a&&(this.spacing=a,this.formContents());return this},findGreatestMinimalChildWidth:function(){for(var a=0,b=0;b<this.items.length;b++)a=Math.max(a,this.items[b].minW);return a},findGreatestMinimalChildHeight:function(){for(var a=0,b=0;b<this.items.length;b++)a=Math.max(a,this.items[b].minH);return a},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Box.prototype);
jayus.hBox=jayus.Box.extend({toObject:function(){var a=jayus.Box.prototype.toObject.call(this);a.type="hBox";return a},listItemAdded:function(a,b){"object"!==typeof b.widthPolicy&&(b.widthPolicy=new jayus.SizePolicy);b.setParent(this);this.dirty(127)},listItemsAdded:function(a,b){var c,d;for(c=0;c<b.length;c++)d=b[c],"object"!==typeof d.widthPolicy&&(d.widthPolicy=new jayus.SizePolicy),d.setParent(this);this.dirty(127)},formContents:function(){this.forming=!0;var a,b,c=0,d=this.width-(this.items.length-
1)*this.spacing,e=0,f=0;for(a=0;a<this.items.length;a++)b=this.items[a],b.hasFlexibleWidth?(f+=b.widthPolicy.size,b.widthPolicy.expand&&(e+=b.widthPolicy.weight)):f+=b.width;var g=d-f;for(a=0;a<this.items.length;a++)b=this.items[a],f=b.hasFlexibleHeight?this.height:b.height,d=b.hasFlexibleWidth?b.widthPolicy.expand?b.widthPolicy.size+b.widthPolicy.weight/e*g:b.widthPolicy.size:b.width,b.x=c,c+=d+this.spacing,b.changeSize(d,f);c=-this.spacing;for(a=e=0;a<this.items.length;a++)b=this.items[a],"number"===
typeof b.minWidth&&(c+=b.minWidth),c+=this.spacing,"number"===typeof b.minHeight&&b.minHeight>e&&(e=b.minHeight);this.minWidth=c;this.minHeight=e;this.width<this.minWidth&&this.changeSize(this.minWidth,this.height);this.height<this.minHeight&&this.changeSize(this.width,this.minHeight);this.forming=!1}});
jayus.vBox=jayus.Box.extend({toObject:function(){var a=jayus.Box.prototype.toObject.call(this);a.type="vBox";return a},listItemAdded:function(a,b){"object"!==typeof b.heightPolicy&&(b.heightPolicy=new jayus.SizePolicy);b.setParent(this);this.dirty(127)},listItemsAdded:function(a,b){var c,d;for(c=0;c<b.length;c++)d=b[c],"object"!==typeof d.heightPolicy&&(d.heightPolicy=new jayus.SizePolicy),d.setParent(this);this.dirty(127)},formContents:function(){if(!this.forming){this.forming=!0;var a,b,c=0,d=this.height-
(this.items.length-1)*this.spacing,e=0,f=0;for(a=0;a<this.items.length;a++)b=this.items[a],b.heightPolicy.flexible?(f+=b.heightPolicy.size,b.heightPolicy.expand&&(e+=b.heightPolicy.weight)):f+=b.height;var g=d-f;for(a=0;a<this.items.length;a++)b=this.items[a],d=this.width,f=b.heightPolicy.flexible?b.heightPolicy.expand?b.heightPolicy.size+b.heightPolicy.weight/e*g:b.heightPolicy.size:b.height,b.y=c,c+=f+this.spacing,b.setSize(d,f);c=0;e=-this.spacing;for(a=0;a<this.items.length;a++)b=this.items[a],
e+=this.spacing,"number"===typeof b.minWidth&&b.minWidth>e&&(c=b.minWidth),"number"===typeof b.minHeight&&(e+=b.minHeight);this.minWidth=c;this.minHeight=e;this.width<this.minWidth&&this.changeSize(this.minWidth,this.height);this.height<this.minHeight&&this.changeSize(this.width,this.minHeight);this.forming=!1}}});jayus.TiledMap=jayus.RectEntity.extend({filepath:"",map:null,tileWidth:0,tileHeight:0,layerVisibility:null,mapLoaded:!1,tilesetsLoaded:!1,loaded:!1,pendingLoad:!1,init:function(a){jayus.Entity.prototype.init.apply(this);arguments.length&&this.setMap(a)},setMap:function(a){var b,c,d;if("string"===typeof a){this.filepath=a;if(!jayus.objects.isLoaded(a))return this.loaded=this.mapLoaded=!1,this.pendingLoad=!0,b=this,jayus.objects.whenLoaded(a,function(a){b.pendingLoad=!1;b.setMap(a.object)}),this;a=
jayus.objects.get(a)}this.map=a;b=this;a=[];for(c=0;c<this.map.tilesets.length;c++)d=this.map.tilesets[c],a.push(d.image),jayus.images.whenLoaded(d.image,function(a){"object"!==typeof a.image.sheet&&(new jayus.SpriteSheet(a.filepath)).setSpriteSize(d.tilewidth,d.tileheight);b.dirty(127)});this.setSize(this.map.width*this.map.tilewidth,this.map.height*this.map.tileheight);this.layerVisibility=[];for(c=0;c<this.map.layers.length;c++)this.layerVisibility.push(this.map.layers[c].visible);this.mapLoaded=
!0;this.loaded=!1;jayus.images.whenLoaded(a,function(){b.tilesetsLoaded=!0;b.loaded=!0;b.fire("loaded")});return this},whenLoaded:function(a){this.loaded?a.apply(this):this.addHandler("loaded",function(b,c){a.apply(this);c.remove=!0});return this},getTileAt:function(a,b){return 1===arguments.length?this.getTileAt(a.x,a.y):new jayus.Point(Math.floor((a-this.x)/this.map.tilewidth),Math.floor((b-this.y)/this.map.tileheight))},getSlotFrame:function(a,b){return 1===arguments.length?this.getSlotFrame(a.x,
a.y):new jayus.Rectangle(this.x+a*this.map.tilewidth,this.y+b*this.map.tileheight,this.map.tilewidth,this.map.tileheight)},isLayerVisible:function(a){return this.layerVisibility[a]},setLayerVisibility:function(a,b){this.layerVisibility[a]!==b&&(this.layerVisibility[a]=b,this.dirty(127));return this},showLayer:function(a){return this.setLayerVisibility(a,!0)},hideLayer:function(a){return this.setLayerVisibility(a,!1)},paintContents:function(a){var b,c;for(b=0;b<this.map.tilesets.length;b++)if(c=this.map.tilesets[b],
!jayus.images.isLoaded(c.image)){console.error('TiledMap.paintContents() - Tileset "'+c.image+'" not yet loaded');return}c=this.map.tilesets[0];var d=jayus.images.get(c.image),e=d.sheet.marginX,f=d.sheet.marginY,g=d.sheet.spriteWidth,h=d.sheet.spriteHeight,k=c.imagewidth/g,l,n,m,p;for(b=0;b<this.map.layers.length;b++)if(c=this.map.layers[b],"tilelayer"===c.type&&this.layerVisibility[b])for(l=c.height-1;0<=l;l--)for(n=c.width-1;0<=n;n--)m=c.data[l*c.width+n]-1,-1!==m&&(p=m%k,m=(m-p)/k,a.drawImage(d,
e+p*g,f+m*h,g,h,n*g,l*h,g,h))}});
