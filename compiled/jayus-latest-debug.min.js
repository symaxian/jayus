/*


 Copyright ? 2011 Jonathon Reesor

 This file is part of Jayus.

 Jayus is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 Jayus is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with Jayus.  If not, see <http://www.gnu.org/licenses/>.
*/
window.EquationParser=function(){var h={applyRule:function(a,c,f){var d,b,e,g;for(d=1;d<a.length;d++)if(g=a[d],g===c||g===f){b=a[d-1];e=a[d+1];if(43===g)b+=e;else if(45===g)b-=e;else if(42===g)b*=e;else if(47===g){if(0===e)throw"Division by zero";b/=e}else throw"Invalid argument";a.splice(d-1,3,b);d=-1}},parse:function(a){for(var c,f,d,b=[],e=0;-1!==a.indexOf("(")&&-1!==a.indexOf(")");)for(c=a.indexOf("(");c<a.length;c++)if(f=a.charCodeAt(c),40===f&&(e=c+1),40===f||41===f)40===d&&(41===f&&(a=a.substr(0,
e-1)+h.parse(a.substr(e,c-e))+a.substr(c+1))),d=f;for(c=1;c<a.length;c++)if(f=a.charCodeAt(c),43===f||(45===f||(42===f||47===f)))d=a.charCodeAt(c-1),43!==d&&(45!==d&&(42!==d&&(47!==d&&(b.push(Number(a.substr(e,c-e)),f),e=c+1))));if(0===b.length)return Number(a);0<e&&b.push(Number(a.substr(e)));h.applyRule(b,42,47);h.applyRule(b,43,45);return b.length?b[0]:0}};return h}();var jayus;
(function(){window.jayus={running:false,frameIntervalRunning:false,lastFrameTime:0,lastStepTime:0,frameInterval:null,stepInterval:null,useReqAnimFrame:true,framerate:60,steprate:60,displays:[],hasFocus:false,focusedDisplay:null,cursorFocus:null,animators:[],frameEventData:{},fontCache:{},fontCacheMaxChar:255,copyObject:function jayus_copyObject(src){this.debug.match("jayus.copyObject",src,"src",5);return this.applyObject(src,{})},applyObject:function jayus_applyObject(src,dest){this.debug.matchArguments("jayus.applyObject",
arguments,"src",5,"dest",5);for(var item in src)if(src.hasOwnProperty(item))dest[item]=src[item];return dest},createClass:function jayus_createClass(props){if(typeof props.init!=="function")props.init=function(){};var constructor=props.init;constructor.prototype=props;constructor.init=function HelperInit(object,args){constructor.prototype.init.apply(object,args)};constructor.extend=window.jayus.extendMethod;constructor.fromObject=window.jayus.fromObjectMethod;return constructor},extendMethod:function jayus_extendMethod(props){var constructor;
if(typeof props.init==="function")constructor=props.init;else if(typeof this.prototype.init==="function")constructor=function(){this.init.apply(this,arguments)};else constructor=function(){};constructor.prototype=Object.create(this.prototype);jayus.applyObject(props,constructor.prototype);constructor.init=function HelperInit(object,args){constructor.prototype.init.apply(object,args)};constructor.extend=window.jayus.extendMethod;constructor.fromObject=window.jayus.fromObjectMethod;return constructor},
fromObjectMethod:function Constructor_fromObject(obj){var entity=new this;entity.initFromObject(obj);return entity},parse:function jayus_parse(obj){if(typeof obj.frozen==="number")return obj;var type=obj.type;if(typeof jayus[type]!=="function")throw new Error("jayus.parse() - Unknown class "+type+", check the type property");var ret=new jayus[type];ret.initFromObject(obj);return ret},groupToObject:function Group_toObject(object){if(this.propagateCursor!==true)object.propagateCursor=this.propagateCursor;
if(this.children!==jayus.Group.children){object.children=[];for(var i=0;i<this.items.length;i++)object.children.push(this.items[i].toObject())}},groupInitFromObject:function Group_initFromObject(object){if(typeof object.propagateCursor==="boolean")this.propagateCursor=object.propagateCursor;if(typeof object.children==="object"){this.children=new jayus.List(this);this.items=this.children.items;this.freeze();for(var i=0;i<object.children.length;i++){var child=object.children[i];this.children.add(jayus.parse(child))}this.unfreeze()}},
executeFormula:function jayus_executeFormula(object,eq){if(eq.indexOf("parent")>=0){if(object.parent===null){console.error("jayus.executeFormula() - Parent property in formula, entity has no parent, returning 0",object,eq);return 0}eq=eq.replace(/parent.x/g,object.parent.x).replace(/parent.y/g,object.parent.y).replace(/parent.width/g,object.parent.width).replace(/parent.height/g,object.parent.height)}if(eq.indexOf("domain")>=0){if(object.parent===null){console.error("jayus.executeFormula() - Domain property in formula, entity has no parent, returning 0",
object,eq);return 0}eq=eq.replace(/domain.width/g,object.domainWidth).replace(/domain.height/g,object.domainHeight)}var answer=window.EquationParser.parse(eq.replace(/x/g,object.x).replace(/y/g,object.y).replace(/width/g,object.width).replace(/height/g,object.height));if(typeof answer==="string"){console.error('jayus.executeFormula() - Unknown error: "'+answer+'", returning 0');return 0}return answer},declareChildrenAsProperties:true,keepTrackOfObjects:false,identifiedObjects:[],getObject:function jayus_getObject(id){for(var i=
0;i<this.identifiedObjects.length;i++){var object=this.identifiedObjects[i];if(object.id===id)return object}return null},mustGetObject:function jayus_mustGetObject(id){var object=this.getObject(id);if(object===null)throw new Error('jayus.mustGetObject() - Object with id "'+id+'" not found');return object},getUrlParameters:function jayus_getUrlParameters(){for(var i=0,vars={},param,paramArray=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");i<paramArray.length;i++){param=
paramArray[i].split("=");vars[param[0]]=param[1]}return vars},init:function jayus_init(){var elem=document.createElement("canvas");if(!(typeof elem.getContext==="function"&&typeof elem.getContext("2d")==="object"))throw new Error("Fatal error, browser does not support the canvas element, unable to initiate Jayus");this.applyObject(this.Responder.prototype,this);this.addDefaultHandlers();this.ua=this.detectBrowser();this.ua.lineDash=typeof this.getContext().setLineDash==="function";window.requestAnimationFrame=
window.requestAnimationFrame||(window.webkitRequestAnimationFrame||(window.mozRequestAnimationFrame||(window.oRequestAnimationFrame||window.msRequestAnimationFrame)));this.ua.requestAnimationFrame=typeof window.requestAnimationFrame==="function";this.keyboard.init();this.colors.cssNames=[];for(var i=0;i<this.colors.displayNames.length;i++)this.colors.cssNames.push(this.colors.displayNames[i].replace(" ","").replace(" ","").toLowerCase());this.initialized=true},detectBrowser:function jayus_detectBrowser(){var browserData=
[{src:navigator.userAgent,str:"Chrome",id:"Chrome"},{src:navigator.userAgent,str:"OmniWeb",ver:"OmniWeb/",id:"OmniWeb"},{src:navigator.vendor,str:"Apple",id:"Safari",ver:"Version"},{prop:window.opera,id:"Opera",ver:"Version"},{src:navigator.vendor,str:"iCab",id:"iCab"},{src:navigator.vendor,str:"KDE",id:"Konqueror"},{src:navigator.userAgent,str:"Firefox",id:"Firefox"},{src:navigator.vendor,str:"Camino",id:"Camino"},{src:navigator.userAgent,str:"Netscape",id:"Netscape"},{src:navigator.userAgent,str:"MSIE",
id:"Explorer",ver:"MSIE"},{src:navigator.userAgent,str:"Gecko",id:"Mozilla",ver:"rv"},{src:navigator.userAgent,str:"Mozilla",id:"Netscape",ver:"Mozilla"}];var osData=[{src:navigator.platform,str:"Win",id:"Windows"},{src:navigator.platform,str:"Mac",id:"Mac"},{src:navigator.userAgent,str:"iPhone",id:"iPhone/iPod"},{src:navigator.platform,str:"Linux",id:"Linux"}];var verString;var searchString=function(data){for(var i=0;i<data.length;i++){var dataString=data[i].src;verString=data[i].ver||data[i].id;
if(dataString){if(dataString.indexOf(data[i].str)!==-1)return data[i].id}else if(data[i].prop)return data[i].id}};var searchVersion=function(dataString){var index=dataString.indexOf(verString);if(index!==-1)return parseFloat(dataString.substring(index+verString.length+1))};return{browser:searchString(browserData)||null,version:searchVersion(navigator.userAgent)||(searchVersion(navigator.appVersion)||null),OS:searchString(osData)||null}},start:function jayus_start(){if(!this.initialized){console.error("jayus.start() - Jayus is not initialized");
return}if(!this.running){this.running=true;if(!this.useReqAnimFrame||!this.ua.requestAnimationFrame)this.frameInterval=setInterval(jayus.frame,1E3/this.framerate);else if(!this.frameIntervalRunning){this.lastFrameTime=Date.now();this.lastStepTime=Date.now();this.frameIntervalRunning=true;this.frame()}this.stepInterval=setInterval(jayus.step,1E3/this.steprate)}else console.warn("jayus.start() - Jayus is already running")},stop:function jayus_stop(){if(this.running){this.running=false;clearInterval(this.frameInterval);
clearInterval(this.stepInterval);this.frameInterval=null;this.stepInterval=null}else console.warn("jayus.stop() - Called when not running")},step:function jayus_step(){if(jayus.running){jayus.chart.begin("Frame");var i,item,now=Date.now(),elapsedMilliSecs=now-jayus.lastStepTime,elapsedSecs=elapsedMilliSecs/1E3;jayus.lastStepTime=now;if(!jayus.isHandler.step||!jayus.fire("step",elapsedSecs)){jayus.chart.begin("Cursor");for(i=0;i<jayus.displays.length;i++){item=jayus.displays[i];if(item.hasPendingMousemoveEvent){item.processPendingMousemove();
item.hasPendingMousemoveEvent=false}}jayus.chart.end();jayus.chart.begin("Animation");for(i=0;i<jayus.animators.length;i++)jayus.animators[i].tick(now,elapsedSecs);jayus.chart.end();if(jayus.box2d.enabled)jayus.box2d.step(elapsedSecs);jayus.chart.update()}jayus.chart.end()}},frame:function jayus_frame(){if(jayus.running){jayus.chart.begin("Frame");if(jayus.useReqAnimFrame&&jayus.ua.requestAnimationFrame)window.requestAnimationFrame(jayus.frame);var i,item,now=Date.now(),elapsedMilliSecs=now-jayus.lastFrameTime;
jayus.fps=1E3/elapsedMilliSecs;jayus.lastFrameTime=now;if(!jayus.isHandler.frame||!jayus.fire("frame",elapsedMilliSecs/1E3)){jayus.chart.begin("Render");for(i=0;i<jayus.displays.length;i++){jayus.chart.begin("Display: "+i);item=jayus.displays[i];if(item.dirtied)item.refreshBuffer();jayus.chart.end()}if(jayus.box2d.enabled){jayus.chart.begin("Box2D Debug");jayus.box2d.drawDebug();jayus.chart.end()}jayus.chart.end();jayus.chart.update()}jayus.chart.end()}else jayus.frameIntervalRunning=false},addDefaultHandlers:function jayus_addDefaultHandlers(){jayus.isHandler=
{step:false,frame:false};jayus.addHandler("keyPress",function(e){if(e.key==="grave"&&e.event.ctrlKey){if(jayus.chart.visible)jayus.chart.hide();else jayus.chart.show();return true}})},manuallyDrawImage:function jayus_manuallyDrawImage(source,destination,width,height){if(typeof destination.imageSmoothingEnabled==="boolean"){var prev=destination.imageSmoothingEnabled;destination.imageSmoothingEnabled=false;destination.drawImage(source.canvas,0,0);destination.imageSmoothingEnabled=prev}else{var data=
source.getImageData(0,0,width,height).data,x,y,pos;for(y=height-1;y>=0;y--)for(x=width-1;x>=0;x--){pos=4*(x+width*y);destination.fillStyle="rgba("+data[pos]+","+data[pos+1]+","+data[pos+2]+","+data[pos+3]/255+")";destination.fillRect(x,y,1,1)}}},chart:{markColor:"grey",markFont:"10px sans-serif",display:null,graphSurface:null,topMS:40,index:0,width:400,height:380,visible:false,initialized:false,windowSize:120,windowIndex:0,rootRoutine:null,currentRoutine:null,timeLabelColumnWidth:30,TIME_LABEL_COLUMN_WIDTH_PADDING:8,
TOP_STACK_HEIGHT:20,CHILD_ROW_SPACING:8,LATENCY_DISPLAY_THRESHOLD:0.5,MAX_ROUTINE_DEPTH:8,defaultRoutineColors:{"Total Latency":"grey","Render":"saddlebrown","Box2d":"blue","Cursor":"Chartreuse","Animation":"orange","DebugPanel":"yellow"},init:function jayus_chart_init(){this.display=jayus.parse({type:"Display",id:"DebugPanelDisplay",width:this.width,height:this.height,children:[{id:"vBox",type:"vBox",constraints:{width:"parent.width",height:"parent.height"},children:[{id:"TopRow",type:"Scene",constraints:{width:"parent.width"},
height:30,heightPolicy:{type:"SizePolicy",size:30,expand:false,flexible:false},bg:{fill:{type:"LinearGradient",start:{x:0,y:0},end:{x:0,y:30},stopPositions:[0,1],stopColors:["#DDD","#CCC"]}},children:[{type:"Text",id:"fpsLabel",font:"12px sans-serif",x:0,y:4,brush:{fill:"#111"}}]},{id:"Graph",type:"Scene",children:[{id:"graphSurface",type:"Surface",constraints:{width:"parent.width",height:"parent.height"}},{id:"line16ms",type:"PaintedShape",brush:{stroke:"dimgrey"},shape:new jayus.Polygon.Line(0,
0,0,0)},{id:"line33ms",type:"PaintedShape",brush:{stroke:"dimgrey"},shape:new jayus.Polygon.Line(0,0,0,0)},{id:"text16ms",type:"Text",font:"10px sans-serif",brush:{fill:"dimgrey"}},{id:"text33ms",type:"Text",font:"10px sans-serif",brush:{fill:"dimgrey"}}]},{type:"FlexibleFrame",id:"RoutineBoxFrame",marginLeft:2,marginRight:2,marginTop:8,marginBottom:8,constraints:{width:"parent.width"},bg:{fill:"white"},child:{id:"RoutineBox",type:"vStack",constraints:{width:"parent.width"},spacing:8}}]}]});jayus.displays.splice(jayus.displays.indexOf(this.display),
1);this.vBox=this.display.children.find("vBox");this.topRow=this.display.children.find("TopRow");this.graph=this.display.children.find("Graph");this.routineBox=this.display.children.find("RoutineBox");this.graphSurface=this.display.children.find("graphSurface");this.fpsLabel=this.topRow.children.find("fpsLabel");this.fpsLabel.ignoreDirty++;setInterval(function(){var label=jayus.chart.fpsLabel;var fps=Math.round(jayus.fps*10)/10+"";if(fps.length===2)fps+=".0";label.setText("Framerate: "+fps);label.setX(label.parent.width-
4-label.width)},100);var line16ms=this.display.children.find("line16ms"),line33ms=this.display.children.find("line33ms"),text16ms=this.display.children.find("text16ms"),text33ms=this.display.children.find("text33ms"),updateLabel=function GraphLabelUpdater(ms,line,text){var y=jayus.chart.graph.height-ms/jayus.chart.topMS*jayus.chart.graph.height;line.shape.setPoint(0,0,Math.floor(y)+0.5);line.shape.setPoint(1,jayus.chart.graph.width,Math.floor(y)+0.5);text.setText(ms+" ms");text.setOrigin(4,y-12)};
line16ms.ignoreDirty++;line33ms.ignoreDirty++;text16ms.ignoreDirty++;text33ms.ignoreDirty++;this.graph.addHandler("dirty",function(dirty){if(dirty&4){updateLabel(16,line16ms,text16ms);updateLabel(33,line33ms,text33ms)}if(jayus.chart.rootRoutine!==null)jayus.chart.rootRoutine.setFrameCount(jayus.chart.graphSurface.width)});this.graph.dirty(4);var div=document.createElement("div");var canvas=this.display.canvas;canvas.style.border="#aaa 1px solid";canvas.style.backgroundColor="black";div.appendChild(canvas);
$(div).dialog({title:"Jayus Debug Panel",open:function(){$(this).data("width.dialog",$(canvas).width()+60)},resize:function(){jayus.chart.display.setWidth($(jayus.chart.dialogContainer).width()-4);jayus.chart.display.setHeight($(jayus.chart.dialogContainer).height()-30);return false},close:function(){jayus.chart.visible=false}});jayus.chart.dialog=div.parentNode;jayus.chart.dialogContainer=jayus.chart.dialog.childNodes[1];this.initialized=true},getRoutineColor:function jayus_chart_getRoutineColor(name){if(typeof this.defaultRoutineColors[name]===
"string")return this.defaultRoutineColors[name];return jayus.colors.cssNames[jayus.math.randomBetween(0,jayus.colors.count-1)]},begin:function jayus_chart_begin(name){if(this.initialized){var data;if(this.rootRoutine===null){this.rootRoutine=this.createRoutineDataObject("Total Latency",null);this.currentRoutine=this.rootRoutine;this.routineBox.children.add(this.rootRoutine.entity)}if(name==="Frame")data=this.rootRoutine;else{data=this.currentRoutine.children[name];if(data===undefined){data=this.createRoutineDataObject(name);
this.currentRoutine.childrenStack.children.add(data.entity);this.currentRoutine.children[name]=data}this.currentRoutine=data}data.startTime=Date.now()}},end:function jayus_chart_end(){var time,data;if(this.initialized){data=this.currentRoutine;time=Date.now()-data.startTime;data.time+=time;data.latencies[this.index]=time;if(data!==this.rootRoutine)this.currentRoutine=data.parent}},createRoutineDataObject:function jayus_chart_createRoutineDataObject(name,parent){var data={name:name,latencies:[],inits:[],
averageLatency:0,initTotal:0,color:this.getRoutineColor(name),parent:this.currentRoutine,children:{},sortedRoutineNames:[],depth:0};if(this.currentRoutine!==null)data.depth=this.currentRoutine.depth+1;if(data.parent!==null)data.parent.sortedRoutineNames.push(data.name);for(var i=0;i<this.graphSurface.width;i++)data.latencies.push(0);var x;if(data.parent===null)x=0;else x=20;data.entity=jayus.parse({type:"Scene",x:x,parent:parent,constraints:{width:"parent.width - x - 2"},heightPolicy:{type:"SizePolicy",
expand:true},bg:{fill:"#BBB",stroke:"black",lineWidth:2},children:[{type:"Scene",x:1,y:1,height:20,constraints:{width:"parent.width"},bg:{},children:[{id:"label",type:"Text",text:name,font:"12px sans-serif",brush:{fill:"black"},constraints:{y:"parent.height/2 - height/2"}},{id:"bar",type:"Scene",bg:{fill:data.color},width:10,constraints:{height:"parent.height - 2"}},{id:"timeLabel",type:"Text",text:"0 ms",font:"12px sans-serif",brush:{fill:"black"},constraints:{y:"parent.height/2 - height/2"}}]},
{id:"childrenStack",type:"vStack",visible:true,x:0,y:20+8,height:300,spacing:8,constraints:{width:"parent.width"}}]});data.label=data.entity.find("label");data.bar=data.entity.find("bar");data.timeLabel=data.entity.find("timeLabel");data.childrenStack=data.entity.find("childrenStack");data.label.ignoreDirty++;data.bar.ignoreDirty++;data.timeLabel.ignoreDirty++;data.bar.addHandler("leftClick",function(){data.color=jayus.chart.getRoutineColor(data.name);this.bg.setFill(data.color)});data.showChildren=
true;data.label.data=data;data.label.handle({cursorOver:function(){this.setBg({fill:"white"})},cursorOut:function(){this.clearBg()},leftClick:function(){this.data.showChildren=!this.data.showChildren}});data.setFrameCount=function(count){for(var i=count-1;i>=0;i--)this.latencies[i]=-1;for(var routine in this.children)this.children[routine].setFrameCount(count)};data.update=function(){if(this.depth>jayus.chart.MAX_ROUTINE_DEPTH)return;var i,routine,childData,width,val,total,count,labelColumnWidth=
0,childrenVisible=false;total=0;count=0;for(i=0;i<this.latencies.length-1;i++){val=this.latencies[i];if(val!==-1){total+=val;count++}}this.averageLatency=total/count;for(routine in this.children){childData=this.children[routine];width=childData.label.width;if(width>labelColumnWidth)labelColumnWidth=width}for(routine in this.children){childData=this.children[routine];childData.labelColumnWidth=labelColumnWidth;childData.update();width=childData.timeLabel.width;if(width+8>jayus.chart.timeLabelColumnWidth)jayus.chart.timeLabelColumnWidth=
width+8;if(childData.entity.visible)childrenVisible=true}this.entity.averageLatency=this.averageLatency;this.entity.setVisible(this.averageLatency>=0.5);this.entity.setIncluded(this.averageLatency>=0.5);this.childrenVisible=childrenVisible&&this.showChildren;if(this.entity.visible){this.timeLabel.setText(Math.round(this.averageLatency*10)/10+" ms");this.entity.children.at(0).setHeight(20);this.entity.children.at(1).setVisible(this.childrenVisible);this.entity.children.at(1).setIncluded(this.childrenVisible);
if(this.childrenVisible){this.entity.setHeight(this.entity.children.at(0).height+8+this.entity.children.at(1).height);var children=this.children;this.sortedRoutineNames.sort(function(a,b){return children[a].averageLatency<children[b].averageLatency});this.childrenStack.children.sort(function(a,b){return a.averageLatency<b.averageLatency})}else this.entity.setHeight(this.entity.children.at(0).height);if(this===jayus.chart.rootRoutine)labelColumnWidth=this.label.width;else labelColumnWidth=this.labelColumnWidth;
labelColumnWidth+=10;this.label.setX(labelColumnWidth-this.label.width-4);this.bar.setX(labelColumnWidth);width=this.entity.parent.width-labelColumnWidth-jayus.chart.timeLabelColumnWidth-4;if(this!==jayus.chart.rootRoutine)width*=this.averageLatency/this.parent.averageLatency;if(!isNaN(width)&&isFinite(width))this.bar.setWidth(width);this.timeLabel.setX(this.entity.width-this.timeLabel.width-4)}};data.drawBars=function(ctx,y){var totalHeight=Math.floor(this.time/jayus.chart.topMS*jayus.chart.graph.height),
childrenHeight=0,selfHeight,temp;if(this.childrenVisible){var routineNames=this.sortedRoutineNames;for(i=0;i<routineNames.length;i++){data=this.children[routineNames[i]];if(data.entity.visible){temp=data.drawBars(ctx,y);y-=temp;childrenHeight+=temp}}}selfHeight=totalHeight-childrenHeight;ctx.fillStyle=this.color;ctx.fillRect(jayus.chart.index,y-selfHeight,1,selfHeight-0.5);this.time=0;return totalHeight};return data},tallyInit:function jayus_chart_tallyInit(type){},show:function jayus_chart_show(){if(!this.initialized)this.init();
this.visible=true;$(jayus.chart.dialog).show();jayus.fire("debugPanelShown")},hide:function jayus_chart_hide(){if(this.initialized&&this.visible){$(jayus.chart.dialog).hide();this.graphSurface.clear();this.index=0;this.visible=false}jayus.fire("debugPanelHidden")},mark:function jayus_chart_mark(text){if(this.visible){var ctx=this.graphSurface.context,metrics=jayus.getTextMetrics(text,this.markFont);ctx.fillStyle=this.markColor;ctx.fillRect(this.index,0,1,this.graph.height-0.5);ctx.fillText(text,this.index-
metrics.width-2,metrics.ascent)}},update:function jayus_chart_update(){if(this.visible){this.begin("DebugPanel");var ctx=this.graphSurface.context,y=this.graphSurface.height,i,data,routineNames,height;if(this.display.hasPendingMousemoveEvent){this.begin("MouseMoveEvent");this.display.processPendingMousemove();this.end()}this.begin("UpdateRoutineTable");this.rootRoutine.update();this.end();this.begin("Rendering");this.rootRoutine.drawBars(ctx,this.graphSurface.height);ctx.clearRect(this.index+1,0,
2,this.graph.height);this.index++;if(this.index>=this.graph.width)this.index=-1;this.display.refreshBuffer();this.end();this.end()}}},cacheFont:function jayus_cacheFont(font){this.debug.match("jayus.cacheFont",font,"font",2);var i,ctx,charWidths,descriptor;if(!this.isFontCached(font)){charWidths=[];ctx=this.getContext();ctx.save();ctx.font=font;for(i=0;i<this.fontCacheMaxChar+1;i++)charWidths[i]=ctx.measureText(String.fromCharCode(i)).width;ctx.restore();descriptor=this.getVerticalFontMetrics(font);
descriptor.charWidths=charWidths;this.fontCache[font]=descriptor}},cacheFonts:function jayus_cacheFonts(fonts){this.debug.matchArray("jayus.cacheFonts",fonts,"fonts",2);for(var i=0;i<fonts.length;i++)this.cacheFont(fonts[i])},isFontCached:function jayus_isFontCached(font){this.debug.match("jayus.isFontCached",font,"font",2);return typeof this.fontCache[font]==="object"},getFontDescriptor:function jayus_getFontDescriptor(font){this.debug.match("jayus.getFontDescriptor",font,"font",2);if(!this.isFontCached(font))this.cacheFont(font);
return this.fontCache[font]},getTextMetrics:function jayus_getTextMetrics(text,font){this.debug.matchArguments("jayus.getTextMetrics",arguments,"text",2,"font",2);if(typeof this.fontCache[font]!=="object")this.cacheFont(font);var descriptor=jayus.fontCache[font],charWidths=descriptor.charWidths,i,width=0;for(i=text.length-1;i>=0;i--)width+=charWidths[text.charCodeAt(i)];return{width:width,ascent:descriptor.ascent,descent:descriptor.descent,height:descriptor.height}},getTextWidth:function jayus_getTextWidth(text,
font){this.debug.matchArguments("jayus.getTextWidth",arguments,"text",2,"font",2);if(typeof this.fontCache[font]!=="object")this.cacheFont(font);var charWidths=jayus.fontCache[font].charWidths,i,width=0;for(i=text.length-1;i>=0;i--)width+=charWidths[text.charCodeAt(i)];return width},getVerticalFontMetrics:function jayus_getVerticalFontMetrics(font){var result={},text=document.createElement("span"),block=document.createElement("div"),div=document.createElement("div");text.style.font=font;text.innerText=
"Hg";block.style.display="inline-block";block.style.width="1px";block.style.height="0";div.appendChild(text);div.appendChild(block);document.body.appendChild(div);try{block.style.verticalAlign="baseline";result.ascent=block.offsetTop-text.offsetTop;block.style.verticalAlign="bottom";result.height=block.offsetTop-text.offsetTop;result.descent=result.height-result.ascent}finally{document.body.removeChild(div)}return result},box2d:{enabled:true,scale:0.5,worlds:[],velocityIterations:10,positionIterations:10,
physicalEntities:[],addWorld:function jayus_box2d_addWorld(world){jayus.debug.match("jayus.box2d.addWorld",world,"world",5);this.worlds.push(world)},removeWorld:function jayus_box2d_removeWorld(world){this.worlds.splice(this.worlds.indexOf(this.world),1)},step:function jayus_box2d_step(elapsedSecs){jayus.chart.begin("Box2d");var i,world;for(i=0;i<this.worlds.length;i++){world=this.worlds[i];world.Step(elapsedSecs,this.velocityIterations,this.positionIterations);world.ClearForces()}for(i=0;i<this.physicalEntities.length;i++)this.physicalEntities[i].updateFromBody();
jayus.chart.end()},drawDebug:function jayus_box2d_drawDebug(){for(var i=0;i<this.worlds.length;i++)this.worlds[i].DrawDebugData()}},getContext:function jayus_getContext(){if(this.displays.length)return this.displays[0].context;return document.createElement("canvas").getContext("2d")},TYPES:{DEFINED:0,BOOLEAN:1,STRING:2,FUNCTION:3,NUMBER:4,OBJECT:5,ARRAY:6,CONTEXT:7,COLOR:8,BRUSH:9,MATRIX:10,LIST:11,ENTITY:12,POINT:13,CIRCLE:14,POLYGON:15,PATH:16,SURFACE:17,SCENE:18,SHAPE:19,RECTANGLE:20,BUFFER:21,
ANIMATOR:22,CANVAS:23},debug:{pauseOnEscape:true,types:["undefined","boolean","string","function","number","object","array","Context","Color","Brush","Matrix","List","Entity","Point","Circle","Polygon","Path","Surface","Scene","Shape","Rectangle","Buffer","Animator","Canvas"],is:function jayus_debug_is(type,v){switch(type){case 0:return typeof v!=="undefined";case 1:return typeof v==="boolean";case 2:return typeof v==="string";case 3:return typeof v==="function";case 4:return typeof v==="number"&&
!isNaN(v);case 5:return typeof v==="object"&&v!==null;case 6:return v instanceof Array;case 7:return v instanceof CanvasRenderingContext2D;case 9:return typeof v==="object";case 8:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:return typeof v==="object"&&v instanceof jayus[jayus.debug.types[type]];case 19:return this.is(13,v)||(this.is(20,v)||(this.is(14,v)||(this.is(15,v)||this.is(16,v))));case 20:return v instanceof jayus.Rectangle||typeof v.x==="number"&&typeof v.width===
"number";case 21:if(typeof ImageData==="function")return v instanceof ImageData;return this.is(5,v)&&(this.is(4,v.width)&&(this.is(4,v.height)&&this.is(6,v.data)));case 22:return!!v.isAnimator;case 23:return v instanceof HTMLCanvasElement}throw new Error("jayus.debug.is() - Unknown type("+jayus.debug.types[type]+") specified");},match:function jayus_debug_match(method,value,name,type){if(!this.is(type,value))throw new TypeError(method+"() - Invalid parameter "+name+this.toString(value)+" sent, "+
jayus.debug.types[type]+" required");},matchOptional:function jayus_debug_matchOptional(method,value,name,type){if(typeof value!=="undefined"&&!this.is(type,value))throw new TypeError(method+"() - Invalid optional parameter "+name+this.toString(value)+" sent, "+jayus.debug.types[type]+" required");},matchArray:function jayus_debug_matchArray(method,value,name,type){if(!this.is(6,value))throw new TypeError(method+"() - Invalid parameter "+name+this.toString(value)+" sent, Array of "+jayus.debug.types[type]+
" required");for(var i=0;i<value.length;i++)if(!this.is(type,value[i]))throw new TypeError(method+"() - Invalid parameter "+name+this.toString(value)+" array sent, element at "+i+"("+value[i]+") is required to be "+jayus.debug.types[type]);},matchArguments:function jayus_debug_matchArguments(name,args){var i,paramName,argValue,paramType;for(i=2;i<arguments.length;i+=2){argValue=args[i/2-1];paramName=arguments[i];paramType=arguments[i+1];if(!this.is(paramType,argValue))throw new TypeError(name+"() - Invalid "+
paramName+this.toString(argValue)+" sent, "+jayus.debug.types[paramType]+" required");}},matchArgumentsAs:function jayus_debug_matchArgumentsAs(name,args,type){var i,paramName,argValue;for(i=3;i<arguments.length;i++){argValue=args[i-3];paramName=arguments[i];if(!this.is(type,argValue))throw new TypeError(name+"() - Invalid "+paramName+this.toString(argValue)+" sent, "+jayus.debug.types[type]+" required");}},matchContext:function jayus_debug_matchContext(method,value){if(!this.is(7,value))throw new TypeError(method+
"() - Invalid parameter ctx"+this.toString(value)+" sent, Context required");},matchCoordinate:function jayus_debug_matchCoordinate(method,x,y){if(!this.is(13,x)&&!this.is(4,x))throw new TypeError(method+"() - Invalid parameter x"+this.toString(x)+" sent, Point or Number required");if(this.is(4,x)&&!this.is(4,y))throw new TypeError(method+"() - Invalid parameter y"+this.toString(y)+" sent, Number required");},matchSize:function jayus_debug_matchSize(method,x,y){if(!this.is(12,x)&&!this.is(4,x))throw new TypeError(method+
"() - Invalid parameter width"+this.toString(x)+" sent, Entity or Number required");if(this.is(4,x)&&!this.is(4,y))throw new TypeError(method+"() - Invalid parameter height"+this.toString(y)+" sent, Number required");},matchRectangle:function jayus_debug_matchRectangle(method,a,b,c,d){switch(arguments.length){case 3:return jayus.debug.matchArguments(method,[a,b],"origin",13,"entity",12);case 4:return jayus.debug.matchArguments(method,[a,b,c],"origin",13,"width",4,"height",4);case 5:return jayus.debug.matchArgumentsAs(method,
[a,b,c,d],4,"x","y","width","height")}throw new TypeError(method+"() - Invalid number of arguments sent, 2, 3, or 4 required");},verifyMethod:function jayus_debug_verifyMethod(object,method){this.matchArguments("jayus.debug.verifyMethod",arguments,"object",5,"method",2);if(!this.is(3,object[method])){console.log(object);throw new TypeError("jayus.debug.verifyMethod() - Object"+this.toString(object)+" does not have method "+method);}},toString:function jayus_debug_toString(v){switch(typeof v){case "undefined":return"(Undefined)";
case "boolean":return"(Boolean:"+v+")";case "number":return"(Number:"+v+")";case "string":return'(String:"'+v+'")';case "object":if(v===null)return"(null)";if(v instanceof Array)return"(Array:["+v+"])";if(typeof v.toString==="function")return v.toString();if(typeof v.toObject==="function")return JSON.stringify(v.toObject());return"(Object:"+v+")";case "function":return"(Function:"+v+")"}return"(Unknown)"},exposedOriginColor:"blue",exposedBoundsColor:"red",exposedScopeColor:"green",exposedFrameColor:"orange",
exposedTransformedDashing:[5,5],defaultDebugRenderer:function jayus_debug_defaultDebugRenderer(ctx){var item;ctx.save();ctx.lineWidth=1;if(this.shapeType===0){item=this.getBounds().alignToCanvas();item.etchOntoContext(ctx);ctx.strokeStyle=jayus.debug.exposedBoundsColor;ctx.stroke()}ctx.strokeStyle=jayus.debug.exposedScopeColor;item=this.getScope().alignToCanvas();ctx.strokeRect(item.x,item.y,item.width,item.height);if(typeof this.getFrame==="function"){item=this.getFrame().alignToCanvas();item.etchOntoContext(ctx);
ctx.strokeStyle=jayus.debug.exposedFrameColor;ctx.stroke();if(this.isTransformed){ctx.setLineDash(jayus.debug.exposedTransformedDashing);item=this.getUnFrame().alignToCanvas();ctx.strokeRect(item.x,item.y,item.width,item.height)}}ctx.restore()},showPoint:function jayus_debug_showPoint(display,x,y,duration){if(arguments.length===3)duration=1E3;var spec=new jayus.Scene(3,3);spec.setBg({fill:"red"});spec.setOrigin(x,y);spec.animate().setAlpha(0).setDuration(duration).addHandler("finished",function(){display.children.remove(spec)}).start();
display.children.add(spec)},pause:function jayus_debug_pause(){var i,display,ctx;if(jayus.running){jayus.stop();for(i=0;i<jayus.displays.length;i++){display=jayus.displays[i];ctx=display.context;ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.fillStyle="rgba(0, 0, 0, 0.5)";ctx.fillRect(0,0,display.width,display.height);ctx.fillStyle="white";ctx.font="24px sans-serif";ctx.textAlign="center";ctx.fillText("Paused",display.width/2,display.height/2);ctx.restore()}}else{for(i=0;i<jayus.displays.length;i++)jayus.displays[i].fullyRefreshBuffer();
jayus.start()}}},intersectTest:function jayus_intersectTest(a,b){var i,temp,ctx,ret,at=a.shapeType,bt=b.shapeType;while(!at){if(a.getBounds()===a)throw new Error("jayus.intersectTest() - a.getBounds() === a, indefinite loop would result");a=a.getBounds();at=a.shapeType}while(!bt){if(b.getBounds()===b)throw new Error("jayus.intersectTest() - b.getBounds() === b, indefinite loop would result");b=b.getBounds();bt=b.shapeType}if(at===-1){for(i=0;i<a.items.length;i++)if(this.intersectTest(a[i],b))return true;
return false}if(bt===-1){for(i=0;i<b.items.length;i++)if(this.intersectTest(a,b[i]))return true;return false}if(at>bt){temp=a;a=b;b=temp}switch(a.shapeType+b.shapeType){case 1+1:return a.x===b.x&&a.y===b.y;case 1+2:return b.intersectsAt(a.x,a.y);case 2+2:return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)<=(a.radius+b.radius)*(a.radius+b.radius);case 1+4:return b.intersectsAt(a.x,a.y);case 2+4:var x=2*Math.abs(a.x-(b.x+b.width/2)),y=2*Math.abs(a.y-(b.y+b.height/2));if(x>b.width+2*a.radius||y>b.height+2*
a.radius)return false;if(x<=b.width||y<=b.height)return true;return(x-b.width)*(x-b.width)+(y-b.height)*(y-b.height)<=4*a.radius*a.radius;case 4+4:return!(a.x+a.width<b.x||(a.y+a.height<b.y||(a.x>b.x+b.width||a.y>b.y+b.height)));case 1+8:return b.intersectsAt(a.x,a.y);case 2+8:return this.intersectsPolygonPolygon(a.toPolygon(),b);case 4+8:return this.intersectPolygonPolygon(a.toPolygon(),b);case 8+8:return this.intersectsPolygonPolygon(a,b);case 1+16:return b.intersectsAt(a.x,a.y);case 2+16:return this.intersectsPolygonPolygon(a.toPolygon(),
b.toPolygon());case 4+16:return this.intersectsPolygonPolygon(a.toPolygon(),b.toPolygon());case 8+16:return this.intersectsPolygonPolygon(a,b.toPolygon());case 16+16:return this.intersectsPolygonPolygon(a.toPolygon(),b.toPolygon())}},intersectLineLine:function jayus_intersectLineLine(a1,a2,b1,b2){jayus.debug.matchArgumentsAs("jayus.intersectLineLine",arguments,13,"a1","a2","b1","b2");var ua_t=(b2.x-b1.x)*(a1.y-b1.y)-(b2.y-b1.y)*(a1.x-b1.x),ub_t=(a2.x-a1.x)*(a1.y-b1.y)-(a2.y-a1.y)*(a1.x-b1.x),u_b=
(b2.y-b1.y)*(a2.x-a1.x)-(b2.x-b1.x)*(a2.y-a1.y);if(u_b!==0){var ua=ua_t/u_b,ub=ub_t/u_b;return 0<=ua&&(ua<=1&&(0<=ub&&ub<=1))}return ua_t===0||ub_t===0},intersectLinePolygon:function jayus_intersectLinePolygon(a1,a2,poly){jayus.debug.matchArguments("jayus.intersectLinePolygon",arguments,"a1",13,"a2",13,"poly",15);for(var i=poly.xPoints.length-1;i>=0;i--)if(this.intersectLineLine(a1,a2,poly.xPoints[i],poly.yPoints[i]))return true;return false},intersectPolygonPolygon:function jayus_intersectPolygonPolygon(poly1,
poly2){jayus.debug.matchArgumentsAs("jayus.intersectPolygonPolygon",arguments,15,"poly1","poly2");for(var i=poly1.xPoints.length-1;i>=0;i--)if(this.intersectLinePolygon(poly1.xPoints[i],poly1.yPoints[i],poly2))return true;return false},distance:function jayus_distance(a,b){this.debug.matchArgumentsAs("jayus.distance",arguments,13,"a","b");var x=a.x-b.x,y=a.y-b.y;return Math.sqrt(x*x+y*y)},math:{randomFrom:function jayus_math_randomFrom(array){jayus.debug.match("jayus.math.randomFrom",array,"array",
6);if(!array.length)throw new RangeError("jayus.math.randomFrom() - Invalid array"+jayus.debug.toString(array)+" sent, array or at least length 1 required");return array[this.randomBetween(0,array.length-1)]},randomBetween:function jayus_math_randomBetween(min,max){jayus.debug.matchArgumentsAs("jayus.math.randomBetween",arguments,4,"min","max");return min+Math.floor((max-min+1)*Math.random())},clamp:function jayus_math_clamp(min,num,max){jayus.debug.matchArgumentsAs("jayus.math.clamp",arguments,4,
"min","num","max");if(num<min)return min;if(num>max)return max;return num},min:function jayus_math_min(numbers){jayus.debug.matchArray("jayus.math.min",numbers,"numbers",4);if(!numbers.length)throw new RangeError("jayus.math.min() - Invalid numbers sent"+jayus.debug.toString(numbers)+", length of at least 1 required");var i,val,min=numbers[0];for(i=numbers.length-1;i>=1;i--){val=numbers[i];if(val<min)min=val}return min},max:function jayus_math_max(numbers){jayus.debug.matchArray("jayus.math.max",
numbers,"numbers",4);if(!numbers.length)throw new RangeError("jayus.math.max() - Invalid numbers sent"+jayus.debug.toString(numbers)+", length of at least 1 required");var i,val,max=numbers[0];for(i=numbers.length-1;i>=1;i--){val=numbers[i];if(val>max)max=val}return max},average:function jayus_math_average(numbers){jayus.debug.matchArray("jayus.math.average",numbers,"numbers",4);if(!numbers.length)throw new RangeError("jayus.math.average() - Invalid numbers sent"+jayus.debug.toString(numbers)+", length of at least 1 required");
var i,total=0;for(i=numbers.length-1;i>=1;i--)total+=numbers[i];return total/numbers.length},toDegrees:function jayus_math_toDegrees(angle){return angle*(180/Math.PI)},toRadians:function jayus_math_toRadians(angle){return angle*(Math.PI/180)},vFlipAngle:function jayus_math_vFlipAngle(angle){jayus.debug.match("jayus.math.vFlipAngle",angle,"angle",4);return 2*Math.PI-angle},hFlipAngle:function jayus_math_hFlipAngle(angle){jayus.debug.match("jayus.math.hFlipAngle",angle,"angle",4);angle=Math.PI-angle;
if(angle<0)angle+=2*Math.PI;return angle},getCwAngleBetween:function jayus_math_getCwAngleBetween(angle1,angle2){jayus.debug.matchArgumentsAs("jayus.math.getCwAngleBetween",arguments,4,"angle1","angle2");var distance=angle1-angle2;if(distance<0)distance+=2*Math.PI;return distance},getCcwAngleBetween:function jayus_math_getCcwAngleBetween(angle1,angle2){jayus.debug.matchArgumentsAs("jayus.math.getCcwAngleBetween",arguments,4,"angle1","angle2");var distance=angle2-angle1;if(distance<0)distance+=2*Math.PI;
return distance}},colors:{count:140,displayNames:["Alice Blue","Antique White","Aqua","Aquamarine","Azure","Beige","Bisque","Black","Blanched Almond","Blue","Blue Violet","Brown","Burly Wood","Cadet Blue","Chartreuse","Chocolate","Coral","Cornflower Blue","Cornsilk","Crimson","Cyan","Dark Blue","Dark Cyan","Dark Goldenrod","Dark Grey","Dark Green","Dark Khaki","Dark Magenta","Dark Olive Green","Dark Orange","Dark Orchid","Dark Red","Dark Salmon","Dark Sea Green","Dark Slate Blue","Dark Slate Grey",
"Dark Turquoise","Dark Violet","Deep Pink","Deep Sky Blue","Dim Grey","Dodger Blue","Firebrick","Floral White","Forest Green","Fuchsia","Gainsboro","Ghost White","Gold","Goldenrod","Grey","Green","Green Yellow","Honeydew","Hot Pink","Indian Red","Indigo","Ivory","Khaki","Lavender","Lavender Blush","Lawn Green","Lemon Chiffon","Light Blue","Light Coral","Light Cyan","Light Goldenrod","Light Green","Light Grey","Light Pink","Light Salmon","Light Sea Green","Light Sky Blue","Light Slate Grey","Light Steel Blue",
"Light Yellow","Lime","Lime Green","Linen","Magenta","Maroon","Medium Aquamarine","Medium Blue","Medium Orchid","Medium Purple","Medium Sea Green","Medium Slate Blue","Medium Spring Green","Medium Turquoise","Medium Violet Red","Midnight Blue","Mint Cream","Misty Rose","Moccasin","Navajo White","Navy","Old Lace","Olive","Olive Drab","Orange","Orange Red","Orchid","Pale Goldenrod","Pale Green","Pale Turquoise","Pale Violet Red","Papaya Whip","Peach Puff","Peru","Pink","Plum","Powder Blue","Purple",
"Red","Rosy Brown","Royal Blue","Saddle Brown","Salmon","Sandy Brown","Sea Green","Seashell","Sienna","Silver","Sky Blue","Slate Blue","Slate Grey","Snow","Spring Green","Steel Blue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","White Smoke","Yellow","Yellow Green"],cssNames:null,redComponents:[240,250,0,127,240,245,255,0,255,0,138,165,222,95,127,210,255,100,255,220,0,0,0,184,169,0,189,139,85,255,153,139,233,143,72,47,0,148,255,0,105,30,178,255,34,255,220,248,255,218,127,0,
173,240,255,205,75,255,240,230,255,124,255,173,240,224,250,144,211,255,255,32,135,119,176,255,0,50,250,255,127,102,0,186,147,60,123,0,72,199,25,245,255,255,255,0,253,128,107,255,255,218,238,152,175,219,255,255,205,255,221,176,127,255,188,65,139,250,244,46,255,160,192,135,106,112,255,0,70,210,0,216,255,64,238,245,255,245,255,154],greenComponents:[248,235,255,255,255,245,228,0,235,0,43,42,184,158,255,105,127,149,248,20,255,0,139,134,169,100,183,0,107,140,50,0,150,188,61,79,206,0,20,191,105,144,34,250,
139,0,220,248,215,165,127,127,255,255,105,92,0,255,230,230,240,252,250,216,128,255,250,238,211,182,160,178,206,136,196,255,255,205,240,0,0,205,0,85,112,179,104,250,209,21,25,255,228,228,222,0,245,128,142,165,69,112,232,251,238,112,239,218,133,192,160,224,127,0,143,105,69,128,164,139,245,82,192,206,90,128,250,255,130,180,128,191,99,225,130,222,255,255,255,205],blueComponents:[255,215,255,212,255,220,196,0,205,255,226,42,135,160,0,30,80,237,220,60,255,139,139,11,169,0,107,139,47,0,204,0,122,143,139,
79,209,211,147,255,105,255,34,240,34,255,220,255,0,32,127,127,47,240,180,92,130,240,140,250,245,0,205,230,128,255,210,144,211,193,122,170,250,153,222,224,0,50,230,255,127,170,205,211,219,113,238,154,204,133,112,250,225,181,173,128,230,0,35,0,0,214,170,152,238,147,213,185,63,203,221,230,0,0,143,225,19,114,96,87,238,45,192,235,205,144,250,127,180,140,128,216,71,208,238,179,255,245,0,50]},DIRTY:{VISIBILITY:1,POSITION:2,SIZE:4,TRANSFORMS:8,CONTENT:16,STYLE:32,BACKGROUND:16,FRAME:6,SCOPE:2+4+8,ALL:127},
SHAPES:{LIST:-1,CUSTOM:0,POINT:1,CIRCLE:2,RECTANGLE:4,POLYGON:8,PATH:16}}})();jayus.easing={linear:function jayus_easing_linear(t){return t},easeInQuad:function jayus_easing_easeInQuad(t){return t*t},easeOutQuad:function jayus_easing_easeOutQuad(t){return t*(2-t)},easeInOutQuad:function jayus_easing_easeInOutQuad(t){return((t/=0.5)<1?t*t:(1-t)*(t-3)+1)/2},easeInCubic:function jayus_easing_easeInCubic(t){return t*t*t},easeOutCubic:function jayus_easing_easeOutCubic(t){return--t*t*t+1},easeInOutCubic:function jayus_easing_easeInOutCubic(t){return(t/=0.5)<1?t*t*t/2:(t-=2)*t*t/
2+1},easeInQuart:function jayus_easing_easeInQuart(t){return t*t*t*t},easeOutQuart:function jayus_easing_easeOutQuart(t){return--t*t*t*-t+1},easeInOutQuart:function jayus_easing_easeInOutQuart(t){return(t/=0.5)<1?t*t*t*t/2:1-(t-=2)*t*t*t/2},easeInQuint:function jayus_easing_easeInQuint(t){return t*t*t*t*t},easeOutQuint:function jayus_easing_easeOutQuint(t){return--t*t*t*t*t+1},easeInOutQuint:function jayus_easing_easeInOutQuint(t){return(t/=0.5)<1?t*t*t*t*t/2:(t-=2)*t*t*t*t/2+1},easeInSine:function jayus_easing_easeInSine(t){return 1-
Math.cos(t*Math.PI/2)},easeOutSine:function jayus_easing_easeOutSine(t){return Math.sin(t*Math.PI/2)},easeInOutSine:function jayus_easing_easeInOutSine(t){return 0.5-Math.cos(t*Math.PI)/2},easeInExpo:function jayus_easing_easeInExpo(t){return(t>0)*Math.pow(2,10*t-10)},easeOutExpo:function jayus_easing_easeOutExpo(t){return 1-(t!==1)*Math.pow(2,-10*t)},easeInOutExpo:function jayus_easing_easeInOutExpo(t){if(!t||t===1)return t;return(t/=0.5)<1?Math.pow(2,10*t-10)/2:1-Math.pow(2,10-10*t)/2},easeInCirc:function jayus_easing_easeInCirc(t){return 1-
Math.sqrt(1-t*t)},easeOutCirc:function jayus_easing_easeOutCirc(t){return Math.sqrt(--t*-t+1)},easeInOutCirc:function jayus_easing_easeInOutCirc(t){if((t/=0.5)<1)return-(Math.sqrt(1-t*t)-1)/2;return(Math.sqrt(1-(t-=2)*t)+1)/2},easeInElastic:function jayus_easing_easeInElastic(t){if(!t||t===1)return t;var p=0.3,s=p/(2*Math.PI)*Math.PI/2;return-Math.pow(2,10*--t)*Math.sin((t-s)*2*Math.PI/p)},easeOutElastic:function jayus_easing_easeOutElastic(t){if(!t||t===1)return t;var p=0.3,s=p/(2*Math.PI)*Math.PI/
2;return Math.pow(2,-10*t)*Math.sin((t-s)*2*Math.PI/p)+1},easeInOutElastic:function jayus_easing_easeInOutElastic(t){if(!t||t===1)return t;var p=0.3*1.5,s=p/(2*Math.PI)*Math.PI/2;return(t/=0.5)<1?-Math.pow(2,10*--t)*Math.sin((t-s)*2*Math.PI/p)/2:Math.pow(2,-10*--t)*Math.sin((t-s)*2*Math.PI/p)/2+1},easeInBack:function jayus_easing_easeInBack(t){var s=1.70158;return t*t*(t*(s+1)-s)},easeOutBack:function jayus_easing_easeOutBack(t){var s=1.70158;return--t*t*((s+1)*t+s)+1},easeInOutBack:function jayus_easing_easeInOutBack(t){var s=
1.70158;return(t/=0.5)<1?t*t*(((s*=1.525)+1)*t-s)/2:(t-=2)*t*(((s*=1.525)+1)*t+s)/2+1},easeInBounce:function jayus_easing_easeInBounce(t){return 1-jayus.easing.easeOutBounce(1-t)},easeOutBounce:function jayus_easing_easeOutBounce(t){if(t<1/2.75)return 7.5625*t*t;if(t<2/2.75)return 7.5625*(t-=1.5/2.75)*t+0.75;if(t<2.5/2.75)return 7.5625*(t-=2.25/2.75)*t+0.9375;return 7.5625*(t-=2.625/2.75)*t+0.984375},easeInOutBounce:function jayus_easing_easeInOutBounce(t){return t<0.5?jayus.easing.easeInBounce(t*
2)/2:jayus.easing.easeOutBounce(t*2-1)/2+0.5}};jayus.Responder=jayus.createClass({hasHandlers:false,isHandler:null,handlers:null,handle:function Responder_handle(handlers){jayus.debug.match("Entity.handle",handlers,"handlers",5);for(var event in handlers)if(handlers.hasOwnProperty(event))this.addHandler(event,handlers[event]);return this},addHandler:function Responder_addHandler(event,handler,options){jayus.debug.matchArguments("Responder.addHandler",arguments,"event",2,"handler",3);jayus.debug.matchOptional("Responder.addHandler",options,"options",
5);if(!this.hasHandlers){this.hasHandlers=true;this.isHandler={frame:false};this.handlers={}}if(typeof options!=="object")options={};options.handler=handler;options.hasContext=typeof options.context==="object";options.enabled=true;options.remove=false;if(this.isHandler[event])this.handlers[event].push(options);else{this.handlers[event]=[options];this.isHandler[event]=true}return this},removeHandler:function Responder_removeHandler(event,handler){jayus.debug.match("Responder.removeHandler",event,"event",
2);if(!jayus.debug.is(3,handler)&&!jayus.debug.is(2,handler))throw new TypeError("Responder.removeHandler() - Invalid handler"+jayus.debug.toString(handler)+" sent, Function or String required.");if(this.isHandler[event]){var i,options,handlers=this.handlers[event];if(typeof handler==="object")handlers.splice(handlers.indexOf(handler),1);else if(handler instanceof Function)for(i=0;i<handlers.length;i++){options=handlers[i];if(options.handler===handler)handlers.splice(i,1)}else for(i=0;i<handlers.length;i++){options=
handlers[i];if(options.id===handler)handlers.splice(i,1)}if(!handlers.length){delete this.handlers[event];this.isHandler[event]=false}}return this},removeHandlers:function Entity_removeHandlers(event){jayus.debug.match("Entity.removeHandlers",event,"event",2);if(this.isHandler[event]){delete this.handlers[event];this.isHandler[event]=false}return this},removeAllHandlers:function Entity_removeAllHandlers(){this.hasHandlers=false;this.isHandler=null;this.handlers=null;if(typeof this.addDefaultHandlers===
"function")this.addDefaultHandlers();return this},fire:function Responder_fire(event,data){jayus.debug.match("Responder.fire",event,"event",2);jayus.debug.matchOptional("Responder.fire",data,"data",0);var i,opts,result,handlers;if(this.hasHandlers&&this.isHandler[event]){handlers=this.handlers[event];for(i=0;i<handlers.length;i++){opts=handlers[i];if(opts.remove){this.removeHandler(event,opts.handler);i--}else if(opts.enabled)if(opts.handler.call(opts.hasContext?opts.context:this,data,opts))return true}}return false}});jayus.Animator=jayus.Responder.extend({isAnimator:true,running:false,attachToJayus:true,startTime:null,duration:1E3,easing:jayus.easing.linear,looped:false,oscillate:false,init:function Animator(updater){jayus.debug.match("Animator",updater,"updater",3);this.update=updater},initFromObject:function Animator_initFromObject(object){jayus.debug.match("Animator.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);if(typeof object.duration==="number")this.duration=
object.duration;if(typeof object.looped==="boolean")this.looped=object.looped;if(typeof object.oscillate==="boolean")this.oscillate=object.oscillate;if(typeof object.easing!=="undefined")this.setEasing(object.easing);if(typeof object.target==="object")this.target=object.target;return this.dirty(127)},start:function Animator_start(){if(!this.running){this.startTime=Date.now();this.running=true;if(this.attachToJayus)jayus.animators.push(this);this.fire("started");this.update(0)}else console.warn("Animator.start() - Started when already running");
return this},restart:function Animator_restart(){this.startTime=Date.now();this.running=true;jayus.animators.push(this);this.fire("started");this.update(0);return this},stop:function Animator_stop(){if(this.running){this.running=false;if(this.attachToJayus){var index=jayus.animators.indexOf(this);if(index!==-1)jayus.animators.splice(index,1)}this.fire("stopped")}else{console.error("Animator.stop() - Stopped when not running");console.log(this)}return this},finish:function Animator_finish(){if(this.running){this.running=
false;if(this.attachToJayus){var index=jayus.animators.indexOf(this);if(index!==-1)jayus.animators.splice(index,1)}this.update(1);this.fire("finished")}else{console.error("Animator.finish() - Finished when not running");console.log(this)}return this},setDuration:function Animator_setDuration(duration){jayus.debug.match("Animator.setDuration",duration,"duration",4);this.duration=duration;return this},setEasing:function Animator_setEasing(easing){if(typeof easing==="string"){jayus.debug.match("Animator.setEasing",
easing,"easing",2);easing=jayus.easing[easing]}else jayus.debug.match("Animator.setEasing",easing,"easing",3);this.easing=easing;return this},tick:function Animator_tick(time){if(time-this.startTime<this.duration){var pos=this.easing((time-this.startTime)/this.duration);if(pos<0)pos=0;if(this.oscillate)if(pos<=0.5)pos*=2;else{pos=(pos-0.5)*2;pos=1-pos}this.update(pos)}else if(this.looped)this.startTime=Date.now();else this.finish()},setLooped:function Animator_setLooped(on){jayus.debug.match("Animator.setLooped",
on,"on",1);this.looped=on;return this},setOscillate:function Animator_setOscillate(on){jayus.debug.match("Animator.setOscillate",on,"on",1);this.oscillate=on;return this}});jayus.Animatable=jayus.createClass({actionsToAnimate:0,animate:function Animatable_animate(){this.actionsToAnimate++;return this}});
jayus.MethodAnimator=jayus.Animator.extend({target:null,method:null,initialValue:null,finalValue:null,multipleParameters:false,values:null,init:function MethodAnimator(target,method,initialValue,finalValue){if(arguments.length){jayus.debug.matchArguments("MethodAnimator",arguments,"target",5,"method",3,"initialValue",0,"finalValue",0);this.target=target;this.method=method;this.initialValue=initialValue;this.finalValue=finalValue;if(initialValue instanceof Array){this.multipleParameters=true;this.values=
[]}}},update:function MethodAnimator_update(pos){if(this.multipleParameters){for(var i=0;i<this.initialValue.length;i++)this.values[i]=this.initialValue[i]+pos*(this.finalValue[i]-this.initialValue[i]);this.method.apply(this.target,this.values)}else this.method.call(this.target,this.initialValue+pos*(this.finalValue-this.initialValue))}});
jayus.MethodAnimatorBy=jayus.Animator.extend({target:null,getter:null,setter:null,from:null,by:null,init:function MethodAnimatorBy(target,getter,setter,by){if(arguments.length){jayus.debug.matchArguments("MethodAnimatorBy",arguments,"target",5,"getter",3,"setter",3,"by",4);this.target=target;this.getter=getter;this.setter=setter;this.by=by}var that=this;this.addHandler("started",function(){if(typeof that.getter==="function")that.from=that.getter.call(that.target);else that.from=that.target[that.getter]})},
initFromObject:function MethodAnimatorBy_initFromObject(object){jayus.debug.match("MethodAnimatorBy.initFromObject",object,"object",5);jayus.Animator.prototype.initFromObject.call(this,object);if(typeof object.target!=="undefined")this.target=object.target;if(typeof object.getter!=="undefined")this.getter=object.getter;if(typeof object.setter!=="undefined")this.setter=object.setter;if(typeof object.by==="number")this.by=object.by;return this.dirty(127)},update:function MethodAnimatorBy_update(pos){if(typeof this.setter===
"function")this.setter.call(this.target,this.from+pos*this.by);else if(typeof this.target[this.setter]==="function")this.target[this.setter](this.from+pos*this.by);else this.target[this.setter]=this.from+pos*this.by}});
jayus.MethodAnimatorFromTo=jayus.Animator.extend({target:null,setter:null,from:null,nullFrom:false,to:null,init:function MethodAnimatorFromTo(target,getter,setter,from,to){if(arguments.length){jayus.debug.matchArguments("MethodAnimatorFromTo",arguments,"target",5,"getter",3,"setter",3,"from",0,"to",0);this.target=target;this.getter=getter;this.setter=setter;this.from=from;this.to=to}if(this.nullFrom){var that=this;this.addHandler("started",function(){that.from=that.setter.call(that.target)})}this.nullFrom=
this.from===null},initFromObject:function MethodAnimatorBy_initFromObject(object){jayus.debug.match("MethodAnimatorBy.initFromObject",object,"object",5);jayus.Animator.prototype.initFromObject.call(this,object);if(typeof object.target!=="undefined")this.target=object.target;if(typeof object.getter!=="undefined")this.getter=object.getter;if(typeof object.setter!=="undefined")this.setter=object.setter;if(typeof object.from==="number")this.from=object.from;if(typeof object.to==="number")this.to=object.to;
return this.dirty(127)},update:function MethodAnimatorFromTo_update(pos){if(typeof this.setter==="function")this.setter.call(this.target,this.from+pos*(this.to-this.from));else if(typeof this.target[this.setter]==="function")this.target[this.setter](this.from+pos*(this.to-this.from));else this.target[this.setter]=this.from+pos*(this.to-this.from)}});
jayus.Animator.Discrete=jayus.Animator.extend({count:null,updater:null,init:function DiscreteAnimator(count,updater){jayus.debug.matchArguments("DiscreteAnimator",arguments,"count",4,"updater",3);this.count=count;this.updater=updater},update:function DiscreteAnimator_update(pos){pos=Math.floor(pos*this.count);if(pos===this.count)pos--;this.updater(pos)}});
jayus.AnimatorSequence=jayus.Animator.extend({animators:null,currentIndex:null,init:function AnimatorSequence(){this.animators=new jayus.List(this);this.animators.typeId=22},initFromObject:function AnimatorSequence_initFromObject(object){jayus.debug.match("AnimatorSequence.initFromObject",object,"object",5);jayus.Animator.prototype.initFromObject.call(this,object);if(typeof object.animators==="object"){this.animators=new jayus.List(this);for(var i=0;i<object.animators.length;i++){var child=object.animators[i];
this.animators.add(jayus.parse(child))}}return this.dirty(127)},listItemAdded:function AnimatorSequence_listItemAdded(list,item){item.attachToJayus=false},listItemsAdded:function AnimatorSequence_listItemsAdded(list,items){for(var i=0;i<items.length;i++)items[i].attachToJayus=false},listItemRemoved:function AnimatorSequence_listItemRemoved(list,item){item.attachToJayus=true},listItemsRemoved:function AnimatorSequence_listItemsRemoved(list,items){for(var i=0;i<items.length;i++)items[i].attachToJayus=
true},update:function AnimatorSequence_update(pos){var items=this.animators.items,count=items.length,index=Math.floor(pos*count);if(index===count)index--;if(this.currentIndex!==index){if(this.currentIndex!==null)items[this.currentIndex].finish();items[index].start();this.currentIndex=index}items[index].update(pos*count-index)}});jayus.Dependency=jayus.Animatable.extend({id:"",dependents:null,dependentCount:0,frozen:0,setId:function Dependency_setId(id){jayus.debug.match("Dependency.setId",id,"id",0);this.id=id;if(jayus.keepTrackOfObjects)if(jayus.identifiedObjects.indexOf(this)===-1)jayus.identifiedObjects.push(this);return this},initFromObject:function Dependency_initFromObject(object){if(typeof object.id!=="undefined")this.setId(object.id);return this},attach:function Dependency_attach(dependent){jayus.debug.match("Dependency.attach",
dependent,"dependent",5);if(!this.dependentCount)this.dependents=[];this.dependents.push(dependent);this.dependentCount++},detach:function Dependency_detach(dependent){jayus.debug.match("Dependency.attach",dependent,"dependent",5);if(this.dependentCount){var index=this.dependents.indexOf(dependent);if(index!==-1){this.dependents.splice(index,1);this.dependentCount--}else console.warn("Dependency.detach() - Cannot remove dependent that is not attached")}},clearDependents:function Dependency_clearDependents(){this.dependents=
null;this.dependentCount=0},dirty:function Dependency_dirty(type){if(!this.frozen)this.informDependents(type);return this},informDependents:function Dependency_informDependents(type){for(var i=0;i<this.dependentCount;i++){jayus.debug.verifyMethod(this.dependents[i],"componentDirtied");this.dependents[i].componentDirtied(this,type)}},forEachDependent:function Dependency_forEachDependent(func,args){for(var i=0;i<this.dependentCount;i++)func.apply(this.dependents[i],args)}});jayus.List=jayus.createClass({shapeType:-1,parent:null,items:null,typeId:0,init:function List(parent){if(arguments.length===1){jayus.debug.match("List",parent,"parent",5);this.parent=parent}this.items=[]},added:function List_added(item){this.parent.listItemAdded(this,item)},addedMany:function List_addedMany(items){this.parent.listItemsAdded(this,items)},removed:function List_removed(item){this.parent.listItemRemoved(this,item)},removedMany:function List_removedMany(items){this.parent.listItemsRemoved(this,
items)},indexOf:function List_indexOf(item){var i;if(typeof item==="string"){jayus.debug.match("List.indexOf",item,"item",0);for(i=this.items.length-1;i>=0;i--)if(this.items[i].id===item)return i;return-1}jayus.debug.match("List.indexOf",item,"item",this.typeId);return this.items.indexOf(item)},has:function List_has(item){jayus.debug.match("List.has",item,"item",this.typeId);return this.items.indexOf(item)>=0},count:function List_count(){return this.items.length},at:function List_at(index){jayus.debug.match("List.at",
index,"index",4);if(0<=index&&index<this.items.length)return this.items[index];return null},get:function List_get(id){jayus.debug.match("List.get",id,"id",0);var i,item;for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.id===id)return item}return null},find:function List_find(id){jayus.debug.match("List.get",id,"id",0);var i,item;for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.id===id)return item;if(item.isParent){item=item.find(id);if(item!==null)return item}}},add:function List_add(item){if(arguments.length===
1){jayus.debug.match("List.add",item,"item",this.typeId);this.items.push(item);this.added(item)}else{for(var i=0;i<arguments.length;i++)this.items.push(arguments[i]);this.addedMany(arguments)}return this},append:function List_append(items){jayus.debug.matchArray("List.append",items,"items",this.typeId);for(var i=0;i<items.length;i++)this.items.push(items[i]);this.addedMany(items);return this},insert:function List_insert(item,index){jayus.debug.matchArguments("List.insert",arguments,"item",this.typeId,
"index",4);this.items.splice(index,0,item);this.added(item);return this},insertBefore:function List_insertBefore(item,pivot){jayus.debug.matchArguments("List.insertBefore",arguments,"item",this.typeId,"pivot",this.typeId);var index=this.items.indexOf(pivot);if(index>0){this.items.splice(index-1,0,item);this.added(item)}return this},insertAfter:function List_insertAfter(item,pivot){jayus.debug.matchArguments("List.insertAfter",arguments,"item",this.typeId,"pivot",this.typeId);var index=this.items.indexOf(pivot);
if(index!==-1){this.items.splice(index,0,item);this.added(item)}return this},remove:function List_remove(item){jayus.debug.match("List.remove",item,"item",this.typeId);var i,index;if(arguments.length===1){index=this.items.indexOf(item);if(index>=0){this.items.splice(index,1);this.removed(item)}}else{for(i=0;i<arguments.length;i++){item=arguments[i];index=this.items.indexOf(item);if(index>=0){this.items.splice(index,1);this.removed(item)}}this.removedMany(arguments)}return this},removeAt:function List_removeAt(index){jayus.debug.match("List.removeAt",
index,"index",4);if(0<=index&&index<this.items.length){var item=this.items[index];this.items.splice(index,1);this.removed(item)}return this},replace:function List_replace(oldItem,newItem){if(typeof oldItem==="string")jayus.debug.matchArguments("List.replace",arguments,"oldId",2,"newItem",this.typeId);else jayus.debug.matchArguments("List.replace",arguments,"oldItem",this.typeId,"newItem",this.typeId);return this.replaceAt(this.indexOf(oldItem),newItem)},update:function List_update(oldItem,newItem){if(typeof oldItem===
"string")jayus.debug.matchArguments("List.update",arguments,"oldId",2,"newItem",this.typeId);else jayus.debug.matchArguments("List.update",arguments,"oldItem",this.typeId,"newItem",this.typeId);var index=this.indexOf(oldItem);if(index===-1)this.add(newItem);else this.replaceAt(index,newItem);return this},replaceAt:function List_replaceAt(index,newItem){jayus.debug.matchArguments("List.replaceAt",arguments,"index",4,"newItem",this.typeId);if(index>=0){this.removed(this.items[index]);this.items[index]=
newItem;this.added(newItem)}return this},purge:function List_purge(){var items=this.items;this.removedMany(items);this.items=[];if(this.parent.items===items)this.parent.items=this.items;return this},onEach:function List_onEach(method,args){jayus.debug.match("List.onEach",method,"method",2);jayus.debug.matchOptional("List.onEach",args,"args",6);for(var i=0;i<this.items.length;i++)this.items[i][method].apply(this.items[i],args);return this},forEach:function List_forEach(func,args){jayus.debug.match("List.forEach",
func,"func",3);jayus.debug.matchOptional("List.forEach",args,"args",6);var i,ret;for(i=0;i<this.items.length;i++){ret=func.apply(this.items[i],args);if(ret!==undefined)return ret}return null},forEvery:function List_forEvery(func,args){jayus.debug.match("List.forEvery",func,"func",3);jayus.debug.matchOptional("List.forEvery",args,"args",6);var i,ret;for(i=0;i<this.items.length;i++){ret=func.apply(this.items[i],args);if(ret!==undefined)return ret}return null},sort:function List_sort(comparator){jayus.debug.match("List.sort",
comparator,"comparator",3);this.items.sort(comparator);this.parent.listItemsMoved();return this}});jayus.Color=jayus.Dependency.extend({r:0,g:0,b:0,a:1,init:function Color(){if(arguments.length)this.set.apply(this,arguments)},toObject:function Color_toObject(){var object={type:"Color",r:this.r,g:this.g,b:this.b,a:this.a};if(this.id!=="")object.id=this.id;return object},initFromObject:function Color_initFromObject(object){jayus.debug.match("Color.initFromObject",object,"object",5);this.r=object.r;this.g=object.g;this.b=object.b;this.a=object.a;return this.dirty(127)},set:function Color_set(r,g,
b,a){switch(arguments.length){case 1:return this.set(r,1);case 2:jayus.debug.matchArguments("Color.set",arguments,"name",2,"alpha",4);var index=jayus.colors.displayNames.indexOf(r);if(index<0)index=jayus.colors.cssNames.indexOf(r);if(index+1)this.set(jayus.colors.redComponents[index],jayus.colors.greenComponents[index],jayus.colors.blueComponents[index],g);return this;case 3:return this.set(r,g,b,1);case 4:jayus.debug.matchArgumentsAs("Color.set",arguments,4,"r","g","b","a");if(this.actionsToAnimate){this.actionsToAnimate--;
return new jayus.MethodAnimator(this,this.set,[this.r,this.g,this.b,this.a],[r,g,b,a])}this.r=r;this.g=g;this.b=b;this.a=a;return this}throw new Error("Color.set() - Invalid number of arguments sent, 1, 2, 3, or 4 required");},setRed:function Color_setRed(value){jayus.debug.match("Color.setRed",value,"value",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setRed,this.r,value)}if(this.r!==value){this.r=value;this.dirty(32)}return this},setGreen:function Color_setGreen(value){jayus.debug.match("Color.setGreen",
value,"value",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setGreen,this.g,value)}if(this.g!==value){this.g=value;this.dirty(32)}return this},setBlue:function Color_setBlue(value){jayus.debug.match("Color.setBlue",value,"value",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setBlue,this.b,value)}if(this.b!==value){this.b=value;this.dirty(32)}return this},setAlpha:function Color_setAlpha(value){jayus.debug.match("Color.setAlpha",
value,"value",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setAlpha,this.a,value)}if(this.a!==value){this.a=value;this.dirty(32)}return this},toHex:function Color_toHex(){var r=this.r.toString(16),g=this.g.toString(16),b=this.b.toString(16);return"#"+(r.length===1?"0"+r:r)+(g.length===1?"0"+g:g)+(b.length===1?"0"+b:b)},toCSS:function Color_toCSS(){this.a=jayus.math.clamp(0,this.a,1);if(this.a-1)return"rgba("+this.r+","+this.g+","+this.b+","+this.a+
")";return"rgb("+this.r+","+this.g+","+this.b+")"},getName:function Color_getName(){var i,colors=jayus.colors;for(i=colors.count-1;i>=0;i--)if(this.r===colors.redComponents[i]&&(this.g===colors.greenComponents[i]&&this.b===colors.blueComponents[i]))return colors.displayNames[i];return""}});jayus.Brush=jayus.Dependency.extend({filling:false,stroking:false,fillType:0,strokeType:0,shadowType:0,alpha:1,strokeFirst:false,fill:null,stroke:null,lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,lineDash:null,lineDashOffset:null,shadow:null,shadowOffsetX:null,shadowOffsetY:null,shadowBlur:null,properties:{names:["alpha","strokeFirst","fill","stroke","lineWidth","lineCap","lineJoin","miterLimit","lineDash","lineDashOffset","shadow","shadowOffsetY","shadowOffsetY","shadowBlur"],objects:["fill",
"stroke","shadow"]},init:function Brush(styling){if(arguments.length){jayus.debug.match("Brush",styling,"styling",5);this.apply(styling)}},componentDirtied:function Brush_componentDirtied(component,type){this.dirty(32)},toObject:function Brush_toObject(){var object={};object.type="Brush";var i,key,val,valType;for(i=0;i<jayus.Brush.prototype.properties.names.length;i++){key=jayus.Brush.prototype.properties.names[i];val=object[key];valType=typeof val;if(val!==jayus.Brush.prototype[key]){if(valType===
"object")val=val.toObject();object[key]=val}}return object},initFromObject:function Brush_initFromObject(object){jayus.debug.match("Brush.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.ignoreDirty++;var i,key,val,valType;for(i=0;i<jayus.Brush.prototype.properties.names.length;i++){key=jayus.Brush.prototype.properties.names[i];val=object[key];valType=typeof val;if(valType!=="undefined"){if(valType==="object")val=jayus.parse(val);if(key==="fill")this.setFill(val);
else if(key==="stroke")this.setStroke(val);else if(key==="shadow")this.setShadow(val);else this[key]=val}}this.ignoreDirty--;this.dirty(127)},apply:function Brush_apply(styling){jayus.debug.match("Brush.apply",styling,"styling",5);this.ignoreDirty++;for(var key in styling)if(styling.hasOwnProperty(key)){if(typeof this["set"+key[0].toUpperCase()+key.slice(1)]!=="function"){var msg='Brush.apply() - Unknown property "'+key+'" present in styling object sent';if(key==="shadowColor")msg+=', did you mean to set the "shadow" property?';
console.warn(msg);continue}this["set"+key[0].toUpperCase()+key.slice(1)](styling[key])}this.ignoreDirty--;return this.dirty(32)},findStyleType:function Brush_findStyleType(style){if(style===null)return 0;if(typeof style==="string")return 1;if(style instanceof CanvasGradient)return 2;if(style instanceof CanvasPattern)return 3;if(style instanceof jayus.Color)return 4;if(style instanceof jayus.LinearGradient)return 5;if(style instanceof jayus.RadialGradient)return 6;throw new Error("Style.findStyleType() - Invalid fill/stroke style: "+
jayus.debug.toString(style));},getNativeStyle:function Brush_getNativeStyle(type,style){if(type<=3)return style;if(type===4)return style.toCSS();if(type===5||type===6)return style.getNative();throw new Error("Style.applyTo() - Invalid fill/stroke type identifier: "+jayus.debug.toString(type));},applyTo:function Brush_applyTo(ctx){if(this.alpha!==1)ctx.globalAlpha*=this.alpha;if(this.filling)ctx.fillStyle=this.getNativeStyle(this.fillType,this.fill);if(this.stroking){ctx.strokeStyle=this.getNativeStyle(this.strokeType,
this.stroke);if(this.lineWidth!==null)ctx.lineWidth=this.lineWidth;if(this.lineCap!==null)ctx.lineCap=this.lineCap;if(this.lineJoin!==null)ctx.lineJoin=this.lineJoin;if(this.miterLimit!==null)ctx.miterLimit=this.miterLimit;if(this.lineDash!==null&&jayus.ua.lineDash){ctx.setLineDash(this.lineDash);if(this.lineDashOffset!==null)ctx.lineDashOffset=this.lineDashOffset}}if(this.shadowType){if(this.shadowType===1)ctx.shadowColor=this.shadow;else if(this.shadowType===2)ctx.shadowColor=this.shadow.toCSS();
else throw new Error("Style.applyTo() - Invalid shadow type identifier: "+jayus.debug.toString(this.shadowType));if(this.shadowOffsetX!==null)ctx.shadowOffsetX=this.shadowOffsetX;if(this.shadowOffsetY!==null)ctx.shadowOffsetY=this.shadowOffsetY;if(this.shadowBlur!==null)ctx.shadowBlur=this.shadowBlur}},paintShape:function Brush_paintShape(ctx){this.applyTo(ctx);if(this.stroking&&this.strokeFirst)ctx.stroke();if(this.filling)ctx.fill();if(this.stroking&&!this.strokeFirst)ctx.stroke()},paintRect:function Brush_paintRect(ctx,
x,y,width,height){ctx.save();this.applyTo(ctx);if(this.stroking&&this.strokeFirst)ctx.strokeRect(x,y,width,height);if(this.filling)ctx.fillRect(x,y,width,height);if(this.stroking&&!this.strokeFirst)ctx.strokeRect(x,y,width,height);ctx.restore()},setAlpha:function Brush_setAlpha(alpha){if(alpha!==null)jayus.debug.match("Brush.setAlpha",alpha,"alpha",4);if(alpha===null)alpha=1;if(this.alpha!==alpha){this.alpha=alpha;this.dirty(32)}return this},setFill:function Brush_setFill(style){if(style!==null)jayus.debug.match("Brush.setFill",
style,"style",0);if(this.fillType>=4)this.fill.detach(this);if(typeof style==="object"&&(style!==null&&typeof style.type==="string"))style=jayus.parse(style);this.fill=style;this.fillType=this.findStyleType(style);if(this.fillType>=4)this.fill.attach(this);this.filling=!!this.fillType;return this.dirty(32)},setStroke:function Brush_setStroke(style){if(style!==null)jayus.debug.match("Brush.setStroke",style,"style",0);if(this.strokeType>=4)this.stroke.detach(this);if(typeof style==="object"&&(style!==
null&&typeof style.type==="string"))style=jayus.parse(style);this.stroke=style;this.strokeType=this.findStyleType(style);if(this.strokeType>=4)this.stroke.attach(this);this.stroking=!!this.strokeType;return this.dirty(32)},setLineWidth:function Brush_setLineWidth(lineWidth){if(lineWidth!==null)jayus.debug.match("Brush.setLineWidth",lineWidth,"lineWidth",4);if(this.lineWidth!==lineWidth){this.lineWidth=lineWidth;this.dirty(32)}return this},setLineCap:function Brush_setLineCap(lineCap){if(lineCap!==
null)jayus.debug.match("Brush.setLineCap",lineCap,"lineCap");if(this.lineCap!==lineCap){this.lineCap=lineCap;this.dirty(32)}return this},setLineJoin:function Brush_setLineJoin(lineJoin){if(lineJoin!==null)jayus.debug.match("Brush.setLineJoin",lineJoin,"lineJoin",2);if(this.lineJoin!==lineJoin){this.lineJoin=lineJoin;this.dirty(32)}return this},setMiterLimit:function Brush_setMiterLimit(miterLimit){if(miterLimit!==null)jayus.debug.match("Brush.setMiterLimit",miterLimit,"miterLimit",2);if(this.miterLimit!==
miterLimit){this.miterLimit=miterLimit;this.dirty(32)}return this},setLineDash:function Brush_setLineDash(lineDash){if(lineDash!==null)jayus.debug.matchArray("Style.setLineDash",lineDash,"lineDash",4);this.lineDash=lineDash;this.dirty(32);return this},setLineDashOffset:function Brush_setLineDashOffset(lineDashOffset){if(lineDashOffset!==null)jayus.debug.match("Brush.setLineDashOffset",lineDashOffset,"lineDashOffset",4);if(this.lineDashOffset!==lineDashOffset){this.lineDashOffset=lineDashOffset;this.dirty(32)}return this},
setShadow:function Brush_setShadow(shadow){if(shadow!==null)jayus.debug.match("Brush.setShadow",shadow,"shadow",0);if(this.shadowType===2)this.shadow.detach(this);this.shadow=shadow;if(shadow===null)this.shadowType=0;else if(typeof shadow==="string")this.shadowType=1;else if(shadow instanceof jayus.Color){this.shadowType=2;this.shadow.attach(this)}else throw new Error("Style.setShadow() - Invalid shadow style: "+jayus.debug.toString(shadow));this.dirty(32);return this},setShadowOffsetX:function Brush_setShadowOffsetX(shadowOffsetX){if(shadowOffsetX!==
null)jayus.debug.match("Brush.setShadowOffsetX",shadowOffsetX,"shadowOffsetX",4);if(this.shadowOffsetX!==shadowOffsetX){this.shadowOffsetX=shadowOffsetX;this.dirty(32)}return this},setShadowOffsetY:function Brush_setShadowOffsetY(shadowOffsetY){if(shadowOffsetY!==null)jayus.debug.match("Brush.setShadowOffsetY",shadowOffsetY,"shadowOffsetY",4);if(this.shadowOffsetY!==shadowOffsetY){this.shadowOffsetY=shadowOffsetY;this.dirty(32)}return this},setShadowBlur:function Brush_setShadowBlur(shadowBlur){if(shadowBlur!==
null)jayus.debug.match("Brush.setShadowBlur",shadowBlur,"shadowBlur",4);if(this.shadowBlur!==shadowBlur){this.shadowBlur=shadowBlur;this.dirty(32)}return this}});jayus.Gradient=jayus.Dependency.extend({stopPositions:null,stopColors:null,nativeGradient:null,reformNative:true,toObject:function Gradient_toObject(){var object={type:"Gradient"};if(this.stopPositions!==null)object.stopPositions=this.stopPositions;if(this.stopColors!==null)object.stopColors=this.stopColors.toObject();if(this.id!=="")object.id=this.id;return object},initFromObject:function Gradient_initFromObject(object){jayus.debug.match("Gradient.initFromObject",object,"object",5);if(typeof object.stopPositions===
"object")this.stopPositions=object.stopPositions;if(typeof object.stopColors==="object")this.stopColors=object.stopColors;this.reformNative=true;return this.dirty(127)},componentDirtied:function Gradient_componentDirtied(component,type){this.reformNative=true;this.dirty(32)},translate:function Gradient_translate(x,y){jayus.debug.matchCoordinate("Gradient.translate",x,y);if(arguments.length===1)return this.translate(x.x,x.y);this.start.translate(x,y);this.end.translate(x,y);this.dirty(127);return this},
addColorStop:function Gradient_addColorStop(position,color){jayus.debug.matchArguments("Gradient.addColorStop",arguments,"position",4,"color",0);this.stopPositions.push(position);this.stopColors.push(color);return this},getNative:function Gradient_getNative(){if(this.reformNative){this.refresh();this.reformNative=false}return this.nativeGradient}});
jayus.LinearGradient=jayus.Gradient.extend({start:null,end:null,init:function LinearGradient(x1,y1,x2,y2){if(arguments.length===2){jayus.debug.matchArguments("LinearGradient",arguments,"start",13,"end",13);this.stopPositions=[];this.stopColors=[];this.start=x1;this.start.attach(this);this.end=y1;this.end.attach(this)}else if(arguments.length===4){jayus.debug.matchArgumentsAs("LinearGradient",arguments,4,"x1","y1","x2","y2");this.init(new jayus.Point(x1,y1),new jayus.Point(x2,y2))}},toObject:function LinearGradient_toObject(){var object=
jayus.Gradient.prototype.toObject.apply(this);object.type="LinearGradient";if(this.start!==null)object.start=this.start.toObject();if(this.end!==null)object.end=this.end.toObject();return object},initFromObject:function LinearGradient_initFromObject(object){jayus.debug.match("LinearGradient.initFromObject",object,"object",5);jayus.Gradient.prototype.initFromObject.call(this,object);if(typeof object.start==="object")this.start=(new jayus.Point).initFromObject(object.start);if(typeof object.end==="object")this.end=
(new jayus.Point).initFromObject(object.end);return this.dirty(127)},refresh:function LinearGradient_refresh(){var i,color;this.nativeGradient=jayus.getContext().createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y);for(i=this.stopPositions.length-1;i>=0;i--){color=this.stopColors[i];if(color instanceof jayus.Color)color=color.toCSS();this.nativeGradient.addColorStop(this.stopPositions[i],color)}return this}});
jayus.RadialGradient=jayus.Gradient.extend({start:null,end:null,init:function RadialGradient(cx1,cy1,r1,cx2,cy2,r2){this.stopPositions=[];this.stopColors=[];var start,end;if(arguments.length===2){jayus.debug.matchArguments("RadialGradient",[cx1,cy1],"cx1",14,"cx2",14);start=cx1;end=cy1}else if(arguments.length===4){jayus.debug.matchArguments("RadialGradient",[cx1,cy1,r1,cx2],"cx1",13,"cy1",4,"r1",13,"cx2",4);start=new jayus.Circle(cx1,cy1);end=new jayus.Circle(r1,cx2)}else{jayus.debug.matchArgumentsAs("RadialGradient",
arguments,4,"cx1","cy1","r1","cx2","cy2","r2");start=new jayus.Circle(cx1,cy1,r1);end=new jayus.Circle(cx2,cy2,r2)}start.attach(this);this.start=start;end.attach(this);this.end=end},toObject:function RadialGradient_toObject(){var object=jayus.Gradient.prototype.toObject.apply(this);object.type="RadialGradient";if(this.start!==jayus.RadialGradient.prototype.start)object.start=this.start.toObject();if(this.end!==jayus.RadialGradient.prototype.end)object.end=this.end.toObject();return object},initFromObject:function RadialGradient_initFromObject(object){jayus.debug.match("RadialGradient.initFromObject",
object,"object",5);jayus.Gradient.prototype.initFromObject.call(this,object);if(typeof object.start==="object")this.start=new jayus.Circle(object.start);if(typeof object.end==="object")this.end=new jayus.Circle(object.end);return this.dirty(127)},refresh:function RadialGradient_refresh(){var i,color;this.nativeGradient=jayus.getContext().createRadialGradient(this.start.x,this.start.y,this.start.radius,this.end.x,this.end.y,this.end.radius);for(i=this.stopPositions.length-1;i>=0;i--){color=this.stopColors[i];
if(color instanceof jayus.Color)color=color.toCSS();this.nativeGradient.addColorStop(this.stopPositions[i],color)}return this}});jayus.Matrix=jayus.createClass({a:1,b:0,tx:0,c:0,d:1,ty:0,init:function Matrix(a,b,tx,c,d,ty){if(arguments.length){jayus.debug.matchArgumentsAs("Matrix",arguments,4,"a","b","tx","c","d","ty");this.a=a;this.b=b;this.tx=tx;this.c=c;this.d=d;this.ty=ty}},toObject:function Matrix_toObject(){var object={type:"Matrix",a:this.a,b:this.b,tx:this.tx,c:this.c,d:this.d,ty:this.ty};if(this.id!=="")object.id=this.id;return object},initFromObject:function Matrix_initFromObject(object){jayus.debug.match("Matrix.initFromObject",
object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.a=object.a;this.b=object.b;this.tx=object.tx;this.c=object.c;this.d=object.d;this.ty=object.ty;this.dirty(127)},translate:function Matrix_translate(x,y){jayus.debug.matchCoordinate("Matrix.translate",x,y);if(arguments.length===1)return this.translate(x.x,x.y);this.tx+=this.a*x+this.b*y;this.ty+=this.d*y+this.c*x;return this},scale:function Matrix_scale(x,y){jayus.debug.matchCoordinate("Matrix.scale",x,y);if(arguments.length===
1)return this.scale(x.x,x.y);this.a*=x;this.c*=x;this.d*=y;this.b*=y;return this},rotate:function Matrix_rotate(angle){jayus.debug.match("Matrix.rotate",angle,"angle",4);var sin=Math.sin(angle),cos=Math.cos(angle);var a=this.a*cos+this.b*sin;this.b=-this.a*sin+this.b*cos;this.a=a;var c=this.d*sin+this.c*cos;this.d=this.d*cos-this.c*sin;this.c=c;return this},multiply:function Matrix_multiply(m1){jayus.debug.match("Matrix.multiply",m1,"m1",10);var m2=this;return new jayus.Matrix(m1.a*m2.a+m1.b*m2.c,
m1.a*m2.b+m1.b*m2.d,m1.a*m2.tx+m1.b*m2.ty+m1.tx,m1.c*m2.a+m1.d*m2.c,m1.c*m2.b+m1.d*m2.d,m1.c*m2.tx+m1.d*m2.ty+m1.ty)},transformPoint:function Matrix_transformPoint(x,y){jayus.debug.matchCoordinate("Matrix.transformPoint",x,y);if(arguments.length===1)return this.transformPoint(x.x,x.y);return this.transformPointOnto(x,y,new jayus.Point)},transformPointOnto:function Matrix_transformPointOnto(x,y,ret){jayus.debug.matchArguments("Matrix.transformPointOnto",arguments,"x",4,"y",4,"ret",13);ret.x=x*this.a+
y*this.b+this.tx;ret.y=x*this.c+y*this.d+this.ty;return ret},inverseTransformPoint:function Matrix_inverseTransformPoint(x,y){jayus.debug.matchCoordinate("Matrix.inverseTransformPoint",x,y);if(arguments.length===1)return this.inverseTransformPoint(x.x,x.y);return this.inverseTransformPointOnto(x,y,new jayus.Point)},inverseTransformPointOnto:function Matrix_inverseTransformPointOnto(x,y,ret){jayus.debug.matchArguments("Matrix.inverseTransformPointOnto",arguments,"x",4,"y",4,"ret",13);var det=this.getDeterminant();
if(det){x-=this.tx;y-=this.ty;ret.x=(x*this.d-y*this.b)/det;ret.y=(y*this.a-x*this.c)/det;return ret}return null},identity:function Matrix_identity(){this.a=this.d=1;this.b=this.tx=this.c=this.ty=0;return this},getDeterminant:function Matrix_getDeterminant(){var det=this.a*this.d-this.b*this.c;if(isFinite(det)&&(Math.abs(det)>1E-11&&(isFinite(this.tx)&&isFinite(this.ty))))return det;return null},clone:function Matrix_clone(){jayus.chart.tallyInit("Matrix","Matrix.clone()");return this.cloneOnto(new jayus.Matrix)},
cloneOnto:function Matrix_cloneOnto(ret){jayus.debug.match("Matrix.cloneOnto",ret,"ret",10);ret.init(this.a,this.b,this.tx,this.c,this.d,this.ty);return ret},equals:function Matrix_equals(mat){jayus.debug.match("Matrix.equals",mat,"mat",10);return this.a===mat.a&&(this.b===mat.b&&(this.c===mat.c&&(this.d===mat.d&&(this.tx===mat.tx&&this.ty===mat.ty))))},applyToContext:function Matrix_applyToContext(ctx){jayus.debug.matchContext("Matrix.applyToContext",ctx);ctx.transform(this.a,this.c,this.b,this.d,
this.tx,this.ty)}});jayus.SizePolicy=jayus.createClass({size:0,weight:1,expand:true,flexible:true,init:function SizePolicy(){},toObject:function SizePolicy_toObject(){var object={type:"SizePolicy"};if(this.size!==0)object.size=this.size;if(this.weight!==1)object.weight=this.weight;if(this.expand!==true)object.expand=this.expand;if(this.flexible!==jayus.SizePolicy.prototype.flexible)object.flexible=this.flexible;return object},initFromObject:function SizePolicy_initFromObject(object){jayus.debug.match("SizePolicy.initFromObject",
object,"object",5);if(typeof object.size==="number")this.size=object.size;if(typeof object.weight==="number")this.weight=object.weight;if(typeof object.expand==="boolean")this.expand=object.expand;if(typeof object.flexible==="boolean")this.flexible=object.flexible;return this}});jayus.images={images:{},pendingImageCount:0,checkFilepath:function jayus_images_checkFilepath(filepath){jayus.debug.match("jayus.images.checkFilepath",filepath,"filepath",2);if(filepath.indexOf("../")!==-1)console.warn('jayus.images.checkFilepath() - Filepath "'+filepath+'" contains "./" or "../", avoid using these')},isLoaded:function jayus_images_isLoaded(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.images.isLoaded",filepath,"filepaths",6);for(var i=0;i<filepath.length;i++)if(!this.isLoaded(filepath[i]))return false;
return true}jayus.debug.match("jayus.images.isLoaded",filepath,"filepath",2);this.checkFilepath(filepath);return typeof this.images[filepath]==="object"&&(this.images[filepath].loaded||this.images[filepath].tagName==="CANVAS")},get:function jayus_images_get(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.images.get",filepath,"filepaths",6);var images=[];for(var i=0;i<filepath.length;i++)images[i]=this.get(filepath[i]);return images}jayus.debug.match("jayus.images.get",filepath,"filepath",
2);this.checkFilepath(filepath);if(!this.isLoaded(filepath))console.warn('jayus.images.get() - Image "'+filepath+'" not yet loaded');return this.images[filepath]},setSubimage:function jayus_images_setSubimage(sourceImage,image,sourceX,sourceY,sourceWidth,sourceHeight){var source=this.get(sourceImage);var canvas=document.createElement("canvas");canvas.width=sourceWidth;canvas.height=sourceHeight;var ctx=canvas.getContext("2d");ctx.drawImage(source,sourceX,sourceY,sourceWidth,sourceHeight,0,0,sourceWidth,
sourceHeight);this.images[image]=canvas;jayus.fire("imageLoaded",{filepath:sourceImage,image:canvas});return this},whenLoaded:function jayus_images_whenLoaded(filepath,handler){if(typeof filepath==="object"){jayus.debug.matchArguments("jayus.images.whenLoaded",arguments,"filepaths",6,"handler",3);if(this.isLoaded(filepath))handler();else{jayus.addHandler("imageLoaded",function(data,options){if(jayus.images.isLoaded(filepath)){handler();options.remove=true}});this.load(filepath)}}else{jayus.debug.matchArguments("jayus.images.whenLoaded",
arguments,"filepath",2,"handler",3);if(this.isLoaded(filepath))handler({filepath:filepath,image:this.get(filepath)});else{jayus.addHandler("imageLoaded",function(data,options){if(data.filepath===filepath){handler(data);options.remove=true}});this.load(filepath)}}return this},load:function jayus_images_load(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.images.load",filepath,"filepaths",6);for(var i=0;i<filepath.length;i++)this.load(filepath[i])}else{jayus.debug.match("jayus.images.load",
filepath,"filepath",2);if(typeof this.images[filepath]!=="object"){var image=new Image;image.isSheet=false;image.loaded=false;this.images[filepath]=image;image.onload=function image_onload(){this.loaded=true;jayus.fire("imageLoaded",{filepath:filepath,image:this});jayus.images.pendingImageCount--;if(!jayus.images.pendingImageCount)jayus.fire("imagesLoaded")};this.pendingImageCount++;image.src=filepath}}}};jayus.objects={objects:{},pendingObjectCount:0,isLoaded:function jayus_objects_isLoaded(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.objects.isLoaded",filepath,"filepaths",6);for(var i=0;i<filepath.length;i++)if(!this.isLoaded(filepath[i]))return false;return true}jayus.debug.match("jayus.objects.isLoaded",filepath,"filepath",2);return typeof this.objects[filepath]==="object"&&this.objects[filepath]!==null},get:function jayus_objects_get(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.objects.get",
filepath,"filepaths",6);var objects=[];for(var i=0;i<filepath.length;i++)objects[i]=this.get(filepath[i]);return objects}jayus.debug.match("jayus.objects.get",filepath,"filepath",2);if(!this.isLoaded(filepath))console.error('jayus.objects.get() - Object "'+filepath+'" not yet loaded');return this.objects[filepath]},whenLoaded:function jayus_objects_whenLoaded(filepath,handler){if(typeof filepath==="object"){jayus.debug.matchArguments("jayus.objects.whenLoaded",arguments,"filepaths",6,"handler",3);
if(this.isLoaded(filepath))handler();else{jayus.addHandler("objectLoaded",function(data,options){if(jayus.objects.isLoaded(filepath)){handler();options.remove=true}});this.load(filepath)}}else{jayus.debug.matchArguments("jayus.objects.whenLoaded",arguments,"filepath",2,"handler",3);if(this.isLoaded(filepath))handler({filepath:filepath,object:this.get(filepath)});else{jayus.addHandler("objectLoaded",function(data,options){if(data.filepath===filepath){handler(data,options);options.remove=true}});this.load(filepath)}}return this},
load:function jayus_objects_load(filepath){if(typeof filepath==="object"){jayus.debug.match("jayus.objects.load",filepath,"filepaths",6);for(var i=0;i<filepath.length;i++)this.load(filepath[i])}else{jayus.debug.match("jayus.objects.load",filepath,"filepath",2);if(typeof this.objects[filepath]!=="object"){var req=new XMLHttpRequest;req.filepath=filepath;req.open("get",filepath,true);req.onload=function(){var object=JSON.parse(this.responseText);jayus.objects.objects[this.filepath]=object;jayus.fire("objectLoaded",
{filepath:this.filepath,object:object,xhr:this});jayus.objects.pendingObjectCount--;if(!jayus.objects.pendingObjectCount)jayus.fire("objectsLoaded")};this.objects[filepath]=null;this.pendingObjectCount++;req.send()}}}};jayus.keyboard={requireFocus:true,pressed:{},keys:[0,0,0,0,0,0,0,0,"backspace","tab",0,0,0,"enter",0,0,"shift","ctrl","alt","break","capsLock",0,0,0,0,0,0,"escape",0,0,0,0,"space","pageUp","pageDown","end","home","left","up","right","down",0,0,0,0,"insert","delete",0,"0","1","2","3","4","5","6","7","8","9",0,0,0,0,0,0,0,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","leftWin","rightWin","select",0,0,"num0","num1","num2","num3","num4","num5",
"num6","num7","num8","num9","numMultiply","numAdd",0,"numSubtract","numPeriod","numDivide","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"numLock","scrollLock",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"semicolon","equalSign","comma","dash","period","forwardSlash","grave",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"leftBracket","backslash","rightBracket","quote"],init:function jayus_keyboard_init(){document.addEventListener("keydown",
function jayus_onkeydownHandler(e){if(jayus.debug.pauseOnEscape&&e.keyCode===27)jayus.debug.pause();if(jayus.keyboard.requireFocus&&jayus.hasFocus){var key=jayus.keyboard.keys[e.keyCode],data={event:e,key:key};if(jayus.keyboard.pressed[key])return!jayus.fire("keyTap",data);jayus.keyboard.pressed[key]=true;var cancel=jayus.fire("keyPress",data)||jayus.fire("keyTap",data);if(cancel){e.preventDefault();return false}}});document.addEventListener("keyup",function jayus_onkeyupHandler(e){var key=jayus.keyboard.keys[e.keyCode];
if(jayus.keyboard.pressed[key]){jayus.keyboard.pressed[key]=false;if(jayus.fire("keyRelease",{event:e,key:key})){e.preventDefault();return false}}});document.addEventListener("keypress",function jayus_onkeypressHandler(e){if(jayus.keyboard.requireFocus&&jayus.hasFocus)if(jayus.fire("charType",{event:e,"char":String.fromCharCode(e.charCode)})){e.preventDefault();return false}})},isPressed:function jayus_keyboard_isPressed(id){jayus.debug.match("jayus.keyboard.isPressed",id,"id",2);if(!this.isKey(id))throw new RangeError("jayus.keyboard.isPressed() - Invalid id"+
jayus.debug.toString(id)+" sent, unknown id");return!!this.pressed[id]},isKey:function jayus_keyboard_isKey(id){jayus.debug.match("jayus.keyboard.isKey",id,"id",2);return this.keys.indexOf(id)>=0}};jayus.Point=jayus.Dependency.extend({x:0,y:0,init:function Point(x,y){if(arguments.length){jayus.debug.matchArgumentsAs("Point",arguments,4,"x","y");this.x=x;this.y=y}},toObject:function Point_toObject(){var object={type:"Point",x:this.x,y:this.y};if(this.id!=="")object.id=this.id;return object},initFromObject:function Point_initFromObject(object){jayus.debug.match("Point.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.x=object.x;this.y=object.y;
return this.dirty(127)},setX:function Point_setX(x){jayus.debug.match("Point.setX",x,"x",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setX,this.x,x)}if(this.x!==x){this.x=x;this.dirty(2)}return this},setY:function Point_setY(y){jayus.debug.match("Point.setY",y,"y",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setY,this.y,y)}if(this.y!==y){this.y=y;this.dirty(2)}return this},set:function Point_set(x,
y){jayus.debug.matchArgumentsAs("Point.set",arguments,4,"x","y");if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.set,[this.x,this.y],[x,y])}if(this.x!==x||this.y!==y){this.x=x;this.y=y;this.dirty(2)}return this},translate:function Point_translate(x,y){jayus.debug.matchCoordinate("Point.translate",x,y);if(arguments.length===1)return this.set(this.x+x.x,this.y+y.y);return this.set(this.x+x,this.y+y)},toString:function Point_toString(){return"(Point: "+this.x+
", "+this.y+")"},clone:function Point_clone(){return new jayus.Point(this.x,this.y)},cloneOnto:function Point_cloneOnto(ret){ret.x=this.x;ret.y=this.y;return ret},equals:function Point_equals(x,y){jayus.debug.matchCoordinate("Point.equals",x,y);if(arguments.length===1)return this.equals(x.x,x.y);return this.x===x&&this.y===y}});jayus.Rectangle=jayus.Dependency.extend({shapeType:4,x:0,y:0,width:0,height:0,roundX:false,roundY:false,init:function Rectangle(x,y,width,height){if(arguments.length){jayus.debug.matchRectangle("Rectangle",x,y,width,height);if(arguments.length===3){this.height=width;this.width=height;this.y=x.y;this.x=x.x}else{this.x=x;this.y=y;this.width=width;this.height=height}}},toObject:function Rectangle_toObject(){var object={type:"Rectangle",x:this.x,y:this.y,width:this.width,height:this.height};if(this.roundX!==
jayus.Rectangle.prototype.roundX)object.roundX=this.roundX;if(this.roundY!==jayus.Rectangle.prototype.roundY)object.roundY=this.roundY;if(this.id!=="")object.id=this.id;return object},initFromObject:function Rectangle_initFromObject(object){jayus.debug.match("Rectangle.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.x=object.x;this.y=object.y;this.width=object.width;this.height=object.height;if(typeof object.roundX==="number")this.roundX=object.roundX;
if(typeof object.roundY==="number")this.roundY=object.roundY;return this.dirty(127)},getOrigin:function Rectangle_getOrigin(){return new jayus.Point(this.x,this.y)},getOriginOnto:function Rectangle_getOriginOnto(ret){ret.x=this.x;ret.y=this.y;return ret},setX:jayus.Point.prototype.setX,setY:jayus.Point.prototype.setY,setOrigin:function Rectangle_setOrigin(x,y){jayus.debug.matchCoordinate("Rectangle.set",x,y);if(arguments.length===1)return this.setOrigin(x.x,x.y);if(this.actionsToAnimate){this.actionsToAnimate--;
return new jayus.MethodAnimator(this,this.setOrigin,[this.x,this.y],[x,y])}if(this.x!==x||this.y!==y){this.x=x;this.y=y;this.dirty(2)}return this},translate:function Rectangle_translate(x,y){jayus.debug.matchCoordinate("Rectangle.translate",x,y);if(arguments.length===1)return this.setOrigin(this.x+x.x,this.y+x.y);return this.setOrigin(this.x+x,this.y+y)},setRounding:function RectEntity_setRounding(x,y){if(arguments.length===1){jayus.debug.match("RectEntity.setRounding",x,"x",1);this.roundX=x;this.roundY=
y}else{jayus.debug.matchArgumentsAs("RectEntity.setRounding",arguments,1,"x","y");if(this.roundX!==x||this.roundY!==y){this.roundX=x;this.roundY=y;this.dirty(127)}}return this},setWidth:function Rectangle_setWidth(width){jayus.debug.match("Rectangle.setWidth",width,"width",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setWidth,this.width,width)}if(this.width!==width){this.width=width;this.dirty(4)}return this},setHeight:function Rectangle_setHeight(height){jayus.debug.match("Rectangle.setHeight",
height,"height",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setHeight,this.height,height)}if(this.height!==height){this.height=height;this.dirty(4)}return this},setSize:function Rectangle_setSize(width,height){jayus.debug.matchSize("Rectangle.setSize",width,height);if(arguments.length===1){height=width.height;width=width.width}if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setSize,[this.width,this.height],
[width,height])}if(this.width!==width||this.height!==height){this.width=width;this.height=height;this.dirty(4)}return this},expand:function Rectangle_expand(width,height){jayus.debug.matchArgumentsAs("Rectangle.expand",arguments,4,"width","height");return this.setSize(this.width+width,this.height+height)},getLeft:function Rectangle_getLeft(){return this.x},getRight:function Rectangle_getRight(){return this.x+this.width},getTop:function Rectangle_getTop(){return this.y},getBottom:function Rectangle_getBottom(){return this.y+
this.height},setLeft:function Rectangle_setLeft(left){jayus.debug.match("Rectangle.setLeft",left,"left",4);return this.setFrame(left,this.y,this.x+this.width-left,this.height)},setRight:function Rectangle_setRight(right){jayus.debug.match("Rectangle.setRight",right,"right",4);return this.setWidth(this.width+right-this.x)},setTop:function Rectangle_setTop(top){jayus.debug.match("Rectangle.setTop",top,"top",4);return this.setFrame(this.x,top,this.width,this.y+this.height-top)},setBottom:function Rectangle_setBottom(bottom){jayus.debug.match("Rectangle.setBottom",
bottom,"bottom",4);return this.setHeight(this.height+bottom-this.y)},setFrame:function Rectangle_setFrame(x,y,width,height){if(arguments.length===3){jayus.debug.matchArguments("Rectangle.setFrame",arguments,"origin",13,"width",4,"height",4);return this.setFrame(x.x,x.y,y,width)}jayus.debug.matchArgumentsAs("Rectangle.setFrame",arguments,4,"x","y","width","height");if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setFrame,[this.x,this.y,this.width,this.height],
[x,y,width,height])}this.x=x;this.y=y;this.width=width;this.height=height;this.dirty(6);return this},includePoint:function Rectangle_includePoint(x,y){jayus.debug.matchCoordinate("Rectangle.includePoint",x,y);if(arguments.length===1)return this.includePoint(x.x,x.y);var x1=Math.min(this.x,x),y1=Math.min(this.y,y),x2=Math.max(this.x+this.width,x),y2=Math.max(this.y+this.height,y);return this.setFrame(x1,y1,x2-x1,y2-y1)},includeRectangle:function Rectangle_includeRectangle(x,y,width,height){if(arguments.length===
1){jayus.debug.match("Rectangle.includeRectangle()",x,"section",20);return this.includeRectangle(x.x,x.y,x.width,x.height)}if(arguments.length===3){jayus.debug.matchArguments("Rectangle.includeRectangle()",arguments,"origin",13,"width",4,"height",4);return this.includeRectangle(x.x,x.y,y,width)}jayus.debug.matchArgumentsAs("Rectangle.includeRectangle()",arguments,4,"x","y","width","height");var x1=Math.min(this.x,x),y1=Math.min(this.y,y),x2=Math.max(this.x+this.width,x+width),y2=Math.max(this.y+this.height,
y+height);return this.setFrame(x1,y1,x2-x1,y2-y1)},alignToCanvas:function Rectangle_alignToCanvas(){return this.setFrame(Math.floor(this.x)+0.5,Math.floor(this.y)+0.5,Math.round(this.width),Math.round(this.height))},intersectsAt:function Rectangle_intersectsAt(x,y){jayus.debug.matchArgumentsAs("Rectangle.intersectsAt",arguments,4,"x","y");return this.x<=x&&(x<=this.x+this.width&&(this.y<=y&&y<=this.y+this.height))},toString:function Rectangle_toString(){return"(Rectangle: "+this.x+", "+this.y+", "+
this.width+", "+this.height+")"},getScope:function Rectangle_getScope(){return this.clone()},getTransformed:function Rectangle_getTransformed(matrix){jayus.debug.match("Rectangle.getTransformed",matrix,"matrix",10);return this.toPolygon().getTransformed(matrix)},clone:function Rectangle_clone(){return this.cloneOnto(new jayus.Rectangle)},cloneOnto:function Rectangle_cloneOnto(ret){jayus.debug.match("Rectangle.cloneOnto",ret,"ret",20);ret.x=this.x;ret.y=this.y;ret.width=this.width;ret.height=this.height;
return ret},toPolygon:function Rectangle_toPolygon(){return new jayus.Polygon.Rectangle(this.x,this.y,this.width,this.height)},paintedWith:function Rectangle_paintedWith(brush){return new jayus.PaintedShape(this,brush)},etchOntoContext:function Rectangle_etchOntoContext(ctx){jayus.debug.matchContext("Rectangle.etchOntoContext",ctx);var x=this.x,y=this.y,w=this.width,h=this.height;ctx.beginPath();if(this.roundX){x=Math.round(x)+0.5;w=Math.round(w)}if(this.roundY){y=Math.round(y)+0.5;h=Math.round(h)}ctx.rect(x,
y,w,h);return this}});jayus.Circle=jayus.Dependency.extend({shapeType:2,x:0,y:0,radius:1,init:function Circle(x,y,radius){if(arguments.length){if(arguments.length===2)jayus.debug.matchArguments("Circle",arguments,"center",13,"radius",4);else if(arguments.length===3)jayus.debug.matchArgumentsAs("Circle",arguments,4,"x","y","radius");else throw new TypeError("Circle() - Invalid number of parameters sent, 0, 2, or 3 required");if(arguments.length===2){this.radius=y;this.y=x.y;this.x=x.x}else{this.x=x;this.y=y;this.radius=
radius}}},toObject:function Circle_toObject(){var object={type:"Circle",x:this.x,y:this.y,radius:this.radius};if(this.id!=="")object.id=this.id;return object},initFromObject:function Circle_initFromObject(object){jayus.debug.match("Circle.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.x=object.x;this.y=object.y;this.radius=object.radius;return this.dirty(127)},getCenter:function Circle_getCenter(){return new jayus.Point(this.x,this.y)},setX:jayus.Point.prototype.setX,
setY:jayus.Point.prototype.setY,setCenter:jayus.Point.prototype.set,translate:function Circle_translate(x,y){jayus.debug.matchCoordinate("Circle.translate",x,y);if(arguments.length===1)return this.setCenter(this.x+x.x,this.y+x.y);return this.setCenter(this.x+x,this.y+y)},alignToCanvas:function Circle_alignToCanvas(){return this},paintedWith:function Circle_paintedWith(brush){return new jayus.PaintedShape(this,brush)},getRadius:function Circle_getRadius(){return this.radius},setRadius:function Circle_setRadius(radius){jayus.debug.match("Circle.setRadius",
radius,"radius",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setRadius,this.radius,radius)}if(this.radius!==radius){this.radius=radius;this.dirty(4)}return this},intersectsAt:function Circle_intersectsAt(x,y){jayus.debug.matchArgumentsAs("Circle.intersectsAt",arguments,4,"x","y");return(this.x-x)*(this.x-x)+(this.y-y)*(this.y-y)<=this.radius*this.radius},getScope:function Circle_getScope(){return new jayus.Rectangle(this.x-this.radius,this.y-this.radius,
this.radius*2,this.radius*2)},clone:function Circle_clone(){return new jayus.Circle(this.x,this.y,this.radius)},cloneOnto:function Circle_cloneOnto(ret){ret.x=this.x;ret.y=this.y;ret.radius=this.radius;return ret},toPolygon:function Circle_toPolygon(detail){if(!arguments.length)return this.toPolygon(10);else jayus.debug.match("Circle.toPolygon",detail,"detail",4);return new jayus.Polygon.Regular(detail,this.radius)},etchOntoContext:function Circle_etchOntoContext(ctx){jayus.debug.matchContext("Circle.etchOntoContext",
ctx);ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2)}});jayus.Polygon=jayus.Dependency.extend({shapeType:8,xPoints:null,yPoints:null,x1:0,y1:0,x2:0,y2:0,closed:true,frame:null,frameDirty:true,init:function Polygon(xPoints,yPoints){if(arguments.length===2){jayus.debug.matchArray("Polygon",xPoints,"xPoints",4);jayus.debug.matchArray("Polygon",yPoints,"yPoints",4);this.xPoints=xPoints;this.yPoints=yPoints}else{this.xPoints=[];this.yPoints=[];if(arguments.length===1){jayus.debug.matchArray("Polygon",xPoints,"xPoints",13);for(var i=0;i<xPoints.length;i++){this.xPoints[i]=
xPoints[i].x;this.yPoints[i]=xPoints[i].y}}}},toObject:function Polygon_toObject(){var object={type:"Polygon",xPoints:this.xPoints,yPoints:this.yPoints};if(this.closed!==true)object.closed=this.closed;if(this.id!=="")object.id=this.id;return object},initFromObject:function Polygon_initFromObject(object){jayus.debug.match("Polygon.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.xPoints=object.xPoints;this.yPoints=object.yPoints;if(typeof object.closed===
"boolean")this.closed=object.closed;this.reformFrame();return this.dirty(127)},translate:function Polygon_translate(x,y){jayus.debug.matchCoordinate("Polygon.translate",x,y);if(arguments.length===1)return this.translate(x.x,x.y);if(x||y){for(var i=0;i<this.xPoints.length;i++){this.xPoints[i]+=x;this.yPoints[i]+=y}this.frameDirty=true}return this},alignToCanvas:function Polygon_alignToCanvas(){return this},paintedWith:function Polygon_paintedWith(brush){return new jayus.PaintedShape(this,brush)},addPoint:function Polygon_addPoint(x,
y){jayus.debug.matchCoordinate("Polygon.addPoint",x,y);if(arguments.length===1)return this.addPoint(x.x,x.y);this.xPoints.push(x);this.yPoints.push(y);this.frameDirty=true;return this.dirty(16)},addPoints:function Polygon_addPoints(xPoints,yPoints){if(arguments.length===1){jayus.debug.matchArray("Polygon.addPoints",xPoints,"xPoints",13);for(var i=0;i<xPoints.length;i++){this.xPoints.push(xPoints[i].x);this.yPoints.push(xPoints[i].y)}}else if(arguments.length===2){jayus.debug.matchArray("Polygon.addPoints",
xPoints,"xPoints",4);jayus.debug.matchArray("Polygon.addPoints",yPoints,"yPoints",4);this.xPoints=this.xPoints.concat(xPoints);this.yPoints=this.yPoints.concat(yPoints)}this.frameDirty=true;return this.dirty(16)},insertPoint:function Polygon_insertPoint(index,x,y){if(arguments.length===2){jayus.debug.matchArguments("Polygon.insertPoint",arguments,"index",4,"point",13);return this.insertPoint(index,x.x,x.y)}jayus.debug.matchArgumentsAs("Polygon.insertPoint",arguments,4,"index","x","y");this.xPoints.splice(index,
0,x);this.yPoints.splice(index,0,y);this.frameDirty=true;return this.dirty(16)},setPoint:function Polygon_setPoint(index,x,y){if(arguments.length===2){jayus.debug.matchArguments("Polygon.setPoint",arguments,"index",4,"point",13);return this.setPoint(index,x.x,x.y)}jayus.debug.matchArgumentsAs("Polygon.setPoint",arguments,4,"index","x","y");this.xPoints[index]=x;this.yPoints[index]=y;this.frameDirty=true;return this.dirty(16)},getLeft:function Shape_getLeft(){return this.getFrame().getLeft()},getTop:function Shape_getTop(){return this.getFrame().getTop()},
getWidth:function Shape_getWidth(){return this.getFrame().getWidth()},getHeight:function Shape_getHeight(){return this.getFrame().getHeight()},getScope:function Polygon_getScope(){return this.getFrame()},getFrame:function Polygon_getFrame(){if(this.frameDirty){this.reformFrame();this.frameDirty=false}return this.frame},reformFrame:function Polygon_reformFrame(){var i,x,y,x1=null,x2=null,y1=null,y2=null;for(i=0;i<this.xPoints.length;i++){x=this.xPoints[i];y=this.yPoints[i];if(x1===null||x<x1)x1=x;
if(x2===null||x>x2)x2=x;if(y1===null||y<y1)y1=y;if(y2===null||y>y2)y2=y}if(this.frame===null)this.frame=new jayus.Rectangle;this.frame.setFrame(x1,y1,x2-x1,y2-y1)},intersectsAt:function Polygon_intersectsAt(x,y){jayus.debug.matchArgumentsAs("Polygon.intersectsAt",arguments,4,"x","y");var ctx=jayus.getContext();ctx.save();this.etchOntoContext(ctx);var ret=ctx.isPointInPath(x,y);ctx.restore();return ret},setClosed:function Polygon_setClosed(on){jayus.debug.match("Polygon.setClosed",on,"on",1);if(this.closed!==
on){this.closed=on;this.dirty(16)}return this},clone:function Polygon_clone(){return new jayus.Polygon(this.xPoints.slice(0),this.yPoints.slice(0))},cloneOnto:function Polygon_cloneOnto(ret){ret.xPoints=this.xPoints.slice(0);ret.yPoints=this.yPoints.slice(0);ret.frameDirty=true;return ret},transform:function Polygon_transform(matrix){jayus.debug.match("Polygon.transform",matrix,"matrix",10);var i,point=new jayus.Point;for(i=0;i<this.xPoints.length;i++){matrix.transformPointOnto(this.xPoints[i],this.yPoints[i],
point);this.xPoints[i]=point.x;this.yPoints[i]=point.y}this.frameDirty=true;return this},getTransformed:function Polygon_getTransformed(matrix){jayus.debug.match("Polygon.getTransformed",matrix,"matrix",10);return this.getTransformedOnto(matrix,new jayus.Polygon)},getTransformedOnto:function Polygon_getTransformedOnto(matrix,ret){jayus.debug.matchArguments("Polygon.getTransformedOnto",arguments,"matrix",10,"ret",15);var i,point=new jayus.Point;ret.xPoints=[];ret.yPoints=[];for(i=0;i<this.xPoints.length;i++){matrix.transformPointOnto(this.xPoints[i],
this.yPoints[i],point);ret.xPoints.push(point.x);ret.yPoints.push(point.y)}return ret},etchOntoContext:function Polygon_etchOntoContext(ctx){jayus.debug.matchContext("Polygon.etchOntoContext",ctx);if(this.xPoints.length){ctx.beginPath();ctx.moveTo(this.xPoints[0],this.yPoints[0]);for(var i=0;i<this.xPoints.length;i++)ctx.lineTo(this.xPoints[i],this.yPoints[i]);if(this.closed)ctx.closePath()}return this}});
jayus.Polygon.Line=function Polygon_Line(x1,y1,x2,y2){if(arguments.length===2){jayus.debug.matchArguments("Polygon.Line()",arguments,"start",13,"end",13);return jayus.Polygon.Line(x1.x,x1.y,y1.x,y1.y)}jayus.debug.matchArgumentsAs("Polygon.Line",arguments,4,"x1","y1","x2","y2");return new jayus.Polygon([x1,x2],[y1,y2])};
jayus.Polygon.LineOnto=function Polygon_LineOnto(x1,y1,x2,y2,ret){jayus.debug.matchArgumentsAs("Polygon.LineOnto",arguments,4,"x1","y1","x2","y2");jayus.debug.match("Polygon.LineOnto",ret,"ret",15);ret.xPoints=[x1,x2];ret.yPoints=[y1,y2];ret.frameDirty=true;return ret};
jayus.Polygon.Rectangle=function Polygon_Rectangle(x,y,width,height){if(arguments.length===3){jayus.debug.matchArguments("Polygon.Rectangle",arguments,"origin",13,"width",4,"height",4);return jayus.Polygon.Rectangle(x.x,x.y,y,width)}jayus.debug.matchArgumentsAs("Polygon.Rectangle",arguments,4,"x","y","width","height");return new jayus.Polygon([x,x+width,x+width,x],[y,y,y+height,y+height])};
jayus.Polygon.Regular=function Polygon_Regular(count,radius){jayus.debug.matchArgumentsAs("Polygon.Regular",arguments,4,"count","radius");var i,poly=new jayus.Polygon,angle=0,step=Math.PI*2/count;for(i=0;i<count;i++){poly.addPoint(radius*Math.cos(angle),radius*Math.sin(angle));angle+=step}return poly};
jayus.Polygon.Star=function Polygon_Star(count,innerRadius,outerRadius){jayus.debug.matchArgumentsAs("Polygon.Star",arguments,4,"count","innerRadius","outerRadius");var i,poly=new jayus.Polygon,angle=0,step=Math.PI/count,atInner=true,radius=innerRadius;for(i=0;i<count*2;i++){poly.addPoint(radius*Math.cos(angle),radius*Math.sin(angle));radius+=atInner?outerRadius:innerRadius;atInner=!atInner;angle+=step}return poly};jayus.Path=jayus.Dependency.extend({shapeType:16,segments:null,x1:0,y1:0,x2:0,y2:0,frame:null,frameDirty:true,toPolygonDetail:10,init:function Path(pathString){this.segments=[];if(arguments.length){jayus.debug.match("Path",pathString,"pathString",2);this.addSVS(pathString)}},toObject:function Path_toObject(){var object={type:"Path",segments:this.segments};if(this.toPolygonDetail!==10)object.toPolygonDetail=this.toPolygonDetail;if(this.id!=="")object.id=this.id;return object},initFromObject:function Path_initFromObject(object){jayus.debug.match("Path.initFromObject",
object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.x=object.xPoints;this.y=object.yPoints;if(typeof object.toPolygonDetail==="number")this.toPolygonDetail=object.toPolygonDetail;this.reformFrame();return this.dirty(127)},translate:function Path_translate(x,y){jayus.debug.matchCoordinate("Path.translate",x,y);if(arguments.length===1)return this.translate(x.x,x.y);for(var i=0;i<this.segments.length;i++)this.moveSegment(i,x,y);return this},alignToCanvas:function Path_alignToCanvas(){return this},
paintedWith:function Path_paintedWith(brush){return new jayus.PaintedShape(this,brush)},getScope:function Path_getScope(){if(this.segments.length===0)return null;this.reformFrame();return new jayus.Rectangle(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1)},reformFrame:function Path_reformFrame(){var i,x,y,point,x1=null,x2=null,y1=null,y2=null;for(i=0;i<this.segments.length;i++){point=this.getPoint(i);x=point.x;y=point.y;if(x1===null||x<x1)x1=x;if(x2===null||x>x2)x2=x;if(y1===null||y<y1)y1=y;if(y2===
null||y>y2)y2=y}this.x1=x1;this.x2=x2;this.y1=y1;this.y2=y2},intersectsAt:function Path_intersectsAt(x,y){jayus.debug.matchCoordinate("Path.intersectsAt",x,y);var ctx=jayus.getContext();ctx.save();this.etchOntoContext(ctx);var ret=ctx.isPointInPath(x,y);ctx.restore();return ret},moveTo:function Path_moveTo(x,y){jayus.debug.matchArgumentsAs("Path.moveTo",arguments,4,"x","y");return this.addSegment(["moveTo",x,y])},moveBy:function Path_moveBy(x,y){jayus.debug.matchArgumentsAs("Path.moveBy",arguments,
4,"x","y");var pos=this.getCurrentPoint();return this.moveTo(pos.x+x,pos.y+y)},closePath:function Path_closePath(){return this.addSegment(["closePath"])},lineTo:function Path_lineTo(x,y){jayus.debug.matchArgumentsAs("Path.lineTo",arguments,4,"x","y");return this.addSegment(["lineTo",x,y])},lineBy:function Path_lineBy(x,y){jayus.debug.matchArgumentsAs("Path.lineBy",arguments,4,"x","y");var pos=this.getCurrentPoint();return this.lineTo(pos.x+x,pos.y+y)},quadraticCurveTo:function Path_quadraticCurveTo(cpx,
cpy,x,y){jayus.debug.matchArgumentsAs("Path.quadraticCurveTo",arguments,4,"cpx","cpy","x","y");return this.addSegment(["quadraticCurveTo",cpx,cpy,x,y])},quadraticCurveBy:function Path_quadraticCurveBy(cpx,cpy,x,y){jayus.debug.matchArgumentsAs("Path.quadraticCurveBy",arguments,4,"cpx","cpy","x","y");var pos=this.getCurrentPoint();return this.quadraticCurveTo(pos.x+cpx,pos.y+cpy,pos.x+x,pos.y+y)},bezierCurveTo:function Path_bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y){jayus.debug.matchArgumentsAs("Path.bezierCurveTo",
arguments,4,"cp1x","cp1y","cp2x","cp2y","x","y");return this.addSegment(["bezierCurveTo",cp1x,cp1y,cp2x,cp2y,x,y])},bezierCurveBy:function Path_bezierCurveBy(cp1x,cp1y,cp2x,cp2y,x,y){jayus.debug.matchArgumentsAs("Path.bezierCurveBy",arguments,4,"cp1x","cp1y","cp2x","cp2y","x","y");var pos=this.getCurrentPoint();return this.bezierCurveTo(pos.x+cp1x,pos.y+cp1y,pos.x+cp2x,pos.y+cp2y,pos.x+x,pos.y+y)},arcTo:function Path_arcTo(x1,y1,x2,y2,radius){jayus.debug.matchArgumentsAs("Path.arcTo",arguments,4,
"x1","y1","x2","y2","radius");return this.addSegment(["arcTo",x1,y1,x2,y2,radius])},arcBy:function Path_arcBy(x1,y1,x2,y2,radius){jayus.debug.matchArgumentsAs("Path.arcBy",arguments,4,"x1","y1","x2","y2","radius");var pos=this.getCurrentPoint();return this.arcTo(pos.x+x1,pos.y+y1,pos.x+x2,pos.y+y2,radius)},arc:function Path_arc(x,y,radius,startAngle,endAngle,anticlockwise){jayus.debug.matchArguments("Path.arc",arguments,"x",4,"y",4,"radius",4,"startAngle",4,"endAngle",4,"anticlockwise",1);return this.addSegment(["arc",
x,y,radius,startAngle,endAngle,anticlockwise])},rect:function Path_rect(x,y,width,height){jayus.debug.matchArgumentsAs("Path.rect",arguments,4,"x","y","width","height");return this.addSegment(["rect",x,y,width,height])},ellipse:function Path_ellipse(x,y,radiusX,radiusY,rotation,startAngle,endAngle,anticlockwise){jayus.debug.matchArguments("Path.ellipse",arguments,"x",4,"y",4,"radiusX",4,"radiusY",4,"startAngle",4,"endAngle",4,"anticlockwise",1);return this.addSegment(["ellipse",x,y,radiusX,radiusY,
startAngle,endAngle,anticlockwise])},horizontalLineTo:function Path_horizontalLineTo(x){jayus.debug.match("Path.horizontalLineTo",x,"x",4);return this.lineTo(x,this.getCurrentPoint().y)},horizontalLineBy:function Path_horizontalLineBy(x){jayus.debug.match("Path.horizontalLineBy",x,"x",4);return this.lineBy(x,0)},verticalLineTo:function Path_verticalLineTo(y){jayus.debug.match("Path.verticalLineTo",y,"y",4);return this.lineTo(this.getCurrentPoint().x,y)},verticalLineBy:function Path_verticalLineBy(y){jayus.debug.match("Path.verticalLineBy",
y,"y",4);return this.lineBy(0,y)},addSegment:function Path_addSegment(data){this.segments.push(data);return this},getInitialPoint:function Path_getInitialPoint(){return this.getPoint(0)},getCurrentPoint:function Path_getCurrentPoint(){return this.getPoint(this.segments.length-1)},getPoint:function Path_getPoint(index){if(this.hasPointIndex(index)){var segment=this.segments[index];switch(segment[0]){case "moveTo":return new jayus.Point(segment[1],segment[2]);case "closePath":return this.getInitialPoint();
case "lineTo":return new jayus.Point(segment[1],segment[2]);case "quadraticCurveTo":return new jayus.Point(segment[3],segment[4]);case "bezierCurveTo":return new jayus.Point(segment[5],segment[6]);case "arcTo":return jayus.getFinalArcToPoint(this,segment);case "arc":var cx=segment[1],cy=segment[2],r=segment[3],startAngle=segment[4],endAngle=segment[5],anticlockwise=segment[6];return new jayus.Point(cx+r*Math.cos(endAngle),cy+r*Math.sin(endAngle));case "rect":return this.getPoint(index-1);case "ellipse":throw new Error('Path.getPoint() - Unimplemented for "ellipse"');
}}else throw new RangeError("Path.getPoint() - Invalid index sent: "+index);},addSVG:function Path_addSVG(path){var i,segment,data=this.parsePathString(path);for(i=0;i<data.length;i++){segment=data[i];switch(segment[0]){case "M":this.moveTo(segment[1],segment[2]);break;case "m":this.moveBy(segment[1],segment[2]);break;case "Z":case "z":this.closePath();break;case "L":this.lineTo(segment[1],segment[2]);break;case "l":this.lineBy(segment[1],segment[2]);break;case "H":this.horizontalLineTo(segment[1]);
break;case "h":this.horizontalLineBy(segment[1]);break;case "V":this.verticalLineTo(segment[1]);break;case "v":this.verticalLineBy(segment[1]);break;case "C":this.bezierCurveTo(segment[1],segment[2],segment[3],segment[4],segment[5],segment[6]);break;case "c":this.bezierCurveBy(segment[1],segment[2],segment[3],segment[4],segment[5],segment[6]);break;case "S":case "s":throw new Error("Path.addSVG() - Unimplemented for S/s commands");case "Q":this.quadraticCurveTo(segment[1],segment[2],segment[3],segment[4]);
break;case "q":this.quadraticCurveBy(segment[1],segment[2],segment[3],segment[4]);break;case "T":case "t":throw new Error("Path.addSVG() - Unimplemented for T/t commands");case "A":case "a":throw new Error("Path.addSVG() - Unimplemented for A/a commands");case "R":case "r":throw new Error("Path.addSVG() - Unimplemented for R/r commands");}}},parsePathString:function Path_parsePathString(path){path=path.replace(/ /g,",").replace(/-/g,",-");path=path.replace(/[MmZzLlHhVvCcSsQqTtAaRr]/g,function(match){return","+
match+","});path=path.split(",");var i,item,paramCounts={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},segment,data=[],paramsNeeded=0;for(i=0;i<path.length;i++){item=path[i];if(item!=="")if(paramsNeeded===0)if(paramCounts.hasOwnProperty(item.toLowerCase())){segment=[item];paramsNeeded=paramCounts[item.toLowerCase()];data.push(segment)}else return"ERROR: expected command, got: "+item;else{var param=parseFloat(item);if(!isNaN(param)){segment.push(param);paramsNeeded--}else return"ERROR: expected parameter, got: "+
item}}return data},getSegmentCount:function Path_getSegmentCount(){return this.segments.length},hasPointIndex:function Path_hasPointIndex(index){jayus.debug.match("Path.hasPointIndex",index,"index",4);return 0<=index&&index<this.segments.length},isClosed:function Path_isClosed(){return this.getInitialPoint().equals(this.getCurrentPoint())},clone:function Path_clone(){var i,j,segment,newSegment,newSegments=[];for(i=0;i<this.segments.length;i++){segment=this.segments[i];newSegment=[];for(j=0;j<segment.length;j++)newSegment.push(segment[j]);
newSegments.push(newSegment)}var path=new jayus.Path;path.segments=newSegments;return path},getTransformed:function Path_getTransformed(matrix){var i,segment,newSegment,temp,newSegments=[];for(i=0;i<this.segments.length;i++){segment=this.segments[i];newSegment=[segment[0]];newSegments.push(newSegment);switch(segment[0]){case "moveTo":temp=matrix.transformPoint(segment[1],segment[2]);newSegment[1]=temp.x;newSegment[2]=temp.y;break;case "closePath":break;case "lineTo":temp=matrix.transformPoint(segment[1],
segment[2]);newSegment[1]=temp.x;newSegment[2]=temp.y;break;case "quadraticCurveTo":temp=matrix.transformPoint(segment[1],segment[2]);newSegment[1]=temp.x;newSegment[2]=temp.y;temp=matrix.transformPoint(segment[3],segment[4]);newSegment[3]=temp.x;newSegment[4]=temp.y;break;case "bezierCurveTo":temp=matrix.transformPoint(segment[1],segment[2]);newSegment[1]=temp.x;newSegment[2]=temp.y;temp=matrix.transformPoint(segment[3],segment[4]);newSegment[3]=temp.x;newSegment[4]=temp.y;temp=matrix.transformPoint(segment[5],
segment[6]);newSegment[5]=temp.x;newSegment[6]=temp.y;break;case "arcTo":case "arc":case "rect":case "ellipse":throw new Error("TODO: Path.getTransformed() - Unimplemented for command "+segment[0]);}}},toPolygon:function Path_toPolygon(detail){if(!arguments.length)detail=this.toPolygonDetail;else jayus.debug.match("Circle.toPolygon",detail,"detail",4);throw new Error("TODO: Path.toPolygon() - Unimplemented");},etchOntoContext:function Path_etchOntoContext(ctx){ctx.beginPath();var i,segment,point=
this.getPoint(0),x=point.x,y=point.y;for(i=0;i<this.segments.length;i++){segment=this.segments[i];switch(segment[0]){case "moveTo":x=segment[1];y=segment[2];ctx.moveTo(x,y);break;case "closePath":ctx.closePath();break;case "lineTo":x=segment[1];y=segment[2];ctx.lineTo(x,y);break;case "bezierCurveTo":x=segment[5];y=segment[6];ctx.bezierCurveTo(segment[1],segment[2],segment[3],segment[4],x,y);break;case "quadraticCurveTo":x=segment[3];y=segment[4];ctx.quadraticCurveTo(segment[1],segment[2],x,y);break;
case "arcTo":ctx.arcTo(segment[1],segment[2],segment[3],segment[4],segment[5]);point=this.getPoint(i);x=point.x;y=point.y;break;case "arc":ctx.arc(segment[1],segment[2],segment[3],segment[4],segment[5],segment[6]);point=this.getPoint(i);x=point.x;y=point.y;break;case "rect":x=segment[1];y=segment[2];ctx.rect(x,y,segment[3],segment[4]);break;case "ellipse":throw new Error("Path.etchOntoContext() - Unimplemented for command ellipse");}}return this}});
jayus.Path.Circle=function Path_Circle(x,y,radius){if(arguments.length===2){jayus.debug.matchArguments("Path.Circle()",arguments,"center",13,"radius",4);return jayus.Path.Circle(x.x,x.y,y)}jayus.debug.matchArgumentsAs("Path.Circle()",arguments,4,"x","y","radius");return(new jayus.Path).arc(x,y,radius,0,Math.PI*2,false)};
jayus.Path.Rectangle=function Path_Rectangle(x,y,width,height){if(arguments.length===3){jayus.debug.matchArguments("Path.Rectangle()",arguments,"origin",13,"width",4,"height",4);return(new jayus.Path).rect(x.x,x.y,y,width)}jayus.debug.matchArgumentsAs("Path.Rectangle()",arguments,4,"x","y","width","height");return(new jayus.Path).rect(x,y,width,height)};
jayus.getFinalArcToPoint=function jayus_getFinalArcToPoint(path,segment){var p0=path.getPoint(segment-1);var x0=p0.x,y0=p0.y,x1=segment[1],y1=segment[2],x2=segment[3],y2=segment[4],r=segment[5];var angle1=Math.atan2(y0-y1,x0-x1),angle2=Math.atan2(y1-y2,x1-x2);var abs=Math.abs(angle1-angle2);var angleDiff=Math.min(Math.PI*2-abs,abs);var u=angleDiff/2;var z=r/Math.tan(u);var x=x1+z*Math.cos(angle2);var y=y1+z*Math.sin(angle2);return new jayus.Point(x,y)};
jayus.getPathScope=function jayus_getPathScope(path){var i,segment,scope=new jayus.Rectangle;for(i=0;i<path.segments.length;i++){segment=path.segments[i];switch(segment[0]){case "moveTo":scope.includeAt(segment[1],segment[2]);break;case "closePath":break;case "lineTo":scope.includeAt(segment[1],segment[2]);break;case "bezierCurveTo":scope.includeAt(segment[1],segment[2]);scope.includeAt(segment[3],segment[4]);scope.includeAt(segment[5],segment[6]);break;case "quadraticCurveTo":scope.includeAt(segment[1],
segment[2]);scope.includeAt(segment[3],segment[4]);break;case "arcTo":break;case "arc":break;case "rect":var x=segment[1],y=segment[2],w=segment[3],h=segment[4];scope.setLeft(Math.max(scope.getLeft(),x));scope.setRight(Math.max(scope.getRight(),x+w));scope.setTop(Math.max(scope.getTop(),y));scope.setBottom(Math.max(scope.getBottom(),y+h));break;case "ellipse":break}}};(function(){jayus.applyObject(jayus.Dependency.prototype,jayus.Responder.prototype);jayus.Entity=jayus.Responder.extend({shapeType:0,isParent:false,included:true,visible:true,alpha:1,isTransformed:false,actionsToAnimate:0,enableDragEvents:false,leftDragging:false,middleDragging:false,rightDragging:false,properties:["visible","included","alpha","angle","xAnchor","yAnchor","trackCursor","canAcceptCursor","canReleaseCursor","enableDragEvents"],debugRenderer:null,exposingAll:false,expose:function Entity_expose(){this.debugRenderer=
jayus.debug.defaultDebugRenderer;this.dirty(127)},unexpose:function Entity_unexpose(){this.debugRenderer=null;this.dirty(127)},toggleExposed:function Entity_toggleExposed(){if(this.debugRenderer!==null)this.unexpose();else this.expose()},exposeAll:function Entity_exposeAll(){this.debugRenderer=jayus.debug.defaultDebugRenderer;this.exposingAll=true;if(this.isParent)this.forEachChild(function(){this.exposeAll()});this.dirty(127)},unexposeAll:function Entity_exposeAll(){this.debugRenderer=null;this.exposingAll=
false;if(this.isParent)this.forEachChild(function(){this.unexposeAll()});this.dirty(127)},animate:function Animatable_animate(){this.actionsToAnimate++;return this},init:function Entity(){if(this.enableDragEvents)this.handle({leftPress:function Entity_startLeftDrag(e){this.leftDragging=true;return this.fire("leftDragStart",e)},leftRelease:function Entity_endLeftDrag(e){if(this.leftDragging){this.leftDragging=false;return this.fire("leftDragEnd",e)}},middlePress:function Entity_startMiddleDrag(e){this.middleDragging=
true;return this.fire("middleDragStart",e)},middleRelease:function Entity_endMiddleDrag(e){if(this.middleDragging){this.middleDragging=false;return this.fire("middleDragEnd",e)}},rightPress:function Entity_startRightDrag(e){this.rightDragging=true;return this.fire("rightDragStart",e)},rightRelease:function Entity_endRightDrag(e){if(this.rightDragging){this.rightDragging=false;return this.fire("rightDragEnd",e)}},cursorMove:function Entity_handleDragging(e){var ret=false;if(this.leftDragging)ret=this.fire("leftDrag",
e)||ret;if(this.middleDragging)ret=this.fire("middleDrag",e)||ret;if(this.rightDragging)ret=this.fire("rightDrag",e)||ret;return ret},cursorOut:function Entity_endDragging(){if(this.leftDragging)this.fire("leftDragEnd");if(this.middleDragging)this.fire("middleDragEnd");if(this.rightDragging)this.fire("rightDragEnd");this.leftDragging=this.middleDragging=this.rightDragging=false}})},toObject:function Entity_toObject(){var object={type:"Entity"};if(this.id!=="")object.id=this.id;var i,key,val,valType;
for(i=0;i<jayus.Entity.prototype.properties.length;i++){key=jayus.Entity.prototype.properties[i];val=this[key];valType=typeof val;if(val!==jayus.Entity.prototype[key]){if(valType==="object")val=val.toObject();object[key]=val}}return object},initFromObject:function Entity_initFromObject(object){jayus.debug.match("Entity.initFromObject",object,"object",5);jayus.Dependency.prototype.initFromObject.call(this,object);this.frozen++;var i,key,val,valType;for(i=0;i<jayus.Entity.prototype.properties.length;i++){key=
jayus.Entity.prototype.properties[i];val=object[key];valType=typeof val;if(val!==undefined){if(valType==="object")val=jayus.parse(val);this[key]=val}}if(typeof object.tooltip==="string")this.setTooltip(object.tooltip);if(typeof object.xScale==="number")this.setXScale(object.xScale);if(typeof object.yScale==="number")this.setYScale(object.yScale);if(typeof object.scale==="number")this.setScale(object.scale);if(typeof object.xVelocity==="number")this.setXVelocity(object.xVelocity);if(typeof object.yVelocity===
"number")this.setYVelocity(object.yVelocity);if(typeof object.dragButton==="string")this.setDragButton(object.dragButton);if(typeof object.parent==="object")this.setParent(object.parent);if(typeof object.constraints==="object")this.setConstraints(object.constraints);this.frozen--;return this.dirty(127)},setId:function Entity_setId(id){jayus.Dependency.prototype.setId.call(this,id);if(jayus.declareChildrenAsProperties&&(this.parent!==null&&id)){if(typeof this.parent[id]!=="undefined"){console.error('Entity.setParent() - Collision between child id("'+
id+'") and parent property('+this.parent[id]+")");return}this.parent[id]=this}},addHandler:function Entity_addHandler(event){jayus.Responder.prototype.addHandler.apply(this,arguments);if(event==="leftClick")this.addHandler("leftRelease",function(e){if(jayus.entityPressedOn===this)this.fire("leftClick",e)});else if(event==="middleClick")this.addHandler("middleRelease",function(e){if(jayus.entityPressedOn===this)this.fire("middleClick",e)});else if(event==="rightClick")this.addHandler("rightRelease",
function(e){if(jayus.entityPressedOn===this)this.fire("rightClick",e)});else if(!this.trackCursor)if(event.indexOf("cursor")===0||(event.indexOf("Press")>=0||event.indexOf("Release")>=0)){this.trackCursor=true;if(this.parent!==null)this.parent.childCursorTrackingChanged(this,true)}},dirtied:true,frozen:0,pendingDirty:0,ignoreDirty:0,freeze:function Entity_freeze(){this.frozen++;return this},unfreeze:function Entity_unfreeze(){this.frozen--;if(!this.frozen)this.thaw();return this},thaw:function Entity_thaw(){jayus.dirtyCount++;
this.fire("dirty",this.pendingDirty);this.dirtied=true;this.informDependents(this.pendingDirty);if(this.constraints!==null)this.constrain();this.pendingDirty=0;return this},dirty:function Entity_dirty(type){jayus.debug.match("Entity.dirty",type,"type",4);if(!this.ignoreDirty)if(this.frozen)this.pendingDirty|=type;else{jayus.dirtyCount++;if(this.constraints!==null)this.constrain();if(this.isTransformed&&type&8+2)this.matrixDirty=true;this.fire("dirty",type);this.dirtied=true;this.informDependents(type);
if(this.parentDisplay!==null&&type&6+8)this.parentDisplay.startCursorUpdate()}return this},parent:null,parentDisplay:null,getAbsoluteParent:function Entity_getAbsoluteParent(){return this.parent!==null?this.parent.getAbsoluteParent():this},setParent:function Entity_setParent(parent){if(this.parent!==parent){if(this.parent!==null)throw new Error("Entity.setParent() - Entity already has a parent");if(parent.exposingAll)this.expose();this.parent=parent;this.parentDisplay=parent.parentDisplay;this.attach(parent);
if(jayus.declareChildrenAsProperties&&this.id)if(typeof parent[this.id]!=="undefined")console.error('Entity.setParent() - Collision between child id("'+this.id+'") and parent property('+parent[this.id]+")");else parent[this.id]=this;if(this.trackCursor)parent.childCursorTrackingChanged(this,true);if(this.constraintsNeedParent){this.parentConstrainerOptions={};var that=this;this.parent.addHandler("dirty",function(type){that.constrain()},this.parentConstrainerOptions)}this.fire("added")}},removeParent:function Entity_removeParent(){if(this.constraints!==
null&&this.constraints.needsParent){this.parentConstrainerOptions.remove=true;this.parentConstrainerOptions=null}if(jayus.declareChildrenAsProperties&&this.id)delete this.parent[this.id];this.detach(this.parent);this.parent=null;this.underCursor=false;this.fire("removed")},setIncluded:function Entity_setIncluded(on){jayus.debug.match("Entity.setIncluded",on,"on",1);if(this.included!==on){this.included=on;this.dirty(127)}return this},include:function Entity_include(){return this.setIncluded(true)},
exclude:function Entity_exclude(){return this.setIncluded(false)},setVisible:function Entity_setVisible(on){jayus.debug.match("Entity.setVisible",on,"on",1);if(this.visible!==on){this.visible=on;this.dirty(1)}return this},show:function Entity_show(){return this.setVisible(true)},hide:function Entity_hide(){return this.setVisible(false)},constraints:null,hasConstraint:null,constraintsNeedParent:false,parentConstrainerOptions:null,setConstraint:function Entity_setConstraint(key,formula){if(typeof this.constraints!==
"object"){var data={};data[key]=formula;this.setConstraints(data)}else{this.constraints[key]=formula;this.hasConstraint[key]=true;this.constrain()}return this},clearConstraint:function Entity_clearConstraint(key){if(typeof this.constraints==="object"){delete this.constraints[key];this.hasConstraint[key]=false}return this},setConstraints:function Entity_setConstraints(data){var key,formula,fromParent=false;this.hasConstraint={x:false,y:false,width:false,height:false};for(key in data){formula=data[key];
this.hasConstraint[key]=true;if(formula.indexOf("parent")!==-1)fromParent=true}if(fromParent&&this.parent!==null){var that=this;this.parent.addHandler("dirty",function(){that.constrain()})}this.constraints=data;this.constraintsNeedParent=fromParent;this.constrain();return this},constrain:function Entity_constrain(){if(this.constraints!==null&&(!this.constraintsNeedParent||this.parent!==null)){var hasData=this.hasConstraint,data=this.constraints;if(hasData.x)this.setX(jayus.executeFormula(this,data.x));
if(hasData.y)this.setY(jayus.executeFormula(this,data.y));if(hasData.width)this.setWidth(jayus.executeFormula(this,data.width));if(hasData.height)this.setHeight(jayus.executeFormula(this,data.height))}return this},setAlpha:function Entity_setAlpha(alpha){jayus.debug.match("Entity.setAlpha",alpha,"alpha",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setAlpha,this.alpha,alpha)}if(this.alpha!==alpha){this.alpha=alpha;this.dirty(16)}return this},trackCursor:false,
canAcceptCursor:true,canReleaseCursor:true,underCursor:false,hasCursor:false,cursorX:0,cursorY:0,tooltip:"Hi!",setTooltip:function Entity_setTooltip(text){this.trackCursor=true;if(this.parent!==null)this.parent.childCursorTrackingChanged(this,true);this.canAcceptCursor=true;this.tooltip=text},updateCursor:function Entity_updateCursor(x,y){var pos=new jayus.Point(x,y);if(this.isTransformed)this.getMatrix().inverseTransformPointOnto(x,y,pos);this.cursorX=pos.x;this.cursorY=pos.y;var intersects=this.cursorHitTest(pos.x,
pos.y);if(this.underCursor)if(!intersects){this.underCursor=false;this.fire("cursorOut",pos);if(this.isParent)this.removeCursorFromChildren()}else{if(this.isParent&&this.propagateCursor)this.updateCursorOnChildren(pos.x,pos.y)}else if(intersects){this.underCursor=true;this.fire("cursorOver",pos);if(this.isParent&&this.propagateCursor)this.updateCursorOnChildren(pos.x,pos.y)}},cursorHitTest:function Entity_cursorHitTest(x,y){return true},removeCursor:function Entity_removeCursor(){this.underCursor=
false;this.fire("cursorOut",null);if(this.isParent)this.removeCursorFromChildren()},dragButton:null,dragging:false,dragStarterOptions:null,dragEnderOptions:null,dragHandlerOptions:null,setDragButton:function Entity_setDragButton(button){if(button!==null&&(button!=="left"&&(button!=="middle"&&button!=="right")))throw"Entity.setDragButton() - Error: button("+button+') must be null, "left", "middle", or "right"';if(this.dragButton===null&&typeof button==="string"){this.dragStarterOptions={};this.dragHandlerOptions=
{};this.dragEnderOptions={};this.addHandler(button+"Press",function(e){this.dragging=false;this.dragHandlerOptions.remove=false;this.dragEnderOptions.remove=false;var that=this;var dragHandler=function(e){that.canReleaseCursor=false;if(!that.dragging){that.parentDisplay.setCursor("move");that.fire("dragStart");that.dragging=true}if(!that.fire("dragged",e))that.translate(e.deltaX,e.deltaY);return true};this.parentDisplay.addHandler("cursorMove",dragHandler,this.dragHandlerOptions);jayus.addHandler(button+
"Release",function(e,options){if(that.dragging){that.canReleaseCursor=true;that.parentDisplay.updateCursor(that.parentDisplay.cursor.x,that.parentDisplay.cursor.y);that.fire("dragEnd");that.parentDisplay.resetCursor()}that.dragHandlerOptions.remove=true;options.remove=true;if(that.dragging){that.dragging=false;return true}},this.dragEnderOptions)},this.dragStarterOptions)}else if(typeof this.dragButton==="string"&&button===null){this.dragStarterOptions.remove=true;this.dragStarterOptions=null;this.dragHandlerOptions.remove=
true;this.dragHandlerOptions=null;this.dragEnderOptions.remove=true;this.dragEnderOptions=null}else if(typeof this.dragButton==="string"&&(typeof button==="string"&&this.dragButton!==button)){this.setDragButton(null);this.setDragButton(button)}this.dragButton=button;return this},matrix:null,matrixDirty:true,getMatrix:function Entity_getMatrix(){if(this.matrixDirty){if(this.matrix===null)this.matrix=new jayus.Matrix;else this.matrix.identity();this.applyTransforms(this.matrix);this.matrixDirty=false}return this.matrix},
applyTransforms:function Entity_applyTransforms(ctx){if(this.isTransformed){var xScale=this.xScale,yScale=this.yScale;if(this.flipX)xScale*=-1;if(this.flipY)yScale*=-1;if(this.xAnchor||this.yAnchor)ctx.translate(this.xAnchor,this.yAnchor);ctx.scale(xScale,yScale);ctx.rotate(this.angle);if(this.xAnchor||this.yAnchor)ctx.translate(-this.xAnchor,-this.yAnchor)}return this},angle:0,setAngle:function Entity_setAngle(angle){jayus.debug.match("Entity.setAngle",angle,"angle",4);if(this.actionsToAnimate){this.actionsToAnimate--;
return new jayus.MethodAnimator(this,this.setAngle,this.angle,angle)}if(this.angle!==angle){this.angle=angle;this.isTransformed=true;this.dirty(8)}return this},rotate:function Entity_rotate(angle){jayus.debug.match("Entity.rotate",angle,"angle",4);return this.setAngle(this.angle+angle)},xScale:1,yScale:1,setScale:function Entity_setScale(x,y){if(arguments.length===1)y=x;if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setScale,[this.xScale,this.yScale],[x,
y])}if(this.xScale!==x||this.yScale!==y){this.xScale=x;this.yScale=y;this.isTransformed=true;this.dirty(8)}return this},setScaleAround:function Entity_setScaleAround(x,y,xAnchor,yAnchor){if(arguments.length===3){jayus.debug.matchArguments("Entity.setScaleAround",arguments,"x",4,"y",4,"xAnchor",4);return this.setScaleAround(x,x,y,xAnchor)}else jayus.debug.matchArgumentsAs("Entity.scale",arguments,4,"x","y","xAnchor","yAnchor");var pos=this.localToParent(xAnchor,yAnchor);this.setScale(x,y);var pos2=
this.localToParent(xAnchor,yAnchor);this.translate(pos.x-pos2.x,pos.y-pos2.y);return this.dirty(127)},scale:function Entity_scale(x,y){if(arguments.length===1){jayus.debug.match("Entity.scale",x,"scale",4);y=x}else jayus.debug.matchArgumentsAs("Entity.scale",arguments,4,"x","y");return this.setScale(this.xScale*x,this.yScale*y)},setXScale:function Entity_setXScale(scale){jayus.debug.match("Entity.scale",scale,"scale",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,
this.setXScale,this.xScale,scale)}if(this.xScale!==scale){this.xScale=scale;this.isTransformed=true;this.dirty(8)}return this},setYScale:function Entity_setYScale(scale){jayus.debug.match("Entity.scale",scale,"scale",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setYScale,this.yScale,scale)}if(this.yScale!==scale){this.yScale=scale;this.isTransformed=true;this.dirty(8)}return this},flipX:false,flipY:false,setFlipX:function Entity_setFlipX(on){jayus.debug.match("Entity.setFlipX",
on,"on",1);if(this.flipX!==on){this.flipX=on;this.isTransformed=true;this.dirty(8)}return this},setFlipY:function Entity_setFlipY(on){jayus.debug.match("Entity.setFlipY",on,"on",1);if(this.flipX!==on){this.flipY=on;this.isTransformed=true;this.dirty(8)}return this},setFlipping:function Entity_setFlipping(x,y){jayus.debug.matchArguments("Entity.setFlipping",arguments,"x",1,"y",1);if(this.flipX!==x||this.flipY!==y){this.flipX=x;this.flipY=y;this.isTransformed=true;this.dirty(8)}return this},xAnchor:0,
yAnchor:0,setAnchor:function Entity_setAnchor(x,y){jayus.debug.matchCoordinate("Entity.setAnchor",x,y);if(arguments.length===1)return this.setAnchor(x.x,x.y);if(this.xAnchor!==x||this.yAnchor!==y){this.xAnchor=x;this.yAnchor=y;this.dirty(8)}return this},screenToLocal:function Entity_screenToLocal(x,y){jayus.debug.matchCoordinate("Entity.screenToLocal",x,y);if(arguments.length===1)return this.screenToLocal(x.x,x.y);if(this.parent!==null){var pos=this.parent.screenToLocal(x,y);return this.parentToLocal(pos)}return new jayus.Point(x,
y)},parentToLocal:function Entity_parentToLocal(x,y){jayus.debug.matchCoordinate("Entity.parentToLocal",x,y);if(arguments.length===1)return this.parentToLocal(x.x,x.y);var pos=new jayus.Point(x,y);if(this.isTransformed)this.getMatrix().inverseTransformPointOnto(x,y,pos);else{pos.x-=this.x;pos.y-=this.y}return pos},localToScreen:function Entity_localToScreen(x,y){jayus.debug.matchCoordinate("Entity.localToScreen",x,y);if(arguments.length===1)return this.localToScreen(x.x,x.y);if(this.parent!==null)return this.parent.localToScreen(this.localToParent(x,
y));return new jayus.Point(x,y)},localToScreenOnto:function Entity_localToScreenOnto(x,y,ret){jayus.debug.matchArguments("Entity.localToScreenOnto",arguments,"x",4,"y",4,"ret",13);if(this.parent!==null){this.localToParentOnto(x,y,ret);this.parent.localToScreenOnto(ret.x,ret.y,ret)}else{ret.x=x;ret.y=y}return ret},localToParent:function Entity_localToParent(x,y){jayus.debug.matchCoordinate("Entity.localToParent",x,y);if(arguments.length===1)return this.localToParent(x.x,x.y);return this.localToParentOnto(x,
y,new jayus.Point)},localToParentOnto:function Entity_localToParentOnto(x,y,ret){jayus.debug.matchArguments("Entity.localToParentOnto",arguments,"x",4,"y",4,"ret",13);if(this.isTransformed)return this.getMatrix().transformPointOnto(x,y,ret);ret.x=x+this.x;ret.y=y+this.y;return ret},running:false,xVelocity:0,yVelocity:0,setXVelocity:function Entity_setXVelocity(vel){jayus.debug.match("Entity.setXVelocity",vel,"vel",4);this.xVelocity=vel;if(!this.running){jayus.animators.push(this);this.running=true}return this},
setYVelocity:function Entity_setYVelocity(vel){jayus.debug.match("Entity.setYVelocity",vel,"vel",4);this.yVelocity=vel;if(!this.running){jayus.animators.push(this);this.running=true}return this},setVelocity:function Entity_setVelocity(x,y){jayus.debug.matchCoordinate("Entity.setVelocity",x,y);if(arguments.length===1)return this.setVelocity(x.x,x.y);this.xVelocity=x;this.yVelocity=y;if(!this.running){jayus.animators.push(this);this.running=true}return this},clearVelocity:function Entity_clearVelocity(){if(this.running){this.xVelocity=
0;this.yVelocity=0;jayus.animators.splice(jayus.animators.indexOf(this),1);this.running=false}return this},tick:function Entity_tick(now,elapsed){this.translate(this.xVelocity*elapsed,this.yVelocity*elapsed)},intersects:function Entity_intersects(object){return jayus.intersectTest(this,object)},intersectCount:function Entity_intersectCount(entities){jayus.debug.matchArray("Entity.intersectCount",entities,"entities",12);if(!entities.length)throw new RangeError("Entity.intersectCount() - Invalid entities"+
jayus.debug.toString(entities)+" sent, length of at least 1 required");var i,count=0;for(i=entities.length-1;i>=0;i--)if(jayus.intersectTest(this,entities[i]))count++;return count},intersectsAny:function Entity_intersectsAny(entities){if(entities instanceof jayus.List)entities=entities.items;jayus.debug.matchArray("Entity.intersectsAny",entities,"entities",12);for(var i=0;i<entities.length;i++)if(jayus.intersectTest(this,entities[i]))return true;return false},intersectsAll:function Entity_intersectsAll(entities){if(entities instanceof
jayus.List)entities=entities.items;jayus.debug.matchArray("Entity.intersectsAll",entities,"entities",12);if(!entities.length)throw new RangeError("Entity.intersectsAll() - Invalid entities"+jayus.debug.toString(entities)+" sent, length of at least 1 required");for(var i=0;i<entities.length;i++)if(!jayus.intersectTest(this,entities[i]))return false;return true},intersectsWhich:function Entity_intersectsWhich(entities){if(entities instanceof jayus.List)entities=entities.items;jayus.debug.matchArray("Entity.intersectsWhich",
entities,"entities",12);var i,ret=[];for(i=0;i<entities.length;i++)if(jayus.intersectTest(this,entities[i]))ret.push(entities[i]);return ret},rasterize:function Entity_rasterize(){var scope=this.getScope(),surface=new jayus.Surface(scope.width,scope.height),x=this.x,y=this.y;this.x=0;this.y=0;this.drawOnto(surface);this.x=x;this.y=y;return surface},drawOnto:function Entity_drawOnto(surface){var ctx=surface.context;ctx.save();this.drawOntoContext(ctx,0,0);ctx.restore();surface.dirty(16);return this}})})();jayus.RectEntity=jayus.Entity.extend({shapeType:4,hasFlexibleWidth:true,hasFlexibleHeight:true,properties:["x","y","width","height","roundX","roundY","alignBg"],updateCursor:function RectEntity_updateCursor(x,y){var pos=new jayus.Point(x,y);if(this.isTransformed)this.getMatrix().inverseTransformPointOnto(x,y,pos);else{pos.x-=this.x;pos.y-=this.y}this.cursorX=pos.x;this.cursorY=pos.y;var intersects=this.cursorHitTest(pos.x,pos.y);if(this.underCursor)if(!intersects){this.underCursor=false;this.fire("cursorOut",
pos);if(this.isParent)this.removeCursorFromChildren()}else{if(this.isParent&&this.propagateCursor)this.updateCursorOnChildren(pos.x,pos.y)}else if(intersects){this.underCursor=true;this.fire("cursorOver",pos);if(this.isParent&&this.propagateCursor)this.updateCursorOnChildren(pos.x,pos.y)}},cursorHitTest:function RectEntity_cursorHitTest(x,y){return 0<=x&&(0<=y&&(x<=this.width&&y<=this.height))},toObject:function RectEntity_toObject(){var object=jayus.Entity.prototype.toObject.apply(this);object.type=
"RectEntity";var i,key,val,valType;for(i=0;i<jayus.RectEntity.prototype.properties.length;i++){key=jayus.RectEntity.prototype.properties[i];val=this[key];valType=typeof val;if(val!==jayus.RectEntity.prototype[key]){if(valType==="object")val=val.toObject();object[key]=val}}if(this.bg!==null)object.bg=this.bg.toObject();if(this.bounds!==null)object.bounds=this.bounds.toObject();return object},initFromObject:function RectEntity_initFromObject(object){jayus.debug.match("RectEntity.initFromObject",object,
"object",5);jayus.Entity.prototype.initFromObject.call(this,object);this.ignoreDirty++;var i,key,val,valType;for(i=0;i<jayus.RectEntity.prototype.properties.length;i++){key=jayus.RectEntity.prototype.properties[i];val=object[key];if(typeof val!=="undefined")this[key]=val}if(typeof object.bounds==="object")this.bounds=jayus.parse(object.bounds);if(typeof object.negateBlur==="boolean")this.negateBlur=object.negateBlur;if(typeof object.buffering==="boolean")this.setBuffering(object.buffering);if(typeof object.bg===
"object")this.setBg(object.bg);if(typeof object.widthPolicy==="object")this.widthPolicy=jayus.parse(object.widthPolicy);if(typeof object.heightPolicy==="object")this.heightPolicy=jayus.parse(object.heightPolicy);this.ignoreDirty--;return this.dirty(127)},x:0,y:0,setX:function Entity_setX(x){jayus.debug.match("Entity.setX",x,"x",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setX,this.x,x)}if(this.x!==x){this.x=x;this.dirty(2)}return this},setY:function Entity_setY(y){jayus.debug.match("Entity.setY",
y,"y",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setY,this.y,y)}if(this.y!==y){this.y=y;this.dirty(2)}return this},getOrigin:jayus.Rectangle.prototype.getOrigin,setOrigin:jayus.Rectangle.prototype.setOrigin,translate:jayus.Rectangle.prototype.translate,getLeft:jayus.Rectangle.prototype.getLeft,getRight:jayus.Rectangle.prototype.getRight,getTop:jayus.Rectangle.prototype.getTop,getBottom:jayus.Rectangle.prototype.getBottom,setLeft:jayus.Rectangle.prototype.setLeft,
setRight:jayus.Rectangle.prototype.setRight,setTop:jayus.Rectangle.prototype.setTop,setBottom:jayus.Rectangle.prototype.setBottom,getPosAt:function RectEntity_getPosAt(anchorX,anchorY){jayus.debug.matchCoordinate("RectEntity.getPosAt",anchorX,anchorY);if(arguments.length===1)return this.getPosAt(anchorX.x,anchorX.y);return this.localToParent(anchorX*this.width,anchorY*this.height)},setPosAt:function RectEntity_setPosAt(x,y,anchorX,anchorY){if(arguments.length===3)return this.setPosAt(x.x,x.y,y,anchorX);
jayus.debug.matchArgumentsAs("RectEntity.setPosAt",arguments,4,"x","y","anchorX","anchorY");return this.translate(x-(this.x+anchorX*this.width),y-(this.y+anchorY*this.height))},setRelativeAnchor:function Entity_setRelativeAnchor(x,y){jayus.debug.matchCoordinate("RectEntity.setRelativeAnchor",x,y);if(arguments.length===1)return this.setAnchor(this.width*x.x,this.height*x.y);return this.setAnchor(this.width*x,this.height*y)},roundX:false,roundY:false,setRounding:function RectEntity_setRounding(x,y){if(arguments.length===
1){jayus.debug.match("RectEntity.setRounding",x,"x",1);this.roundX=x;this.roundY=y}else{jayus.debug.matchArgumentsAs("RectEntity.setRounding",arguments,1,"x","y");if(this.roundX!==x||this.roundY!==y){this.roundX=x;this.roundY=y;this.dirty(127)}}return this},body:null,setBody:function RectEntity_setBody(body){jayus.debug.match("RectEntity.setBody",body,"body",5);if(this.body!==null)delete this.body.entity;else{jayus.box2d.physicalEntities.push(this);this.setAnchor(this.width/2,this.height/2)}this.body=
body;this.body.entity=this;return this},removeBody:function RectEntity_removeBody(){if(this.body!==null){delete this.body.entity;this.body=null;jayus.box2d.physicalEntities.splice(jayus.box2d.physicalEntities.indexOf(this),1)}return this},updateFromBody:function RectEntity_updateFromBody(){if(this.body!==null&&this.body.IsAwake()){var pos=this.body.GetPosition();this.setPosAt(pos.x,pos.y,0.5,0.5);this.angle=this.body.GetAngle();this.isTransformed=true;this.matrixDirty=true}},width:0,height:0,setWidth:function RectEntity_setWidth(width){jayus.debug.match("RectEntity.setWidth",
width,"width",4);if(!this.hasFlexibleWidth)throw new Error("RectEntity.setWidth() - Entity width is not flexible");if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setWidth,this.width,width)}if(width!==this.width)this.changeSize(width,this.height);return this},setHeight:function RectEntity_setHeight(height){jayus.debug.match("RectEntity.setHeight",height,"height",4);if(!this.hasFlexibleHeight)throw new Error("RectEntity.setHeight() - Entity height is not flexible");
if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setHeight,this.height,height)}if(height!==this.height)this.changeSize(this.width,height);return this},setSize:function RectEntity_setSize(width,height){jayus.debug.matchSize("RectEntity.setSize",width,height);if(!this.hasFlexibleWidth||!this.hasFlexibleHeight)throw new Error("RectEntity.setSize() - Entity size is not flexible");if(arguments.length===1)return this.setSize(width.width,width.height);if(this.width!==
width||this.height!==height)this.changeSize(width,height);return this},changeSize:function RectEntity_changeSize(width,height){this.width=width;this.height=height;this.dirty(4)},intersectsAt:function RectEntity_intersectsAt(x,y){return this.getBounds().intersectsAt(x,y)},getUnFrame:function RectEntity_getUnFrame(){return new jayus.Rectangle(this.x,this.y,this.width,this.height)},getFrame:function RectEntity_getFrame(){if(this.isTransformed)return(new jayus.Polygon.Rectangle(0,0,this.width,this.height)).transform(this.getMatrix());
return new jayus.Rectangle(this.x,this.y,this.width,this.height)},getScope:function RectEntity_getScope(){return this.getFrame().getScope()},bounds:null,boundsClone:null,getBounds:function RectEntity_getBounds(){if(this.bounds!==null){this.bounds.cloneOnto(this.boundsClone);return this.boundsClone.translate(this.x,this.y)}return this.getFrame().getScope()},setBounds:function RectEntity_setBounds(shape){jayus.debug.match("RectEntity.setBounds",shape,"shape",0);if(shape.shapeType!=="number")shape=jayus.parse(shape);
if(this.bounds!==null)this.bounds.detach(this);this.bounds=shape;this.bounds.attach(this);this.boundsClone=this.bounds.clone();this.shapeType=0;return this},clearBounds:function RectEntity_clearBounds(){if(this.bounds!==null){this.bounds.detach(this);this.bounds=null;this.boundsClone=null;this.shapeType=4}return this},componentDirtied:function RectEntity_componentDirtied(component,type){if(component===this.bounds)this.bounds.cloneOnto(this.boundsClone)},bg:null,alignBg:true,setBg:function RectEntity_setBg(brush){jayus.debug.match("RectEntity.setBg",
brush,"brush",0);if(!(brush instanceof jayus.Brush))brush=new jayus.Brush(brush);if(this.bg!==null)this.bg.detach(this);this.bg=brush;this.bg.attach(this);return this.dirty(16)},clearBg:function RectEntity_clearBg(){if(this.bg!==null){this.bg.detach(this);this.bg=null;this.dirty(16)}return this},buffered:false,bufferBg:true,canvas:null,context:null,negateBlur:false,setBuffering:function RectEntity_setBuffering(on){jayus.debug.match("RectEntity.setBuffering",on,"on",1);if(!this.buffered&&on){this.canvas=
document.createElement("canvas");this.context=this.canvas.getContext("2d");this.refreshBuffer()}else if(this.buffered&&!on){this.canvas=null;this.context=null}this.buffered=on;return this},refreshBuffer:function RectEntity_refreshBuffer(){if(this.buffered){var canvas=this.canvas;if(this.width!==canvas.width||this.height!==canvas.height){canvas.width=this.width;canvas.height=this.height}this.fullyRefreshBuffer()}},fullyRefreshBuffer:function RectEntity_fullyRefreshBuffer(){if(this.buffered){var ctx=
this.context;ctx.clearRect(0,0,this.width,this.height);ctx.save();if(this.bufferBg&&this.bg!==null)this.bg.paintRect(ctx,0,0,this.width,this.height);this.paintContents(ctx);ctx.restore()}},applyTransforms:function RectEntity_applyTransforms(ctx){var x=this.x,y=this.y;if(this.roundX)x=Math.round(x);if(this.roundY)y=Math.round(y);if(this.isTransformed){var xScale=this.xScale,yScale=this.yScale;if(this.xAnchor||this.yAnchor){x+=this.xAnchor;y+=this.yAnchor}ctx.translate(x,y);ctx.scale(xScale,yScale);
ctx.rotate(this.angle);if(this.xAnchor||this.yAnchor)ctx.translate(-this.xAnchor,-this.yAnchor);if(this.flipX||this.flipY){ctx.translate(this.width/2,this.height/2);ctx.scale(this.flipX?-1:1,this.flipY?-1:1);ctx.translate(-this.width/2,-this.height/2)}}else if(x||y)ctx.translate(x,y);return this},drawOntoContext:function RectEntity_drawOntoContext(ctx){jayus.debug.matchContext("RectEntity.drawOntoContext",ctx);if(this.id)jayus.chart.begin("Draw: "+this.id);ctx.save();if(this.alpha!==1)ctx.globalAlpha*=
this.alpha;this.applyTransforms(ctx);if(this.buffered){if(this.dirtied)this.refreshBuffer();if(!this.bufferBg&&this.bg!==null)if(this.alignBg&&this.bg.lineWidth%2)this.bg.paintRect(ctx,0.5,0.5,Math.round(this.width),Math.round(this.height));else this.bg.paintRect(ctx,0,0,this.width,this.height);if(this.negateBlur)jayus.manuallyDrawImage(this.context,ctx,this.width,this.height);else ctx.drawImage(this.canvas,0,0)}else{if(this.bg!==null)if(this.alignBg&&this.bg.lineWidth%2)this.bg.paintRect(ctx,0.5,
0.5,Math.round(this.width),Math.round(this.height));else this.bg.paintRect(ctx,0,0,this.width,this.height);this.paintContents(ctx)}this.dirtied=false;ctx.restore();if(this.debugRenderer!==null)this.debugRenderer(ctx);if(this.id)jayus.chart.end();return this}});jayus.PaintedShape=jayus.Entity.extend({shape:null,brush:null,init:function PaintedShape(shape,brush){jayus.Entity.prototype.init.apply(this);if(arguments.length===2){this.shape=shape;shape.attach(this);if(brush!==undefined)this.setBrush(brush)}},toObject:function PaintedShape_toObject(){var object=jayus.Entity.prototype.toObject.apply(this);object.type="PaintedShape";if(this.shape!==null)object.shape=this.shape.toObject();if(this.brush!==null)object.brush=this.brush.toObject();return object},initFromObject:function PaintedShape_initFromObject(object){jayus.debug.match("PaintedShape.initFromObject",
object,"object",5);jayus.Entity.prototype.initFromObject.call(this,object);this.ignoreDirty++;if(typeof object.shape==="object")this.setShape(object.shape);if(typeof object.brush==="object")this.setBrush(object.brush);this.ignoreDirty--;return this.dirty(127)},componentDirtied:function PaintedShape_componentDirtied(component,type){this.dirty(16)},translate:function PaintedShape_translate(x,y){this.shape.translate.call(this.shape,x,y);this.dirty(2)},intersectsAt:function PaintedShape_intersectsAt(x,
y){if(this.isTransformed){var pos=this.getMatrix().inverseTransformPoint(x,y);x=pos.x;y=pos.y}return this.shape.intersectsAt(x,y)},cursorHitTest:function Shape_cursorHitTest(x,y){return this.shape.intersectsAt(x,y)},setShape:function PaintedShape_setShape(shape){jayus.debug.match("PaintedShape.setShape",shape,"shape",19);if(this.shape!==shape){if(this.shape!==null)this.shape.detach(this);this.shape=shape;shape.attach(this);this.dirty(127)}return this},setBrush:function PaintedShape_setBrush(brush){jayus.debug.match("PaintedShape.setBrush",
brush,"brush",5);if(this.brush!==null)this.brush.detach(this);if(!(brush instanceof jayus.Brush))brush=new jayus.Brush(brush);this.brush=brush;brush.attach(this);return this.dirty(16)},clearBrush:function PaintedShape_clearBrush(){if(this.brush!==null){this.brush.detach(this);this.brush=null;this.dirty(16)}return this},getScope:function PaintedShape_getScope(){if(!this.isTransformed)return this.shape.getScope();var scope=this.shape.getScope().getTransformed(this.getMatrix()).getScope();if(this.brush.stroking||
this.brush.shadowing){var scale=Math.max(this.xScale,this.yScale),left=0,right=0,top=0,bottom=0;if(this.brush.stroking){var miterLimit=10;if(typeof this.brush.miterLimit==="number")miterLimit=this.brush.miterLimit;left=right=top=bottom=miterLimit*scale/1.5}if(this.brush.shadowing){left=Math.max(left,left+this.brush.shadowBlur-this.brush.shadowOffsetX);right=Math.max(right,right+this.brush.shadowBlur+this.brush.shadowOffsetX);top=Math.max(top,top+this.brush.shadowBlur-this.brush.shadowOffsetY);bottom=
Math.max(bottom,bottom+this.brush.shadowBlur+this.brush.shadowOffsetY)}scope.setSize(scope.width+left+right,scope.height+top+bottom);scope.translate(-left,-top)}return scope},getBounds:function PaintedShape_getBounds(){return this.shape},drawOntoContext:function PaintedShape_drawOntoContext(ctx){jayus.debug.matchContext("PaintedShape.drawOntoContext",ctx);if(this.brush!==null){ctx.save();if(this.alpha!==1)ctx.globalAlpha*=this.alpha;this.applyTransforms(ctx);this.shape.etchOntoContext(ctx);this.brush.paintShape(ctx);
ctx.restore();if(this.debugRenderer!==null)this.debugRenderer(ctx)}}});jayus.Text=jayus.RectEntity.extend({text:"",font:"12pt sans-serif",brush:null,alignment:0,fontDesc:null,lines:null,lineWidths:null,init:function Text(text,font,brush){jayus.Entity.prototype.init.apply(this);this.fontDesc=jayus.getFontDescriptor(this.font);this.lines=[];this.lineWidths=[];if(arguments.length===1)jayus.debug.match("Text",text,"text",2);else if(arguments.length===2)jayus.debug.matchArguments("Text",arguments,"text",2,"font",2);else if(arguments.length===3)jayus.debug.matchArguments("Text",
arguments,"text",2,"font",2,"brush",5);if(arguments.length){this.ignoreDirty++;this.setText(text);if(arguments.length>1){this.setFont(font);if(arguments.length>2)this.setBrush(brush)}this.ignoreDirty--}this.refreshMetrics()},toObject:function Text_toObject(){var object=jayus.RectEntity.prototype.toObject.apply(this);object.type="Text";if(this.text!=="")object.text=this.text;if(this.font!==jayus.Text.prototype.font)object.font=this.font;if(this.brush!==null)object.brush=this.brush;if(this.alignment!==
0)object.alignment=this.alignment;return object},initFromObject:function Text_initFromObject(object){jayus.debug.match("Text.initFromObject",object,"object",5);this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,object);if(typeof object.text==="string")this.setText(object.text);if(typeof object.font==="string")this.setFont(object.font);if(typeof object.brush!=="undefined")this.setBrush(object.brush);if(typeof object.alignment==="number")this.setAlignment(object.alignment);this.ignoreDirty--;
this.refreshMetrics();return this.dirty(127)},componentDirtied:function Text_componentDirtied(){this.dirty(16)},refreshMetrics:function Text_refreshMetrics(){var width,maxWidth=0;for(var i=this.lines.length-1;i>=0;i--){width=jayus.getTextWidth(this.lines[i],this.font);this.lineWidths[i]=width;if(width>maxWidth)maxWidth=width}this.changeSize(maxWidth,this.lines.length*this.fontDesc.height);this.minWidth=this.width;this.minHeight=this.height},getScope:function Text_getScope(){var scope=this.getFrame().getScope();
if(this.brush!==null)if(this.brush.stroking||this.brush.shadowing){var scale=Math.max(this.xScale,this.yScale),left=0,right=0,top=0,bottom=0;if(this.brush.stroking){var width=this.brush.lineWidth*scale/2;left=right=top=bottom=Math.sqrt(width*width*2)}if(this.brush.shadowing){left=Math.max(left,left+this.brush.shadowBlur-this.brush.shadowOffsetX);right=Math.max(right,right+this.brush.shadowBlur+this.brush.shadowOffsetX);top=Math.max(top,top+this.brush.shadowBlur-this.brush.shadowOffsetY);bottom=Math.max(bottom,
bottom+this.brush.shadowBlur+this.brush.shadowOffsetY)}scope.setSize(scope.width+left+right,scope.height+top+bottom);scope.translate(-left,-top)}return scope},setText:function Text_setText(text){jayus.debug.match("Text.setText",text,"text",2);if(this.text!==text){this.text=text;this.lines=text.split("\n");this.lineWidths.length=this.lines.length;this.refreshMetrics();this.dirty(16)}return this},setFont:function Text_setFont(font){jayus.debug.match("Text.setFont",font,"font",2);if(this.font!==font){this.font=
font;this.fontDesc=jayus.getFontDescriptor(font);this.refreshMetrics()}return this},setAlignment:function TextBox_setAlignment(alignment){jayus.debug.match("TextBox.setAlignment",alignment,"alignment",4);if(this.alignment!==alignment){this.alignment=alignment;if(this.lines.length>1){this.refreshMetrics();this.dirty(16)}}return this},setBrush:function Text_setBrush(brush){jayus.debug.match("Text.setBrush",brush,"brush",5);if(this.brush!==null)this.brush.detach(this);if(!(brush instanceof jayus.Brush))brush=
new jayus.Brush(brush);this.brush=brush;this.brush.attach(this);return this.dirty(127)},clearBrush:function Text_clearBrush(){if(this.brush!==null){this.brush.detach(this);this.brush=null;this.dirty(127)}return this},paintContents:function Text_paintContents(ctx){var ascent=this.fontDesc.ascent,height=this.fontDesc.height;if(this.brush===null){console.log(this);throw new Error("Text.paintContents() - Brush is null");}this.brush.applyTo(ctx);ctx.font=this.font;var i,line,x;for(i=0;i<this.lines.length;i++){line=
this.lines[i];x=(this.width-this.lineWidths[i])*this.alignment;if(this.brush.stroking&&this.brush.strokeFirst)ctx.strokeText(line,x,ascent+i*height);if(this.brush.filling)ctx.fillText(line,x,ascent+i*height);if(this.brush.stroking&&!this.brush.strokeFirst)ctx.strokeText(line,x,ascent+i*height)}}});jayus.TextBox=jayus.Text.extend({hasFlexibleWidth:true,hasFlexibleHeight:true,init:function TextBox(text,font,brush){jayus.Entity.prototype.init.apply(this);this.fontDesc=jayus.getFontDescriptor(this.font);this.lines=[];this.lineWidths=[];if(arguments.length===1)jayus.debug.match("Text",text,"text",2);else if(arguments.length===2)jayus.debug.matchArguments("Text",arguments,"text",2,"font",2);else if(arguments.length===3)jayus.debug.matchArguments("Text",arguments,"text",2,"font",2,"brush",5);if(arguments.length){this.ignoreDirty++;
this.setText(text);if(arguments.length>1){this.setFont(font);if(arguments.length>2)this.setBrush(brush)}this.ignoreDirty--}this.words=this.divideText(this.text);this.refreshMetrics();this.addHandler("dirty",function(type){if(type&4)this.refreshMetrics()})},setText:function TextBox_setText(text){jayus.debug.match("TextBox.setText",text,"text",2);if(this.text!==text){this.text=text;this.words=this.divideText(this.text);this.refreshMetrics();this.dirty(16)}return this},divideText:function TextBox_divideText(str){var i,
c,out=[],curr="";for(i=0;i<str.length;i++){c=str[i];if(c===" "||c==="\n"){out.push(curr,c);curr=""}else curr+=c}out.push(curr);return out},refreshMetrics:function TextBox_refreshMetrics(){var font=this.font,lines=[],lineWidths=[],words=this.words,i=0,currentLine,currentLineLength,nextWord,nextWordLength,minW=0;while(i!==words.length){currentLine="";currentLineLength=0;nextWord=words[i];if(nextWord===" "||nextWord==="\n")nextWordLength=0;else nextWordLength=jayus.getTextWidth(nextWord,font);do{if(nextWord===
"\n"){i++;break}currentLine+=nextWord;currentLineLength+=nextWordLength;i++;if(i===words.length)break;nextWord=words[i];nextWordLength=jayus.getTextWidth(nextWord,font);if(nextWordLength>minW)minW=nextWordLength}while(currentLineLength+nextWordLength<this.width);while(currentLine[0]===" "||currentLine[0]==="\n")currentLine=currentLine.substr(1);lines.push(currentLine);lineWidths.push(currentLineLength)}this.minWidth=minW;this.lines=lines;this.lineWidths=lineWidths}});jayus.Grid=jayus.RectEntity.extend({isParent:true,slotWidth:10,slotHeight:10,xPadding:0,yPadding:0,items:null,init:function Grid(){jayus.RectEntity.prototype.init.apply(this);this.items=[[null]]},componentDirtied:function Grid_componentDirtied(component,type){},updateSize:function Grid_updateSize(){return this.updateWidth().updateHeight()},updateWidth:function Grid_updateWidth(){return this.setWidth(this.items[0].length*this.slotWidth+(this.items[0].length-1)*this.xPadding)},updateHeight:function Grid_updateHeight(){return this.setHeight(this.items.length*
this.slotHeight+(this.items.length-1)*this.yPadding)},setSlotWidth:function Grid_setSlotWidth(width){jayus.debug.match("Grid.setSlotWidth",width,"width",4);if(this.slotWidth!==width){this.slotWidth=width;this.updateSize()}return this},setSlotHeight:function Grid_setSlotHeight(height){jayus.debug.match("Grid.setSlotHeight",height,"height",4);if(this.slotHeight!==height){this.slotHeight=height;this.updateSize()}return this},setSlotSize:function Grid_setSlotSize(width,height){jayus.debug.matchSize("Grid.setSlotSize",
width,height);if(arguments.length===1){height=width.height;width=width.width}if(this.slotWidth!==width||this.slotHeight!==height){this.slotWidth=width;this.slotHeight=height;this.updateSize()}return this},setPadding:function Grid_setPadding(x,y){jayus.debug.matchCoordinate("Grid.setPadding",x,y);if(arguments.length===1)return this.setPadding(x.x,x.y);if(this.xPadding!==x||this.yPadding!==y){this.xPadding=x;this.yPadding=y;this.dirty(127)}return this},count:function Grid_count(){var i,j,count=0;for(i=
0;i<this.getRowCount();i++)for(j=0;j<this.getColumnCount();j++)if(this.items[i][j]!==null)count++;return count},slotCount:function Grid_slotCount(){return this.items.length*this.items[0].length},hasSlot:function Grid_hasSlot(x,y){jayus.debug.matchCoordinate("Grid.hasSlot",x,y);if(arguments.length===1)return this.hasSlot(x.x,x.y);return this.hasColumn(x)&&this.hasRow(y)},hasColumn:function Grid_hasColumn(x){jayus.debug.match("Grid.hasColumn",x,"x",4);return 0<=x&&x<this.items[0].length},hasRow:function Grid_hasRow(y){jayus.debug.match("Grid.hasRow",
y,"y",4);return 0<=y&&y<this.items.length},hasChild:function Grid_hasChild(item){var i,j;if(item instanceof jayus.Entity)for(i=0;i<this.getRowCount();i++){if(this.items[0].indexOf(item)>=0)return true}else for(i=0;i<this.getRowCount();i++)for(j=0;j<this.getColumnCount();j++)if(this.items[i][j].id===item)return true;return false},hasChildAt:function Grid_hasChildAt(x,y){jayus.debug.matchCoordinate("Grid.hasChildAt",x,y);if(arguments.length===1)return this.hasChildAt(x.x,x.y);return this.getChildAt(x,
y)!==null},indexOf:function Grid_indexOf(item){var row,col,j;if(item instanceof jayus.Entity)for(row=0;row<this.getRowCount();row++){j=this.items[row].indexOf(item);if(j>=0)return new jayus.Point(col,row)}else for(row=0;row<this.getRowCount();row++)for(col=0;col<this.getColumnCount();col++)if(this.get(col,row).id===item)return new jayus.Point(col,row);return null},getChildAt:function Grid_getChildAt(x,y){jayus.debug.matchCoordinate("Grid.getChildAt",x,y);if(arguments.length===1)return this.getChildAt(x.x,
x.y);if(this.hasSlot(x,y))return this.items[y][x];return null},getChild:function Grid_getChild(id){jayus.debug.match("Grid.getChild",id,"id",0);var i,j;for(i=0;i<this.getRowCount();i++)for(j=0;j<this.getColumnCount();j++)if(this.getChildAt(j,i).id===id)return this.items[i][j];return null},setChild:function Grid_setChild(x,y,child){if(arguments.length===2)return this.setChild(x.x,x.y,y);jayus.debug.matchArguments("Grid.setChild",arguments,"x",4,"y",4,"child",12);if(this.hasSlot(x,y)){var old=this.items[y][x];
if(old!==null)old.removeParent();this.items[y][x]=child;if(child!==null){child.setParent(this);child.translate(x*(this.slotWidth+this.xPadding),y*(this.slotHeight+this.yPadding))}this.dirty()}return this},getChildUnder:function Grid_getChildUnder(x,y){jayus.debug.matchCoordinate("Grid.getChildUnder",x,y);if(arguments.length===1)return this.getChildUnder(x.x,x.y);return this.getChildAt(this.getSlotUnder(x,y))},getSlotUnder:function Grid_getSlotUnder(x,y){jayus.debug.matchCoordinate("Grid.getSlotUnder",
x,y);if(arguments.length===1)return this.getSlotUnder(x.x,x.y);return new jayus.Point(Math.floor((x-this.x)/(this.slotWidth+this.xPadding)),Math.floor((y-this.y)/(this.slotHeight+this.yPadding)))},getSlotFrame:function Grid_getSlotFrame(x,y){jayus.debug.matchCoordinate("Grid.getSlotFrame",x,y);if(arguments.length===1)return this.getSlotFrame(x.x,x.y);if(this.hasSlot(x,y))return new jayus.Rectangle(this.x+x*(this.slotWidth+this.xPadding),this.y+y*(this.slotHeight+this.yPadding),this.slotWidth,this.slotHeight);
return null},removeChild:function Grid_removeChild(child){var index=this.indexOf(child);if(index!==null){if(typeof child!=="object")this.items[index.y][index.x].removeParent();else child.removeParent();this.items[index.y][index.x]=null}return this},removeChildAt:function Grid_removeChildAt(x,y){jayus.debug.matchCoordinate("Grid.removeChildAt",x,y);if(arguments.length===1)return this.removeChildAt(x.x,x.y);var child=this.getChildAt(x,y);if(child!==null){child.removeParent();this.items[y][x]=null}return this},
setGridSize:function Grid_setGridSize(columns,rows){return this.setColumnCount(columns).setRowCount(rows)},getRowCount:function Grid_getRowCount(){return this.items.length},setRowCount:function Grid_setRowCount(rows){jayus.debug.match("Grid.setRowCount",rows,"rows",4);while(rows<this.getRowCount())this.removeRow();while(rows>this.getRowCount())this.addRow();return this},addRow:function Grid_addRow(row){if(!arguments.length)row=[];while(row.length<this.getColumnCount())row.push(null);this.items.push(row);
this.updateSize();return this.dirty()},removeRow:function Grid_removeRow(index){jayus.debug.match("Grid.removeRow",index,"index",4);this.forEachInRow(index,function(){this.removeParent()});if(this.getRowCount()>1&&this.hasRow(index))this.items.splice(index,1);this.updateSize();return this.dirty()},getColumnCount:function Grid_getColumnCount(){return this.items[0].length},setColumnCount:function Grid_setColumnCount(cols){jayus.debug.match("Grid.setColumnCount",cols,"cols",4);while(cols<this.getColumnCount())this.removeColumn();
while(cols>this.getColumnCount())this.addColumn();return this},addColumn:function Grid_addColumn(col){if(!arguments.length)col=[];while(col.length<this.getRowCount())col.push(null);for(var i=0;i<this.getRowCount();i++)this.items[i].push(col[i]);this.updateSize();return this.dirty()},removeColumn:function Grid_removeColumn(index){jayus.debug.match("Grid.removeColumn",index,"index",4);this.forEachInColumn(index,function(){this.removeParent()});if(this.getColumnCount()>1&&this.hasColumn(index))for(var i=
0;i<this.getRowCount();i++)this.items[i].splice(index,1);this.updateSize();return this.dirty()},onEach:function Grid_onEach(method,args){jayus.debug.match("Grid.onEach",method,"method",2);return this.forEachSlot(function(x,y,item){if(item!==null)item[method].apply(item,x,y,args)})},forEach:function Grid_forEach(func,args){jayus.debug.match("Grid.forEach",func,"func",3);return this.forEachSlot(function(x,y,item){if(item!==null)func.call(this,x,y,item)})},forEachInRow:function Grid_forEachInRow(row,
func,args){jayus.debug.matchArguments("Grid.forEachInRow",arguments,"row",4,"func",3);if(this.hasRow(row))for(var j=0,item;j<this.getColumnCount();j++){item=this.items[row][j];if(item!==null)func.apply(item,args)}return this},forEachInColumn:function Grid_forEachInColumn(col,func,args){jayus.debug.matchArguments("Grid.forEachInColumn",arguments,"col",4,"func",3);if(this.hasColumn(col))for(var i=0,item;i<this.getRowCount();i++){item=this.items[i][col];if(item!==null)func.apply(item,args)}return this},
forEachSlot:function Grid_forEachSlot(func){jayus.debug.match("Grid.forEachSlot",func,"func",3);var x,y;for(x=0;x<this.getColumnCount();x++)for(y=0;y<this.getRowCount();y++)if(func.call(this,x,y,this.items[y][x])===null)return this;return this},findCursorAcceptor:function Grid_findCursorAcceptor(){var acceptor,ret=null;this.forEach(function(x,y,item){if(item.underCursor)if(item.isParent){acceptor=item.findCursorAcceptor();if(acceptor!==null){ret=acceptor;return null}if(item.canAcceptCursor){ret=item;
return null}}else if(item.canAcceptCursor){ret=item;return null}});return ret},fireOnEach:function Grid_fireOnEach(event,data){jayus.debug.match("Grid.fireOnEach",event,"event",2);var x,y,item;for(x=0;x<this.getColumnCount();x++)for(y=0;y<this.getRowCount();y++){item=this.items[y][x];if(item!==null)if(item.fire(event,data))return true}return false},fireOnCursor:function Grid_fireOnCursor(event,data){jayus.debug.match("Grid.fireOnCursor",event,"event",2);var x,y,item;for(x=0;x<this.getColumnCount();x++)for(y=
0;y<this.getRowCount();y++){item=this.items[y][x];if(item!==null&&item.underCursor){if(item.isParent&&item.fireOnCursor(event,data))return true;if(item.fire(event,data))return true}}return false},updateCursorOnChildren:function Grid_updateCursorOnChildren(x,y){this.forEach(function(i,j,item){if(item.trackCursor)jayus.util.updateCursorOnChild(item,x,y)})},removeCursorFromChildren:function Grid_removeCursorFromChildren(data){this.forEach(function(x,y,item){if(item.underCursor)item.removeCursor()})},
paintContents:function Grid_paintContents(ctx){jayus.debug.matchContext("Grid.paintContents",ctx);var i,j,item;for(i=0;i<this.items.length;i++)for(j=0;j<this.items[i].length;j++){item=this.items[i][j];if(item!==null&&item.visible)item.drawOntoContext(ctx)}}});jayus.Image=jayus.RectEntity.extend({image:null,filepath:null,hasSection:false,sectionX:0,sectionY:0,loaded:false,pendingLoad:false,roundX:true,roundY:true,init:function Image(image,loadHandler){jayus.Entity.prototype.init.apply(this);if(arguments.length!==0){if(arguments.length===2)this.addHandler("loaded",loadHandler);this.setSource(image)}},toObject:function Image_toObject(){var object=jayus.RectEntity.prototype.toObject.apply(this);object.type="Image";if(this.section!==null)object.section=this.section.toObject();
if(this.image instanceof HTMLImageElement)object.image=this.filepath;else if(this.image instanceof jayus.Surface)object.image=this.image.toObject();delete object.width;delete object.height;return object},initFromObject:function Image_initFromObject(object){jayus.RectEntity.prototype.initFromObject.call(this,object);this.hasSection=typeof object.section==="object";if(this.hasSection)this.section=new jayus.Rectangle(object.section);if(typeof object.image==="string")this.setSource(object.image);else if(typeof object.image===
"object")this.setSource(new jayus.Surface(object.image));return this.dirty(127)},setSource:function Image_setSource(image){if(this.pendingLoad){console.warn('Image.setSource() - Called while still waiting for image "'+filepath+'" to be loaded');return this}if(typeof image==="string"){if(this.filepath===image){console.debug("Image.setSource() - Called twice with same filepath: "+image);return this}var filepath=image;this.filepath=filepath;if(!jayus.images.isLoaded(filepath)){this.loaded=false;this.pendingLoad=
true;var that=this;jayus.images.whenLoaded(filepath,function(data){that.pendingLoad=false;that.setSource(data.image)});return this}image=jayus.images.get(filepath)}if(this.image===image){console.debug("Image.setSource() - Called twice with same image: "+image);return this}this.image=image;if(!this.hasSection){this.width=this.image.width;this.height=this.image.height;this.dirty(4)}this.loaded=true;this.fire("loaded");return this},whenLoaded:function Image_whenLoaded(handler){jayus.debug.match("Image.whenLoaded",
handler,"handler",3);if(this.loaded)handler.apply(this);else this.addHandler("loaded",function(data,options){handler.apply(this);options.remove=true});return this},setSection:function Image_setSection(x,y,width,height){if(arguments.length===1){jayus.debug.match("Image.setSection()",x,"section",20);return this.setSection(x.x,x.y,x.width,x.height)}else if(arguments.length===3){jayus.debug.matchArguments("Image.setSection()",arguments,"origin",13,"width",4,"height",4);return this.setSection(x.x,x.y,
y,width)}else jayus.debug.matchArgumentsAs("Image.setSection()",arguments,4,"x","y","width","height");this.hasSection=true;if(this.width!==width||this.height!==height){this.sectionX=x;this.sectionY=y;this.width=width;this.height=height;this.dirty(4)}else if(this.sectionX!==x||this.sectionY!==y){this.sectionX=x;this.sectionY=y;this.dirty(16)}return this},clearSection:function Image_clearSection(){if(!this.loaded){console.warn("Image.clearSection() - Image not yet loaded, cannot clear section");return}if(this.hasSection){this.hasSection=
false;this.width=this.image.width;this.height=this.image.height;this.dirty(4)}return this},toPattern:function Image_toPattern(repetition){if(!arguments.length)repetition="repeat";jayus.debug.match("Image.toPattern",repetition,"repetition",2);if(["repeat","repeat-x","repeat-y","no-repeat"].indexOf(repetition)===-1)throw new Error("Image.toPattern() - Invalid repetition"+jayus.debug.toString(repetition)+' sent, "repeat", "repeat-x", "repeat-y", or "no-repeat" required');return this.rasterize().toPattern(repetition)},
paintContents:function Image_paintContents(ctx){jayus.debug.matchContext("Image.paintContents",ctx);if(!this.loaded){console.error("Image.paintContents() - Image "+this.filepath+" not yet loaded, cannot paint");return}var image=this.image;if(image instanceof jayus.Surface)image=image.canvas;if(this.hasSection)ctx.drawImage(image,this.sectionX,this.sectionY,this.width,this.height,0,0,this.width,this.height);else ctx.drawImage(image,0,0);return this}});jayus.Sprite=jayus.Image.extend({animation:null,animator:null,spriteIndexX:null,spriteIndexY:null,sheet:null,toObject:function Sprite_toObject(){var object=jayus.Image.prototype.toObject.call(this);object.type="Sprite";if(this.spriteIndexX!==null||this.spriteIndexY!==null){object.spriteIndexX=this.spriteIndexX;object.spriteIndexY=this.spriteIndexY}return object},initFromObject:function Sprite_initFromObject(object){jayus.Image.prototype.initFromObject.call(this,object);if(typeof object.spriteIndexX!==
"undefined"||typeof object.spriteIndexY!=="undefined")this.setSprite(object.spriteIndexX,object.spriteIndexY);else if(typeof object.spriteIndexX!==typeof object.spriteIndexY)console.warn("Sprite.initFromObject() - Properties spriteIndexX and spriteIndexY must both be present if one is");return this.dirty(127)},setSpriteSheet:function Sprite_setSpriteSheet(sheet){this.sheet=sheet;return this},setSprite:function Sprite_setSprite(x,y){if(this.sheet===null&&this.image===null){console.error('Sprite.setSprite() - Cannot set sprite, image "'+
this.filepath+'" not found, it is likely not loaded yet');return this}var sheet=this.sheet||this.image.sheet;if(typeof sheet!=="object"){console.error('Sprite.setSprite() - Cannot set sprite, image nor sprite contains a spritesheet as the "sheet" property');return this}if(arguments.length===1){if(typeof x==="string"){if(this.spriteIndexX!==x){var data=sheet.namedSprites[x];if(typeof data!=="object"){console.error('Sprite.setSprite("'+x+'") - Named sprite not found in sprite sheet');return this}this.setSection(data.x,
data.y,data.width,data.height);this.setRelativeAnchor(0.5,0.5);this.setFlipping(data.flipX,data.flipY);this.spriteIndexX=x}return this}if(typeof x==="number"){var width=Math.floor(this.width/(sheet.spriteWidth+sheet.marginX)),tileX=x%width,tileY=(x-tileX)/width;return this.setSprite(tileX,tileY)}if(!(x instanceof jayus.Point))console.warn("Sprite.setSprite() - Requires string, number, Point, or two numbers");return this.setSprite(x.x,x.y)}if(this.spriteIndexX!==x||this.spriteIndexY!==y){this.spriteIndexX=
x;this.spriteIndexY=y;this.setSection(sheet.marginX+x*sheet.spriteWidth,sheet.marginY+y*sheet.spriteHeight,sheet.spriteWidth,sheet.spriteHeight);this.dirty(127)}return this},playAnimation:function Sprite_playAnimation(name,func){jayus.debug.match("Sprite.playAnimation",name,"name",2);jayus.debug.matchOptional("Sprite.playAnimation",func,"func",3);this.setAnimation(name,false);if(arguments.length>1)this.animator.addHandler("finished",func);return this},loopAnimation:function Sprite_loopAnimation(name){jayus.debug.match("Sprite.loopAnimation",
name,"name",2);return this.setAnimation(name,true)},setAnimation:function Sprite_setAnimation(name,looped){jayus.debug.matchArguments("Sprite.setAnimation",arguments,"name",2,"looped",1);var sheet=this.sheet||this.image.sheet;if(typeof sheet!=="object"){console.error('Sprite.setSprite() - Cannot set sprite, image nor sprite contains a spritesheet as the "sheet" property');return this}if(!sheet.hasAnimation(name))console.error("Sprite.setAnimation() - Spritesheet does not contain sprite/animation: "+
name);if(this.animator!==null&&this.animator.running){if(this.animation===name)return this;this.animator.stop()}this.animation=name;var data=sheet.animations[name],sequence=data.sprites;this.setRelativeAnchor(0.5,0.5);this.setFlipping(data.flipX,data.flipY);this.animator=new jayus.Animator.Discrete(sequence.length,function(index){this.sprite.setSprite(sequence[index])});this.animator.sprite=this;this.animator.setDuration(sheet.animations[name].duration).setLooped(looped).start();return this},stopAnimation:function Sprite_stopAnimation(){if(this.animator!==
null&&this.animator.running)this.animator.stop()}});jayus.SpriteSheet=jayus.Dependency.extend({spriteWidth:32,spriteHeight:32,spacingX:0,spacingY:0,marginX:0,marginY:0,animations:null,namedSprites:null,init:function SpriteSheet(filepath){this.animations={};this.namedSprites={};if(arguments.length){jayus.debug.match("SpriteSheet",filepath,"filepath",2);var sheet=this;jayus.images.whenLoaded(filepath,function(data){data.image.sheet=sheet})}},nameSprite:function SpriteSheet_nameSprite(name,x,y,width,height){jayus.debug.matchArguments("SpriteSheet.nameSprite",
arguments,"name",2,"x",4,"y",4,"width",4,"height",4);this.namedSprites[name]={x:x,y:y,width:width,height:height,flipX:false,flipY:false};return this},setSpriteFlipping:function SpriteSheet_setSpriteFlipping(name,flipX,flipY){jayus.debug.matchArguments("SpriteSheet.setSpriteFlipping",arguments,"name",2,"flipX",1,"flipY",1);if(typeof this.namedSprites[name]!=="object")throw new Error("SpriteSheet.setSpriteFlipping() - Unknown sprite name: "+name);var data=this.namedSprites[name];data.flipX=flipX;data.flipY=
flipY;return this},setSpriteSize:function SpriteSheet_setSpriteSize(width,height){jayus.debug.matchSize("SpriteSheet.setSpriteSize",width,height);if(arguments.length===1){height=width.height;width=width.width}if(this.spriteWidth!==width||this.spriteHeight!==height){this.spriteWidth=width;this.spriteHeight=height;this.dirty(4)}return this},setSpacing:function SpriteSheet_setSpacing(x,y){jayus.debug.matchCoordinate("SpriteSheet.setSpacing",x,y);if(arguments.length===1)return this.setSpacing(x.x,x.y);
this.spacingX=x;this.spacingY=y;return this},setMargin:function SpriteSheet_setMargin(x,y){jayus.debug.matchCoordinate("SpriteSheet.setMargin",x,y);if(arguments.length===1)return this.setMargin(x.x,x.y);this.marginX=x;this.marginY=y;return this},hasAnimation:function SpriteSheet_hasAnimation(name){return typeof this.animations[name]==="object"},addAnimation:function SpriteSheet_addAnimation(name,sprites,duration){if(arguments.length===2){duration=1E3;jayus.debug.matchArguments("SpriteSheet.addAnimation",
arguments,"name",2,"sprites",6)}else jayus.debug.matchArguments("SpriteSheet.addAnimation",arguments,"name",2,"sprites",6,"duration",4);this.animations[name]={sprites:sprites,duration:duration,flipX:false,flipY:false};return this},add:function SpriteSheet_add(animations){for(var key in animations)if(animations.hasOwnProperty(key)){var animation=animations[key];if(typeof animation.flipX==="undefined")animation.flipX=false;if(typeof animation.flipY==="undefined")animation.flipY=false;if(typeof animation.duration===
"undefined")animation.duration=1E3;this.animations[key]=animation}return this},setAnimationDuration:function SpriteSheet_setAnimationDuration(animation,duration){jayus.debug.matchArguments("SpriteSheet.setAnimationDuration",arguments,"animation",2,"duration",4);if(!this.hasAnimation(animation))throw new Error("SpriteSheet.setAnimationDuration() - Invalid animation"+jayus.debug.toString(animation)+" sent, unknown animation");this.animations[animation].duration=duration;return this},setAnimationFlipping:function SpriteSheet_setAnimationFlipping(animation,
flipX,flipY){jayus.debug.matchArguments("SpriteSheet.setAnimationFlipping",arguments,"animation",2,"flipX",1,"flipY",1);if(!this.hasAnimation(animation))throw new Error("SpriteSheet.setAnimationFlipping() - Invalid animation"+jayus.debug.toString(animation)+" sent, unknown animation");this.animations[animation].flipX=flipX;this.animations[animation].flipY=flipY;return this}});jayus.Surface=jayus.RectEntity.extend({width:300,height:150,init:function Surface(width,height){jayus.Entity.prototype.init.apply(this);if(arguments.length===2){jayus.debug.matchArgumentsAs("Surface",arguments,4,"width","height");this.width=width;this.height=height}this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.context=this.canvas.getContext("2d")},initFromObject:function Surface_initFromObject(object){jayus.debug.match("Surface.initFromObject",
object,"object",5);this.ignoreDirty++;jayus.Scene.prototype.initFromObject.call(this,object);if(typeof object.negateBlur==="boolean")this.negateBlur=object.negateBlur;this.ignoreDirty--;this.dirty(127)},clear:function Surface_clear(){this.context.clearRect(0,0,this.width,this.height);return this.dirty(16)},fill:function Surface_fill(r,g,b,a){switch(arguments.length){case 1:return this.fill(r.r,r.g,r.b,r.a);case 2:return this.fill(r.r,r.g,r.b,r.a*g);case 3:return this.fill(r,g,b,1);case 4:jayus.debug.matchArgumentsAs("Surface.fill",
arguments,4,"r","g","b","a");var ctx=this.context;ctx.save();ctx.fillStyle="rgba("+r+","+g+","+b+","+a+")";ctx.globalCompositeOperation="copy";ctx.fillRect(0,0,this.width,this.height);ctx.restore();return this}},getBuffer:function Surface_getBuffer(x,y,width,height){switch(arguments.length){case 0:return this.getBuffer(0,0,this.width,this.height);case 1:jayus.debug.match("Surface.getBuffer()",x,"section",20);return this.getBuffer(x.x,x.y,x.width,x.height);case 3:jayus.debug.matchArguments("Surface.getBuffer()",
arguments,"origin",13,"width",4,"height",4);return this.getBuffer(x.x,x.y,width,height)}jayus.debug.matchArgumentsAs("Surface.getBuffer()",arguments,4,"x","y","width","height");return this.context.getImageData(x,y,width,height)},putBuffer:function Surface_putBuffer(x,y,buffer){switch(arguments.length){case 1:jayus.debug.match("Surface.putBuffer",x,"buffer",21);return this.putBuffer(0,0,x);case 2:jayus.debug.matchArguments("Surface.putBuffer",arguments,"position",13,"buffer",21);return this.putBuffer(x.x,
x.y,y)}jayus.debug.matchArguments("Surface.putBuffer",arguments,"x",4,"y",4,"buffer",21);this.context.putImageData(buffer,x,y);return this.dirty(16)},getPixel:function Surface_getPixel(x,y){jayus.debug.matchCoordinate("Surface.getPixel",x,y);if(arguments.length===1)return this.getPixel(x.x,x.y);var data=this.getBuffer(x,y,1,1).data;return new jayus.Color(data[0],data[1],data[2],data[3]/255)},setPixel:function Surface_setPixel(x,y,r,g,b,a){switch(arguments.length){case 2:jayus.debug.matchArguments("Surface.setPixel",
arguments,"pixel",13,"color",8);return this.setPixel(x.x,x.y,y.r,y.g,y.b,y.a);case 3:jayus.debug.matchArguments("Surface.setPixel",arguments,"x",4,"y",4,"color",8);return this.setPixel(x,y,r.r,r.g,r.b,r.a);case 4:jayus.debug.matchArguments("Surface.setPixel",arguments,"pixel",13,"r",4,"g",4,"b",4);return this.setPixel(x.x,x.y,y,r,g,1);case 5:jayus.debug.matchArgumentsAs("Surface.setPixel",arguments,4,"x","y","r","g","b");return this.setPixel(x,y,r,g,b,1);case 6:jayus.debug.matchArgumentsAs("Surface.setPixel",
arguments,4,"x","y","r","g","b","a");var buffer=this.context.createImageData(1,1),data=buffer.data;data[0]=r;data[1]=g;data[2]=b;data[3]=a*255;return this.putBuffer(x,y,buffer)}},getPixelFrame:function Surface_getPixelFrame(x,y){jayus.debug.matchCoordinate("Surface.getPixelFrame",x,y);if(arguments.length===1)return this.getPixelFrame(x.x,x.y);return new jayus.Rectangle(this.x+x*this.xScale,this.y+y*this.yScale,this.xScale,this.yScale)},getPixelAt:function Surface_getPixelAt(x,y){jayus.debug.matchCoordinate("Surface.getPixelAt",
x,y);if(arguments.length===1)return this.getPixelAt(x.x,x.y);if(this.intersectsAt(x,y)){if(x===this.x+this.width)x--;if(y===this.y+this.height)y--;return new jayus.Point(Math.floor((x-this.x)/this.xScale),Math.floor((y-this.y)/this.yScale))}return null},blurImage:function Surface_blurImage(intensity){jayus.debug.match("Surface.blurImage",intensity,"intensity",4);var data=this.getBuffer().data,w=this.width,h=this.height,newBuffer=this.context.createImageData(w,h),newData=newBuffer.data,x,y,sx,sy,r,
b,g,a,c,z,i=0;for(y=h-1;y>=0;y--)for(x=w-1;x>=0;x--){r=g=b=a=c=0;for(sy=y-intensity;sy<y+1+intensity;sy++)if(sy>=0&&sy<h)for(sx=x-intensity;sx<x+1+intensity;sx++)if(sx>=0&&sx<w){z=(sy*w+sx)*4;r+=data[z];g+=data[z+1];b+=data[z+2];a+=data[z+3];c++}newData[i]=r/c;newData[i+1]=g/c;newData[i+2]=b/c;newData[i+3]=a/c;i+=4}return this.putBuffer(newBuffer)},exportPNG:function Surface_exportPNG(){window.open(this.canvas.toDataURL("image/png"),"_blank");return this},toPattern:function Surface_toPattern(repetition){if(!arguments.length)repetition=
"repeat";else{jayus.debug.match("Surface.toPattern",repetition,"repetition",2);if(["repeat","repeat-x","repeat-y","no-repeat"].indexOf(repetition)===-1)throw new Error("Surface.toPattern() - Invalid repetition"+jayus.debug.toString(repetition)+' sent, "repeat", "repeat-x", "repeat-y", or "no-repeat" required');}return this.context.createPattern(this.canvas,repetition)},paintContents:function Surface_paintContents(ctx){if(this.negateBlur)jayus.manuallyDrawImage(this.context,ctx,this.width,this.height);
else ctx.drawImage(this.canvas,0,0)}});jayus.Group={children:null,isParent:true,find:function Group_find(id){jayus.debug.match("Entity.setId",id,"id",0);var i,item;for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.id===id)return item;if(item.isParent){item=item.find(id);if(item!==null)return item}}return null},getAllChildren:function Group_getAllChildren(parentsAfter){var i,item,children=[];for(i=0;i<this.items.length;i++){item=this.items[i];if(item.isParent)if(parentsAfter)children=children.concat(item,item.getAllChildren(parentsAfter));
else children=children.concat(item.getAllChildren(parentsAfter),item);else children.push(item)}return children},getChildrenUnderCursor:function Group_getChildrenUnderCursor(){var i,ret=[];for(i=0;i<this.items.length;i++)if(this.items[i].underCursor)ret.push(this.items[i]);return ret},getChildrenAt:function Group_getChildrenAt(x,y){jayus.debug.matchCoordinate("Group.getChildrenAt",x,y);if(arguments.length===1)return this.getChildrenAt(x.x,x.y);var i,ret=[];for(i=0;i<this.items.length;i++)if(this.items[i].intersectsAt(x,
y))ret.push(this.items[i]);return ret},forEachChild:function Group_forEachChild(func,args){jayus.debug.match("Group.forEachChild",func,"func",3);return this.children.forEach(func,args)},forEveryChild:function Group_forEveryChild(func,args){jayus.debug.match("Group.forEveryChild",func,"func",3);return this.children.forEvery(func,args)},fireOnChildren:function Group_fireOnChildren(event,data){jayus.debug.match("Group.fireOnChildren",event,"event",2);var i,item,items=this.items;for(i=0;i<items.length;i++){item=
items[i];if(item.isParent&&item.fireOnChildren(event,data))return true;if(item.fire(event,data))return true}return false},fireOnCursor:function Group_fireOnCursor(event,data){jayus.debug.match("Group.fireOnCursor",event,"event",2);var i,item,items=this.items;for(i=items.length-1;i>=0;i--){item=items[i];if(item.underCursor){if(item.isParent&&item.fireOnCursor(event,data))return true;if(item.fire(event,data))return true}}return false},propagateCursor:false,updateCursorOnChildren:function Group_updateCursorOnChildren(x,
y){var i,item,items=this.items;if(this.contentsOriginX!==undefined){x-=this.contentsOriginX;y-=this.contentsOriginY}for(i=items.length-1;i>=0;i--){item=items[i];if(item.trackCursor)item.updateCursor(x,y)}},findCursorAcceptor:function Group_findCursorAcceptor(){var i,item,acceptor;for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.underCursor)if(item.isParent){acceptor=item.findCursorAcceptor();if(acceptor!==null)return acceptor;if(item.canAcceptCursor)return item}else if(item.canAcceptCursor)return item}return null},
removeCursorFromChildren:function Group_removeCursorFromChildren(){var i,item,items=this.items;for(i=0;i<items.length;i++){item=items[i];if(item.underCursor){item.underCursor=false;item.fire("cursorOut");if(item.isParent)item.removeCursorFromChildren()}}},childCursorTrackingChanged:function Group_childCursorTrackingChanged(child,trackCursor){if(trackCursor){this.propagateCursor=true;if(!this.trackCursor){this.trackCursor=true;if(this.parent!==null)this.parent.childCursorTrackingChanged(this,true)}}}};jayus.Wrapper={isParent:false,propagateCursor:true,childCursorTrackingChanged:function Wrapper_childCursorTrackingChanged(child,trackCursor){if(trackCursor){this.propagateCursor=true;if(!this.trackCursor){this.trackCursor=true;if(this.parent!==null)this.parent.childCursorTrackingChanged(this,true)}}},updateCursorOnChildren:function Frame_updateCursorOnChildren(x,y){if(this.child.trackCursor)this.child.updateCursor(x,y)},removeCursorFromChildren:function Wrapper_removeCursorFromChildren(){if(this.child.underCursor)this.child.removeCursor()},
findCursorAcceptor:function Wrapper_findCursorAcceptor(){if(this.child.underCursor)if(this.child.isParent){var acceptor=this.child.findCursorAcceptor();if(acceptor!==null)return acceptor;if(this.child.canAcceptCursor)return this.child}else return this.child;return null},child:null,setChild:function Wrapper_setChild(child){jayus.debug.match("Wrapper.setChild",child,"child",12);this.child=child;child.setParent(this);this.isParent=true;if(child.trackCursor)this.childCursorTrackingChanged(child,true);
return this},removeChild:function Wrapper_removeChild(){this.child.removeParent();this.child=null;this.isParent=false;return this},find:function Wrapper_find(id){if(this.isParent){if(this.child.id===id)return this.child;if(this.child.isParent)return this.child.find(id)}return null},onEachChild:function Wrapper_onEachChild(method,args){jayus.debug.match("Wrapper.onEachChild",method,"method",2);return this.child[method].apply(this.child,args)},forEachChild:function Wrapper_forEachChild(func,args){jayus.debug.match("Wrapper.forEachChild",
func,"func",3);return func.apply(this.child,args)},forEveryChild:function Wrapper_forEveryChild(func,args){jayus.debug.match("Wrapper.forEveryChild",func,"func",3);if(this.child.isParent)this.child.forEveryChild(func,args);return func.apply(this.child,args)},fireOnChildren:function Wrapper_fireOnChildren(event,data){jayus.debug.match("Wrapper.fireOnChildren",event,"event",2);return this.child.fire(event,data)},fireOnCursor:function Wrapper_fireOnCursor(event,data){jayus.debug.match("Wrapper.fireOnCursor",
event,"event",2);if(this.isParent&&this.child.underCursor){if(this.child.isParent&&this.child.fireOnCursor(event,data))return true;return this.child.fire(event,data)}return false}};jayus.Layer=jayus.Entity.extend({x:0,y:0,childrenAdded:null,scope:null,scopeDirty:true,canAcceptCursor:false,componentDirtied:function Layer_componentDirtied(component,type){if(component instanceof jayus.Entity){if(type&2+4+8)component.scopeChanged=true;this.scopeDirty=true}this.dirty(16)},listItemAdded:function Layer_listItemAdded(list,item){this.childrenAdded.push(item);item.prevScope=item.getScope();item.setParent(this);this.dirty(16)},listItemsAdded:function Layer_listItemsAdded(list,items){var i,
item;for(i=0;i<items.length;i++){item=items[i];this.childrenAdded.push(item);item.prevScope=item.getScope();item.setParent(this)}this.dirty(16)},listItemRemoved:function Layer_listItemRemoved(list,item){item.removeParent();this.dirty(16)},listItemsRemoved:function Layer_listItemsRemoved(list,items){for(var i=0;i<items.length;i++)items[i].removeParent();this.dirty(16)},init:function Layer(width,height){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;
this.scope=new jayus.Rectangle;this.childrenAdded=[];this.children.typeId=12;if(arguments.length===2){jayus.debug.matchArgumentsAs("Layer",arguments,4,"width","height");this.width=width;this.height=height}},toObject:function Layer_toObject(){var object=jayus.Entity.prototype.toObject.apply(this);object.type="Layer";var i,key,val,valType;for(i=0;i<jayus.Layer.prototype.properties.length;i++){key=jayus.Layer.prototype.properties[i];val=this[key];valType=typeof val;if(val!==jayus.Layer.prototype[key]){if(valType===
"object")val=val.toObject();object[key]=val}}return object},cursorHitTest:function Layer_cursorHitTest(x,y){return true},getScope:function Layer_getScope(){var i,scope,x1,y1,x2,y2;if(this.scopeDirty)if(this.items.length){x1=Infinity;y1=Infinity;x2=-Infinity;y2=-Infinity;for(i=this.items.length-1;i>=0;i--){scope=this.items[i].getScope();if(scope.x<x1)x1=scope.x;if(scope.x+scope.width>x2)x2=scope.x+scope.width;if(scope.y<y1)y1=scope.y;if(scope.y+scope.height>y2)y2=scope.y+scope.height}this.scope.setFrame(x1,
y1,x2-x1,y2-y1)}else this.scope.setFrame(0,0,0,0);return this.scope},setX:jayus.RectEntity.prototype.setX,setY:jayus.RectEntity.prototype.setY,getOrigin:jayus.Rectangle.prototype.getOrigin,setOrigin:jayus.Rectangle.prototype.setOrigin,translate:jayus.Rectangle.prototype.translate,intersectsAt:function Layer_intersectsAt(x,y){return true},roundX:false,roundY:false,setRounding:jayus.RectEntity.prototype.setRounding,applyTransforms:function Layer_applyTransforms(ctx){var x=this.x,y=this.y;if(this.roundX)x=
Math.round(x);if(this.roundY)y=Math.round(y);if(this.isTransformed){var xScale=this.xScale,yScale=this.yScale;if(this.flipX)xScale*=-1;if(this.flipY)yScale*=-1;if(this.xAnchor||this.yAnchor){x+=this.xAnchor;y+=this.yAnchor}ctx.translate(x,y);ctx.scale(xScale,yScale);ctx.rotate(this.angle);if(this.xAnchor||this.yAnchor)ctx.translate(-this.xAnchor,-this.yAnchor)}else if(x||y)ctx.translate(x,y);return this},drawOntoContext:function Layer_drawOntoContext(ctx){ctx.save();if(this.alpha!==1)ctx.globalAlpha*=
this.alpha;this.applyTransforms(ctx);var i,item;for(i=0;i<this.items.length;i++){item=this.items[i];if(item.visible)item.drawOntoContext(ctx)}ctx.restore()}});jayus.applyObject(jayus.Group,jayus.Layer.prototype);jayus.Scene=jayus.RectEntity.extend({childrenAdded:null,clipChildrenToFrame:false,redrawAll:true,componentDirtied:function Scene_componentDirtied(component,type){if(component instanceof jayus.Entity)if(type&2+4+8)component.scopeChanged=true;if(component===this.bounds)this.bounds.cloneOnto(this.boundsClone);this.dirty(16)},listItemAdded:function Scene_listItemAdded(list,item){if(this.childrenAdded===null)this.childrenAdded=[];this.childrenAdded.push(item);item.prevScope=item.getScope();if(item.trackCursor)this.childCursorTrackingChanged(item,
true);item.setParent(this);this.dirty(16)},listItemsAdded:function Scene_listItemsAdded(list,items){var i,item;if(this.childrenAdded===null)this.childrenAdded=[];for(i=0;i<items.length;i++){item=items[i];this.childrenAdded.push(item);item.prevScope=item.getScope();if(item.trackCursor)this.childCursorTrackingChanged(item,true);item.setParent(this)}this.dirty(16)},listItemRemoved:function Scene_listItemRemoved(list,item){item.removeParent();this.redrawAll=true;this.dirty(16)},listItemsRemoved:function Scene_listItemsRemoved(list,
items){for(var i=0;i<items.length;i++)items[i].removeParent();this.redrawAll=true;this.dirty(16)},init:function Scene(width,height){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;this.children.typeId=12;if(arguments.length===2){jayus.debug.matchArgumentsAs("Scene",arguments,4,"width","height");this.width=width;this.height=height}},toObject:function Scene_toObject(){var object=jayus.RectEntity.prototype.toObject.apply(this);jayus.groupToObject.call(this,
object);object.type="Scene";if(this.optimizeBuffering!==false)object.optimizeBuffering=this.optimizeBuffering;if(this.groupDamagedRegions!==true)object.groupDamagedRegions=this.groupDamagedRegions;if(this.damagedRegionPadding!==2)object.damagedRegionPadding=this.damagedRegionPadding;return object},initFromObject:function Scene_initFromObject(object){jayus.debug.match("Scene.initFromObject",object,"object",5);this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,object);jayus.groupInitFromObject.call(this,
object);if(typeof object.clipChildrenToFrame==="boolean")this.clipChildrenToFrame=object.clipChildrenToFrame;if(typeof object.optimizeBuffering==="boolean")this.optimizeBuffering=object.optimizeBuffering;if(typeof object.groupDamagedRegions==="boolean")this.groupDamagedRegions=object.groupDamagedRegions;if(typeof object.damagedRegionPadding==="number")this.damagedRegionPadding=object.damagedRegionPadding;this.ignoreDirty--;this.dirty(127)},optimizeBuffering:false,groupDamagedRegions:true,damagedRegionPadding:2,
setOptimizedBuffering:function Scene_setOptimizedBuffering(on){jayus.debug.match("Scene.setOptimizedBuffering",on,"on",1);if(this.optimizeBuffering!==on){this.optimizeBuffering=on;this.redrawAll=true;this.dirty(16)}return this},refreshBuffer:function Scene_refreshBuffer(){if(this.buffered){var width=this.width,height=this.height,canvas=this.canvas,ctx=this.context;if(width!==canvas.width||height!==canvas.height){canvas.width=width;canvas.height=height}if(this.optimizeBuffering&&!this.redrawAll)this.optimizedRefreshBuffer();
else{this.fullyRefreshBuffer();this.redrawAll=false}this.dirtied=false}},optimizedRefreshBuffer:function Scene_optimizedRefreshBuffer(){if(this.buffered){var ctx=this.context,i,i2,item,region,region2,damagedRegions=[];for(i=0;i<this.items.length;i++){item=this.items[i];item.clean=true;if(item.scopeChanged){damagedRegions.push(item.getScope().includeRectangle(item.prevScope));item.prevScope=item.getScope();item.scopeChanged=false;item.clean=false}else if(item.dirtied){damagedRegions.push(item.getScope());
item.dirtied=false;item.clean=false}}var done=false;if(this.groupDamagedRegions)while(!done){done=true;for(i=0;i<damagedRegions.length;i++){region=damagedRegions[i];for(i2=0;i2<damagedRegions.length;i2++){region2=damagedRegions[i2];if(region!==region2&&jayus.intersectTest(region,region2)){damagedRegions[i].includeRectangle(region2);damagedRegions.splice(i2,1);done=false;if(i>=i2)i--;i2--}}}}var padding=this.damagedRegionPadding;for(i=0;i<damagedRegions.length;i++){region=damagedRegions[i];region.translate(-padding,
-padding);region.setSize(region.width+padding*2,region.height+padding*2)}for(i=0;i<damagedRegions.length;i++){region=damagedRegions[i];for(i2=0;i2<this.items.length;i2++){item=this.items[i2];if(item.clean&&jayus.intersectTest(item,region))item.clean=false}}if(this.showDamage)this.clearDamage();ctx.save();for(i=0;i<damagedRegions.length;i++){region=damagedRegions[i];ctx.clearRect(region.x,region.y,region.width,region.height)}ctx.beginPath();for(i=0;i<damagedRegions.length;i++){region=damagedRegions[i];
ctx.rect(region.x,region.y,region.width,region.height)}ctx.clip();if(this.bufferBg&&this.bg!==null)if(this.alignBg)this.bg.paintRect(ctx,0.5,0.5,Math.round(this.width),Math.round(this.height));else this.bg.paintRect(ctx,0,0,this.width,this.height);for(i=0;i<this.items.length;i++){item=this.items[i];if(!item.clean&&item.visible){item.drawOntoContext(ctx);if(this.showDamage)this.paintRedraw(item)}}if(this.showDamage)for(i=0;i<damagedRegions.length;i++)this.paintDamage(damagedRegions[i]);ctx.restore()}},
paintContents:function Scene_paintContents(ctx){if(this.clipChildrenToFrame){ctx.beginPath();ctx.rect(0,0,this.width,this.height);ctx.clip()}if(this.contentsOriginX!==undefined)ctx.translate(this.contentsOriginX,this.contentsOriginY);var i,item;for(i=0;i<this.items.length;i++){item=this.items[i];if(item.visible)item.drawOntoContext(ctx)}}});jayus.applyObject(jayus.Group,jayus.Scene.prototype);jayus.Display=jayus.Scene.extend({buffered:true,cursor:new jayus.Point,suppressContextMenu:true,suppressSelection:true,pendMousemoveEvents:true,hasPendingMousemoveEvent:false,pendingMousemoveEvent:null,init:function Display(width,height){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;this.children.typeId=12;if(arguments.length)if(arguments.length===1)jayus.debug.match("Display",width,"canvas",23);else if(arguments.length===2)jayus.debug.matchArguments("Display",
arguments,"width",4,"height",4);else throw new TypeError("Display() - Invalid number of arguments sent, 0, 1, or 2 required");var canvas;if(arguments.length===1){canvas=width;canvas.parentElement.style.position="relative"}else{canvas=document.createElement("canvas");if(arguments.length){canvas.width=width;canvas.height=height}}this.canvas=canvas;this.width=canvas.width;this.height=canvas.height;this.context=canvas.getContext("2d");jayus.displays.push(this);this.hookCursorListeners(this.canvas);this.addDefaultHandlers();
this.addHandler("dirty",function Display_dirty_updateCursor(e){if(e&2+4+8)this.startCursorUpdate()})},listItemAdded:function Display_listItemAdded(list,item){jayus.Scene.prototype.listItemAdded.call(this,list,item);item.parentDisplay=this;if(item.isParent){var display=this;item.forEveryChild(function(){this.parentDisplay=display})}},listItemsAdded:function Display_listItemsAdded(list,items){jayus.Scene.prototype.listItemsAdded.call(this,list,items);var i,item,displaySetter=function(){this.parentDisplay=
display};for(i=0;i<items.length;i++){item=items[i];item.parentDisplay=this;if(item.isParent){var display=this;item.forEveryChild(displaySetter)}}},setBuffering:function Display_setBuffering(){},processPendingMousemove:function Display_processPendingMousemove(e){this.hasPendingMousemoveEvent=false;return this.processMousemove(this.pendingMousemoveEvent)},processMousemove:function Display_processMousemove(e){if(!this.underCursor){this.underCursor=true;this.fire("cursorOver")}var x=e.offsetX===undefined?
e.layerX:e.offsetX,y=e.offsetY===undefined?e.layerY:e.offsetY,data={display:this,event:e,x:x,y:y,deltaX:x-this.cursor.x,deltaY:y-this.cursor.y};this.cursor.x=x;this.cursor.y=y;if(this.cursor.dependentCount)this.cursor.dirty(2);if(!this.fireOnCursor("cursorMove",data))this.fire("cursorMove",data);this.startCursorUpdate()},hookCursorListeners:function Display_hookCursorListeners(canvas){var display=this,cursorEventObject={event:null,display:display,x:null,y:null},scrollEventObject={event:null,display:display,
x:null,y:null,scroll:null,xScroll:null,yScroll:null},updateCursorEventObject=function(e){cursorEventObject.event=e;cursorEventObject.x=e.offsetX===undefined?e.layerX:e.offsetX;cursorEventObject.y=e.offsetY===undefined?e.layerY:e.offsetY},updateScrollEventObject=function(e,scroll,xScroll,yScroll){scrollEventObject.event=e;scrollEventObject.scroll=scroll;scrollEventObject.xScroll=xScroll;scrollEventObject.yScroll=yScroll},getButtonName=function(e){if(e.button===0)return"left";if(e.button===1)return"middle";
if(e.button===2)return"right";return"unknown"},mousemoveHandler=function Display_mousemoveHandler(e){if(display.pendMousemoveEvents){display.pendingMousemoveEvent=e;display.hasPendingMousemoveEvent=true}else display.processMousemove(e)},mouseoutHandler=function Display_mouseoutHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();updateCursorEventObject(e);for(var i=0,buttonName;i<3;i++){buttonName=getButtonName(i);if(jayus[buttonName+"Down"]){jayus[buttonName+"Down"]=false;
jayus.fire(buttonName+"Release",cursorEventObject);display.fireOnCursor(buttonName+"Release",cursorEventObject)}}if(jayus.cursorFocus!==null){jayus.cursorFocus.fire("cursorLeave");jayus.cursorFocus=null}display.underCursor=false;display.fire("cursorOut");display.removeCursorFromChildren()};canvas.addEventListener("mousemove",mousemoveHandler);canvas.addEventListener("mouseleave",mouseoutHandler);if(this.suppressSelection){canvas.style.webkitUserSelect="none";canvas.style.mozUserSelect="none";canvas.onselectstart=
function(){return false}}canvas.addEventListener("focus",function(e){display.fire("focused",{event:e,display:display});display.focused=true;jayus.focusedDisplay=display;jayus.hasFocus=true});canvas.addEventListener("blur",function(e){display.fire("blurred",{event:e,display:display});display.focused=false;jayus.focusedDisplay=null;jayus.hasFocus=false});canvas.setAttribute("tabindex","1");canvas.style.outline=0;canvas.addEventListener("mousedown",function Display_mousedownHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();
display.focus();if(!display.underCursor){display.underCursor=true;display.fire("cursorOver")}updateCursorEventObject(e);var buttonName=getButtonName(e),eventName=buttonName+"Press";jayus[buttonName+"Down"]=true;jayus.entityPressedOn=jayus.cursorFocus;if(jayus.fire(eventName,cursorEventObject)||(display.fireOnCursor(eventName,cursorEventObject)||display.fire(eventName,cursorEventObject))){e.stopPropagation();e.preventDefault();return false}});document.body.addEventListener("mouseup",function Display_mouseupHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();
updateCursorEventObject(e);var buttonName=getButtonName(e),eventName=buttonName+"Release";jayus[buttonName+"Down"]=false;jayus.fire(eventName,cursorEventObject)||(display.fireOnCursor(eventName,cursorEventObject)||display.fire(eventName,cursorEventObject))});canvas.addEventListener("contextmenu",function Display_contextmenuHandler(e){if(display.suppressContextMenu)e.preventDefault()});if(jayus.ua.browser==="Firefox")canvas.addEventListener("wheel",function Display_DOMMouseScrollHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();
if(!display.underCursor){display.underCursor=true;display.fire("cursorOver")}updateScrollEventObject(e,NaN,e.deltaX,e.deltaY);if(jayus.fire("scroll",scrollEventObject)||(display.fireOnCursor("scroll",scrollEventObject)||display.fire("scroll",scrollEventObject)))e.preventDefault()});else if(jayus.ua.browser==="IE")canvas.onmousewheel=function Display_onmousewheelHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();if(!display.underCursor){display.underCursor=true;display.fire("cursorOver")}updateScrollEventObject(e,
e.wheelDelta,e.wheelDeltaX,e.wheelDeltaY);if(jayus.fire("scroll",scrollEventObject)||(display.fireOnCursor("scroll",scrollEventObject)||display.fire("scroll",scrollEventObject)))return false};else canvas.addEventListener("mousewheel",function Display_mousewheelHandler(e){if(display.hasPendingMousemoveEvent)display.processPendingMousemove();if(!display.underCursor){display.underCursor=true;display.fire("cursorOver")}updateScrollEventObject(e,-e.wheelDelta/120,e.wheelDeltaX/120,-e.wheelDeltaY/120);
if(jayus.fire("scroll",scrollEventObject)||(display.fireOnCursor("scroll",scrollEventObject)||display.fire("scroll",scrollEventObject)))e.preventDefault()})},addDefaultHandlers:function Display_addDefaultHandlers(){var display=this;jayus.addHandler("keyPress",function(e){if(display.underCursor&&e.key==="grave"){var i,target,targets=display.getChildrenUnderCursor();if(targets.length===0)targets.push(display);for(i=0;i<targets.length;i++){target=targets[i];if(e.event.shiftKey)if(target.exposingAll)target.exposeAll();
else target.unexposeAll();else if(target.debugRenderer===null)target.expose();else target.unexpose()}}})},startCursorUpdate:function Display_startCursorUpdate(){var acceptor,tooltip;if(this.underCursor&&this.propagateCursor){this.updateCursorOnChildren(this.cursor.x,this.cursor.y);acceptor=this.findCursorAcceptor();this.cursorFocus=acceptor;if(jayus.cursorFocus!==acceptor)if(jayus.cursorFocus===null||jayus.cursorFocus.canReleaseCursor){if(jayus.cursorFocus!==null)jayus.cursorFocus.fire("cursorLeave");
jayus.cursorFocus=acceptor;if(acceptor!==null){acceptor.fire("cursorEnter");tooltip=acceptor.tooltip;if(this.canvas.title!==tooltip)this.canvas.setAttribute("title",tooltip)}else if(this.canvas.title)this.canvas.removeAttribute("title")}}},getTopCanvas:function Display_getTopCanvas(){return this.overlayCanvas!==null?this.overlayCanvas:this.canvas},showDamage:false,overlayCanvas:null,overlayContext:null,overlayFadeAnimator:null,initOverlay:function Display_initOverlay(){var canvas=document.createElement("canvas");
canvas.width=this.width;canvas.height=this.height;canvas.style.position="absolute";canvas.style.left=this.canvas.offsetLeft;canvas.style.top=this.canvas.offsetTop;canvas.style.opacity="0.5";this.overlayCanvas=canvas;this.overlayContext=canvas.getContext("2d");this.overlayContext.lineWidth=4;this.canvas.parentElement.appendChild(this.overlayCanvas);this.hookCursorListeners(canvas);this.overlayFadeAnimator=(new jayus.Animator(function update(pos){canvas.style.opacity=0.5-0.5*pos})).setDuration(500)},
clearDamage:function Display_clearDamage(){if(this.showDamage){this.initOverlay();var ctx=this.overlayContext;ctx.clearRect(0,0,this.width,this.height)}},paintDamage:function Display_paintDamage(rect){this.paintOverlayRect(rect,"red")},paintRedraw:function Display_paintRedraw(rect){this.paintOverlayRect(rect,"yellow")},paintOverlayRect:function Display_paintOverlayRect(rect,color){if(this.showDamage){this.initOverlay();var ctx=this.overlayContext;ctx.fillStyle=color;ctx.fillRect(rect.x,rect.y,rect.width,
rect.height);this.overlayCanvas.style.opacity="0.5";this.overlayFadeAnimator.restart()}},setVisible:function Display_setVisible(on){jayus.debug.match("Display.setVisible",on,"on",1);this.visible=on;if(on)this.canvas.style.visibility="";else this.canvas.style.visibility="hidden";return this},setAlpha:function Display_setAlpha(alpha){jayus.debug.match("Display.setAlpha",alpha,"alpha",4);if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setAlpha,this.alpha,alpha)}if(this.alpha!==
alpha){this.alpha=alpha;this.canvas.style.opacity=alpha}return this},setInto:function Display_setInto(element){element.style.position="relative";if(this.visible)element.appendChild(this.canvas);return this},focus:function Display_focus(){this.canvas.focus();return this},blur:function Display_blur(){this.canvas.blur();return this},isFullScreen:function Display_isFullScreen(){return(document.fullscreenEnabled||(document.mozFullScreenEnabled||document.webkitFullScreenEnabled))&&this.canvas===(document.fullscreenElement||
(document.mozFullScreenElement||document.webkitFullScreenElement))},requestFullScreen:function Display_requestFullScreen(){var canvas=this.canvas;if(canvas.requestFullScreen)canvas.requestFullScreen();else if(canvas.mozRequestFullScreen)canvas.mozRequestFullScreen();else if(canvas.webkitRequestFullScreen)canvas.webkitRequestFullScreen();return this.isFullScreen()},cancelFullScreen:function Display_cancelFullScreen(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();
else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();return this},getCursor:function Display_getCursor(){return this.customIcon?this.customCursor:this.getTopCanvas().style.cursor},setCursor:function Display_setCursor(cursor){if(typeof cursor==="string"){jayus.debug.match("Display.setCursor",cursor,"cursor",2);this.getTopCanvas().style.cursor=cursor;this.hasCustomCursor=false}else{jayus.debug.match("Display.setCursor",cursor,"cursor",12);this.getTopCanvas().style.cursor="none";
this.hasCustomCursor=true;this.customCursor=cursor}return this},resetCursor:function Display_resetCursor(){this.getTopCanvas().style.cursor="";this.hasCustomCursor=false;this.customCursor=null}});jayus.RESIZE_SELF=0;jayus.RESIZE_CHILD=1;jayus.RESIZE_MARGINS=2;
jayus.Frame=jayus.RectEntity.extend(jayus.applyObject({flexible:false,forming:false,widthMode:0,heightMode:0,minWidthMode:"child",minHeightMode:"child",init:function Frame(child){jayus.Entity.prototype.init.apply(this);if(child!==undefined){jayus.debug.match("Frame",child,"child",12);jayus.chart.tallyInit(12);this.setChild(child);this.formContents();this.isParent=true}else this.isParent=false;this.addHandler("dirty",function(type){this.formContents()})},initFromObject:function Frame_initFromObject(object){jayus.debug.match("Frame.initFromObject",
object,"object",5);this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,object);if(typeof object.marginLeft==="number")this.marginLeft=object.marginLeft;if(typeof object.marginRight==="number")this.marginRight=object.marginRight;if(typeof object.marginTop==="number")this.marginTop=object.marginTop;if(typeof object.marginBottom==="number")this.marginBottom=object.marginBottom;if(typeof object.widthMode==="number")this.widthMode=object.widthMode;if(typeof object.heightMode==="number")this.heightMode=
object.heightMode;if(typeof object.child==="object")this.setChild(jayus.parse(object.child));this.ignoreDirty--;return this.dirty(127)},setChild:function Frame_setChild(child){jayus.Wrapper.setChild.call(this,child);if(!this.width)this.setWidth(child.width+this.marginLeft+this.marginRight);if(!this.height)this.setHeight(child.height+this.marginTop+this.marginBottom);if(typeof child.minWidth==="number")this.minWidth=child.minWidth+this.marginLeft+this.marginRight;if(typeof child.minHeight==="number")this.minHeight=
child.minHeight+this.marginTop+this.marginBottom;this.formContents();return this},componentDirtied:function Frame_componentDirtied(component,type){if(type&4){if(this.minWidthMode==="child"&&typeof this.child.minWidth==="number")this.minWidth=this.child.minWidth+this.marginLeft+this.marginRight;if(this.minHeightMode==="child"&&typeof this.child.minHeight==="number")this.minHeight=this.child.minHeight+this.marginTop+this.marginBottom;if(!this.forming)this.formContents()}else this.dirty(127)},marginBrush:null,
setMarginBrush:function Frame_setMarginBrush(brush){jayus.debug.match("Frame.setMarginBrush",brush,"brush",5);if(this.marginBrush!==null)this.marginBrush.detach(this);if(!(brush instanceof jayus.Brush))brush=new jayus.Brush(brush);this.marginBrush=brush;this.marginBrush.attach(this);return this.dirty(16)},clearMarginBrush:function Frame_clearMarginBrush(){if(this.marginBrush!==null){this.marginBrush.detach(this);this.marginBrush=null;this.dirty(16)}return this},marginLeft:6,marginRight:6,marginTop:6,
marginBottom:6,setMargin:function Frame_setMargin(left,right,top,bottom){if(arguments.length===1){jayus.debug.match("Frame.setMargin",left,"margin",4);bottom=top=right=left}else jayus.debug.matchArgumentsAs("Frame.setMargin",arguments,4,"left","right","top","bottom");this.marginLeft=left;this.marginRight=right;this.marginTop=top;this.marginBottom=bottom;this.formContents();return this},setMarginLeft:function Frame_setMarginLeft(margin){jayus.debug.match("Frame.setMarginLeft",margin,"margin",4);return this.setMargin(margin,
this.marginRight,this.marginTop,this.marginBottom)},setMarginRight:function Frame_setMarginRight(margin){jayus.debug.match("Frame.setMarginRight",margin,"margin",4);return this.setMargin(this.marginLeft,margin,this.marginTop,this.marginBottom)},setMarginTop:function Frame_setMarginTop(margin){jayus.debug.match("Frame.setMarginTop",margin,"margin",4);return this.setMargin(this.marginLeft,this.marginRight,margin,this.marginBottom)},setMarginBottom:function Frame_setMarginBottom(margin){jayus.debug.match("Frame.setMarginBottom",
margin,"margin",4);return this.setMargin(this.marginLeft,this.marginRight,this.marginTop,margin)},formContents:function Frame_formContents(){if(this.child!==null&&!this.forming){var child=this.child;this.forming=true;child.setOrigin(this.marginLeft,this.marginTop);if(this.widthMode===jayus.RESIZE_SELF)this.setWidth(child.width+this.marginLeft+this.marginRight);else if(this.widthMode===jayus.RESIZE_CHILD)child.setWidth(this.width-this.marginLeft-this.marginRight);else console.error("Frame.formContents() - Invalid widthMode: "+
this.widthMode);if(this.heightMode===jayus.RESIZE_SELF)this.setHeight(child.height+this.marginTop+this.marginBottom);else if(this.heightMode===jayus.RESIZE_CHILD)child.setHeight(this.height-this.marginTop-this.marginBottom);else console.error("Frame.formContents() - Invalid heightMode: "+this.heightMode);if(this.width<this.minWidth)this.changeSize(this.minWidth,this.height);if(this.height<this.minHeight)this.changeSize(this.width,this.minHeight);this.forming=false}},paintContents:function Frame_paintContents(ctx){jayus.debug.matchContext("Frame.paintContents",
ctx);if(this.marginBrush!==null)if(this.marginBrush.fill||this.marginBrush.stroking){ctx.save();this.marginBrush.applyTo(ctx);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(this.width,0);ctx.lineTo(this.width,this.height);ctx.lineTo(0,this.height);ctx.lineTo(0,0);ctx.moveTo(this.marginLeft,this.marginTop);ctx.lineTo(this.width-this.marginRight,this.marginTop);ctx.lineTo(this.width-this.marginRight,this.height-this.marginBottom);ctx.lineTo(this.marginLeft,this.height-this.marginBottom);ctx.lineTo(this.marginLeft,
this.marginTop);if(this.marginBrush.stroking&&this.marginBrush.strokeFirst)ctx.stroke();if(this.marginBrush.filling)ctx.fill();if(this.marginBrush.stroking&&!this.marginBrush.strokeFirst)ctx.stroke();ctx.restore()}ctx.save();this.child.drawOntoContext(ctx);this.child.dirtied=false;ctx.restore()}},jayus.copyObject(jayus.Wrapper)));jayus.FlexibleFrame=jayus.Frame.extend({flexible:true});jayus.EditableFrame=jayus.Frame.extend({maxWidth:Infinity,maxHeight:Infinity,flexible:true,enabledHandles:{nw:1,n:1,ne:1,e:1,se:1,s:1,sw:1,w:1},cornerThreshold:6,edgeThreshold:5,state:"",display:null,init:function EditableFrame(child){jayus.Frame.prototype.init.call(this,child);this.addHandler("cursorMove",function(e){if(!this.dragging){this.state="";var cursor=e.display.cursor,varWidth=this.child.hasFlexibleWidth,varHeight=this.child.hasFlexibleHeight;if(varWidth&&varHeight)if(this.enabledHandles.nw&&
jayus.distance(this.getPosAt(0,0),cursor)<this.cornerThreshold)this.state="nw";else if(this.enabledHandles.ne&&jayus.distance(this.getPosAt(1,0),cursor)<this.cornerThreshold)this.state="ne";else if(this.enabledHandles.sw&&jayus.distance(this.getPosAt(0,1),cursor)<this.cornerThreshold)this.state="sw";else if(this.enabledHandles.se&&jayus.distance(this.getPosAt(1,1),cursor)<this.cornerThreshold)this.state="se";if(this.state===""&&varWidth)if(this.enabledHandles.w&&Math.abs(this.x-e.x)<this.edgeThreshold)this.state=
"w";else if(this.enabledHandles.e&&Math.abs(this.x+this.width-e.x)<this.edgeThreshold)this.state="e";if(this.state===""&&varHeight)if(this.enabledHandles.n&&Math.abs(this.y-e.y)<this.edgeThreshold)this.state="n";else if(this.enabledHandles.s&&Math.abs(this.y+this.height-e.y)<this.edgeThreshold)this.state="s";if(this.state!=="")this.parentDisplay.setCursor(this.state+"-resize");else this.parentDisplay.resetCursor()}});this.addHandler("cursorOut",function(e){if(!this.dragging){this.parentDisplay.resetCursor();
this.state=""}});this.addHandler("leftPress",function(e){this.dragging=true;if(this.state===""){this.parentDisplay.setCursor("move");this.fire("dragStart")}else if(this.state==="nw")this.start=this.getPosAt(1,1);else if(this.state==="n"||(this.state==="e"||this.state==="ne"))this.start=this.getPosAt(0,1);else if(this.state==="sw"||this.state==="w")this.start=this.getPosAt(1,0);else if(this.state==="s"||this.state==="se")this.start=this.getPosAt(0,0);var that=this;jayus.addHandler("leftRelease",function(data,
options){that.dragging=false;if(that.state===""){that.fire("dragEnd");that.parentDisplay.resetCursor()}options.remove=true});var dragHandler=function(e,options){if(that.dragging){if(that.state==="")that.translate(e.deltaX,e.deltaY);else{var width=null,height=null,anchorX=0,anchorY=0;if(that.state==="nw"){anchorX=1;anchorY=1;width=that.start.x-e.x;height=that.start.y-e.y}else if(that.state==="n"){anchorY=1;height=that.start.y-e.y}else if(that.state==="ne"){anchorY=1;width=e.x-that.start.x;height=that.start.y-
e.y}else if(that.state==="sw"){anchorX=1;width=that.start.x-e.x;height=e.y-that.start.y}else if(that.state==="s")height=e.y-that.start.y;else if(that.state==="se"){width=e.x-that.start.x;height=e.y-that.start.y}else if(that.state==="e")width=e.x-that.start.x;else if(that.state==="w"){anchorX=1;width=that.start.x-e.x}var pos=that.getPosAt(anchorX,anchorY);if(width!==null)if(width<that.minWidth)width=that.minWidth;else if(width>that.maxWidth)width=that.maxWidth;if(height!==null)if(height<that.minHeight)height=
that.minHeight;else if(height>that.maxHeight)height=that.maxHeight;if(width!==null&&height!==null){that.setSize(width,height);width=that.width}else if(height===null)that.setWidth(width);else that.setHeight(height);that.setPosAt(pos,anchorX,anchorY)}return true}options.remove=true};e.display.addHandler("cursorMove",dragHandler);return true})},setMinimumSize:function EditableFrame_setMinimumSize(width,height){jayus.debug.matchArgumentsAs("EditableFrame.setMinimumSize",arguments,4,"width","height");
this.minW=width;this.minH=height;return this}});jayus.FlowLayout=jayus.RectEntity.extend({alignment:0,contractHeight:false,width:100,height:100,forming:false,minWidth:0,init:function FlowLayout(){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.items=this.children.items;this.children.typeId=12;this.addHandler("dirty",function(type){if(type&4)this.formContents()})},componentDirtied:function Box_componentDirtied(component,type){if(!this.forming)this.dirty(127)},listItemAdded:function FlowLayout_listItemAdded(list,item){item.setParent(this);
if(item.minWidth>this.minWidth)this.minWidth=item.minWidth;this.dirty(127)},listItemsAdded:function FlowLayout_listItemAdded(list,items){for(var i=0;i<items.length;i++){var item=items[i];item.setParent(this);if(item.minWidth>this.minWidth)this.minWidth=item.minWidth}this.dirty(127)},listItemRemoved:function FlowLayout_listItemRemoved(list,item){item.removeParent();this.refreshMinWidth();this.dirty(127)},listItemsRemoved:function FlowLayout_listItemsRemoved(list,items){for(var i=0;i<items.length;i++)items[i].removeParent();
this.refreshMinWidth();this.dirty(127)},refreshMinWidth:function FlowLayout_refreshMinWidth(){var w=0;for(var i=0;i<this.items.length;i++){var item=this.items[i];if(item.minWidth>w)w=item.minWidth}this.minWidth=w},setAlignment:function FlowLayout_setAlignment(alignment){jayus.debug.match("FlowLayout.setAlignment",alignment,"alignment",4);if(this.alignment!==alignment){this.alignment=alignment;this.formContents()}return this},formContents:function FlowLayout_formContents(){if(this.forming)return;this.forming=
true;var items=this.items,itemIndex=0,currentLineIndex,y=0,currentLine,currentLineWidth,h,x,item,nextItem,nextItemWidth,lineHeights=[];while(itemIndex!==items.length){currentLine=[];currentLineWidth=0;h=0;x=0;nextItem=items[itemIndex];nextItemWidth=nextItem.width;do{nextItem.x=x;nextItem.y=y;currentLine.push(nextItem);currentLineWidth+=nextItemWidth;x+=nextItemWidth;if(nextItem.height>h)h=nextItem.height;itemIndex++;if(itemIndex===items.length)break;nextItem=items[itemIndex];nextItemWidth=nextItem.width}while(currentLineWidth+
nextItemWidth<this.width);for(currentLineIndex=0;currentLineIndex<currentLine.length;currentLineIndex++){item=currentLine[currentLineIndex];if(this.alignment!==0)item.x+=(this.width-currentLineWidth)*this.alignment;if(typeof item.verticalAlign==="number")item.y=item.y+item.verticalAlign*(h-item.height)}y+=h;lineHeights.push(h)}for(itemIndex=0;itemIndex<items.length;itemIndex++)items[itemIndex].dirty(2);this.lineHeights=lineHeights;this.minHeight=y;if(this.contractHeight||this.height<this.minHeight)this.changeSize(this.width,
this.minHeight);this.dirty(4);this.forming=false},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.FlowLayout.prototype);jayus.Stack=jayus.RectEntity.extend({spacing:8,reversed:false,isParent:true,hasFlexibleWidth:true,hasFlexibleHeight:true,init:function Stack(){jayus.RectEntity.prototype.init.apply(this,arguments);this.children=new jayus.List(this);this.items=this.children.items;this.children.typeId=12},toObject:function Stack_toObject(){var object=jayus.RectEntity.prototype.toObject.apply(this);jayus.groupToObject.call(this,object);object.type="Stack";if(this.spacing!==8)object.spacing=this.spacing;if(this.reversed!==
8)object.reversed=this.reversed;return object},initFromObject:function Stack_initFromObject(object){jayus.debug.match("Stack.initFromObject",object,"object",5);this.ignoreDirty++;jayus.RectEntity.prototype.initFromObject.call(this,object);jayus.groupInitFromObject.call(this,object);if(typeof object.spacing==="number")this.spacing=object.spacing;if(typeof object.reversed==="boolean")this.reversed=object.reversed;this.formContents();this.ignoreDirty--;return this.dirty(127)},componentDirtied:function Stack_componentDirtied(component,
type){if(type&4)this.formContents();this.dirty(16)},listItemAdded:function Stack_listItemAdded(list,item){this.formContents();item.setParent(this);this.dirty(16)},listItemsAdded:function Stack_listItemsAdded(list,items){this.formContents();for(var i=0;i<items.length;i++)items[i].setParent(this);this.dirty(16)},listItemRemoved:function Stack_listItemRemoved(list,item){this.formContents();item.removeParent();this.dirty(16)},listItemsRemoved:function Stack_listItemsRemoved(list,items){this.formContents();
for(var i=0;i<items.length;i++)items[i].removeParent();this.dirty(16)},listItemsMoved:function Stack_listItemsMoved(){this.formContents();this.dirty(16)},setReversed:function Stack_setReversed(on){jayus.debug.match("Stack.setReversed",on,"on",1);if(this.reversed!==on){this.reversed=on;this.formContents()}return this},setSpacing:function Stack_setSpacing(spacing){jayus.debug.match("Stack.setSpacing",spacing,"spacing",4);if(this.spacing!==spacing){this.spacing=spacing;this.formContents()}return this},
paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Stack.prototype);
jayus.hStack=jayus.Stack.extend({automaticHeight:true,hasFlexibleWidth:false,toObject:function hStack_toObject(){var object=jayus.Stack.prototype.toObject.apply(this);object.type="hStack";if(this.automaticHeight!==true)object.automaticHeight=this.automaticHeight.toObject();return object},formContents:function hStack_formContents(){var w=0,h=0,newH,i,item;if(this.reversed)for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.included){item.setX(w);w+=item.width+this.spacing;newH=item.height;
if(newH>h)h=newH}}else for(i=0;i<this.items.length;i++){item=this.items[i];if(item.included){item.setX(w);w+=item.width+this.spacing;newH=item.height;if(newH>h)h=newH}}var height=this.height;this.minWidth=this.width;this.minHeight=h;if(this.height<this.minHeight)height=h;this.changeSize(w-this.spacing,height)}});
jayus.vStack=jayus.Stack.extend({automaticWidth:true,hasFlexibleHeight:false,getAutomaticWidth:function vStack_getAutomaticWidth(){return this.automaticWidth},setAutomaticWidth:function vStack_setAutomaticWidth(on){jayus.debug.match("vStack.setAutomaticWidth",on,"on",1);if(this.automaticWidth!==on){this.automaticWidth=on;this.formContents()}return this},toObject:function vStack_toObject(){var object=jayus.Stack.prototype.toObject.apply(this);object.type="vStack";if(this.automaticWidth!==true)object.automaticWidth=
this.automaticWidth.toObject();return object},formContents:function vStack_formContents(){var h=0,w=0,i,item,newW;if(this.reversed)for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.included){item.setY(h);h+=item.height+this.spacing;newW=item.width;if(newW>w)w=newW}}else for(i=0;i<this.items.length;i++){item=this.items[i];if(item.included){item.setY(h);h+=item.height+this.spacing;newW=item.width;if(newW>w)w=newW}}var width=this.width;this.minWidth=w;this.minHeight=this.height;if(this.width<
this.minWidth)width=w;this.changeSize(width,h-this.spacing)}});jayus.Box=jayus.RectEntity.extend({width:100,height:100,spacing:8,reversed:false,isParent:true,forming:false,init:function Box(object){jayus.Entity.prototype.init.apply(this,arguments);this.children=new jayus.List(this);this.items=this.children.items;this.children.typeId=12;this.addHandler("dirty",function Box_dirtyHandler(type){if(type&4)this.formContents()})},toObject:function Box_toObject(){var object=jayus.RectEntity.prototype.toObject.call(this);jayus.groupToObject.call(this,object);object.id=
"__Box__";if(this.spacing!==jayus.Box.prototype.spacing)object.spacing=this.spacing;if(this.reversed!==false)object.reversed=this.reversed;return object},initFromObject:function Box_initFromObject(object){jayus.RectEntity.prototype.initFromObject.call(this,object);jayus.groupInitFromObject.call(this,object);if(typeof object.spacing==="number")this.setSpacing(object.spacing);if(typeof object.reversed==="boolean")this.setReversed(object.reversed);return this.dirty(127)},componentDirtied:function Box_componentDirtied(component,
type){if(!this.forming)this.dirty(127)},listItemRemoved:function Box_listItemRemoved(list,item){item.removeParent();this.dirty(127)},setReversed:function Box_setReversed(on){jayus.debug.match("Box.setReversed",on,"on",1);if(this.reversed!==on){this.reversed=on;this.formContents()}return this},setSpacing:function Box_setSpacing(spacing){jayus.debug.match("Box.setSpacing",spacing,"spacing",4);if(this.spacing!==spacing){this.spacing=spacing;this.formContents()}return this},findGreatestMinimalChildWidth:function Box_findGreatestMinimalChildWidth(){var width=
0;for(var i=0;i<this.items.length;i++)width=Math.max(width,this.items[i].minW);return width},findGreatestMinimalChildHeight:function Box_findGreatestMinimalChildHeight(){var height=0;for(var i=0;i<this.items.length;i++)height=Math.max(height,this.items[i].minH);return height},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Box.prototype);
jayus.hBox=jayus.Box.extend({toObject:function hBox_toObject(){var object=jayus.Box.prototype.toObject.call(this);object.type="hBox";return object},listItemAdded:function hBox_listItemAdded(list,item){if(typeof item.widthPolicy!=="object")item.widthPolicy=new jayus.SizePolicy;item.setParent(this);this.dirty(127)},listItemsAdded:function hBox_listItemsAdded(list,items){var i,item;for(i=0;i<items.length;i++){item=items[i];if(typeof item.widthPolicy!=="object")item.widthPolicy=new jayus.SizePolicy;item.setParent(this)}this.dirty(127)},
formContents:function hBox_formContents(){this.forming=true;var i,item,x=0,space=this.width-(this.items.length-1)*this.spacing,totalWeight=0,totalFixedSize=0,itemWidth,itemHeight,minW,minH;for(i=0;i<this.items.length;i++){item=this.items[i];if(item.hasFlexibleWidth){totalFixedSize+=item.widthPolicy.size;if(item.widthPolicy.expand)totalWeight+=item.widthPolicy.weight}else totalFixedSize+=item.width}var extraSpace=space-totalFixedSize;for(i=0;i<this.items.length;i++){item=this.items[i];if(item.hasFlexibleHeight)itemHeight=
this.height;else itemHeight=item.height;if(item.hasFlexibleWidth)if(item.widthPolicy.expand)itemWidth=item.widthPolicy.size+extraSpace*(item.widthPolicy.weight/totalWeight);else itemWidth=item.widthPolicy.size;else itemWidth=item.width;item.x=x;x+=itemWidth+this.spacing;item.changeSize(itemWidth,itemHeight)}minW=-this.spacing;minH=0;for(i=0;i<this.items.length;i++){item=this.items[i];if(typeof item.minWidth==="number")minW+=item.minWidth;minW+=this.spacing;if(typeof item.minHeight==="number"&&item.minHeight>
minH)minH=item.minHeight}this.minWidth=minW;this.minHeight=minH;if(this.width<this.minWidth)this.changeSize(this.minWidth,this.height);if(this.height<this.minHeight)this.changeSize(this.width,this.minHeight);this.forming=false}});
jayus.vBox=jayus.Box.extend({toObject:function vBox_toObject(){var object=jayus.Box.prototype.toObject.call(this);object.type="vBox";return object},listItemAdded:function vBox_listItemAdded(list,item){if(typeof item.heightPolicy!=="object")item.heightPolicy=new jayus.SizePolicy;item.setParent(this);this.dirty(127)},listItemsAdded:function vBox_listItemsAdded(list,items){var i,item;for(i=0;i<items.length;i++){item=items[i];if(typeof item.heightPolicy!=="object")item.heightPolicy=new jayus.SizePolicy;
item.setParent(this)}this.dirty(127)},formContents:function vBox_formContents(){if(this.forming)return;this.forming=true;var i,item,y=0,space=this.height-(this.items.length-1)*this.spacing,totalWeight=0,totalFixedSize=0,itemWidth,itemHeight,minW,minH;for(i=0;i<this.items.length;i++){item=this.items[i];if(item.heightPolicy.flexible){totalFixedSize+=item.heightPolicy.size;if(item.heightPolicy.expand)totalWeight+=item.heightPolicy.weight}else totalFixedSize+=item.height}var extraSpace=space-totalFixedSize;
for(i=0;i<this.items.length;i++){item=this.items[i];itemWidth=this.width;if(item.heightPolicy.flexible)if(item.heightPolicy.expand)itemHeight=item.heightPolicy.size+extraSpace*(item.heightPolicy.weight/totalWeight);else itemHeight=item.heightPolicy.size;else itemHeight=item.height;item.y=y;y+=itemHeight+this.spacing;item.setSize(itemWidth,itemHeight)}minW=0;minH=-this.spacing;for(i=0;i<this.items.length;i++){item=this.items[i];minH+=this.spacing;if(typeof item.minWidth==="number"&&item.minWidth>minH)minW=
item.minWidth;if(typeof item.minHeight==="number")minH+=item.minHeight}this.minWidth=minW;this.minHeight=minH;if(this.width<this.minWidth)this.changeSize(this.minWidth,this.height);if(this.height<this.minHeight)this.changeSize(this.width,this.minHeight);this.forming=false}});jayus.TiledMap=jayus.RectEntity.extend({filepath:"",map:null,tileWidth:0,tileHeight:0,layerVisibility:null,mapLoaded:false,tilesetsLoaded:false,loaded:false,pendingLoad:false,init:function TiledMap(map){jayus.Entity.prototype.init.apply(this);if(arguments.length)this.setMap(map)},checkMapLoaded:function TiledMap_checkMapLoaded(){if(!this.mapLoaded)throw new Error("TiledMap.checkMapLoaded() - Error, map file not yet loaded");},setMap:function TiledMap_setMap(map){if(this.pendingLoad){console.warn('TiledMap.setMap() - Called while still waiting for map file "'+
filepath+'" to be loaded');return this}var that,filepath,filepaths,i,data;if(typeof map==="string"){filepath=map;if(filepath===this.filepath){console.debug("TiledMap.setMap() - Called twice with same filepath: "+filepath);return this}this.filepath=filepath;if(!jayus.objects.isLoaded(filepath)){this.mapLoaded=false;this.loaded=false;this.pendingLoad=true;that=this;jayus.objects.whenLoaded(filepath,function(data){that.pendingLoad=false;that.setMap(data.object)});return this}map=jayus.objects.get(filepath)}if(map===
this.map){console.debug("TiledMap.setMap() - Called twice with same map: "+map);return this}this.map=map;that=this;filepaths=[];for(i=0;i<this.map.tilesets.length;i++){data=this.map.tilesets[i];filepaths.push(data.image);jayus.images.whenLoaded(data.image,function(event){if(typeof event.image.sheet!=="object"){var sheet=new jayus.SpriteSheet(event.filepath);sheet.setSpriteSize(data.tilewidth,data.tileheight)}that.dirty(127)})}this.setSize(this.map.width*this.map.tilewidth,this.map.height*this.map.tileheight);
this.layerVisibility=[];for(i=0;i<this.map.layers.length;i++)this.layerVisibility.push(this.map.layers[i].visible);this.mapLoaded=true;this.loaded=false;jayus.images.whenLoaded(filepaths,function(){that.tilesetsLoaded=true;that.loaded=true;that.fire("loaded")});return this},whenLoaded:function TiledMap_whenLoaded(handler){jayus.debug.match("TiledMap.whenLoaded",handler,"handler",3);if(this.loaded)handler.apply(this);else this.addHandler("loaded",function(data,options){handler.apply(this);options.remove=
true});return this},getTileAt:function TiledMap_getTileAt(x,y){jayus.debug.matchCoordinate("TiledMap.getTileAt",x,y);if(arguments.length===1)return this.getTileAt(x.x,x.y);return new jayus.Point(Math.floor((x-this.x)/this.map.tilewidth),Math.floor((y-this.y)/this.map.tileheight))},getSlotFrame:function TiledMap_getSlotFrame(x,y){jayus.debug.matchCoordinate("TiledMap.getSlotFrame",x,y);this.checkMapLoaded();if(arguments.length===1)return this.getSlotFrame(x.x,x.y);return new jayus.Rectangle(this.x+
x*this.map.tilewidth,this.y+y*this.map.tileheight,this.map.tilewidth,this.map.tileheight)},isLayerVisible:function TiledMap_isLayerVisible(index){jayus.debug.match("TiledMap.isLayerVisible",index,"index",4);this.checkMapLoaded();return this.layerVisibility[index]},setLayerVisibility:function TiledMap_setLayerVisibility(index,visible){jayus.debug.matchArguments("TiledMap.setLayerVisibility",arguments,"index",4,"visible",1);this.checkMapLoaded();if(this.layerVisibility[index]!==visible){this.layerVisibility[index]=
visible;this.dirty(127)}return this},showLayer:function TiledMap_showLayer(index){jayus.debug.match("TiledMap.showLayer",index,"index",4);this.checkMapLoaded();return this.setLayerVisibility(index,true)},hideLayer:function TiledMap_hideLayer(index){jayus.debug.match("TiledMap.hideLayer",index,"index",4);this.checkMapLoaded();return this.setLayerVisibility(index,false)},paintContents:function TiledMap_paintContents(ctx){jayus.debug.matchContext("TiledMap.paintContents",ctx);this.checkMapLoaded();var i,
tileset;for(i=0;i<this.map.tilesets.length;i++){tileset=this.map.tilesets[i];if(!jayus.images.isLoaded(tileset.image)){console.error('TiledMap.paintContents() - Tileset "'+tileset.image+'" not yet loaded');return}}tileset=this.map.tilesets[0];var layer,image=jayus.images.get(tileset.image),marginX=image.sheet.marginX,marginY=image.sheet.marginY,tileWidth=image.sheet.spriteWidth,tileHeight=image.sheet.spriteHeight,tilesPerRow=tileset.imagewidth/tileWidth,tileY,tileX,index,sourceTileX,sourceTileY;for(i=
0;i<this.map.layers.length;i++){layer=this.map.layers[i];if(layer.type==="tilelayer"&&this.layerVisibility[i])for(tileY=layer.height-1;tileY>=0;tileY--)for(tileX=layer.width-1;tileX>=0;tileX--){index=layer.data[tileY*layer.width+tileX]-1;if(index!==-1){sourceTileX=index%tilesPerRow;sourceTileY=(index-sourceTileX)/tilesPerRow;ctx.drawImage(image,marginX+sourceTileX*tileWidth,marginY+sourceTileY*tileHeight,tileWidth,tileHeight,tileX*tileWidth,tileY*tileHeight,tileWidth,tileHeight)}}}}});
